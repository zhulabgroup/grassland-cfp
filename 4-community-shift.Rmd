---
title: "Community shift analyses"
date: "`r format(Sys.time(), '%B %d, %Y')`"
editor_options: 
  chunk_output_type: console
output:
  bookdown::html_document2: 
    fig_caption: true
    number_sections: true
    global_numbering: true
  bookdown::word_document2: 
    fig_caption: true
    number_sections: true
    global_numbering: true
---

```{r setup, echo=FALSE, message=FALSE}
source("scripts/utils/setup.R")
```

# Methods

Let us begin with the theory of moment method estimation, which is a generalization of the CTI/CPI approach. For location $i$, species $j$, denote species abundance (point intercept or percent cover) as $A_{ij}$, and species trait (e.g., optimal temperature) as $T_j$. At the community level, the expected trait (i.e., first moment), which is equivalent to CTI/CPI, is

$$
\mathrm{E}(T_i) = \bar{T_i} = \frac{\sum_j A_{ij}T_j}{\sum_j A_{ij}}.
$$

Furthermore, the trait variance (i.e., second central moment), using the variance-expectation formula, is

$$
\mathrm{Var}(T_i) = \mathrm{E}[T_i^2] - \mathrm{E}[T_i]^2 = \frac{\sum_j A_{ij}T_j^2}{\sum_j A_{ij}} - \bar{T_i}^2.
$$

A pair of $\{\mathrm{E}(T_i), \mathrm{Var}(T_i)\}$ characterizes the trait values under the distribution of species abundance. Operationally, we might use a pair of mean and standard deviation, $\{ \mu(T_i) = \mathrm{E}(T_i), \sigma(T_i) = \sqrt{\mathrm{Var}(T_i)}\}$, so that they are comparable with the same unit. 

Show available sampling year for plot by site for experimental and observational data.

```{r data-avail}
read_rds(.path$com_exp) %>%
  distinct(site, plot, year) %>%
  ggplot(aes(year, plot)) +
  geom_point() +
  facet_wrap(~site, scales = "free")

read_rds(.path$com_obs) %>%
  distinct(site, plot, year) %>%
  ggplot(aes(year, plot)) +
  geom_point() +
  facet_wrap(~site, scales = "free")
```

Calculate CWM using niche estimates for experimental and observational data.

```{r cal-cwm}
source("scripts/calculate-cwm.R")
```

# Experimental data

```{r plot-cwm-exp}
source("scripts/plot-cwm-exp.R")
```

## JRGCE 

In the following figures, left-right indicates warming-only vs. warming-all treatments. Warming-only treatments have fewer plots; all warming treatments have more plots, which average over all the other precip, CO2, nitrogen treatments. Top-bottom indicates mean or std dev of the community indexes.

### CTI ~ warming treatment

```{r jrgce-cti-warming, fig.cap="Community Temperature Index (CTI) statistics respond to warming treatments}
plot_cwm_jrgce(cwm_tag = "mean_cti", trt_tag = "tmp_only") +
  plot_cwm_jrgce(cwm_tag = "mean_cti", trt_tag = "tmp_all") +
  plot_cwm_jrgce(cwm_tag = "sd_cti", trt_tag = "tmp_only") +
  plot_cwm_jrgce(cwm_tag = "sd_cti", trt_tag = "tmp_all") +
  plot_annotation(tag_levels = "A") +
  plot_layout(2, 2)
```

### CPI ~ warming treatment

```{r jrgce-cpi-warming, fig.cap="Community Precipitation Index (CPI) statistics respond to warming treatments}
plot_cwm_jrgce(cwm_tag = "mean_cpi", trt_tag = "tmp_only") +
  plot_cwm_jrgce(cwm_tag = "mean_cpi", trt_tag = "tmp_all") +
  plot_cwm_jrgce(cwm_tag = "sd_cpi", trt_tag = "tmp_only") +
  plot_cwm_jrgce(cwm_tag = "sd_cpi", trt_tag = "tmp_all") +
  plot_annotation(tag_levels = "A") +
  plot_layout(2, 2)
```

### CVI ~ warming treatment

```{r jrgce-cvi-warming, fig.cap="Community VPD Index (CVI) statistics respond to warming treatments}
plot_cwm_jrgce(cwm_tag = "mean_cvi", trt_tag = "tmp_only") +
  plot_cwm_jrgce(cwm_tag = "mean_cvi", trt_tag = "tmp_all") +
  plot_cwm_jrgce(cwm_tag = "sd_cvi", trt_tag = "tmp_only") +
  plot_cwm_jrgce(cwm_tag = "sd_cvi", trt_tag = "tmp_all") +
  plot_annotation(tag_levels = "A") +
  plot_layout(2, 2)
```

### CTI ~ watering treatment

```{r jrgce-cti-watering, fig.cap="Community Temperature Index (CTI) statistics respond to watering treatments}
plot_cwm_jrgce(cwm_tag = "mean_cti", trt_tag = "ppt_only") +
  plot_cwm_jrgce(cwm_tag = "mean_cti", trt_tag = "ppt_all") +
  plot_cwm_jrgce(cwm_tag = "sd_cti", trt_tag = "ppt_only") +
  plot_cwm_jrgce(cwm_tag = "sd_cti", trt_tag = "ppt_all") +
  plot_annotation(tag_levels = "A") +
  plot_layout(2, 2)
```

### CPI ~ watering treatment

```{r jrgce-cpi-watering, fig.cap="Community Precipitation Index (CPI) statistics respond to watering treatments}
plot_cwm_jrgce(cwm_tag = "mean_cpi", trt_tag = "ppt_only") +
  plot_cwm_jrgce(cwm_tag = "mean_cpi", trt_tag = "ppt_all") +
  plot_cwm_jrgce(cwm_tag = "sd_cpi", trt_tag = "ppt_only") +
  plot_cwm_jrgce(cwm_tag = "sd_cpi", trt_tag = "ppt_all") +
  plot_annotation(tag_levels = "A") +
  plot_layout(2, 2)
```

### CVI ~ watering treatment

```{r jrgce-cvi-watering, fig.cap="Community VPD Index (CVI) statistics respond to warming treatments}
plot_cwm_jrgce(cwm_tag = "mean_cvi", trt_tag = "ppt_only") +
  plot_cwm_jrgce(cwm_tag = "mean_cvi", trt_tag = "ppt_all") +
  plot_cwm_jrgce(cwm_tag = "sd_cvi", trt_tag = "ppt_only") +
  plot_cwm_jrgce(cwm_tag = "sd_cvi", trt_tag = "ppt_all") +
  plot_annotation(tag_levels = "A") +
  plot_layout(2, 2)
```

## McLaughlin Water Experiment

In the following figures, left-right indicates non-serpentine vs. serpentine soil types. Top-bottom indicates mean or std dev of the community indexes.

### CTI ~ watering treatment

```{r mclexp-cti-watering, fig.cap="Community Temperature Index (CTI) statistics respond to watering treatments}
plot_cwm_mclexp(cwm_tag = "mean_cti", trt_tag = "watering") +
  plot_cwm_mclexp(cwm_tag = "sd_cti", trt_tag = "watering") +
  plot_annotation(tag_levels = "A") +
  plot_layout(1, 2)
```

### CPI ~ watering treatment

```{r mclexp-cpi-watering, fig.cap="Community Precipitation Index (CPI) statistics respond to watering treatments}
plot_cwm_mclexp(cwm_tag = "mean_cpi", trt_tag = "watering") +
  plot_cwm_mclexp(cwm_tag = "sd_cpi", trt_tag = "watering") +
  plot_annotation(tag_levels = "A") +
  plot_layout(1, 2)
```

### CVI ~ watering treatment

```{r mclexp-cvi-watering, fig.cap="Community VPD Index (CVI) statistics respond to watering treatments}
plot_cwm_mclexp(cwm_tag = "mean_cvi", trt_tag = "watering") +
  plot_cwm_mclexp(cwm_tag = "sd_cvi", trt_tag = "watering") +
  plot_annotation(tag_levels = "A") +
  plot_layout(1, 2)
```

### CTI ~ drought treatment

```{r mclexp-cti-drought, fig.cap="Community Temperature Index (CTI) statistics respond to drought treatments}
plot_cwm_mclexp(cwm_tag = "mean_cti", trt_tag = "drought") +
  plot_cwm_mclexp(cwm_tag = "sd_cti", trt_tag = "drought") +
  plot_annotation(tag_levels = "A") +
  plot_layout(1, 2)
```

### CPI ~ drought treatment

```{r mclexp-cpi-drought, fig.cap="Community Precipitation Index (CPI) statistics respond to drought treatments}
plot_cwm_mclexp(cwm_tag = "mean_cpi", trt_tag = "drought") +
  plot_cwm_mclexp(cwm_tag = "sd_cpi", trt_tag = "drought") +
  plot_annotation(tag_levels = "A") +
  plot_layout(1, 2)
```

### CVI ~ drought treatment

```{r mclexp-cvi-drought, fig.cap="Community VPD Index (CVI) statistics respond to drought treatments}
plot_cwm_mclexp(cwm_tag = "mean_cvi", trt_tag = "drought") +
  plot_cwm_mclexp(cwm_tag = "sd_cvi", trt_tag = "drought") +
  plot_annotation(tag_levels = "A") +
  plot_layout(1, 2)
```

## Santa Cruz IDE

Michael said Marshall Field has lots of native species, while Arboretum and YLR are highly invaded (2/16/22). That might explain the difference among those sites. 

In the following figures, left-right indicates different sites; top-bottom indicates mean or std dev of the community indexes.

### CTI ~ drought treatment

```{r scide-cti-drought, fig.cap="Community Temperature Index (CTI) statistics respond to drought treatments"}
plot_cwm_scide(cwm_tag = "mean_cti") +
  plot_cwm_scide(cwm_tag = "sd_cti") +
  plot_annotation(tag_levels = "A") +
  plot_layout(1, 2)
```

### CPI ~ drought treatment

```{r scide-cpi-drought, fig.cap="Community Precipitation Index (CPI) statistics respond to drought treatments"}
plot_cwm_scide(cwm_tag = "mean_cpi") +
  plot_cwm_scide(cwm_tag = "sd_cpi") +
  plot_annotation(tag_levels = "A") +
  plot_layout(1, 2)
```

### CVI ~ drought treatment
```{r scide-cvi-drought, fig.cap="Community VPD Index (CVI) statistics respond to drought treatments"}
plot_cwm_scide(cwm_tag = "mean_cvi") +
  plot_cwm_scide(cwm_tag = "sd_cvi") +
  plot_annotation(tag_levels = "A") +
  plot_layout(1, 2)
```

# Observational data

## Community change

### CTI ~ year

Community temperature niches change over years.

CTI community-level mean in several sites increases over years, suggesting communities are becoming "warmer," i.e., thermophilization.

```{r, fig.cap="Compare mean(CTI) across sites over years"}
obs_tbl %>%
  select(site, year, plot, com_idx = tmp_com_mean) %>%
  group_by(site) %>%
  nest() %>%
  mutate( # lm and p value
    p_val = map(data, ~ lm(com_idx ~ year, data = .)) %>%
      map_dbl(~ broom::glance(.) %>% pull(p.value))
  ) %>%
  unnest(cols = data) %>%
  ggplot(aes(year, com_idx)) +
  geom_boxplot(aes(group = year)) +
  geom_smooth( # add lm trend line when significant
    data = . %>% filter(p_val < 0.05),
    method = "lm", se = FALSE,
    color = "red"
  ) +
  facet_wrap(~site, scales = "free_y") +
  labs(
    x = "Year", y = "Community Temperature Index (CTI, °C)"
  )
```

CTI community-level standard deviation.

```{r, fig.cap="Compare sd(CTI) across sites over years"}
obs_tbl %>%
  mutate(com_idx = sqrt(tmp_com_var)) %>%
  select(site, year, plot, com_idx) %>%
  group_by(site) %>%
  nest() %>%
  mutate( # lm and p value
    p_val = map(data, ~ lm(com_idx ~ year, data = .)) %>%
      map_dbl(~ broom::glance(.) %>% pull(p.value))
  ) %>%
  unnest(cols = data) %>%
  ggplot(aes(year, com_idx)) +
  geom_boxplot(aes(group = year)) +
  geom_smooth( # add lm trend line when significant
    data = . %>% filter(p_val < 0.05),
    method = "lm", se = FALSE,
    color = "red"
  ) +
  facet_wrap(~site, scales = "free_y") +
  labs(
    x = "Year", y = "Community Temperature Index (CTI, °C)"
  )
```

### CPI ~ year

Community precipitation niches change over years.

CPI community-level mean in several sites decreases over years, suggesting communities are becoming "drier," i.e., mesophilization.

```{r, fig.cap="Compare mean(CPI) across sites over years"}
obs_tbl %>%
  select(site, year, plot, com_idx = ppt_com_mean) %>%
  group_by(site) %>%
  nest() %>%
  mutate( # lm and p value
    p_val = map(data, ~ lm(com_idx ~ year, data = .)) %>%
      map_dbl(~ broom::glance(.) %>% pull(p.value))
  ) %>%
  unnest(cols = data) %>%
  ggplot(aes(year, com_idx)) +
  geom_boxplot(aes(group = year)) +
  geom_smooth( # add lm trend line when significant
    data = . %>% filter(p_val < 0.05),
    method = "lm", se = FALSE,
    color = "red"
  ) +
  facet_wrap(~site, scales = "free_y") +
  labs(
    x = "Year", y = "Community Precipitation Index (CPI, mm)"
  )
```

CPI community-level standard deviation.

```{r, fig.cap="Compare sd(CPI) across sites over years"}
obs_tbl %>%
  mutate(com_idx = sqrt(ppt_com_var)) %>%
  select(site, year, plot, com_idx) %>%
  group_by(site) %>%
  nest() %>%
  mutate( # lm and p value
    p_val = map(data, ~ lm(com_idx ~ year, data = .)) %>%
      map_dbl(~ broom::glance(.) %>% pull(p.value))
  ) %>%
  unnest(cols = data) %>%
  ggplot(aes(year, com_idx)) +
  geom_boxplot(aes(group = year)) +
  geom_smooth( # add lm trend line when significant
    data = . %>% filter(p_val < 0.05),
    method = "lm", se = FALSE,
    color = "red"
  ) +
  facet_wrap(~site, scales = "free_y") +
  labs(
    x = "Year", y = "Community Precipitation Index (CPI, mm)"
  )
```

### CVI ~ year

Community VPDmax niches change over years.

CVI community-level mean in several sites changes over years, but no clear direction.

```{r, fig.cap="Compare mean(CVI) across sites over years"}
obs_tbl %>%
  select(site, year, plot, com_idx = vpd_com_mean) %>%
  group_by(site) %>%
  nest() %>%
  mutate( # lm and p value
    p_val = map(data, ~ lm(com_idx ~ year, data = .)) %>%
      map_dbl(~ broom::glance(.) %>% pull(p.value))
  ) %>%
  unnest(cols = data) %>%
  ggplot(aes(year, com_idx)) +
  geom_boxplot(aes(group = year)) +
  geom_smooth( # add lm trend line when significant
    data = . %>% filter(p_val < 0.05),
    method = "lm", se = FALSE,
    color = "red"
  ) +
  facet_wrap(~site, scales = "free_y") +
  labs(
    x = "Year", y = "Community VPDmax Index (CVI, Pa)"
  )
```

CVI community-level standard deviation.

```{r, fig.cap="Compare sd(CVI) across sites over years"}
obs_tbl %>%
  mutate(com_idx = sqrt(vpd_com_var)) %>%
  select(site, year, plot, com_idx) %>%
  group_by(site) %>%
  nest() %>%
  mutate( # lm and p value
    p_val = map(data, ~ lm(com_idx ~ year, data = .)) %>%
      map_dbl(~ broom::glance(.) %>% pull(p.value))
  ) %>%
  unnest(cols = data) %>%
  ggplot(aes(year, com_idx)) +
  geom_boxplot(aes(group = year)) +
  geom_smooth( # add lm trend line when significant
    data = . %>% filter(p_val < 0.05),
    method = "lm", se = FALSE,
    color = "red"
  ) +
  facet_wrap(~site, scales = "free_y") +
  labs(
    x = "Year", y = "Community VPDmax Index (CVI, Pa)"
  )
```

## Climate change

Observational site climate change over the study period.

```{r}
site_tbl <- read_rds("data/community/site-info.rds")
```

Download PRISM data (to be updated with Chelsa). Set PRISM dir first.

```{r}
prism::prism_set_dl_dir("data/climate/prism/")
```

Download (not run, only once).

```{r, eval=FALSE}
range(exp_tbl$year) # 1998:2021
range(obs_tbl$year) # 1983:2019
prism::get_prism_annual("tmean", years = 1983:2021, keepZip = FALSE)
prism::get_prism_annual("ppt", years = 1983:2021, keepZip = FALSE)
prism::get_prism_annual("vpdmax", years = 1983:2021, keepZip = FALSE)
```

Extract site climate from PRISM.

```{r}
site_tmp_tbl <- prism::prism_archive_subset(
  "tmean", "annual",
  years = 1983:2020
) %>%
  prism::pd_stack() %>%
  raster::extract(site_tbl) %>%
  bind_cols(site = site_tbl$abbr, .) %>%
  pivot_longer(-site, names_to = "year", values_to = "tmp") %>%
  mutate(year = year %>%
    str_sub(start = -8L, end = -5L) %>%
    as.integer())

site_ppt_tbl <- prism::prism_archive_subset(
  "ppt", "annual",
  years = 1983:2020
) %>%
  prism::pd_stack() %>%
  raster::extract(site_tbl) %>%
  bind_cols(site = site_tbl$abbr, .) %>%
  pivot_longer(-site, names_to = "year", values_to = "ppt") %>%
  mutate(year = year %>%
    str_sub(start = -8L, end = -5L) %>%
    as.integer())

site_vpd_tbl <- prism::prism_archive_subset(
  "vpdmax", "annual",
  years = 1983:2020
) %>%
  prism::pd_stack() %>%
  raster::extract(site_tbl) %>%
  bind_cols(site = site_tbl$abbr, .) %>%
  pivot_longer(-site, names_to = "year", values_to = "vpd") %>%
  mutate(year = year %>%
    str_sub(start = -8L, end = -5L) %>%
    as.integer())
```

Assemble site climate data.

```{r}
site_clim_tbl <- site_tmp_tbl %>%
  full_join(site_ppt_tbl, by = c("site", "year")) %>%
  full_join(site_vpd_tbl, by = c("site", "year")) %>%
  right_join(obs_tbl %>%
    distinct(site, year), by = c("site", "year")) %>%
  arrange(site, year)
```

Plot temperature change.

```{r, fig.cap="Observational site temperature change across years"}
site_clim_tbl %>%
  ggplot(aes(year, tmp)) +
  geom_point() +
  geom_smooth(
    method = "lm", se = FALSE,
    color = "red", lty = "dashed"
  ) +
  ggpubr::stat_cor(aes(label = ..p.label..),
    p.accuracy = 0.05,
    color = "red"
  ) +
  facet_wrap(~site, scales = "free_y") +
  labs(
    x = "Year", y = "Mean annual temperature (°C)"
  )
```

Plot precipitation change.

```{r, fig.cap="Observational site precipitation change across years"}
site_clim_tbl %>%
  ggplot(aes(year, ppt)) +
  geom_point() +
  geom_smooth(
    method = "lm", se = FALSE,
    color = "red", lty = "dashed"
  ) +
  ggpubr::stat_cor(aes(label = ..p.label..),
    p.accuracy = 0.05,
    color = "red"
  ) +
  facet_wrap(~site, scales = "free_y") +
  labs(
    x = "Year", y = "Mean annual precipitation (mm)"
  )
```

Plot VPDmax change.

```{r, fig.cap="Observational site VPDmax change across years"}
site_clim_tbl %>%
  ggplot(aes(year, vpd)) +
  geom_point() +
  geom_smooth(
    method = "lm", se = FALSE,
    color = "red", lty = "dashed"
  ) +
  ggpubr::stat_cor(aes(label = ..p.label..),
    p.accuracy = 0.05,
    color = "red"
  ) +
  facet_wrap(~site, scales = "free_y") +
  labs(
    x = "Year", y = "Mean VPDmax (hPa)"
  )
```

Remove intermediate objects.

```{r}
rm(site_clim_tbl, site_ppt_tbl, site_tbl, site_tmp_tbl, site_vpd_tbl)
rm(exp_file, exp_tbl, niche_file, niche_tbl, obs_file, obs_tbl)
```
