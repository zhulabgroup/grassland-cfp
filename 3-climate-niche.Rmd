---
title: "Climate niche estimation"
date: "`r format(Sys.time(), '%B %d, %Y')`"
editor_options: 
  chunk_output_type: console
output:
  bookdown::html_document2: 
    fig_caption: true
    number_sections: true
    global_numbering: true
  bookdown::word_document2: 
    fig_caption: true
    number_sections: true
    global_numbering: true
---

```{r setup, echo=FALSE, message=FALSE}
source("scripts/utils/setup.R")
```

# Get occurrence data

The first question is what the geographic extent that we search for occurrence records. Joise used the state of California for convenience, but it seems to make more sense using an ecological, not administrative, boundary. We thought about using NEON domains. After much discussion, we decided to use the [biodiversity hotspots](https://www.cepf.net/our-work/biodiversity-hotspots). The most relevant one is California Floristic Province (CFP). Study sites seem to distribute nicely across CFP. 

```{r site-info}
site_sf <- read_rds(.path$geo_site)
site_sf %>%
  as_tibble() %>% # drop geometry
  knitr::kable()
```

Make a map overlaying sites with CFP and admin boundaries from [Natural Earth](https://www.naturalearthdata.com/). 

```{r site-map, fig.cap="Site map"}
source("scripts/plot-site-map.R")
site_gg
rm(list = ls())
```

Compile two species tables. 

1. All the species from community data (experimental and observational).
1. Species consolidation table.

```{r all-species}
source("scripts/compile-all-species.R")
spp_consol_tbl %>%
  knitr::kable(caption = "Species consolidation table")
rm(list = ls())
```

## GBIF

First, extract occurrence data from GBIF, using the species list. The query output is an object of class `occdat`. Convert it to nested data, then unnest the data. Save GBIF occurrence data to a file. Second, consolidate species names in GBIF. Note that GBIF depends on download dates. So we'll keep the download file with date stamp.

```{r get-gbif, eval=FALSE}
source("scripts/get-gbif.R")
rm(list = ls())
```

## iNaturalist

We do not directly querying the data separately because:

1. it has a hard limit of 10,000 records;
1. it is very slow;
1. running too many queries per minute may be blocked.

Instead, we get massive data at once by using the dataset of research grade observations submitted weekly to GBIF, as [recommended](https://www.gbif.org/dataset/50c9509d-22c7-4a22-a47d-8c48425ef4a7).

```{r get-inat, eval=FALSE}
source("scripts/get-inat.R")
rm(list = ls())
```

## BIEN

Retrieve all BIEN data then select those within CFP. 

```{r get-bien, eval=FALSE}
source("scripts/get-bien.R")
rm(list = ls())
```

## eJepson (CCH)

eJepson might be more accurate compared to iNat and GBIF.

Download full dataset at https://www.cch2.org/portal/collections/harvestparams.php
(Searching within the bounding box of 55N-10N, 130W-50W.)

Keep records with species of interest and within CFP.

```{r get-cch, eval=FALSE}
source("scripts/get-cch.R")
rm(list = ls())
```

## Compare occurrence data sets

Compare the above data sets, in alphabetical order, BIEN, CCH, GBIF, iNat.

```{r compare-occ-data-tab}
source("scripts/compare-occ-data.R")
knitr::kable(occ_comp_tbl,
  caption = "Compare occurrence data samples in the study area."
)
```

```{r compare-occ-data-fig, fig.cap="Compare occurrence data samples in the study area."}
occ_comp_gg
rm(list = ls())
```

# Get climate data

## CHELSA

Download and process [CHELSA climatology data v2.1](https://chelsa-climate.org/downloads/). We used annual data of temperature and precipitation (see [metadata](https://chelsa-climate.org/bioclim/) below). Daily and monthly data are also available.

```{r, echo=FALSE}
tribble(
  ~shortname, ~longname, ~unit, ~scale, ~offset, ~explanation,
  "bio1", "mean annual air temperature", "°C", "0.1", "-273.15", "mean annual daily mean air temperatures averaged over 1 year",
  "bio12", "annual precipitation amount", "kg m^-2^ year^-1^", "0.1", "0", "accumulated precipitation amount over 1 year",
  "vpd_max", "max monthly vapor pressure deficit", "Pa", "0.1", "0", "the highest monthly vapor pressure deficit"
) %>%
  knitr::kable(caption = "CHELSA climatology data used in the project")
```

Note that precipitation unit, kg m^-2^ year^-1^, is equivalent to mm yr^-1^. 

```{r get-chelsa, eval=FALSE}
source("scripts/get-chelsa.R")
rm(list = ls())
```

## PRISM

Download and process PRISM using the *prism* package.

```{r get-prism, eval=FALSE}
source("scripts/get-prism.R")
rm(list = ls())
```

## TerraClimate

Manually download climatology data from the [website](http://thredds.northwestknowledge.net:8080/thredds/catalog/TERRACLIMATE_ALL/summaries/catalog.html). Calculate mean annual temperature, total annual precipitation, and maximum monthly vapor pressure deficit from monthly climatology.

```{r get-terraclimate, eval=FALSE}
source("scripts/get-terraclimate.R")
rm(list = ls())
```

## Extract climate data at occurrence sites and then compare

Use GBIF occurrence data longitude and latitude to extract site climate values from CHELSA and PRISM rasters.

```{r extract-climate, eval=FALSE}
source("scripts/load-climate-ras.R")
source("scripts/extract-climate-gbif.R")
rm(list = ls())
```

Compare CHELSA, PRISM, and TerraClimate data at GBIF occurrence locations, by making scatter plots with correlation. 

```{r compare-climate, fig.cap="Compare climate data from different sources."}
source("scripts/compare-clim-data.R")
tmp_gg / ppt_gg / vpd_gg
rm(list = ls())
```

# Estimate species climate niches

## Individual species

Visualize individual species occurrence in climate space.

```{r estimate-ind-spp, eval=FALSE}
source("scripts/estimate-ind-spp-niche.R")
# runtime ~= 4 min
pdf(.path$sum_niche_fig, width = 8, height = 8 * .618)
print(niche_gg)
dev.off()
```

## All species

Summarize species climate niches (mean, sd, etc.).

```{r summarize-all-spp}
source("scripts/estimate-all-spp-niche.R")
source("scripts/plot-all-spp-niche.R")
```

These different summary statistics (mean, median, upper, and lower quantiles) are highly and significantly correlated.

```{r fig.cap="Species temperature niche statistics (°C)"}
niche_tmp_gg
```

```{r fig.cap="Species precipitation niche statistics (mm)"}
niche_ppt_gg
```

```{r fig.cap="Species VPD max niche statistics (Pa)"}
niche_vpd_gg
```

Different dimensions of the niche space (temperature, precipitation, and VPD max) are also correlated (using mean as summary).

```{r fig.cap="Correlation of species niche dimensions"}
niche_dim_gg
```

With all the correlations, we can safely use the mean temperature and precipitation to visualize species niches in climate space. Note the strong negative correlation between temperature and precipitation (r = `r format(with(niche_tbl, cor(tmp_occ_mean, ppt_occ_mean)), digits = 3)`, p = `r format(with(niche_tbl, cor.test(tmp_occ_mean, ppt_occ_mean))$p.value, digits = 3)`).

```{r fig.cap="Species climate niches, with mean (point) and standard error (crossbar)"}
niche_tp_gg
```

```{r fig.cap="Same as last figure, interactive"}
niche_tp_gg %>%
  plotly::ggplotly(tooltip = "text")
```

Prepare to save niche estimates.

```{r}
niche_tbl <- niche_tbl %>%
  select(
    species, occ_n,
    tmp_occ_mean, tmp_occ_sd,
    tmp_occ_median, tmp_occ_q05, tmp_occ_q25, tmp_occ_q75, tmp_occ_q95,
    ppt_occ_mean, ppt_occ_sd,
    ppt_occ_median, ppt_occ_q05, ppt_occ_q25, ppt_occ_q75, ppt_occ_q95,
    vpd_occ_mean, vpd_occ_sd,
    vpd_occ_median, vpd_occ_q05, vpd_occ_q25, vpd_occ_q75, vpd_occ_q95
  )
```

Create dummy species, append to niche estimates, and save.

```{r}
Avena_tbl <- niche_tbl %>%
  filter(species %in% c(
    "Avena barbata",
    "Avena fatua"
  )) %>%
  summarize(across(-c(species:occ_n), mean))

Festuca_tbl <- niche_tbl %>%
  filter(species %in% c(
    "Festuca bromoides",
    "Festuca perennis"
  )) %>%
  summarize(across(-c(species:occ_n), mean))

Hypochaeris_tbl <- niche_tbl %>%
  filter(species %in% c(
    "Hypochaeris glabra",
    "Hypochaeris radicata"
  )) %>%
  summarize(across(-c(species:occ_n), mean))

Raphanus_tbl <- niche_tbl %>%
  filter(species %in% c(
    "Raphanus sativus",
    "Raphanus raphanistrum" # this species doesn't exist from GBIF download
  )) %>%
  summarize(across(-c(species:occ_n), mean))

niche_tbl %>%
  add_row(species = "Avena DUMMY", occ_n = NA, Avena_tbl) %>%
  add_row(species = "Festuca DUMMY", occ_n = NA, Festuca_tbl) %>%
  add_row(species = "Hypochaeris DUMMY", occ_n = NA, Hypochaeris_tbl) %>%
  add_row(species = "Raphanus DUMMY", occ_n = NA, Raphanus_tbl) %>%
  write_rds(.path$sum_niche)
```

Remove intermediate objects.

```{r}
rm(Avena_tbl, Festuca_tbl, Hypochaeris_tbl, niche_tbl, Raphanus_tbl)
rm(cfp_sf, spp_tbl)
rm(clim_file, gbif_file)
```

## Spatial thinning occurrence records

Spatial thinning GBIF-CHELSA data to validate climate niche estimates, using the **spThin** package.

Reference:
Aiello-Lammens, Matthew E., Robert A. Boria, Aleksandar Radosavljevic, Bruno Vilela, and Robert P. Anderson. “SpThin: An R Package for Spatial Thinning of Species Occurrence Records for Use in Ecological Niche Models.” Ecography 38, no. 5 (2015): 541–45. https://doi.org/10.1111/ecog.01132.

```{r, eval=FALSE}
# run time = 22 min
occ_clim_sf <- read_rds(clim_file) %>%
  sf::st_as_sf()

occ_clim_tbl <- sf::st_coordinates(occ_clim_sf) %>%
  as_tibble() %>%
  bind_cols(occ_clim_sf) %>%
  select(lat = Y, lon = X, key, species, tmp = chelsa_tmp, ppt = chelsa_ppt)

# species climate summary for full dataset
sp_sum_tbl <- occ_clim_tbl %>%
  group_by(species) %>%
  summarize(
    tmp_mean_full = mean(tmp), ppt_mean_full = mean(ppt),
    tmp_median_full = median(tmp), ppt_median_full = median(ppt)
  ) %>%
  arrange(species)

sp_thin_tbl <- tibble()

set.seed(31416)

for (i in seq_along(sp_sum_tbl$species)) {
  # subset species
  sp <- sp_sum_tbl$species[i]
  print(sp)
  loc_full_tbl <- occ_clim_tbl %>%
    filter(species == sp)

  # thin data
  loc_thin_ls <- spThin::thin(
    loc.data = loc_full_tbl,
    lat.col = "lat",
    long.col = "lon",
    spec.col = "species",
    thin.par = 10, # distance in km that records to be separated by
    reps = 1,
    locs.thinned.list.return = TRUE,
    write.files = FALSE,
    write.log.file = FALSE
  )

  # summarize climate
  sp_thin_tbl <- loc_full_tbl[row.names(loc_thin_ls[[1]]), ] %>%
    summarize(
      tmp_mean_thin = mean(tmp), ppt_mean_thin = mean(ppt),
      tmp_median_thin = median(tmp), ppt_median_thin = median(ppt)
    ) %>%
    bind_cols(species = sp, .) %>%
    bind_rows(sp_thin_tbl, .)
}

sp_sum_tbl %>%
  full_join(sp_thin_tbl, by = "species") %>%
  write_rds("data/occurrence/niche-estimates-cfp-2022-09-18-thin.rds")

rm(loc_full_tbl, loc_thin_ls, occ_clim_sf, occ_clim_tbl, sp_sum_tbl, sp_thin_tbl)
rm(clim_file, i, sp)
```

Post-thinning analysis.

```{r}
thin_file <- "data/occurrence/niche-estimates-cfp-2022-09-18-thin.rds"
thin_tbl <- read_rds(thin_file)
```

The comparison shows full vs. thinned niche estimates are very similar.

```{r fig.cap="Species temperature niche statistics (°C)"}
thin_tbl %>%
  select(
    tmp_mean_full, tmp_mean_thin,
    tmp_median_full, tmp_median_thin
  ) %>%
  GGally::ggpairs(
    title = "Species temperature niche (°C)",
    columnLabels = c("Full mean", "Thinned mean", "Full median", "Thinned median")
  )
```

```{r fig.cap="Species precipitation niche statistics (mm)"}
thin_tbl %>%
  select(
    ppt_mean_full, ppt_mean_thin,
    ppt_median_full, ppt_median_thin
  ) %>%
  GGally::ggpairs(
    title = "Species precipitation niche (mm)",
    columnLabels = c("Full mean", "Thinned mean", "Full median", "Thinned median")
  )
```

```{r}
rm(thin_file, thin_tbl)
```
