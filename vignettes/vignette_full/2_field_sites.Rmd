---
title: "2 Field sites"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{my-vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_knit$set(root.dir = here::here()) # knit from project directory
knitr::opts_chunk$set(
  collapse = TRUE,
  out.width = "100%",
  cache = T,
  comment = "#>"
)
```

```{r setup}
library(grassland)
theme_set(ggthemes::theme_few())
```

Tidy up and correct community composition data (experimental and observational).
```{r, eval=F}
path_community_tidy <- tidy_community_data()
```

```{r}
dat_community_tidy <- read_community(version = "tidy")
```

```{r}
read_site_info() %>% knitr::kable() # perhaps make extdata
```

```{r}
df_data_avail <- summ_data_avail(dat_community, type = "long")
gg_data_avail <- plot_data_availability(df_data_avail)
gg_data_avail
```
```{r}
df_data_avail_obs <- summ_data_avail(dat_community, type = "short", subset = "obs")
```

We compiled `r df_data_avail_obs %>% pull(nyear) %>% min()` - `r df_data_avail_obs %>% pull(nyear) %>% max()` yr observational data from 12 sites with `r df_data_avail_obs %>% pull(nyear) %>% sum()` total site years.

```{r}
sf_site_obs <- read_site_info(subset = "obs")
dat_clim <- read_climate()
df_summ_site_latlon <- summ_site_obs(sf_site = sf_site_obs, dat_clim = dat_clim$chelsa, type = "latlon")
df_summ_site_clim <- summ_site_obs(sf_site = sf_site_obs, dat_clim = dat_clim$chelsa, type = "climate")
summ_site_hull <- summ_site_obs(sf_site = sf_site_obs, dat_clim = dat_clim$chelsa, type = "hull")
```


These observational sites spanned a large geographical area (`r df_summ_site_latlon$lon_max %>% signif(3) %>% abs()` - `r df_summ_site_latlon$lon_min %>% signif(3) %>% abs()` °W, `r df_summ_site_latlon$lat_min %>% signif(3) %>% abs()` - `r df_summ_site_latlon$lat_max %>% signif(3) %>% abs()` °N) and climate gradient (`r df_summ_site_clim$tmp_min %>% signif(3)`  - `r df_summ_site_clim$tmp_max %>% signif(3)` °C temperature, `r df_summ_site_clim$ppt_min %>% signif(3)` - `r df_summ_site_clim$ppt_max %>% signif(3)` mm precipitation).

These observational sites spanned an approximately `r summ_site_hull %>% signif(1) %>% format(big.mark = ",")` km^2 geographical area.

```{r, eval = F}
path_climate_site_annual <- calc_climate_annual_site()
```

```{r}
dat_clim_site <- read_climate_site()
df_cc_site <- calc_climate_change_site(dat_clim_site = dat_clim_site)
df_cc_site %>% knitr::kable()
df_summ_site_cc <- summ_site_climate_change(df_cc_site = df_cc_site)
gg_site_cc <- plot_site_climate_change(dat_clim_site = dat_clim_site, dat_avail = df_data_avail)
```

The mean warming rate (increasing mean annual temperature per year) was `r df_summ_site_cc %>% filter(clim_var == "tmp") %>% pull(mean) %>% signif(3)` °C yr^-1^, ranging from `r df_summ_site_cc %>% filter(clim_var == "tmp") %>% pull(min) %>% signif(3)` °C yr^-1^ to `r df_summ_site_cc %>% filter(clim_var == "tmp") %>% pull(max)  %>% signif(3)` °C yr^-1^; the mean drying trend (decreasing total annual precipitation per year) was `r df_summ_site_cc %>% filter(clim_var == "ppt") %>% pull(mean) %>% signif(3) %>% abs()` mm yr^-1^, ranging from `r df_summ_site_cc %>% filter(clim_var == "ppt") %>% pull(max) %>% signif(3) %>% abs()` mm yr^-1^ to `r df_summ_site_cc %>% filter(clim_var == "ppt") %>% pull(min) %>% signif(3) %>% abs()` mm yr^-1^.

Info on experimental site
```{r}
df_data_avail_exp <- summ_data_avail(dat_community, type = "long", subset = "exp")

df_jrgce_env <- read_jrgce_env()
df_summ_jrgce_env <- summ_jrgce_env(df_env = df_jrgce_env)
```

The experiment occupied ~0.75 ha within a 5-ha grassland stand and experienced a large variation of plot-level temperature (`r df_summ_jrgce_env %>% filter(var=="tmp") %>% pull(min) %>% signif(3)` - `r df_summ_jrgce_env %>% filter(var=="tmp") %>% pull(max) %>% signif(3)` °C) and precipitation (`r df_summ_jrgce_env %>% filter(var=="ppt") %>% pull(min) %>% signif(3)` - `r df_summ_jrgce_env %>% filter(var=="ppt") %>% pull(max) %>% signif(3)` mm) in `r df_data_avail_exp %>% filter(str_detect(sitename, "Jasper")) %>% pull(count) %>% sum()` total plot years.

Output figures and r data files
```{r, eval = F}
save_figure(out = list(data_avail = gg_data_avail, site_cc = gg_site_cc))
save_extdata(out = list("alldata/input/climate/Environment.csv"))
```
