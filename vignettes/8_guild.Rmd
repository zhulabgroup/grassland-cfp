---
title: "8 Guild"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{8 Guild}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_knit$set(root.dir = here::here()) # knit from project directory
knitr::opts_chunk$set(
  collapse = TRUE,
  out.width = "100%",
  cache = T,
  comment = "#>",
  fig.width = 8,
  fig.height = 8,
  dpi = 300
)
```

```{r setup, cache = F, message = F}
library(grassland)
theme_set(ggthemes::theme_few())
```

In the main analysis, we characterized community composition in the climate space. Previous studies often use species guilds, such as examining changes in grass and forb dominance, and have yielded inconsistent observations and experimental results. For comparison, we examined community compositional shifts characterized by species guilds. We used three common classifications for species guilds: their origin (native vs. non-native), life history (annual vs. perennial), or functional groups (grass vs. forb).

## Summarizing percentages of guilds

```{r}
dat_guild <- tidy_guild(dat_community, niche = F)
dat_guild %>%
  filter(!str_detect(species, "DUMMY")) %>%
  group_by(group, guild) %>%
  summarise(n = n())

dat_guild_niche <- tidy_guild(dat_community, dat_niche, niche = T)
dat_guild_niche %>%
  filter(!str_detect(species, "DUMMY")) %>%
  group_by(group, guild) %>%
  summarise(n = n(), occ_n = sum(occ_n))
```

## Compare species niches by guild

We first compared the climate niches of species of different guilds using permutational multivariate analysis of variance (PERMANOVA).

```{r}
dat_guild_niche <- tidy_guild(dat_community, dat_niche)
gg_guild_niche <- plot_guild_niche(dat_guild_niche = dat_guild_niche)
gg_guild_niche
res_guild_niche <- test_guild_niche(dat_guild_niche = dat_guild_niche)
res_guild_niche
```
Comparison of species climate niches of different species guilds in terms of (A) origin, (B) life history, and (C) functional group. Red Gaussian ellipses show the 95% confidence interval of the climate niche of each species guild. The climate niches are not significantly different when comparing species of different origins or species of different functional groups (permutational multivariate analysis of variance, PERMANOVA, p > 0.05) but were significantly different when comparing species with different life histories (p d 0.001), with annual species associated with hotter and drier locations compared to perennial species.

## Analyze community shift with guild

```{r}
dat_community$obs %>%
  mutate(
    native = str_sub(guild, 1, 1)
  ) %>%
  select(-guild) %>%
  group_by(abbr = site) %>%
  summarise(
    native_perc = sum(abund * (native == "N")) / sum(abund)
  ) %>%
  ungroup() %>%
  mutate(nonnative_perc = 1 - native_perc)
```

Similar to the analysis of changes in CTI and CPI, we then examined the relative abundance of species of specific guilds at the 12 observational sites and the JRGCE warming experiment, by fitting linear regressions with the percentages of natives, annuals, and grasses as response variables and year as the predictor.

Plot guild percentage change over time from observational and experimental data.

```{r}
(gg_guild_percentage_obs <- plot_guild_percentage(option = "obs", dat_community = dat_community))

(gg_guild_percentage_exp <- plot_guild_percentage(option = "exp", dat_community = dat_community))
```
Grassland communities had inconsistent compositional changes in species origin (measured by the percentage of natives), life history (measured by the percentage of annuals), and functional group (measured by the percentage of grasses) in 12 long-term observational sites across the California Floristic Province and in the Jasper Ridge Global Change Experiment.

Output figures and R data files.

```{r, eval = F}
save_figure(out = list(
  guild_niche = gg_guild_niche,
  guild_perc_obs = gg_guild_percentage_obs,
  guild_perc_exp = gg_guild_percentage_exp
))
```
