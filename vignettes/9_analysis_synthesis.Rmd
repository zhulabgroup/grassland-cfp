---
title: "9 Analysis and synthesis"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{9 Analysis and synthesis}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_knit$set(root.dir = here::here()) # knit from project directory
knitr::opts_chunk$set(
  collapse = TRUE,
  out.width = "100%",
  cache = T,
  comment = "#>",
  fig.width = 8,
  fig.height = 8
)
```

```{r setup, cache = F}
library(grassland)
theme_set(ggthemes::theme_few())
```

Analyze individual species contributing to CTI-CPI change.

```{r, eval=F}
dat_gainloss <- calc_species_gainloss(dat_community = dat_community, dat_niche = dat_niche)
# need to output to csv
```

```{r}
gg_species_change <- plot_species_gainloss(dat_niche = dat_niche, dat_gainloss = dat_gainloss)
gg_species_change$combined
```

```{r}
df_summ_species_change_obs <- summ_species_change(dat_gainloss, option = "obs")
df_summ_species_change_exp <- summ_species_change(dat_gainloss, option = "exp")
```

Across the observations, species gained in communities by significantly increasing abundance over time (e.g., _`r df_summ_species_change_obs %>% filter(change == "increase") %>% pull(species)`_) or recruitment (appeared only after the 5th yr, e.g., _`r df_summ_species_change_obs %>% filter(change == "new") %>% pull(species)`_); in contrast, species lost from communities by significantly decreasing abundance over time (e.g., _`r df_summ_species_change_obs %>% filter(change == "decrease") %>% pull(species)`_) or extirpation (disappeared in the last 5 yr, e.g., _`r df_summ_species_change_obs %>% filter(change == "lost") %>% pull(species)`_). In the experiment, species did not experience complete turnover, but some gained by being more abundant (e.g., _`r df_summ_species_change_exp %>% filter(change == "increase") %>% pull(species)`_), while some lost by being less abundant (e.g., _`r df_summ_species_change_exp %>% filter(change == "decrease") %>% pull(species)`_) in warming compared to ambient plots.

Compare species rank abundance in observational communities over years and experimental communities across treatments. Test for difference in evenness in observational and experimental communities.

```{r}
dat_rank <- calc_rank_abundance(dat_community = dat_community)

dat_evenness <- calc_evenness(dat_community = dat_community)
df_evenness_summ <- test_evenness_change(dat_evenness = dat_evenness)
df_evenness_summ

gg_rank_abundance <- plot_rank_abundance(dat_rank = dat_rank, df_evenness_summ = df_evenness_summ)
gg_rank_abundance$obs
gg_rank_abundance$exp
```

Due to the high correlation of species temperature and precipitation niches, CTI and CPI shifts at the community level appear highly coupled. Synthesize the coupled CTI-CPI shifts, both visually and numerically.

```{r, eval = F}
dat_shift <- calc_community_shift(dat_index = dat_index)
```

```{r}
gg_community_shift <- plot_community_shift(dat_shift, dat_niche)
gg_community_shift$combined
```

```{r}
df_summ_shift_coupling <- summ_shift_coupling(dat_shift)
df_summ_shift_coupling
```

A community thermophilization of 0.1 °C corresponded to a xerophilization of `r df_summ_shift_coupling %>% filter(ratio == "cpi_to_cti") %>% filter(group == "Observation") %>% pull(median) %>% signif(3) %>% abs()` mm from the observations and `r df_summ_shift_coupling %>% filter(ratio == "cpi_to_cti") %>% filter(group == "Experiment") %>% pull(median) %>% signif(3) %>% abs()` mm from the experiment. Likewise, a community xerophilization of 10 mm corresponded to a thermophilization of `r df_summ_shift_coupling %>% filter(ratio == "cti_to_cpi") %>% filter(group == "Observation") %>% pull(median) %>% signif(3) %>% abs()` °C from the observations and `r df_summ_shift_coupling %>% filter(ratio == "cti_to_cpi") %>% filter(group == "Experiment") %>% pull(median) %>% signif(3) %>% abs()` °C from the experiment.

Output figures and R data files.

```{r, eval = F}
save_figure(out = list(
  species_change = gg_species_change$combined,
  species_change_obs = gg_species_change$obs$circle_detail,
  species_change_exp = gg_species_change$exp$circle_detail,
  rank_abund_obs = gg_rank_abundance$obs,
  rank_abund_exp = gg_rank_abundance$exp,
  community_shift = gg_community_shift$combined
))

save_table(out = list(
  gainloss = dat_gainloss %>% tidy_table_gainloss()
))

save_rda(out = list(dat_gainloss, dat_shift))
```
