---
title: "4 Species niche"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{4 Species niche}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_knit$set(root.dir = here::here()) # knit from project directory
knitr::opts_chunk$set(
  collapse = TRUE,
  out.width = "100%",
  cache = T,
  comment = "#>",
  fig.width = 8,
  fig.height = 8
)
```

```{r setup, cache = F}
library(grassland)
theme_set(ggthemes::theme_few())
```

Download biogeography (occurrence) data from four sources: BIEN, CCH, GBIF, iNat.

```{r, eval=F}
spp_tbl <- tidy_taxonomy_consolidate(dat_community = dat_community)
path_occ <- down_biogeography(species_table = spp_tbl) # needs parallel computation
dat_occ_full <- read_biogeography(path_occ = path_occ, gbif_only = F)
dat_occ <- read_biogeography(path_occ = path_occ, gbif_only = T)
```

```{r}
dat_occ_full <- read_biogeography(gbif_only = F)
gg_biogeography <- plot_biogeography(dat_occ_full)
gg_biogeography
```

```{r}
df_summ_occ <- summ_biogeography(dat_occ = dat_occ_full)
df_summ_occ %>% knitr::kable()
```

We retrieved `r df_summ_occ %>% filter(source == "gbif") %>% pull(n_occ)` occurrence records of `r df_summ_occ %>% filter(source == "gbif") %>% pull(n_sp)` species in the CFP from the Global Biodiversity Information Facility (GBIF).

Calculate and summarize species climate niches.

```{r, eval = F}
dat_clim <- read_climate()
path_trait <- calc_individual_trait(dat_occ, dat_clim, occ_source = "gbif", clim_source = "chelsa")
dat_trait <- read_individual_trait(path_trait = path_trait)
```

```{r}
dat_niche <- calc_species_niche(dat_trait, add_dummy = T)
df_summ_niche <- summ_species_niche(dat_niche = dat_niche)
```

Among all the `r df_summ_niche$n` species with more than 100 GBIF records, their average temperatures ranging from `r df_summ_niche$tmp_min %>% signif(3) %>% format(big.mark = ",")` 째C to `r df_summ_niche$tmp_max %>% signif(3) %>% format(big.mark = ",")` 째C, and their average precipitations ranging from `r df_summ_niche$ppt_min %>% signif(3) %>% format(big.mark = ",")` mm to `r df_summ_niche$ppt_max %>% signif(3) %>% format(big.mark = ",")` mm.

Plot and summarize two example species geographic distributions and climate niches.

```{r}
gg_individual_trait_species_niche_cool <- plot_individual_trait_species_niche_ind_sp(dat_occ, dat_trait, sp = "Danthonia californica")
gg_individual_trait_species_niche_cool
gg_individual_trait_species_niche_warm <- plot_individual_trait_species_niche_ind_sp(dat_occ, dat_trait, sp = "Stipa pulchra")
gg_individual_trait_species_niche_warm
```

```{r}
df_summ_niche_cool <- summ_species_niche(dat_niche = dat_niche, sp = "Danthonia californica")
df_summ_niche_warm <- summ_species_niche(dat_niche = dat_niche, sp = "Stipa pulchra")
```

_Danthonia californica_ had `r df_summ_niche_cool$n_occ` records, with temperature of `r df_summ_niche_cool$tmp_median %>% signif(3) %>% format(big.mark = ",")` (`r df_summ_niche_cool$tmp_lower %>% signif(3) %>% format(big.mark = ",")` -`r df_summ_niche_cool$tmp_upper %>% signif(3) %>% format(big.mark = ",")` )째C and precipitation of `r df_summ_niche_cool$ppt_median %>% signif(3) %>% format(big.mark = ",")` (`r df_summ_niche_cool$ppt_lower %>% signif(3) %>% format(big.mark = ",")`-`r df_summ_niche_cool$ppt_upper %>% signif(3) %>% format(big.mark = ",")`) mm, whereas _Stipa pulchra_ had `r df_summ_niche_warm$n_occ` records, with temperature of `r df_summ_niche_warm$tmp_median %>% signif(3) %>% format(big.mark = ",")` (`r df_summ_niche_warm$tmp_lower %>% signif(3) %>% format(big.mark = ",")` -`r df_summ_niche_warm$tmp_upper %>% signif(3) %>% format(big.mark = ",")` )째C and precipitation of `r df_summ_niche_warm$ppt_median %>% signif(3) %>% format(big.mark = ",")` (`r df_summ_niche_warm$ppt_lower %>% signif(3) %>% format(big.mark = ",")`-`r df_summ_niche_warm$ppt_upper %>% signif(3) %>% format(big.mark = ",")`) mm.

Plot all species climate niches.

```{r, eval = F}
path_gg_trait <- plot_individual_trait_species_niche_ind_sp_all(dat_occ, dat_trait, dat_niche)
```

```{r, eval = F}
gg_niche <- plot_individual_trait_species_niche_all(dat_occ, dat_trait, dat_niche, frac = 1)
gg_niche$sp_niche
```

```{r}
gg_niche <- plot_individual_trait_species_niche_all(dat_occ, dat_trait, dat_niche, frac = 0)
gg_niche$sp_niche
```

Calculate all species climate niches temperature and precipitation correlation.

```{r}
mod_species_niche_cor <- test_species_niche(dat_niche = dat_niche)
mod_species_niche_cor
```

Across all the species, the temperature and precipitation averages were negatively and significantly correlated (Pearson's correlation _r_ = `r mod_species_niche_cor$estimate`).

Compare climate associated with species occurrence from different data sources.

```{r, eval = F}
path_trait_chelsa <- calc_individual_trait(dat_occ, dat_clim, occ_source = "gbif", clim_source = "chelsa")
path_trait_prism <- calc_individual_trait(dat_occ, dat_clim, occ_source = "gbif", clim_source = "prism")
path_trait_terraclim <- calc_individual_trait(dat_occ, dat_clim, occ_source = "gbif", clim_source = "terraclim")
```

```{r}
dat_trait_chelsa <- read_individual_trait(path_trait = "alldata/intermediate/climate-niche/gbif-chelsa.rds")
dat_trait_prism <- read_individual_trait(path_trait = "alldata/intermediate/climate-niche/gbif-prism.rds")
dat_trait_terraclim <- read_individual_trait(path_trait = "alldata/intermediate/climate-niche/gbif-terraclim.rds")
gg_climate_source <- plot_climate_source(dat_trait_chelsa, dat_trait_prism, dat_trait_terraclim)
gg_climate_source
```

Compare estimates of species climate niche using different bioclim variables.

```{r, eval = F}
path_trait_bioclim <- calc_individual_trait(dat_occ, dat_clim, occ_source = "gbif", clim_source = "chelsa", allbioclim = T)
```

```{r}
dat_trait_bioclim <- read_individual_trait(path_trait = "alldata/intermediate/climate-niche/gbif-chelsa_full.rds")
gg_bioclim_tmp <- plot_bioclim(dat_trait_bioclim, var = "tmp")
gg_bioclim_tmp
gg_bioclim_ppt <- plot_bioclim(dat_trait_bioclim, var = "ppt")
gg_bioclim_ppt
```

Compare estimates of species climate niche using different summary statistics.

```{r}
gg_niche_stat_tmp <- plot_niche_stat(dat_niche, var = "tmp")
gg_niche_stat_tmp
gg_niche_stat_ppt <- plot_niche_stat(dat_niche, var = "ppt")
gg_niche_stat_ppt
```

Compare estimates of species climate niche by spatial thinning occurrence records.

```{r, eval = F}
path_occ_thin <- cal_thin_occ(dat_occ = dat_occ$gbif, dat_trait = dat_trait, option = "spatial", num_cores = 4) # slow
```

```{r}
dat_trait_thin <- calc_trait_thin(path_occ_thin = NULL, dat_trait, option = "spatial")
```
After spatial thinning, `r nrow(dat_trait)` records were reduced to `r nrow(dat_trait_thin)` records.

```{r}
dat_niche_thin <- calc_species_niche(dat_trait_thin, add_dummy = T)
gg_niche_thin <- plot_niche_subset(dat_niche, dat_niche_thin)
gg_niche_thin
```

Compare estimates of species climate niche by climate thinning occurrence records.
```{r, eval = F}
path_occ_thin_clim <- cal_thin_occ(dat_occ = dat_occ$gbif, dat_trait = dat_trait, option = "climate", num_cores = 4) # slow
```

```{r}
dat_trait_thin_clim <- calc_trait_thin(path_occ_thin = NULL, dat_trait, option = "climate")
```
After climate thinning, `r nrow(dat_trait)` records were reduced to `r nrow(dat_trait_thin_clim)` records.

```{r}
dat_niche_thin_clim <- calc_species_niche(dat_trait_thin_clim, add_dummy = T)
gg_niche_thin_clim <- plot_niche_subset(dat_niche, dat_niche_thin_clim)
gg_niche_thin_clim
```

Get early GBIF data from 1961 to 1990.
```{r, eval=F}
spp_tbl <- tidy_taxonomy_consolidate(dat_community = dat_community)
path_occ_early <- down_biogeography(species_table = spp_tbl, start_year = 1961, end_year = 1990, postfix = "early", gbif_only = T) # needs parallel computation
dat_occ_early <- read_biogeography(path_occ_early, gbif_only = T)
```

Calculate and summarize species climate niches from early GBIF data.

```{r, eval = F}
dat_clim <- read_climate()
path_trait_early <- calc_individual_trait(dat_occ_early, dat_clim, occ_source = "gbif", clim_source = "chelsa", postfix = "early")
dat_trait_early <- read_individual_trait(path_trait = path_trait_early)
```
We obtained `r nrow(dat_trait_early)` records of `r dat_trait_early %>% pull(species) %>% unique() %>% length()` species from early GBIF data, compared to `r nrow(dat_trait)` total records.

```{r}
dat_niche_early <- calc_species_niche(dat_trait_early, add_dummy = T)
gg_niche_early <- plot_niche_subset(dat_niche, dat_niche_early, type = "early")
gg_niche_early
```

Output figures and R data files.

```{r, eval = F}
save_figure(out = list(
  biogeography = gg_biogeography,
  niche = gg_niche$combined,
  niche_cool = gg_individual_trait_species_niche_cool,
  niche_warm = gg_individual_trait_species_niche_warm,
  clim_source = gg_climate_source,
  bioclim_tmp = gg_bioclim_tmp,
  bioclim_ppt = gg_bioclim_ppt,
  niche_stat_tmp = gg_niche_stat_tmp,
  niche_stat_ppt = gg_niche_stat_ppt,
  niche_thin = gg_niche_thin
  niche_thin_clim = gg_niche_thin_clim,
  niche_early = gg_niche_early
))

save_table(out = list(
  niche = dat_niche %>% tidy_table_niche()
))

save_rda(out = list(dat_occ, dat_trait, dat_niche))
```
