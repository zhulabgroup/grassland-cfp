---
title: "5 Community shift"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{5 Community shift}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_knit$set(root.dir = here::here()) # knit from project directory
knitr::opts_chunk$set(
  collapse = TRUE,
  out.width = "100%",
  cache = T,
  comment = "#>",
  fig.width = 8,
  fig.height = 8,
  dpi = 300
)
```

```{r setup, cache = F, message = F}
library(grassland)
theme_set(ggthemes::theme_few())
```

Statistically test species climate trait (temperature or precipitation) change using weighted LM or LME.

```{r}
df_trait_change_obs <- test_trait_change_all(dat_community, dat_niche, option = "obs")
df_trait_change_obs %>%
  mutate(
    estimate = estimate %>% signif(3) %>% round(6),
    std.error = std.error %>% signif(3) %>% round(6),
    p.value = p.value %>% round(4)
  ) %>%
  knitr::kable()
df_trait_change_exp <- test_trait_change_all(dat_community, dat_niche, option = "exp")
df_trait_change_exp %>%
  mutate(
    estimate = estimate %>% signif(3) %>% round(6),
    std.error = std.error %>% signif(3) %>% round(6),
    p.value = p.value %>% round(4)
  ) %>%
  knitr::kable()
df_summ_trait_change_obs <- summ_change(df_trait_change_obs, option = "obs")
```

Overall, the 12 observational sites had significant increases in temperature trait (`r df_trait_change_obs %>% filter(site == "all") %>% filter(trait == "tmp") %>% pull(estimate) %>% signif(3)` °C yr^-1^) and significant decreases in precipitation trait (`r df_trait_change_obs %>% filter(site == "all") %>% filter(trait == "ppt") %>% pull(estimate) %>% signif(3)` mm yr^-1^) over the years. 

By site, `r df_summ_trait_change_obs %>% pull(n_sig) %>% min()` out of the 12 sites had significant increases in temperature trait and significant decreases in precipitation trait over the years. Among all 12 sites, the temperature traits increases at a rate ranging from `r df_summ_trait_change_obs %>% filter(trait == "tmp") %>% pull(min) %>% signif(3)` °C yr^-1^ to `r df_summ_trait_change_obs %>% filter(trait == "tmp") %>% pull(max) %>% signif(3)` °C yr^-1^; the precipitation trait decreases at a rate ranging from `r df_summ_trait_change_obs %>% filter(trait == "ppt") %>% pull(max) %>% signif(3)` mm yr^-1^ to `r df_summ_trait_change_obs %>% filter(trait == "ppt") %>% pull(min) %>% signif(3)` mm yr^-1^.

Comparing warming plots to ambient plots, pooling data from all years in each phase, no significant difference was detected in Phase I or II, whereas Phase III exhibited a significant increase in temperature trait of `r df_trait_change_exp %>% filter(exp == "jrgce", grp == "Phase III") %>% filter(trait == "tmp") %>% pull(estimate) %>% signif(3)` °C and a significant decrease in precipitation trait of `r df_trait_change_exp %>% filter(exp == "jrgce", grp == "Phase III") %>% filter(trait == "ppt") %>% pull(estimate)` mm.

Plot the above comparisons and tests.

```{r}
gg_trait_change_obs <- plot_trait_change(option = "obs", dat_community, dat_niche)
gg_trait_change_obs
gg_trait_change_exp <- plot_trait_change(option = "exp", dat_community, dat_niche)
gg_trait_change_exp
```

Scaling up from the individual species to the community, we can calculate Community Temperature Index (CTI) and Community Precipitation Index (CPI). CTI (or CPI) are species temperature (or precipitaion) weighted by their relative abundance in any community. For location $i$, species $j$, denote species abundance (point intercept or percent cover) as $A_{ij}$, and species temperature and precipitaion niche as $T_j$ and $P_j$. The CTI and CPI are defined as follows.

$$
\mathrm{CTI}_i = \mathrm{E}[T]_i = \frac{\sum_j A_{ij}T_j}{\sum_j A_{ij}},\\
\mathrm{CPI}_i = \mathrm{E}[P]_i = \frac{\sum_j A_{ij}P_j}{\sum_j A_{ij}}.
$$

Calculate CTI-CPI in observational and experimental communities.

```{r, eval = F}
dat_index <- calc_community_index(dat_niche = dat_niche, dat_community = dat_community)
usethis::use_data(dat_index, overwrite = T)
```

Statistically test CTI and CPI changes using LM or LME.

```{r}
df_index_change_obs <- test_index_change_all(dat_index, option = "obs")
df_index_change_obs %>%
  mutate(
    estimate = estimate %>% signif(3),
    std.error = std.error %>% signif(3),
    p.value = p.value %>% round(4)
  ) %>%
  knitr::kable()
df_index_change_exp <- test_index_change_all(dat_index, option = "exp")
df_index_change_exp %>%
  mutate(
    estimate = estimate %>% signif(3),
    std.error = std.error %>% signif(3),
    p.value = p.value %>% round(4)
  ) %>%
  knitr::kable()
df_summ_index_change_obs <- summ_change(df_index_change_obs, option = "obs")
```

Overall, the 12 observational sites had significant thermophilization (increases in CTI) (`r df_index_change_obs %>% filter(site == "all") %>% filter(index == "cti") %>% pull(estimate) %>% signif(3)` °C yr^-1^) and significant xerophilization (decreases in CPI) (`r df_index_change_obs %>% filter(site == "all") %>% filter(index == "cpi") %>% pull(estimate) %>% signif(3)` mm yr^-1^) over the years. 

By site, `r df_summ_index_change_obs %>% pull(n_sig) %>% min()` out of the 12 sites had significant increases in CTI and significant decreases in CPI over the years. Among all 12 sites, the mean thermophilization rate (increasing CTI per year) ranged from `r df_summ_index_change_obs %>% filter(index == "cti") %>% pull(min) %>% signif(3)` °C yr^-1^ to `r df_summ_index_change_obs %>% filter(index == "cti") %>% pull(max) %>% signif(3)` °C yr^-1^; the mean xerophilization rate (decreasing CPI per year) ranged from `r df_summ_index_change_obs %>% filter(index == "cpi") %>% pull(max) %>% signif(3)` mm yr^-1^ to `r df_summ_index_change_obs %>% filter(index == "cpi") %>% pull(min) %>% signif(3)` mm yr^-1^.

Comparing warming plots to ambient plots, pooling data from all years in each phase, no significant difference was detected in Phase I or II, whereas Phase III exhibited a significant thermophilization (increase in CTI) of `r df_index_change_exp %>% filter(exp == "jrgce", grp == "Phase III") %>% filter(index == "cti") %>% pull(estimate) %>% signif(3)` °C and a significant decrease in precipitation trait of `r df_index_change_exp %>% filter(exp == "jrgce", grp == "Phase III") %>% filter(index == "cpi") %>% pull(estimate) %>% signif(3)` mm.

Plot the above comparisons and tests.

```{r}
gg_community_index_obs <- plot_community_index(option = "obs", dat_index = dat_index)
gg_community_index_obs
gg_community_index_exp <- plot_community_index(option = "exp", dat_index = dat_index, experiment = "jrgce", treatment = "warming")
gg_community_index_exp
```

Output figures and R data files.

```{r, eval = F}
save_figure(out = list(
  trait_change_obs = gg_trait_change_obs,
  trait_change_exp = gg_trait_change_exp,
  community_index_obs = gg_community_index_obs,
  community_index_exp = gg_community_index_exp
))
```
