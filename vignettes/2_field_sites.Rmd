---
title: "2 Field sites"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{2 Field sites}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_knit$set(root.dir = here::here()) # knit from project directory
knitr::opts_chunk$set(
  collapse = TRUE,
  out.width = "100%",
  cache = T,
  comment = "#>",
  fig.width = 8,
  fig.height = 8,
  dpi = 300
)
```

```{r setup, cache = F, message = F}
library(grassland)
theme_set(ggthemes::theme_few())
```

Tidy up and correct community composition data (experimental and observational).

```{r, eval=F}
path_community_tidy <- tidy_community_data()
```

```{r}
dat_community_tidy <- read_community(version = "tidy")
```

Read site information.

```{r}
read_site_info() %>% knitr::kable()
gg_site_map <- plot_site_map()
gg_site_map
```

Visualize data availability across sites.

```{r}
df_data_avail <- summ_data_avail(dat_community, type = "long")
gg_data_avail <- plot_data_availability(df_data_avail)
gg_data_avail
```

```{r}
df_data_avail_obs <- summ_data_avail(dat_community, type = "short", subset = "obs")
```

We compiled `r df_data_avail_obs %>% pull(nyear) %>% min()` - `r df_data_avail_obs %>% pull(nyear) %>% max()` yr observational data from 12 sites with `r df_data_avail_obs %>% pull(nyear) %>% sum()` total site years.

Summarize the geographic and climatic extents of the study sites.

```{r}
sf_site_obs <- read_site_info(subset = "obs")
dat_clim <- read_climate()
df_summ_site_latlon <- summ_site_obs(sf_site = sf_site_obs, dat_clim = dat_clim$chelsa, type = "latlon")
df_summ_site_clim <- summ_site_obs(sf_site = sf_site_obs, dat_clim = dat_clim$chelsa, type = "climate")
summ_site_hull <- summ_site_obs(sf_site = sf_site_obs, dat_clim = dat_clim$chelsa, type = "hull")
```

These observational sites spanned a large geographical area (`r df_summ_site_latlon$lon_max %>% signif(3) %>% abs()` - `r df_summ_site_latlon$lon_min %>% signif(3) %>% abs()` °W, `r df_summ_site_latlon$lat_min %>% signif(3) %>% abs()` - `r df_summ_site_latlon$lat_max %>% signif(3) %>% abs()` °N) and climate gradient (`r df_summ_site_clim$tmp_min %>% signif(3)`  - `r df_summ_site_clim$tmp_max %>% signif(3)` °C temperature, `r df_summ_site_clim$ppt_min %>% signif(3)` - `r df_summ_site_clim$ppt_max %>% signif(3)` mm precipitation).

These observational sites spanned an approximately `r summ_site_hull %>% signif(1) %>% format(big.mark = ",")` km^2^ geographical area.

```{r, eval = F}
path_climate_site_annual <- calc_climate_annual_site()
```

Calculate and summarize climate change at these observational sites.

```{r}
dat_clim_site <- read_climate_site()
df_cc_site <- calc_climate_change_site(dat_clim_site = dat_clim_site)
df_cc_site %>%
  mutate(
    estimate = estimate %>% signif(3),
    std.error = std.error %>% signif(3),
    p.value = p.value %>% round(4)
  ) %>%
  knitr::kable()
df_summ_site_cc <- summ_change(df_change = df_cc_site, option = "obs")
df_summ_site_cc

gg_site_cc <- plot_site_climate_change(dat_clim_site = dat_clim_site, dat_avail = df_data_avail)
gg_site_cc
gg_site_cc_landsc <- plot_site_climate_change(dat_clim_site = dat_clim_site, dat_avail = df_data_avail, layout = "landsc")
```

Overall, the 12 observational sites had significant warming (`r df_cc_site %>% filter(site == "all") %>% filter(clim_var == "tmp") %>% pull(estimate) %>% signif(3)` °C yr^-1^) and significant drying (`r df_cc_site %>% filter(site == "all") %>% filter(clim_var == "ppt") %>% pull(estimate) %>% signif(3) %>% magrittr::multiply_by(-1)` mm yr^-1^) over the years. 

By site, `r df_summ_site_cc %>% filter(clim_var == "tmp") %>% pull(n_sig)` out of the 12 sites had significant warming and `r df_summ_site_cc %>% filter(clim_var == "ppt") %>% pull(n_sig)` had significant drying over the years. Among all 12 sites, the warming rate ranged from `r df_summ_site_cc %>% filter(clim_var == "tmp") %>% pull(min) %>% signif(3)` °C yr^-1^ to `r df_summ_site_cc %>% filter(clim_var == "tmp") %>% pull(max) %>% signif(3)` °C yr^-1^; the drying rate ranged from `r df_summ_site_cc %>% filter(clim_var == "tmp") %>% pull(max) %>% signif(3) %>% magrittr::multiply_by(-1)` mm yr^-1^ to `r df_summ_site_cc %>% filter(clim_var == "ppt") %>% pull(min) %>% signif(3) %>% magrittr::multiply_by(-1)` mm yr^-1^.

Likewise, summarize climate information at the experimental site.

```{r}
df_data_avail_exp <- summ_data_avail(dat_community, type = "long", subset = "exp")
df_jrgce_env <- read_jrgce_env()
df_summ_jrgce_env <- summ_jrgce_env(df_env = df_jrgce_env)
```

The experiment occupied ~0.75 ha within a 5-ha grassland stand and experienced a large variation of plot-level temperature (`r df_summ_jrgce_env %>% filter(var=="tmp") %>% pull(min) %>% signif(3)` - `r df_summ_jrgce_env %>% filter(var=="tmp") %>% pull(max) %>% signif(3)` °C) and precipitation (`r df_summ_jrgce_env %>% filter(var=="ppt") %>% pull(min) %>% signif(3)` - `r df_summ_jrgce_env %>% filter(var=="ppt") %>% pull(max) %>% signif(3)` mm) in `r df_data_avail_exp %>% filter(str_detect(sitename, "Jasper")) %>% pull(count) %>% sum()` total plot years.

Output figures and R data files.

```{r, eval = F}
save_figure(out = list(
  site_map = gg_site_map,
  data_avail = gg_data_avail,
  site_cc = gg_site_cc,
  site_cc_landsc = gg_site_cc_landsc
))

save_extdata(out = list("alldata/input/basemap/site_info.csv"))
```
