# Preliminary analyses

Setup and load packages

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
```

```{r}
library(tidyverse)
library(patchwork)
library(plotly)
```

## Observational data

The objectives are

1. Replicate Josie's key results on CTI change
1. Compare with site-level climate change

First, get community climate indexes: community temperature index (CTI) and community precipitation index (CPI).

Modified from Josie's code `Com_MajorAnalyses.Rmd` section `# Changes in wCTI over time`.

```{r}
cci_dat <- read_csv("archives/CAGrasslandCommunityChange-master/Analysis/CTI Data/AllSite_CTI_08_2020.csv") %>%
  select(-`...1`) %>%
  filter(
    species.name != "Linanthus jepsonii",
    species.name != "Linanthus latisectus",
    relcov >= 0
  )
```

Explore species climate niches estimated from [GBIF](https://www.gbif.org/) occurrence data by Josie. Note the strong negative correlation between mean temp and precip. Warmer locations are associated with drier locations? I talked with Greg and he agreed this is true in California--both geography (north-south) and elevation. The figure is interactive--Karen and Michael, can you hover your mouse to see if the data points and species names make sense?

Update: Karen said it would be helpful to plot native vs. exotic species. I found Josie had a column "guild" with some codes: `r unique(cci_dat$guild)`. From Josie's code `ComComp Data Cleanup/Data_CleanupOnly.Rmd` lines 697-699, it looks like the 1st letter is **N**ative vs. **E**xotic, the 2nd letter is **A**nnual vs. **P**erennial, and the 3rd letter is lifeform **G**rass vs. **F**orb (but what are other characters?). So I extracted the 1st letter and recoded them into native vs. exotic. Karan and Michael, you can click the guild names on the legend to turn data points on and off.

```{r, fig.cap = "Species climate niches estimated from GBIF by Josie"}
(cci_dat %>%
  select(spnm = species.name, guild, tmp = meanT, ppt = meanp) %>%
  distinct() %>%
  mutate(nat_ext = str_sub(guild, 1, 1) %>%
    factor(levels = c("N", "E"), labels = c("Native", "Exotic"))) %>%
  ggplot(aes(tmp, ppt,
    color = nat_ext,
    text = spnm
  )) +
  geom_point(alpha = .5) +
  # geom_smooth(method = "lm", aes(tmp, ppt)) +
  labs(
    color = "Species",
    x = "Species occurrence mean temperature (degC)",
    y = "Species occurrence mean precipitation (mm)"
  ) +
  scale_color_manual(values = c("black", "red"))
) %>%
  ggplotly(tooltip = "text")
```

Get plot-level and site-level summaries.

```{r, fig.cap="Replicate Josie's Figure CTI"}
cci_plot_sum <- cci_dat %>%
  group_by(site, plot, year) %>%
  mutate(
    relCTI = relcov * meanT,
    relCPI = relcov * meanp
  ) %>%
  summarise(
    plotCTI = sum(relCTI),
    plotCPI = sum(relCPI)
  ) %>%
  arrange(site, plot, year)

cci_site_sum <- cci_plot_sum %>% # from plot summary, can redo using indiviual obs
  group_by(site, year) %>%
  summarise(
    meanCTI = mean(plotCTI),
    seCTI = plotrix::std.error(plotCTI),
    meanCPI = mean(plotCPI),
    seCPI = plotrix::std.error(plotCPI)
  )

cci_site_gg <- ggplot(cci_site_sum, aes(
  x = year,
  y = meanCTI, ymin = meanCTI - seCTI, ymax = meanCTI + seCTI
)) +
  geom_pointrange() +
  geom_line() +
  facet_wrap(~site, scales = "free", nrow = 2)

cci_site_gg +
  labs(
    x = "Year",
    y = "Community Temperature Index (CTI, degC)"
  )
```

Note that the goal was to replicate Josie's manuscript Figure CTI. The data look right, but sites seem to be mislabeled. 

Then, get site climate data. Modified from Josie's code `Com_MajorAnalyses.Rmd` subsection `## CTI vs actual temp`.

```{r, fig.cap="Replicate Josie's Figure weather"}
clim_dat <- read_csv("archives/CAGrasslandCommunityChange-master/Analysis/ClimData/PRISM_wtryr_alldata.csv") %>%
  select(-`...1`)

clim_site_sum <- cci_dat %>%
  distinct(site, year) %>%
  left_join(clim_dat, by = c("site" = "site", "year" = "wateryear")) %>%
  mutate(grow_meanT = (grow_minT + grow_maxT) / 2) # grow_meanT is highly correlated with mean_meanT

clim_site_gg <- clim_site_sum %>%
  ggplot(aes(x = year, y = grow_meanT)) + # ymin = grow_minT, ymax = grow_maxT
  geom_point() +
  geom_line() +
  facet_wrap(~site, scales = "free", nrow = 2)

clim_site_gg +
  labs(
    x = "Year",
    y = "Growing season temperature (degC)"
  )
```

Note that the goal was to replicate Josie's manuscript Figure weather and Table weather models. It looks right to me (no mislabel).

Finally, combine climate change and community change. 

Time-series plots of site-level climate change and site-level community climate index change.

```{r, fig.cap="Compare long-term climate change vs. community change summarized by CTI", fig.height=10}
(clim_site_gg +
  geom_smooth(method = "lm") +
  labs(title = "(a) Climate change", x = "", y = "Growing season temperature (degC)")) /
  (cci_site_gg +
    geom_smooth(method = "lm") +
    labs(title = "(b) Community change", x = "Year", y = "Community Temperature Index (CTI, degC)"))
```

I think the comparison looks very interesting. Climate change seems to drive community composition change.

Directly compare site-level climate values to community climate index seems less intuitive. 

```{r, fig.cap="Compare site average temperature vs. CTI"}
clim_site_sum %>%
  full_join(cci_site_sum, by = c("site", "year")) %>%
  ggplot(aes(
    x = grow_meanT,
    y = meanCTI, ymin = meanCTI - seCTI, ymax = meanCTI + seCTI
  )) +
  geom_pointrange() +
  facet_wrap(~site, scales = "free", nrow = 2) +
  geom_smooth(method = "lm") +
  labs(
    x = "Growing season temperature (degC)",
    y = "Community Temperature Index (CTI, degC)"
  )
```

## Experimental data

Analyze JRGCE functional group data

![Jasper Ridge Global Change Experiment (JRGCE)](images/jasperridge.jpg)

The objectives are 

1. Look at species composition change over 17 yr
1. Compare species composition from ambient vs. elevated plots using the above community-level summary approach

First, get JRGCE data.

- Species abundance data: biomass, pin counts, presence/absence survey
- Species information: species code and name
- Treatment information: plot and treatment combinations

```{r}
# community abundance data
attach("~/Data/archives/JRGCE/Input/Biomass/FG/All abundance and environment.rdata")
com_dat <- abund.dat %>% ungroup()
detach()

# species information
spp_dat <- read_csv("~/Data/archives/JRGCE/Input/Biomass/CSV/Species.csv")

# treatment information
trt_dat <- read_csv("~/Data/archives/JRGCE/Input/Biomass/NPP/Submission/Treatment.csv")
```

Then, match JGRCE species to Josie's species with CTI/CPI.

```{r}
sp_jrgce <- spp_dat %>%
  select(spcd = SPECIES_CODE, spnm = `Species or unit name`) %>%
  arrange(spnm)

cci_dat <- read_csv("archives/CAGrasslandCommunityChange-master/Analysis/CTI Data/AllSite_CTI_08_2020.csv") %>%
  select(-`...1`) %>%
  filter(
    species.name != "Linanthus jepsonii",
    species.name != "Linanthus latisectus",
    relcov >= 0
  ) %>%
  select(spnm = species.name, tmp = meanT, ppt = meanp) %>%
  distinct(spnm, tmp, ppt) %>%
  arrange(spnm) %>%
  inner_join(sp_jrgce, by = "spnm") %>%
  select(spcd, spnm, tmp, ppt)
```

Check those species climate niches. Again, strong negative correlation.

```{r, fig.cap="Species climate niches for a subset of species in Jasper Ridge"}
cci_dat %>%
  ggplot(aes(tmp, ppt)) +
  geom_point(alpha = .5) +
  geom_smooth(method = "lm") +
  labs(
    x = "Species occurrence mean temperature (degC)",
    y = "Species occurrence mean precipitation (mm)"
  )
```

Assign community-level temp/precip to plots.

```{r}
# assign community-level temp/precip to plots
cci_jrgce_dat <- com_dat %>%
  select(yr, plt, spcd = sp, bio, pin, pa1, pa2) %>%
  inner_join(cci_dat, by = "spcd") %>%
  group_by(yr, plt) %>%
  summarize(
    bio_tmp = sum(bio * tmp) / sum(bio),
    bio_ppt = sum(bio * ppt) / sum(bio),
    pin_tmp = sum(pin * tmp) / sum(pin),
    pin_ppt = sum(pin * ppt) / sum(pin)
  ) %>%
  left_join(trt_dat, by = c("yr", "plt"))
```

Compare CTI from ambient vs. elevated temp plots, with all the other treatments at the ambient conditions. We can use either biomass as the weight or pin count as the weight. Greg said pin count is more commonly used to reflect community composition. 

Their CTI are similar in the beginning and then diverge (warming plots have warmer species) later.

```{r, fig.cap="Compare CTI in ambient vs. elevated warming treatments over years"}
cci_jrgce_dat %>%
  mutate(tmp = factor(tmp, 0:1, c("Ambient", "Elevated"))) %>%
  filter(ppt == 0, co2 == 0, ntg == 0) %>%
  drop_na() %>% # a few plots have no estimates, due to missing species niche info
  ggplot(aes(yr, pin_tmp, col = tmp, group = tmp)) +
  geom_point(alpha = .5) +
  geom_smooth() +
  labs(
    x = "Year", y = "Community Temperature Index (CTI, degC)",
    color = "Warming treatment"
  ) +
  scale_color_manual(values = c("black", "red"))
```

Boxplots to compare both treatment effects and long-term (year) effects.

```{r, fig.cap="Compare CTI in ambient vs. elevated warming treatments over years"}
cci_jrgce_dat %>%
  mutate(
    tmp = factor(tmp, 0:1, c("Ambient", "Elevated")),
    yr = as.factor(yr)
  ) %>%
  filter(ppt == 0, co2 == 0, ntg == 0) %>%
  drop_na() %>%
  ggplot(aes(yr, pin_tmp, col = tmp, group = interaction(tmp, yr))) +
  geom_boxplot() +
  labs(
    x = "Year", y = "Community Temperature Index (CTI, degC)",
    color = "Warming treatment"
  ) +
  scale_color_manual(values = c("black", "red"))
```

Likewise, we can compare precipitation treatment (elevated means adding water). Note this is not a drought experiment. Plots with added water have species like high precip.

```{r, fig.cap="Compare CPI in ambient vs. elevated adding water treatments over years"}
cci_jrgce_dat %>%
  mutate(ppt = factor(ppt, 0:1, c("Ambient", "Elevated"))) %>%
  filter(tmp == 0, co2 == 0, ntg == 0) %>%
  drop_na() %>% # a few plots have no estimates, due to missing species niche info
  ggplot(aes(yr, pin_ppt, col = ppt, group = ppt)) +
  geom_point(alpha = .5) +
  geom_smooth() +
  labs(
    x = "Year", y = "Community Precipitation Index (CPI, mm)",
    color = "Add-water treatment"
  ) +
  scale_color_manual(values = c("black", "blue"))
```

Boxplots to compare both treatment effects and long-term (year) effects.

```{r, fig.cap="Compare CPI in ambient vs. elevated adding water treatments over years"}
cci_jrgce_dat %>%
  mutate(
    ppt = factor(ppt, 0:1, c("Ambient", "Elevated")),
    yr = as.factor(yr)
  ) %>%
  filter(tmp == 0, co2 == 0, ntg == 0) %>%
  drop_na() %>%
  ggplot(aes(yr, pin_ppt, col = ppt, group = interaction(ppt, yr))) +
  geom_boxplot() +
  labs(
    x = "Year", y = "Community Precipitation Index (CPI, mm)",
    color = "Add-water treatment"
  ) +
  scale_color_manual(values = c("black", "blue"))
```
