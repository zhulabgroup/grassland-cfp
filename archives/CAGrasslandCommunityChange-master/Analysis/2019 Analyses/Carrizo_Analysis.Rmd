---
title: "Carrizo Analysis"
author: "Josie Lesage"
date: "12/11/2019"
output: html_document
---

# Setup and data import
```{r setup, include=FALSE}
## community analysis
library(codyn)
library(MASS)
library(vegan)
library(lme4)

## CTI analysis
library(CoordinateCleaner)
library(countrycode)
library(mapr)
library(maptools)
library(raster)
library(rgbif)
library(scrubr)
library(sp)
library(spocc)

## misc/both/other
library(oz)
library(plotrix)
library(tidyverse)
```


```{r data import, include = FALSE}
car_data <- read.csv("carrizo_data.csv") 
```

The goal for this project is to successfully download species occurance location data from GBIF for the species in the Swanton plots, and to associate this location data with climate data from the WorldClim database. Additionally, I hope to do any cleaning that's needed between these steps before I can generate a community temperature index for the site over time.


## Preparing a species list table
In order to get the appropriate data from gbif, we need to generate a table of species/genus information that we can reference and call from.

```{r species table}
car_species <- unique(car_data$species.name)
car_list <- as.data.frame(car_species)

car_list$car_species <- paste0("'", car_list$car_species, "',")
  
cat(format_delim(car_list, delim = ""))

```

There are a total of ~70 species in the Carrizo dataset, some of which are sub-species, and others of which as genera or physical features (holes, moss, etc).


```{r fixing species table}
car_data <- car_data %>%
  filter(species.name != "litter",
         species.name != "bare",
         species.name != "hole",
         species.name != "moss")

car_data_rel <- car_data %>%
  select(year, Plot, species.name, Intercepts) %>%
  distinct(year, Plot, species.name, .keep_all = TRUE) %>%
  group_by(Plot, year) %>%
  mutate(sumintercept = sum(Intercepts),
         relcov = Intercepts/sumintercept)
```

**Note:** there are instances of "bromus sp." and "rumex spp." in the dataset. I am not sure if I should remove this one hit, or leave it be. It's probably bromus hordeaceus - but no way to know for sure. 


# Community Poisson GLM

**Look at chapter 14 of the Mixed Models book.**

Before running our analysis, we should check the means and variance for the response variable over different predictor variables. 

```{r Rich explore}
car_rich_means <- car_data_rel %>%
  group_by(year, Plot) %>%
  summarise(rich = n_distinct(species.name)) %>%
  ungroup() %>% group_by(year) %>%
  summarise(meanrich = mean(rich),
            serich = (std.error(rich)))

car_rich <- car_data_rel %>%
  group_by(year, Plot) %>%
  summarise(meanrich = n_distinct(species.name))

ggplot(car_rich, aes(x = year, y = meanrich)) +
  geom_point() 

```


# Community turnover - annual +/-
To answer who joins and who leaves each year, we need to calculate the species in the starting year, then see how many are added and how many leave. We'll do this with Lauren Hallet's (hopefully awesome) codyn package - which has a function for turnover.

```{r turnover metrics}
car_turnover <- turnover(df = car_data_rel,
                          time.var = "year",
                          species.var = "species.name",
                          abundance.var = "Intercepts",
                          replicate.var = "Plot")

car_test <- car_data %>%
  filter(year == 2014,
         Plot == 1104)

swan_turn_means <- swan_turnover %>%
  group_by(year) %>%
  summarise(meanturn = mean(total),
            seturn = std.error(total))

ggplot(swan_turn_means, aes(x = year, y = meanturn)) +
  geom_point() +
  geom_errorbar(aes(ymin = meanturn-seturn, ymax = meanturn+seturn)) +
  labs(title = "Swanton - Community Turnover (n = 3)",
       x = "Year",
       y = "Turnover (# spp. lost+gained / total # spp.)")

```


# Gathering & cleaning occurance data

We will gather species occurrance data from GBIF through the SpOcc package. 

```{r grabbing gbif data, echo = FALSE, cache = TRUE, warning=FALSE}
## look at species list made in 'fixing table' section above

car_genus_list <- c('Delphenium',
                     'Allium',
                     'Astragalus')

car_species_list <- c('Bromus madritensis ssp rubens', 
                       'Schismus arabicus',
                       'Hordeum murinum',
                       'Erodium cicutarium',
                       'Vulpia microstachys v pauciflora',
                       'Vulpia myuros v hirsuta',
                       'Lepidium nitidum',
                       'Tropidocarpum gracile',
                       'Trifolium gracilentum',
                       'Guillenia lasiophylla',
                       'Dichelostemma capitatum',
                       'Amsinckia tessellata',
                       'Calandrinia ciliata',
                       'Phlox gracilis',
                       'Lasthenia californica',
                       'Bromus hordeaceus',
                       'Athysanus pusillus',
                       'Sisymbrium irio',
                       'Poa secunda ssp secunda',
                       'Pectocarya penicillata',
                       'Lotus wrangelianus',
                       'Monolopia lanceolata',
                       'Microseris elegans',
                       'Microseris douglasii',
                       'Malacothrix coulteri',
                       'Lasthenia minor',
                       'Eriogonum gracillimum',
                       'Lupinus microcarpus v microcarpus',
                       'Trichostema lanceolatum',
                       'Trifolium albopurpureum',
                       'Amsinckia menziesii',
                       'Descurainia sophia',
                       'Capsella bursa-pastoris',
                       'Astragalus didymocarpus',
                       'Salsola tragus',
                       'Astragalus oxyphysus',
                       'Lepidium dictyotum',
                       'Astragalus lentiginosus v nigricalycis',
                       'Phacelia ciliata',
                       'Amsinckia menziesii v intermedia',
                       'Monolopia congdonii',
                       'Marrubium vulgare',
                       'Hollisteria lanata',
                       'Herniaria hirsuta ssp. cinerea',
                       'Plagiobothrys canescens',
                       'Linanthus liniflorus',
                       'Castilleja exserta',
                       'Chorizanthe uniaristata',
                       'Chorizanthe watsonii',
                       'Lupinus bicolor',
                       'Uropappus lindleyi',
                       'Vulpia bromoides',
                       'Chaenactis glabriuscula v glabriuscula',
                       'Lastarriaea coriacea',
                       'Camissonia campestris',
                       'Plantago erecta',
                       'Muilla maritima',
                       'Lactuca serriola',
                       'Lasthenia glabrata ssp coulteri',
                       'Camissonia palmeri',
                       'Crassula connata',
                       'Eremocarpus setigerus',
                       'Castilleja lineariloba',
                       'Stephanomeria pauciflora',
                       'Delphinium recurvatum')

car_species_data <- occ(query = car_species_list, from = "gbif", has_coords = TRUE, limit = 10000,
                gbifopts = list(hasGeospatialIssue = FALSE, country = "US",
                                stateProvince = "California"))

```

We need to clean the coordinates, as it appears some are in the ocean (look @ NorCal), and there might be some that are just incorrect. To do this, we will use a coordinate cleaner package.

```{r cleaning jasper coords, echo=FALSE, cache = TRUE, dependson="grabbing jasper gbif data"}
## we can also replace all synonym taxon names with one (cuts down the number of plotted dot colors)
## we should use the scrubr version of the function in the future
car_species_data <- fixnames(car_species_data, how = "query")

## The occ2df function should convert the data to a dataframe format
car_species_data_df <- occ2df(car_species_data)

map_ggplot(car_species_data, map = "state", size = 0.5) 

## flagging incorrect coordinates
flags <- clean_coordinates(x = car_species_data_df, lon = "longitude", lat = "latitude",
                          species = "name",
                          tests = c("capitals", "centroids", "equal","gbif", "institutions",
                                    "seas", "zeros")) # most test are on by default


## examining the flags
plot(flags, lon = "longitude", lat = "latitude")
flag_df <- car_species_data_df[!flags$.summary,]
str(flag_df)
summary(flag_df)

# keep only the non-flagged data
car_species_data_df <- car_species_data_df[flags$.summary,]

```
Most of our flagged coordinates are coastal/in the ocean. Therefore, we'll remove them from our database after taking a look at which ones (~1350 out of 15,300, so ~8.8%) were flagged.  

It appears that there were flagged instances for most of the species. For this practice run-through, I'll definitely just cut them out without taking a closer look (for now).  
More guidance on cleaning datasets and removing bad coordinates is [available here](https://ropensci.github.io/CoordinateCleaner/articles/Tutorial_Cleaning_GBIF_data_with_CoordinateCleaner.html).  

# Adding climate data

Following the jcoliver webpage guides...

```{r map of geo extent, echo = FALSE}
max.lat <- ceiling(max(car_species_data_df$latitude))
min.lat <- floor(min(car_species_data_df$latitude))
max.lon <- ceiling(max(car_species_data_df$longitude))
min.lon <- floor(min(car_species_data_df$longitude))
geographic.extent <- extent(x = c(min.lon, max.lon, min.lat, max.lat))

# Load the data to use for our base map
data(wrld_simpl)

# Plot the base map
plot(wrld_simpl, 
     xlim = c(min.lon, max.lon),
     ylim = c(min.lat, max.lat),
     axes = TRUE, 
     col = "grey95")

# Add the points for individual observation
points(x = car_species_data_df$longitude, 
       y = car_species_data_df$latitude, 
       col = "olivedrab", 
       pch = 20, 
       cex = 0.75)
# And draw a little box around the graph
box()
```

```{r based on oikos page, cache = TRUE}
xy <- car_species_data_df[,c("longitude","latitude")]
sp_xy <- car_species_data_df[c("name", "longitude","latitude")]

sp_xy <- sp_xy %>%
  rename(species = name)

env <- getData('worldclim', var='bio', res=2.5)

plot(env, 1, main=NULL, axes=FALSE)
points(xy, col='blue', pch=20)

xy_bio <- raster::extract(env, xy)

```

Reference list for climate variables:
 * BIO1 = Annual Mean Temperature (°C * 10) -- (i.e. 231 represents 23.1 °C)
 * BIO2 = Mean Diurnal Range (Mean of monthly (max temp – min temp)) 
 * BIO3 = Isothermality (BIO2/BIO7) (* 100)
 * BIO4 = Temperature Seasonality (standard deviation *100)
 * BIO5 = Max Temperature of Warmest Month (°C * 10)
 * BIO6 = Min Temperature of Coldest Month (°C * 10)
 * BIO7 = Temperature Annual Range (BIO5-BIO6)
 * BIO8 = Mean Temperature of Wettest Quarter (°C * 10)
 * BIO9 = Mean Temperature of Driest Quarter (°C * 10)
 * BIO10 = Mean Temperature of Warmest Quarter (°C * 10)
 * BIO11 = Mean Temperature of Coldest Quarter (°C * 10)
 * BIO12 = Annual Precipitation (mm)
 * BIO13 = Precipitation of Wettest Month (mm)
 * BIO14 = Precipitation of Driest Month (mm)
 * BIO15 = Precipitation Seasonality (Coeficent of Variation) 
 * BIO16 = Precipitation of Wettest Quarter (mm)
 * BIO17 = Precipitation of Driest Quarter (mm)
 * BIO18 = Precipitation of Warmest Quarter (mm)
 * BIO19 = Precipitation of Coldest Quarter (mm)
 
```{r mean species temp, echo=FALSE}
car_species_clim <- cbind(xy_bio, sp_xy)

car_species_clim <- car_species_clim %>%
  group_by(species) %>%
  summarise(meant = mean(bio1, na.rm = TRUE),
         meanp = mean(bio12, na.rm = TRUE)) %>%
  mutate(meanT = meant/10) %>%
  rename(species.name = species) 
          
```


### Delphinium
```{r Carrizo Delphinium}
car_delpinium <- c('Delphinium gypsophilum',
                    'Delphinium patens',
                    'Delphinium parryi',
                    'Delphinium recurvatum')

car_delpinium_data <- occ(query = jasp_trifolium, from = "gbif", has_coords = TRUE, limit = 10000,
                gbifopts = list(hasGeospatialIssue = FALSE, country = "US",
                                stateProvince = "California"))

## we can also replace all synonym taxon names with one (cuts down the number of plotted dot colors)
## we should use the scrubr version of the function in the future
car_delpinium_data <- fixnames(car_delpinium_data, how = "query")

## The occ2df function should convert the data to a dataframe format
car_delpinium_data_df <- occ2df(car_delpinium_data)

map_ggplot(car_delpinium_data, map = "state", size = 0.5) 

flags <- clean_coordinates(x = car_delpinium_data_df, lon = "longitude", lat = "latitude",
                          species = "name",
                          tests = c("capitals", "centroids", "equal","gbif", "institutions",
                                    "seas", "zeros")) # most test are on by default

# remove flagged records
car_delpinium_data_df <- car_delpinium_data_df[flags$.summary,]

# extract lat/long for each datapoint
xy <- car_delpinium_data_df[,c("longitude","latitude")]
sp_xy <- car_delpinium_data_df[c("name", "longitude","latitude")]
sp_xy <- sp_xy %>%
  rename(species = name)
env <- getData('worldclim', var='bio', res=2.5)
plot(env, 1, main=NULL, axes=FALSE)
points(xy, col='blue', pch=20)
xy_bio <- raster::extract(env, xy)
car_delpinium_clim <- cbind(xy_bio, sp_xy)

# change all datapoints to the "species sp" format that's used in the og dataframe, calc CTI
car_delpinium_clim <- car_delpinium_clim %>%
  mutate(species.name = "Delphenium sp.") %>%
   group_by(species.name) %>%
   summarise(meant = mean(bio1, na.rm = TRUE),
         meanp = mean(bio12, na.rm = TRUE)) %>%
  mutate(meanT = meant/10) 
```

### Allium
```{r Carrizo Allium}
car_allium <- c('Allium lacunosum',
                   'Allium peninsulare',
                   'Allium crispum',
                   'Allium fimbriatum',
                   'Allium howellii')

car_allium_data <- occ(query = car_allium, from = "gbif", has_coords = TRUE, limit = 10000,
                gbifopts = list(hasGeospatialIssue = FALSE, country = "US",
                                stateProvince = "California"))

## we can also replace all synonym taxon names with one (cuts down the number of plotted dot colors)
## we should use the scrubr version of the function in the future
car_allium_data <- fixnames(car_allium_data, how = "query")

## The occ2df function should convert the data to a dataframe format
car_allium_data_df <- occ2df(car_allium_data)

map_ggplot(car_allium_data, map = "state", size = 0.5) 

flags <- clean_coordinates(x = car_allium_data_df, lon = "longitude", lat = "latitude",
                          species = "name",
                          tests = c("capitals", "centroids", "equal","gbif", "institutions",
                                    "seas", "zeros")) # most test are on by default

# remove flagged records
car_allium_data_df <- car_allium_data_df[flags$.summary,]

# extract lat/long for each datapoint
xy <- car_allium_data_df[,c("longitude","latitude")]
sp_xy <- car_allium_data_df[c("name", "longitude","latitude")]
sp_xy <- sp_xy %>%
  rename(species = name)
env <- getData('worldclim', var='bio', res=2.5)
plot(env, 1, main=NULL, axes=FALSE)
points(xy, col='blue', pch=20)
xy_bio <- raster::extract(env, xy)
car_allium_clim <- cbind(xy_bio, sp_xy)

# change all datapoints to the "species sp" format that's used in the og dataframe, calc CTI
car_allium_clim <- car_allium_clim %>%
  mutate(species.name = "Allium sp.") %>%
   group_by(species.name) %>%
   summarise(meant = mean(bio1, na.rm = TRUE),
         meanp = mean(bio12, na.rm = TRUE)) %>%
  mutate(meanT = meant/10) 
```

### Astragalus
```{r Carrizo Astragalus}
car_astragalus <- c('Astragalus asymmetricus',
                'Astragalus didymocarpus',
                'Astragalus douglasii',
                'Astragalus macrodon',
                'Astragalus oxyphysus',
                'Astragalus lentiginosus')

car_astragalus_data <- occ(query = car_astragalus, from = "gbif", has_coords = TRUE, limit = 10000,
                gbifopts = list(hasGeospatialIssue = FALSE, country = "US",
                                stateProvince = "California"))

## we can also replace all synonym taxon names with one (cuts down the number of plotted dot colors)
## we should use the scrubr version of the function in the future
car_astragalus_data <- fixnames(car_astragalus_data, how = "query")

## The occ2df function should convert the data to a dataframe format
car_astragalus_data_df <- occ2df(car_astragalus_data)

map_ggplot(car_astragalus_data, map = "state", size = 0.5) 

flags <- clean_coordinates(x = car_astragalus_data_df, lon = "longitude", lat = "latitude",
                          species = "name",
                          tests = c("capitals", "centroids", "equal","gbif", "institutions",
                                    "seas", "zeros")) # most test are on by default

# remove flagged records
car_astragalus_data_df <- car_astragalus_data_df[flags$.summary,]

# extract lat/long for each datapoint
xy <- car_astragalus_data_df[,c("longitude","latitude")]
sp_xy <- car_astragalus_data_df[c("name", "longitude","latitude")]
sp_xy <- sp_xy %>%
  rename(species = name)
env <- getData('worldclim', var='bio', res=2.5)
plot(env, 1, main=NULL, axes=FALSE)
points(xy, col='blue', pch=20)
xy_bio <- raster::extract(env, xy)
car_astragalus_clim <- cbind(xy_bio, sp_xy)

# change all datapoints to the "species sp" format that's used in the og dataframe, calc CTI
car_astragalus_clim <- car_astragalus_clim %>%
  mutate(species.name = "Astragalus sp.") %>%
   group_by(species.name) %>%
   summarise(meant = mean(bio1, na.rm = TRUE),
         meanp = mean(bio12, na.rm = TRUE)) %>%
  mutate(meanT = meant/10) 
```

# Calculating CTI
To calculate CTI, we need to summarize the weight of each species in a community and multiply that by the TI for that species. 

```{r relative cover of each spp, cache = TRUE}
car_data_rel <- car_data %>%
  select(year, Plot, species.name, Intercepts) %>%
  #distinct
  group_by(Plot, year) %>%
  mutate(sumintercept = sum(Intercepts),
         relcov = Intercepts/sumintercept)
```


```{r Creating CTI table}
car_CTI <- left_join(car_data_rel, car_species_clim, by = "species.name") 
car_CTI <- left_join(car_CTI, car_delpinium_clim, by = "species.name") %>%
  mutate(meant = coalesce(meant.x, meant.y),
         meanp = coalesce(meanp.x, meanp.y),
         meanT = coalesce(meanT.x, meanT.y),) %>% 
        select(-meant.x, -meant.y, -meanp.x, -meanp.y, -meanT.x, -meanT.y)
car_CTI <- left_join(car_CTI, car_allium_clim, by = "species.name") %>%
  mutate(meant = coalesce(meant.x, meant.y),
         meanp = coalesce(meanp.x, meanp.y),
         meanT = coalesce(meanT.x, meanT.y),) %>% 
        select(-meant.x, -meant.y, -meanp.x, -meanp.y, -meanT.x, -meanT.y)
car_CTI <- left_join(car_CTI, car_astragalus_clim, by = "species.name") %>%
  mutate(meant = coalesce(meant.x, meant.y),
         meanp = coalesce(meanp.x, meanp.y),
         meanT = coalesce(meanT.x, meanT.y),) %>% 
        select(-meant.x, -meant.y, -meanp.x, -meanp.y, -meanT.x, -meanT.y)

car_CTI <- car_CTI %>%
  mutate(relTI = relcov*meanT,
         relP = relcov*meanp) %>%
  group_by(year, Plot) %>%
  summarise(CTI = sum(relTI, rm.na = TRUE),
            CPI = sum(relP, rm.na = TRUE))

car_CTI_means <- car_CTI %>%
  group_by(year) %>%
  summarise(meanCTI = mean(CTI),
            seCTI = std.error(CTI),
            meanCPI = mean(CPI),
            seCPI = std.error(CPI))

ggplot(car_CTI_means, aes(x=year, y=meanCTI)) +
  geom_point() +
  geom_errorbar(aes(ymin = meanCTI-seCTI, ymax = meanCTI+seCTI), width=0.2)

ggplot(car_CTI_means, aes(x=year, y=meanCPI)) +
  geom_point() +
  geom_errorbar(aes(ymin = meanCPI-seCPI, ymax = meanCPI+seCPI), width=0.2) 


```
