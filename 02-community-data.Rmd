# Community data preparation 

Objectives

- Clean up experimental community data (JRGCE, McLaughlin Water Exp, Santa Cruz IDE)
- Clean up observational community data (~10 datasets)
- Correct species names
- Gather site information

Key results

- Raw data path: `data/community/raw/`
- Tidy data path: `data/community/tidy/`
- Processed data path: `data/community/`

Setup and load packages.

```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, eval = FALSE)
```

```{r}
library(tidyverse)
```

## Study sites

```{r, eval=FALSE}
site_sf <- tribble(
  ~abbr, ~name, ~latitude, ~longitude, ~grass_type, ~data_method,
  "angelo", "Angelo Coast", "39 43 02.5", "-123 39 11.1", "Valley", "Cover in 30x0.09 m2 quadrats",
  "carrizo", "Carrizo Plain", "35 11 20.6", "-119 51 45.2", "Valley", "9x9 point intercept in 1 m2 quadrats",
  "elkhorn", "Elkhorn Slough", "36 52 02.4", "-121 44 27.5", "Coastal prairie", "5x5 point intercept in 1 m2 quadrats",
  "jasper", "Jasper Ridge", "37 24 22.4", "-122 14 31.8", "Serpentine", "Cover in 1 m2 quadrats",
  "jrgce", "Jasper Ridge Global Change Experiment", "37 24 22.4", "-122 14 31.8", "???", "Point intercept (?)",
  "mclann", "McLaughlin Annual", "38 52 11.2", "-122 25 15.6", "Valley", "Cover in 1 m2 quadrats; first 6 years are richness only",
  "mclserp", "McLaughlin Serpentine", "38 52 11.2", "-122 25 15.6", "Serpentine", "Cover in 1 m2 quadrats; first 6 years are richness only",
  "pleasantonridge", "Pleasanton Ridge", "37 36 55.47384", "-121 53 4.4142", "???", "???",
  "scide", "IDE Arboretum", "36 58 38.856", "-122 03 8.136", "???", "???",
  "scide", "IDE Marshall Field", "37 0 57", "-122 4 45", "???", "???",
  "scide", "IDE Younger Lagoon", "36 57 0", "-122 4 0", "???", "???",
  "sunol", "Sunol", "37 30 36.66", "-121 49 42.78", "???", "???",
  "swanton", "Swanton Ranch", "37 02 43.1", "-122 13 16.1", "Coastal prairie", "1 m2 quadrats; 5x5 point-intercept",
  "ucsc", "UC Santa Cruz", "36 59 11.1", "-122 03 09.2", "Coastal prairie", "5x5 point intercept in 1 m2 quadrats",
  "vascocaves", "Vasco Caves", "37 48 18", "-121 41 13.2", "???", "???"
) %>%
  mutate(
    latitude = measurements::conv_unit(latitude, from = "deg_min_sec", to = "dec_deg") %>% as.numeric(),
    longitude = measurements::conv_unit(longitude, from = "deg_min_sec", to = "dec_deg") %>% as.numeric()
  ) %>%
  sf::st_as_sf(coords = c("longitude", "latitude"), crs = 4326)

write_rds(site_sf, file = "data/community/site-info.rds")

rm(site_sf)
```

## Experimental community data

### Jasper Ridge Global Change Experiment

![Jasper Ridge Global Change Experiment (JRGCE)](images/jasper-ridge.jpg)

JRGCE data provided by Nona Chiariello.

Raw data tables (CSV files) include pin count, species, treatment.

```{r pin count table}
pin_tbl <- read_csv("data/community/raw/JRGCE/Pin count.csv", col_types = "iiccicc") %>%
  select(year = YEAR, plot = ID, species = SPECIES, abund = TOTAL) %>%
  mutate(species = if_else(
    str_starts(species, "Acmispon americanus"),
    "Acmispon americanus var.americanus",
    species
  )) %>%
  mutate(species = if_else(
    str_starts(species, "Crepis"),
    "Crepis vesicaria ssp. taraxacifolia",
    species
  )) %>%
  filter(!is.na(abund))
```

```{r species table}
spp_tbl <- read_csv("data/community/raw/JRGCE/Species.csv", col_types = "ccccccccccccccc") %>%
  mutate(guild = str_c(case_when(
    NATIVE_CODE == "I" ~ "E", # Invasive -> Exotic
    NATIVE_CODE == "N" ~ "N", # Native
    NATIVE_CODE == "U" ~ "U", # Unknown
    is.na(NATIVE_CODE) ~ "U"
  ), FXNGROUP_CODE)) %>%
  select(species = `Species or unit name`, guild)
```

```{r treatment table}
trt_tbl <- read_csv("data/community/raw/JRGCE/Treatment.csv", col_types = "iiiiciiiiiiiiic") %>%
  pull(id) %>%
  expand_grid(year = 1998:2014, plot = .) %>% # full year-treatment tibble
  full_join(read_csv("data/community/raw/JRGCE/Treatment.csv", col_types = "iiiiciiiiiiiiic") %>%
    select(plot = id, starts_with("Heat_"), Precip, CO2, Nitrogen),
  by = "plot"
  ) %>%
  mutate( # recode treatment
    tmp = case_when(
      year >= 1998 & year <= 2003 ~ as.logical(Heat_1998_2003 - 1),
      year >= 2004 & year <= 2006 ~ as.logical(Heat_2004_2006 - 1),
      year >= 2007 & year <= 2014 ~ as.logical(Heat_2007_2014 - 1)
    ),
    ppt = as.logical(Precip - 1),
    co2 = as.logical(CO2 - 1),
    ntg = as.logical(Nitrogen - 1)
  ) %>%
  mutate(
    tmp = if_else(year == 1998, FALSE, tmp),
    ppt = if_else(year == 1998, FALSE, ppt),
    co2 = if_else(year == 1998, FALSE, co2),
    ntg = if_else(year == 1998, FALSE, ntg)
  ) %>%
  mutate(
    treat = str_c(
      ifelse(tmp, "T", "_"),
      ifelse(ppt, "P", "_"),
      ifelse(co2, "C", "_"),
      ifelse(ntg, "N", "_")
    )
  ) %>%
  select(year, plot, treat) %>%
  arrange(year, plot)
```

Join all tables, remove intermediate objects, and save the tidy data. 

```{r}
jrgce_data <- pin_tbl %>%
  left_join(spp_tbl, by = "species") %>%
  left_join(trt_tbl, by = c("year", "plot")) %>%
  mutate(site = "jrgce", abund_type = "point_intercept") %>%
  select(site, year, plot, treat, species, guild, abund, abund_type) %>%
  arrange(year, plot, species)

write_csv(jrgce_data, "data/community/tidy/jrgce.csv")
```

Remove intermediate objects.

```{r}
rm(pin_tbl, spp_tbl, trt_tbl)
rm(jrgce_data)
```

### McLaughlin Water Experiment

The experiment was introduced in Harrison, Susan P., Marina L. LaForgia, and Andrew M. Latimer. “Climate‐driven Diversity Change in Annual Grasslands: Drought plus Deluge Does Not Equal Normal.” Global Change Biology 24, no. 4 (April 2018): 1782–92. https://doi.org/10.1111/gcb.14018.

Susan's notes (email on 4/22/22):

- Treatments began in Fall 2015 and ended in Winter 2020.   The years in the datasheets refer to Spring sampling.   Thus, sampling year 2015 is pre-treatment data, and sampling year 2021 is one full year post-treatment.
- In practice it’s best to treat this as three separate sub-experiments.    On non-serpentine soil, the treatments are Watering and Watering Control.   On serpentine soil, there is also a watering experiment with treatments Watering and Watering Control.   On serpentine soil there is also a drought shelter experiment with treatments Shelter and Shelter Control.    The design was not conducive to analyzing these three sub-experiments all together.

Read in raw data. Note 2020 data is missing.

```{r}
cover_2015_tbl <- readxl::read_excel("data/community/raw/HarrisonExperiment/2015-2021 Water Experiment Data.xlsx", sheet = "2015")
cover_2016_tbl <- readxl::read_excel("data/community/raw/HarrisonExperiment/2015-2021 Water Experiment Data.xlsx", sheet = "2016")
cover_2017_tbl <- readxl::read_excel("data/community/raw/HarrisonExperiment/2015-2021 Water Experiment Data.xlsx", sheet = "2017")
cover_2018_tbl <- readxl::read_excel("data/community/raw/HarrisonExperiment/2015-2021 Water Experiment Data.xlsx", sheet = "2018")
cover_2019_tbl <- readxl::read_excel("data/community/raw/HarrisonExperiment/2015-2021 Water Experiment Data.xlsx", sheet = "2019")
# cover_2020_tbl <- readxl::read_excel("data/community/raw/HarrisonExperiment/2015-2021 Water Experiment Data.xlsx", sheet = "2020")
cover_2021_tbl <- readxl::read_excel("data/community/raw/HarrisonExperiment/2015-2021 Water Experiment Data.xlsx", sheet = "2021")
plot_tbl <- readxl::read_excel("data/community/raw/HarrisonExperiment/2015-2021 Water Experiment Data.xlsx", sheet = "Plot codes")
```

Combine cover data across years and join with plot-treatment data.

```{r}
cover_long_tbl <- (
  cover_2015_tbl %>%
    rename(species = "Plots") %>%
    pivot_longer(-species, names_to = "plot", values_to = "abund") %>%
    mutate(year = 2015)
) %>%
  bind_rows(
    cover_2016_tbl %>%
      rename(species = "Plots") %>%
      pivot_longer(-species, names_to = "plot", values_to = "abund") %>%
      mutate(year = 2016)
  ) %>%
  bind_rows(
    cover_2017_tbl %>%
      rename(species = "Plots") %>%
      pivot_longer(-species, names_to = "plot", values_to = "abund") %>%
      mutate(year = 2017)
  ) %>%
  bind_rows(
    cover_2018_tbl %>%
      rename(species = "Plots") %>%
      pivot_longer(-species, names_to = "plot", values_to = "abund") %>%
      mutate(year = 2018)
  ) %>%
  bind_rows(
    cover_2019_tbl %>%
      rename(species = "Plots") %>%
      pivot_longer(-species, names_to = "plot", values_to = "abund") %>%
      mutate(year = 2019)
  ) %>%
  bind_rows(
    cover_2021_tbl %>%
      rename(species = "Plots") %>%
      pivot_longer(-species, names_to = "plot", values_to = "abund") %>%
      mutate(year = 2021)
  ) %>%
  select(year, plot, species, abund) %>%
  mutate(plot = as.integer(plot))

mclexp_data <- plot_tbl %>%
  mutate(
    plot = as.integer(Site),
    treat = case_when(
      Trt == "W" ~ "WX", # watering; X means not available; watering is paired--compare WX vs. _X, not X_
      Trt == "WC" ~ "_X", # watering control (_)
      Trt == "S" ~ "XD", # shelter -> drought
      Trt == "SC" ~ "X_" # shelter control -> drought control
    ) %>%
      str_c(Soil) # S = serpentine soil, N = non-serpentine soil
  ) %>%
  select(plot, treat) %>%
  full_join(cover_long_tbl, by = "plot") %>%
  mutate(site = "mclexp", guild = NA, abund_type = "cover") %>%
  select(site, year, plot, treat, species, guild, abund, abund_type) %>%
  filter(
    abund > 0,
    !(species %in% c("bare", "gopher", "litter", "mosses", "rock", "soil"))
  ) %>%
  arrange(year, plot, species)

write_csv(mclexp_data, "data/community/tidy/mclexp.csv")
```

Remove intermediate objects.

```{r}
rm(cover_2015_tbl, cover_2016_tbl, cover_2017_tbl, cover_2018_tbl, cover_2019_tbl, cover_2021_tbl, cover_long_tbl, plot_tbl)
rm(mclexp_data)
```

### Santa Cruz International Drought Experiment

![Michael Loik and the Santa Cruz International Drought Experiment (IDE). Image credit: Lobsang Wangdu. Source: https://ucnrs.org/doctor-drought/](images/santa-cruz-ide.jpeg)

Data provided by Michael Loik. 

```{r}
scide_data <- read_csv("data/community/raw/SantaCruzIDE/IDESpeciesComp_LongFormat_2015_2021.csv",
  col_types = c("ciicdicdcc")
) %>%
  mutate(
    site = Site %>%
      str_replace(" ", "") %>%
      tolower() %>%
      str_c("scide_", .),
    year = Year,
    plot = str_c(Plot, Block, sep = "-"),
    treat = case_when(
      Treatment == "Ambient" ~ "_",
      Treatment == "Drought" ~ "D"
    ),
    species = Species,
    guild = str_c(
      case_when( # origin
        Origin == "Native" ~ "N",
        Origin == "Non-native" ~ "E", # exotic
        is.na(Origin) ~ "U" # unknown
      ),
      case_when( # lifeform
        Lifeform == "Annual" ~ "AU", # annual unknown
        Lifeform == "Annual forb" ~ "AF",
        Lifeform == "Annual grass" ~ "AG",
        Lifeform == "Annual rush" ~ "AR",
        Lifeform == "N-fixer" ~ "NF",
        Lifeform == "Perennial forb" ~ "PF",
        Lifeform == "Perennial grass" ~ "PG",
        Lifeform == "Perennial sedge" ~ "PS",
        Lifeform == "Rhizomatous forb" ~ "RF",
        Lifeform == "Rhizomatous grass" ~ "RG",
        Lifeform == "Rhizomatous rush" ~ "RR",
        Lifeform %in% c("Shrub", "Shurb") ~ "S",
        is.na(Lifeform) ~ "U" # unknown
      )
    ),
    abund = Cover,
    abund_type = "cover"
  ) %>%
  select(site, year, plot, treat, species, guild, abund, abund_type)

write_csv(scide_data, "data/community/tidy/scide.csv")
```

Remove intermediate objects.

```{r}
rm(scide_data)
```

## Observational community data

### Angelo

These data were collected by K.B. Suttle from 2002 to 2015.  

```{r Angelo Data Import and Clean, message=FALSE}
Angelo <- read_csv("data/community/raw/Angelo/Angelo_CommCompData.csv") %>%
  filter(TMT == "C") %>%
  pivot_longer(-c(Year, Plot, TMT), names_to = "species", values_to = "cover")
names(Angelo) <- tolower(names(Angelo))
Angelo_spp <- read_csv("data/community/raw/Angelo/Angelo_spp_guilds.csv")
Angelo <- left_join(Angelo, Angelo_spp, by = "species") %>%
  mutate(Site = "angelo") %>%
  filter(cover > 0)
angelo_data <- Angelo %>%
  select("tmt", "plot", "year", "species.name", "cover", "guild") %>%
  mutate(site = "angelo") %>%
  filter(
    guild != "Bare",
    guild != "Moss",
    guild != "Litter"
  ) %>%
  mutate(site = "angelo")

angelo_data <- angelo_data %>%
  as_tibble() %>%
  select(site, year, plot, species = species.name, guild, abund = cover) %>%
  mutate(species = str_trim(species), guild = as.character(guild), abund_type = "cover") %>%
  arrange(site, year, plot, species)

write_csv(angelo_data, "data/community/tidy/angelo.csv")
```

Remove intermediate objects.

```{r}
rm(Angelo, Angelo_spp)
rm(angelo_data)
```

### Carrizo

Carrizo Plain data from Loralee Larios, from 2007 to 2021, updated on June 28, 2022. The data are taken in plots, with a variable number of plots measured annually. These data only have the control plots after 2015 so replication will go from 10 20m x 20m plots with 8 1m2 subplots  to 4 20m x 20m plots with 8 1m2 subplots. Those plots that are kept would correspond to Center Well plots 2, 3, 4, 6 and Swain plots 1,2,7,9.

Loralee's email (7/5/22) on Count vs. Count2:

> For the point of whether to use Count or Count2. I would suggest using Count 2, while this does capture species that were likely rare in that 1m2 plot, these species may be regionally dominant and just rare in that plot so I think it would give you a better representation of the range of abundance for a species. 

```{r}
# community data spreadsheet
carrizo_com <- readxl::read_xlsx(
  "data/community/raw/Carrizo/2022-06-28/Carrizo_data for Joise_2007_2021.xlsx",
  sheet = 1,
  col_types = c(
    "date", "numeric", "text", "text", "text",
    "numeric", "text", "text", "text", "text",
    "text", "numeric", "text", "text", "text",
    "text", "text", "text", "text", "numeric",
    "numeric", "text"
  ),
  na = "NA"
) %>%
  filter(cattle == "Ungrazed") %>% # only ungrazed plots
  select(
    plot = Site, year,
    species_code = SpeciesCode, species_name = Species.Name,
    intercept = Count2 # Updated number of hits, where any species that was present but not hit were given a 1
  ) %>%
  filter(intercept > 0, !is.na(intercept))

# species data
carrizo_spp <- read_csv(
  "data/community/raw/Carrizo/2022-07-05/Carrizo_global_species list_v2.csv",
  col_types = "c"
) %>%
  mutate(guild = case_when(
    newform == "ia" ~ "EAG", # Invasive (Exotic) Annual Grass
    newform == "ih" ~ "EAF", # Invasive (Exotic) Annual Forb
    newform == "ip" ~ "EPF", # Invasive (Exotic) Perennial Forb
    newform == "na" ~ "NAG", # Native Annual Grass
    newform == "nh" ~ "NAF", # Native Annual Forb
    newform == "np" ~ "NPF", # Native	Perennial	Forb
    newform == "npg" ~ "NPG", # Native Perennial Grass
    newform == "nps" ~ "NPS" # Native Perennial Shrub
  ))

# join community and species data
carrizo_data <- carrizo_com %>%
  filter(
    plot %in% c("EP2", "EP3", "EP4", "EP6", "SC1", "SC2", "SC7", "SC9"),
    # !(species_code == "AMSMEN" & is.na(species_name)),
    !(species_code == "ASTspp" & is.na(species_name)),
    !(species_code == "BARE" & species_name == "Bare ground"),
    !(species_code == "BURROW" & species_name == "Animal burrow"),
    !(species_code == "CRYPTO" & is.na(species_name)),
    # !(species_code == "EUPPOL" & is.na(species_name)),
    !(species_code == "FRESHDIRT" & species_name == "freshly disturbed dirt"),
    !(species_code == "GOPHER" & species_name == "gopher mound"),
    !(species_code == "HOLE" & species_name == "hole in ground"),
    !(species_code == "LITTER" & species_name == "litter"),
    !(species_code == "MOSS" & is.na(species_name)),
    !(species_code == "UNK 11" & is.na(species_name))
  ) %>%
  left_join(carrizo_spp %>% select(species_code = spp.code, species_name = SCIENTIFIC.NAME, guild),
    by = c("species_code", "species_name")
  ) %>%
  mutate(species_name = case_when(
    species_code == "AMSMEN" ~ "Amsinckia menziesii",
    species_code == "EUPPOL" ~ "Chamaesyce polycarpa (Euphorbia polycarpa)",
    TRUE ~ species_name
  )) %>%
  group_by(plot, year, species_code, species_name, guild) %>%
  summarize(abund = sum(intercept)) %>%
  ungroup() %>%
  mutate(site = "carrizo", species_name = str_trim(species_name), abund_type = "point_intercept") %>%
  select(site, year, plot, species = species_name, guild, abund, abund_type) %>%
  arrange(site, year, plot, species)

write_csv(carrizo_data, "data/community/tidy/carrizo.csv")
```

Remove intermediate objects.

```{r}
rm(carrizo_com, carrizo_data, carrizo_spp)
```

### East Bay

East Bay Regional Park District (EBRPD) data from Joan Dudney. Three sites: PR = Pleasant Ridge, VC = Vasco Cave, SU = Sunol.

```{r}
eb_spp_tbl <- readxl::read_xlsx("data/community/raw/Dudney/_VegSpCodeAttributes_2010.xlsx") %>%
  mutate(
    species_code = toupper(species),
    guild = str_c(
      case_when(
        `native/exotic` == "e" ~ "E", # Exotic
        `native/exotic` == "n" ~ "N", # Native
        TRUE ~ "U" # else is Unknown
      ),
      case_when(
        `annual/perennial` == "a" ~ "A", # Annual
        `annual/perennial` == "p" ~ "P", # Perennial
        TRUE ~ "U" # else is Unknown
      ),
      case_when(
        `forb/grass` == "f" ~ "F", # Forb
        `forb/grass` == "g" ~ "G", # Grass
        `forb/grass` == "n" ~ "R", # Rush
        `forb/grass` == "s" ~ "S", # Shurb
        `forb/grass` == "t" ~ "T", # Tree
        TRUE ~ "U" # else is Unknown
      )
    )
  ) %>%
  select(species_code, species = latin, guild)

eb_com_tbl <- read_csv("data/community/raw/Dudney/EBRPD_2002thru2012_Dec2013_BRXX AVXX updated.csv",
  col_types = "cicidc"
) %>%
  rename(plot = plot.ID, species_code = species) %>%
  group_by(site, year, plot, species_code) %>%
  summarize(hits = n()) %>%
  group_by(site, year, plot) %>%
  mutate(tot_hits = sum(hits)) %>%
  group_by(site, year, plot, species_code) %>%
  summarize(abund = hits / tot_hits) %>%
  left_join(eb_spp_tbl, by = "species_code") %>%
  mutate(abund_type = "point_intercept") %>%
  mutate(species = coalesce(species, species_code)) %>% # if species == NA, replace with species_code
  filter(
    !(species %in% c("bare", "COWPIE", "gopher", "litter", "mosses", "rock", "soil")),
    !str_detect(species, "unknown"),
    is.na(guild) | guild != "UUU"
  ) %>%
  select(site, year, plot, species, guild, abund, abund_type) %>%
  arrange(site, year, plot, species)
```

Validate with Joan's functional group (guild) spreadsheet.

```{r, eval=FALSE}
eb_guild_sum_tbl1 <- readxl::read_xlsx("data/community/raw/Dudney/FunctionalGroups_EBParks.xlsx",
  range = readxl::cell_cols("A:E")
) %>%
  rename(plot = plot.ID, guild = fungrp)

eb_guild_sum_tbl2 <- read_csv("data/community/raw/Dudney/EBRPD_2002thru2012_Dec2013_BRXX AVXX updated.csv",
  col_types = "cicidc"
) %>%
  rename(plot = plot.ID, species_code = species) %>%
  left_join(eb_spp_tbl, by = "species_code") %>%
  group_by(site, year, plot, guild) %>%
  summarize(abund = n())

inner_join(eb_guild_sum_tbl1, eb_guild_sum_tbl2, by = c("site", "year", "plot", "guild")) %>%
  ggplot(aes(abund.x, abund.y)) +
  geom_point() +
  geom_abline(intercept = 0, slope = 1, color = "red") +
  labs(x = "Species hit from Dudney", y = "Species hit from Zhu")

rm(eb_guild_sum_tbl1, eb_guild_sum_tbl2)
```

#### Pleasanton Ridge

Include PR4-9 plots that have 10 yr of data, 2003-2012.

```{r}
eb_com_tbl %>%
  filter(site == "PR", plot %in% str_c("PR", 4:9)) %>%
  mutate(site = "pleasantonridge") %>%
  write_csv("data/community/tidy/pleasantonridge.csv")
```

#### Sunol

Include SU1-6 plots that have 8 yr of data, 2005-2012. Include SU7-9 plots that have 7 yr of data, 2005-2011.

```{r}
eb_com_tbl %>%
  filter(site == "SU", plot %in% str_c("SU", 1:9)) %>%
  mutate(site = "sunol") %>%
  write_csv("data/community/tidy/sunol.csv")
```

#### Vasco Caves

Include VC1-3 plots that have 12 yr of data, 2002-2012. Include VC4-6 plots that have 11 yr of data, 2002-2011. Include VC7-9 plots that have 11 yr of data, 2003-2012. Include VC10 plot that has 10 yr of data, 2003-2011. 

Joan's additional notes: 

> I'd probably remove VC1, 8 & 9 to stay consistent with the remaining plots (and 9 interceptions is low), but if you're feeling like more is better, I can see the argument to keep them in:)

Josie's additional notes:

> Were you able to sort out why some transects only had 9 interceptions? When I poked at the data, it looked like only several plots at Vasco Caves had 9 hits (VC1, VC8, and VC9, matching your notes) but only in 2012. Does that match what you found? If that's the case, it seems like our best bet might be to include those plots for all years except 2012.

```{r}
eb_com_tbl %>%
  filter(site == "VC", plot %in% str_c("VC", 1:10)) %>%
  filter(!(year == 2012 & plot %in% c("VC1", "VC8", "VC9"))) %>%
  mutate(site = "vascocaves") %>%
  write_csv("data/community/tidy/vascocaves.csv")
```

Remove intermediate objects.

```{r}
rm(eb_com_tbl, eb_spp_tbl)
```

### Jasper

These data were collected from Jasper Ridge Biological Preserve by Lauren Hallett and Richard Hobbs from 1983 to 2015.  

```{r Jasper Data Import & Clean, message=FALSE}
Jasper_Veg <- read_csv("data/community/raw/Jasper/JR_cover_forJosie.csv",
  col_types = cols_only(year = "d", species = "c", cover = "d", uniqueID = "c")
) %>%
  pivot_wider(names_from = species, values_from = cover) %>%
  replace(is.na(.), 0) %>%
  pivot_longer(cols = aghe:vumi, names_to = "species", values_to = "cover") %>%
  group_by(uniqueID, year, species) %>%
  summarize(cover = mean(cover))
JR_spp <- read_csv("data/community/raw/Jasper/JR_speciesnames2.csv")
Jasper <- left_join(Jasper_Veg, JR_spp, by = "species")
Jasper_species <- Jasper %>%
  select("uniqueID", "year", "species.name", "cover", "guild") %>%
  mutate(site = "jasper") %>%
  filter(cover > 0) %>%
  ungroup()
jasper_spp_check <- Jasper_species %>%
  group_by(species.name, guild) %>%
  summarise(mean = mean(cover))

jasper_data <- Jasper_species %>%
  as_tibble() %>%
  select(site, year, plot = uniqueID, species = species.name, guild, abund = cover) %>%
  mutate(plot = as.character(plot), species = as.character(species) %>% str_trim(), guild = as.character(guild), abund_type = "cover") %>%
  arrange(site, year, plot, species)

write_csv(jasper_data, "data/community/tidy/jasper.csv")
```

Remove intermediate objects.

```{r}
rm(Jasper, Jasper_species, jasper_spp_check, Jasper_Veg, JR_spp)
rm(jasper_data)
```

### McLaughlin

Data provided by Susan Harrison for two sites: Annual and Serpentine. First, read common site and species tables.

```{r}
McL_Sites <- read_csv("data/community/raw/McLaughlin/AbioticSiteDataNew.csv") %>%
  rename(Site = site)
McL_spp <- read_csv("data/community/raw/McLaughlin/McLaughlin_FunctionalGroups.csv")
```

#### Annual

Like the McLauglin Serpentine dataset, these data were collected at McLauglin Reserve in Northern California from 2000-2014 by Susan Harrison. These data represent 42 annual grassland plots, and were measured using 1m^2^ quadrants. Data is richness only from 2000-2005, but full community data 2006-2014. 

```{r McLaughlin Importing and Cleaning Data, message=FALSE}
## importing the data
McLAnn <- read_csv("data/community/raw/McLaughlin/Core_Community_Data2019.csv",
  col_types = c(
    id = "i", Year = "i", Site = "d", Quadrat = "i", Species_Name = "c",
    Cover = "d", Notes = "c", Merged_Species = "c"
  )
)

## combining the data with site infomation, filtering to just serpentine sites
McLAnn <- left_join(McLAnn, McL_Sites, by = "Site")
McLAnn <- McLAnn %>%
  filter(Serpentine == "N") %>%
  rename(plot = Site)

## combining the guild information, creating a "guild" column, selecting only the desired info
McLAnn <- left_join(McLAnn, McL_spp, by = "Species_Name") %>%
  rename(
    nat.exo = Native.Exotic,
    lifeform = Grass.Forb.Shrub,
    ann.per = Annual.Perennial
  ) %>%
  mutate(
    Guild1 = str_sub(nat.exo, 1, 1),
    Guild3 = str_sub(lifeform, 1, 1),
    Guild2 = str_sub(ann.per, 1, 1)
  ) %>%
  unite(Guild1, Guild2, col = "Guild1", sep = "") %>%
  unite(Guild1, Guild3, col = "guild", sep = "") %>%
  mutate(Site = "mclann") %>%
  select(Year, Site, plot, Quadrat, Cover, Species_Name, nat.exo, ann.per, lifeform, guild) %>%
  group_by(Year, Site, plot, Species_Name, nat.exo, ann.per, lifeform, guild) %>%
  summarise(cover = mean(Cover)) %>%
  ungroup()
mclann_data <- McLAnn %>%
  rename(
    species.name = Species_Name,
    year = Year
  ) %>%
  filter(
    species.name != "Bare",
    species.name != "Rock",
    species.name != "Unknown grass",
    species.name != "Unknown forb"
  ) %>%
  mutate(site = "mclann")

mclann_data <- mclann_data %>%
  as_tibble() %>%
  ungroup() %>%
  select(site = Site, year, plot, species = species.name, guild, abund = cover) %>%
  mutate(plot = as.integer(plot), species = as.character(species) %>% str_trim(), guild = as.character(guild), abund_type = "cover") %>%
  arrange(site, year, plot, species) %>%
  filter(!is.na(abund), abund > 0)

write_csv(mclann_data, "data/community/tidy/mclann.csv")
```

#### Serpentine

These data were collected by Susan Harrison from serpentine grassland sites at McLaughlin Reserve in Northern California. These data are for 38 plots that were measured using 1m^2^ quadrants. Data collected 2000-2014; richness only from 2000-2005 but full community data 2006-2014. 

```{r Import and Clean McL Serpentine, message=FALSE}
## importing the data
McLSerp <- read_csv("data/community/raw/McLaughlin/Core_Community_Data2019.csv")

## combining the data with site information, filtering to just serpentine sites
McLSerp <- left_join(McLSerp, McL_Sites, by = "Site")
McLSerp <- McLSerp %>%
  filter(Serpentine == "S") %>%
  rename(plot = Site)

## combining the guild information, creating a "guild" column, selecting only the desired info
McLSerp <- left_join(McLSerp, McL_spp, by = "Species_Name") %>%
  rename(
    nat.exo = Native.Exotic,
    lifeform = Grass.Forb.Shrub,
    ann.per = Annual.Perennial
  ) %>%
  mutate(
    Guild1 = str_sub(nat.exo, 1, 1),
    Guild3 = str_sub(lifeform, 1, 1),
    Guild2 = str_sub(ann.per, 1, 1)
  ) %>%
  unite(Guild1, Guild2, col = "Guild1", sep = "") %>%
  unite(Guild1, Guild3, col = "guild", sep = "") %>%
  mutate(Site = "mclserp") %>%
  select(Year, Site, plot, Quadrat, Cover, Species_Name, nat.exo, ann.per, lifeform, guild) %>%
  group_by(Year, Site, plot, Species_Name, nat.exo, ann.per, lifeform, guild) %>%
  summarise(cover = mean(Cover))
mclserp_data <- McLSerp %>%
  rename(
    species.name = Species_Name,
    year = Year
  ) %>%
  filter(
    species.name != "Bare",
    species.name != "Rock",
    species.name != "Unknown forb"
  ) %>%
  mutate(site = "mclserp")

mclserp_data <- mclserp_data %>%
  as_tibble() %>%
  ungroup() %>%
  select(site = Site, year, plot, species = species.name, guild, abund = cover) %>%
  mutate(plot = as.integer(plot), species = as.character(species) %>% str_trim(), guild = as.character(guild), abund_type = "cover") %>%
  arrange(site, year, plot, species) %>%
  filter(!is.na(abund), abund > 0)

write_csv(mclserp_data, "data/community/tidy/mclserp.csv")
```

Remove intermediate objects.

```{r}
rm(McL_Sites, McL_spp, McLAnn, mclann_data, McLSerp, mclserp_data)
```

### Santa Cruz

Three sites provided by Karen Holl: Elkhorn Slough, Swanton Ranch, and UC Santa Cruz. 

#### Elkhorn

Data for grassland plots at Elkhorn Slough. Data were collected by Karen Holl and Grey Hayes between 1999 and 2018. For these analyses, we are using on the control plots (n = 3), and removing all other treatments from the dataset. 

Josie's comments (5/12/22): Elkhorn site is in Elkhorn Ranch; not so coastal and might not be windy.

```{r Importing Elkhorn, warning=FALSE, message=FALSE}
elkspp <- read_csv("data/community/raw/HollData/ElkhornSpecies.csv") %>%
  mutate(species.code = tolower(species.code))
elk_guilds <- read_csv("data/community/raw/HollData/ElkhornGuilds.csv")
elk_counts <- list()
for (i in 1:20) {
  year <- as.character(1999:2018)[i]
  skips <- c(4, 3, 3, 3, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 2, 1, 1, 1, 1, 1)
  filename <- paste0("data/community/raw/HollData/Elk_", year, ".csv")
  out <- read_csv(filename, skip = skips[i], show_col_types = FALSE)
  # elk_counts[[year]] <- select_if(out, has_data)
  elk_counts[[year]] <- out
}
elk_counts <- lapply(seq_along(elk_counts), function(i) {
  rename_with(elk_counts[[i]], tolower) %>%
    rename_with(~ sub("frequency", "freq", sub("treatment", "treat", sub("replicate", "rep", sub("9$", "", .x))))) %>%
    select(-starts_with("comment"), -starts_with("..."), -starts_with("0"))
})

# lapply(elk_counts, names)
```

Because these data are in separate files (one year per file), we need to clean the data and compile all of the years into a single object. To clean the data, we selected only the Elkhorn plots (these files also contained the data from two other sites; UCSC and Swanton, removed the non-control plots, restructured the data to make sure only non-zero datapoints were included, and added the year.

We then combined the file with species guild information to each yearly object. 

```{r Cleaning Elkhorn, warning=FALSE}
cleanElkhornData <- function(data, gathercol1, gathercol2, site = c("elk", "swa", "ucsc")) {
  filtersite <- match.arg(site, c("elk", "swa", "ucsc"))
  keep_cols <- c("site", "freq", "treat", "rep", "species.code", "intercepts", "plot")
  if (!(gathercol1 %in% names(data)) | !(gathercol2 %in% names(data))) {
    stop("gathercol1 and gathercol2 must be columns in data.")
  }
  ind_col1 <- which(names(data) == gathercol1)
  ind_col2 <- which(names(data) == gathercol2)
  if (ind_col1 > ind_col2) stop("gathercol1 must come before gathercol2 in the column names of the data.")
  columns <- names(data)[ind_col1:ind_col2]
  data <- suppressWarnings(mutate(data, across(all_of(columns), function(x) as.numeric(x))))
  data %>%
    mutate(
      freq = tolower(freq),
      freq = if_else(freq == "control", "con", freq),
      site = tolower(site),
      site = if_else(site == "swan", "swa", site),
      site = if_else(site == "swanton", "swa", site)
    ) %>%
    filter(
      site == filtersite,
      freq == "con"
    ) %>%
    pivot_longer(all_of(columns), names_to = "species.code", values_to = "intercepts") %>%
    mutate(
      intercepts = as.numeric(intercepts),
      intercepts = if_else(is.na(intercepts), 0, intercepts),
      species.code = tolower(species.code)
    ) %>%
    select(any_of(keep_cols)) %>%
    return()
}
cleanElkhornPlot <- function(data) {
  data %>%
    pivot_wider(names_from = "plot", values_from = "intercepts", names_prefix = "plot") %>%
    mutate(intercepts = (plot1 + plot2 + plot3 + plot4)) %>%
    select(-plot1, -plot2, -plot3, -plot4)
}

elk_counts_clean <- list()
elk_counts_clean[[1]] <- elk_counts[[1]] %>% cleanElkhornData("anaarv", "bare")
elk_counts_clean[[2]] <- elk_counts[[2]] %>%
  cleanElkhornData("aircar", "naspul") %>%
  cleanElkhornPlot()
elk_counts_clean[[3]] <- elk_counts[[3]] %>%
  cleanElkhornData("anaarv", "thatch") %>%
  cleanElkhornPlot()
elk_counts_clean[[4]] <- elk_counts[[4]] %>% cleanElkhornData("anaarv", "thatch")
elk_counts_clean[[5]] <- elk_counts[[5]] %>% cleanElkhornData("aircar", "vulpsp")
elk_counts_clean[[6]] <- elk_counts[[6]] %>% cleanElkhornData("aircar", "vulpsp")
elk_counts_clean[[7]] <- elk_counts[[7]] %>% cleanElkhornData("aircar", "vulpsp")
elk_counts_clean[[8]] <- elk_counts[[8]] %>% cleanElkhornData("aircar", "vulpsp")
elk_counts_clean[[9]] <- elk_counts[[9]] %>% cleanElkhornData("aircar", "vulpsp")
elk_counts_clean[[10]] <- elk_counts[[10]] %>% cleanElkhornData("aircar", "hormur")
elk_counts_clean[[11]] <- elk_counts[[11]] %>% cleanElkhornData("aircar", "vulpsp")
elk_counts_clean[[12]] <- elk_counts[[12]] %>% cleanElkhornData("aircar", "vulpsp")
elk_counts_clean[[13]] <- elk_counts[[13]] %>% cleanElkhornData("aircar", "vulpsp")
elk_counts_clean[[14]] <- elk_counts[[14]] %>% cleanElkhornData("aircar", "vulpsp")
elk_counts_clean[[15]] <- elk_counts[[15]] %>% cleanElkhornData("aircar", "vulpsp")
elk_counts_clean[[16]] <- elk_counts[[16]] %>% cleanElkhornData("aircar", "vulpsp")
elk_counts_clean[[17]] <- elk_counts[[17]] %>% cleanElkhornData("aircar", "vulpsp")
elk_counts_clean[[18]] <- elk_counts[[18]] %>% cleanElkhornData("aircar", "vulpia")
elk_counts_clean[[19]] <- elk_counts[[19]] %>% cleanElkhornData("aircar", "vulpia")
elk_counts_clean[[20]] <- elk_counts[[20]] %>% cleanElkhornData("aircar", "vulpia")

# lapply(elk_counts_clean, dim)
for (i in 1:length(elk_counts_clean)) {
  elk_counts_clean[[i]]$year <- (1999:2018)[i]
}
```

At this point, all that is left to do is to combine the objects so that we have one large object with each year of data in it. 

```{r Elkhorn graph prep, warning=FALSE}
elk_counts_df <- do.call(rbind, elk_counts_clean) %>%
  left_join(elkspp, by = "species.code") %>%
  filter(intercepts > 0) %>%
  select("rep", "year", "species.name", "intercepts", "guild") %>%
  mutate(
    site = "elkhorn",
    species.name = factor(species.name)
  )
# removing unwanted guilds (moss, litter, etc.)
elk_counts_df <- elk_counts_df %>%
  group_by(rep, year, guild, species.name) %>%
  summarize(intercepts = sum(intercepts)) %>%
  filter(
    guild != "Moss",
    guild != "Thatch",
    guild != "Bare"
  )
# unique(elk_counts_df$species.name)
# unique(elk_counts_df$guild)
elk_guilds <- elk_counts_df %>%
  group_by(rep, year, guild) %>%
  summarize(guildtotal = sum(intercepts)) %>%
  ungroup() %>%
  group_by(year, guild) %>%
  summarize(mean.intercepts = mean(guildtotal))

elkhorn_data <- elk_counts_df %>%
  filter(
    species.name != "Moss",
    species.name != "Thatch",
    species.name != "Bare ground"
  ) %>%
  mutate(site = "elkhorn")

elkhorn_data <- elkhorn_data %>%
  as_tibble() %>%
  select(site, year, plot = rep, species = species.name, guild, abund = intercepts) %>%
  mutate(year = as.integer(year), species = as.character(species) %>% str_trim(), guild = as.character(guild), abund = as.integer(abund), abund_type = "point_intercept") %>%
  arrange(site, year, plot, species)

write_csv(elkhorn_data, "data/community/tidy/elkhorn.csv")
```

Remove intermediate objects.

```{r}
rm(elk_counts, elk_counts_clean, elk_counts_df, elk_guilds, elkspp, out)
rm(filename, i, skips, year)
rm(elkhorn_data)
```

#### Swanton

These are data for grassland plots at Swanton Ranch. Data were collected by Karen Holl and Grey Hayes between 1999 and 2012. These data are structured similarly to the Elkhorn slough plots, so the code is also similar. For these analyses, I am using on the control plots (n = 3), and removing all other treatments from the dataset. 

Josie's comment (5/12/22): Swanton is close to the coast, always windy. The treatment is grazing.

```{r, message=FALSE}
Swanspp <- read_csv("data/community/raw/HollData/ElkhornSpecies.csv") %>%
  mutate(species.code = tolower(species.code))
Swan_guilds <- read_csv("data/community/raw/HollData/ElkhornGuilds.csv")
swan_counts <- list()
for (i in 1:14) {
  year <- as.character(1999:2012)[i]
  skips <- c(4, 3, 3, 3, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0)
  if (i != 10) {
    filename <- paste0("data/community/raw/HollData/Elk_", year, ".csv")
  } else {
    filename <- "data/community/raw/HollData/swanton_08.csv"
  }
  out <- read_csv(filename, skip = skips[i], show_col_types = FALSE)
  swan_counts[[year]] <- out
}
swan_counts <- lapply(seq_along(swan_counts), function(i) {
  rename_with(swan_counts[[i]], tolower) %>%
    rename_with(~ sub("frequency", "freq", sub("treatment", "treat", sub("replicate", "rep", sub("9$", "", .x))))) %>%
    select(-starts_with("comment"), -starts_with("..."), -starts_with("0"))
})

# lapply(swan_counts, names)
```

```{r Cleaning Swanton, warning=FALSE}
swan_counts_clean <- list()
swan_counts_clean[[1]] <- swan_counts[[1]] %>% cleanElkhornData("anaarv", "bare", site = "swa")
swan_counts_clean[[2]] <- swan_counts[[2]] %>%
  cleanElkhornData("aircar", "naspul", site = "swa") %>%
  cleanElkhornPlot()
swan_counts_clean[[3]] <- swan_counts[[3]] %>%
  cleanElkhornData("anaarv", "thatch", site = "swa") %>%
  cleanElkhornPlot()
swan_counts_clean[[4]] <- swan_counts[[4]] %>% cleanElkhornData("anaarv", "thatch", site = "swa")
swan_counts_clean[[5]] <- swan_counts[[5]] %>% cleanElkhornData("aircar", "vulpsp", site = "swa")
swan_counts_clean[[6]] <- swan_counts[[6]] %>% cleanElkhornData("aircar", "vulpsp", site = "swa")
swan_counts_clean[[7]] <- swan_counts[[7]] %>% cleanElkhornData("aircar", "vulpsp", site = "swa")
swan_counts_clean[[8]] <- swan_counts[[8]] %>% cleanElkhornData("aircar", "vulpsp", site = "swa")
swan_counts_clean[[9]] <- swan_counts[[9]] %>% cleanElkhornData("aircar", "vulpsp", site = "swa")
swan_counts_clean[[10]] <- swan_counts[[10]] %>% cleanElkhornData("aircar", "spearv", site = "swa")
swan_counts_clean[[11]] <- swan_counts[[11]] %>% cleanElkhornData("aircar", "vulpsp", site = "swa")
swan_counts_clean[[12]] <- swan_counts[[12]] %>% cleanElkhornData("aircar", "vulpsp", site = "swa")
swan_counts_clean[[13]] <- swan_counts[[13]] %>% cleanElkhornData("aircar", "vulpsp", site = "swa")
swan_counts_clean[[14]] <- swan_counts[[14]] %>% cleanElkhornData("aircar", "vulpsp", site = "swa")

# lapply(swan_counts_clean, dim)
for (i in 1:length(swan_counts_clean)) {
  swan_counts_clean[[i]]$year <- (1999:2012)[i]
}
```

```{r Swanton Graph Prep, warning=FALSE}
swan_counts_df <- do.call(rbind, swan_counts_clean) %>%
  left_join(Swanspp, by = "species.code") %>%
  filter(intercepts > 0) %>%
  select("rep", "year", "species.name", "intercepts", "guild") %>%
  mutate(
    site = "swanton",
    species.name = factor(species.name)
  )
# removing unwanted guilds (moss, litter, etc.)
swan_counts_df <- swan_counts_df %>%
  group_by(rep, year, guild, species.name) %>%
  summarize(intercepts = sum(intercepts)) %>%
  filter(
    guild != "Moss",
    guild != "Thatch",
    guild != "Bare"
  )
# unique(swan_counts_df$species.name)
# unique(swan_counts_df$guild)
elk_guilds <- swan_counts_df %>%
  group_by(rep, year, guild) %>%
  summarize(guildtotal = sum(intercepts)) %>%
  ungroup() %>%
  group_by(year, guild) %>%
  summarize(mean.intercepts = mean(guildtotal))

swanton_data <- swan_counts_df %>%
  filter(
    species.name != "Moss",
    species.name != "Thatch",
    species.name != "Bare ground"
  ) %>%
  mutate(site = "swanton")

swanton_data <- swanton_data %>%
  as_tibble() %>%
  select(site, year, plot = rep, species = species.name, guild, abund = intercepts) %>%
  mutate(year = as.integer(year), species = as.character(species) %>% str_trim(), guild = as.character(guild), abund = as.integer(abund), abund_type = "point_intercept") %>%
  arrange(site, year, plot, species)

write_csv(swanton_data, "data/community/tidy/swanton.csv")
```

Remove intermediate objects.

```{r}
rm(elk_guilds, out, swan_counts, swan_counts_clean, swan_counts_df, Swan_guilds, Swanspp)
rm(filename, i, skips, year)
rm(swanton_data)
```

Update on 6/3/22. Karen corrected species names, so use the new CSV file for Swanton data.

Further update on 6/9/22. Karen made one more minor correction. Same file.

```{r}
read_csv("data/community/raw/HollData/swanton-updated.csv") %>%
  arrange(site, year, plot, species) %>%
  write_csv("data/community/tidy/swanton.csv")
```

#### UCSC

These are data for grassland plots at UCSC. Data were collected by Karen Holl and Grey Hayes between 1999 and 2012. These data are structured similarly to the Elkhorn slough plots, so the code is also similar. For these analyses, we are using on the control plots (n = 3), and removing all other treatments from the dataset. 

Josie's comment (5/12/22): The site is in East Meadow. The treatment is grazing.

```{r Importing UCSC, warning=FALSE, message=FALSE}
UCSCspp <- read_csv("data/community/raw/HollData/ElkhornSpecies.csv") %>%
  mutate(species.code = tolower(species.code))
UCSC_guilds <- read_csv("data/community/raw/HollData/ElkhornGuilds.csv")
ucsc_counts <- list()
for (i in 1:14) {
  year <- as.character(1999:2012)[i]
  skips <- c(4, 3, 3, 3, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0)
  if (i != 10) {
    filename <- paste0("data/community/raw/HollData/Elk_", year, ".csv")
  } else {
    filename <- "data/community/raw/HollData/ucsc_08.csv"
  }
  out <- read_csv(filename, skip = skips[i], show_col_types = FALSE)
  ucsc_counts[[year]] <- out
}
ucsc_counts <- lapply(seq_along(ucsc_counts), function(i) {
  rename_with(ucsc_counts[[i]], tolower) %>%
    rename_with(~ sub("frequency", "freq", sub("treatment", "treat", sub("replicate", "rep", sub("9$", "", .x))))) %>%
    select(-starts_with("comment"), -starts_with("..."), -starts_with("0"))
})

# lapply(ucsc_counts, names)
```

After creating objects for each year, we will clean each to a compatible structure. 

```{r Cleaning UCSC, warning=FALSE}
ucsc_counts_clean <- list()
ucsc_counts_clean[[1]] <- ucsc_counts[[1]] %>% cleanElkhornData("anaarv", "bare", site = "ucsc")
ucsc_counts_clean[[2]] <- ucsc_counts[[2]] %>%
  cleanElkhornData("aircar", "naspul", site = "ucsc") %>%
  cleanElkhornPlot()
ucsc_counts_clean[[3]] <- ucsc_counts[[3]] %>%
  cleanElkhornData("anaarv", "thatch", site = "ucsc") %>%
  cleanElkhornPlot()
ucsc_counts_clean[[4]] <- ucsc_counts[[4]] %>% cleanElkhornData("anaarv", "thatch", site = "ucsc")
ucsc_counts_clean[[5]] <- ucsc_counts[[5]] %>% cleanElkhornData("aircar", "vulpsp", site = "ucsc")
ucsc_counts_clean[[6]] <- ucsc_counts[[6]] %>% cleanElkhornData("aircar", "vulpsp", site = "ucsc")
ucsc_counts_clean[[7]] <- ucsc_counts[[7]] %>% cleanElkhornData("aircar", "vulpsp", site = "ucsc")
ucsc_counts_clean[[8]] <- ucsc_counts[[8]] %>% cleanElkhornData("aircar", "vulpsp", site = "ucsc")
ucsc_counts_clean[[9]] <- ucsc_counts[[9]] %>% cleanElkhornData("aircar", "vulpsp", site = "ucsc")
ucsc_counts_clean[[10]] <- ucsc_counts[[10]] %>% cleanElkhornData("aircar", "brohor", site = "ucsc")
ucsc_counts_clean[[11]] <- ucsc_counts[[11]] %>% cleanElkhornData("aircar", "vulpsp", site = "ucsc")
ucsc_counts_clean[[12]] <- ucsc_counts[[12]] %>% cleanElkhornData("aircar", "vulpsp", site = "ucsc")
ucsc_counts_clean[[13]] <- ucsc_counts[[13]] %>% cleanElkhornData("aircar", "vulpsp", site = "ucsc")
ucsc_counts_clean[[14]] <- ucsc_counts[[14]] %>% cleanElkhornData("aircar", "vulpsp", site = "ucsc")

# lapply(ucsc_counts_clean, dim)
for (i in 1:length(ucsc_counts_clean)) {
  ucsc_counts_clean[[i]]$year <- (1999:2012)[i]
}
```

Once the data is cleaned and in a similar format, it's ready to be compiled. 

```{r Compiling UCSC, warning=FALSE}
ucsc_counts_df <- do.call(rbind, ucsc_counts_clean) %>%
  left_join(UCSCspp, by = "species.code") %>%
  filter(intercepts > 0) %>%
  select("rep", "year", "species.name", "intercepts", "guild") %>%
  mutate(
    site = "ucsc",
    species.name = factor(species.name)
  )
# removing unwanted guilds (moss, litter, etc.)
ucsc_counts_df <- ucsc_counts_df %>%
  group_by(rep, year, guild, species.name) %>%
  summarize(intercepts = sum(intercepts)) %>%
  filter(
    guild != "Moss",
    guild != "Thatch",
    guild != "Bare"
  )
# unique(ucsc_counts_df$species.name)
# unique(ucsc_counts_df$guild)
elk_guilds <- ucsc_counts_df %>%
  group_by(rep, year, guild) %>%
  summarize(guildtotal = sum(intercepts)) %>%
  ungroup() %>%
  group_by(year, guild) %>%
  summarize(mean.intercepts = mean(guildtotal))

ucsc_data <- ucsc_counts_df %>%
  filter(
    species.name != "Moss",
    species.name != "Thatch",
    species.name != "Bare ground"
  ) %>%
  mutate(site = "ucsc")

ucsc_data <- ucsc_data %>%
  as_tibble() %>%
  select(site, year, plot = rep, species = species.name, guild, abund = intercepts) %>%
  mutate(year = as.integer(year), species = as.character(species) %>% str_trim(), guild = as.character(guild), abund = as.integer(abund), abund_type = "point_intercept") %>%
  arrange(site, year, plot, species)

write_csv(ucsc_data, "data/community/tidy/ucsc.csv")
```

Remove intermediate objects.

```{r}
rm(elk_guilds, out, ucsc_counts, ucsc_counts_clean, ucsc_counts_df, UCSC_guilds, UCSCspp)
rm(filename, i, skips, year)
rm(ucsc_data)
```

Remove intermediate objects.

```{r}
rm(cleanElkhornData, cleanElkhornPlot)
```

## Combine all community data

Read directly from CSV file(s) for all experimental and observational data. Make sure data types are correct. 

```{r}
tidy_exp_tbl <- read_csv("data/community/tidy/jrgce.csv", col_types = "ciccccdc") %>%
  bind_rows(read_csv("data/community/tidy/mclexp.csv", col_types = "ciccccdc")) %>%
  bind_rows(read_csv("data/community/tidy/scide.csv", col_types = "ciccccdc"))

tidy_obs_tbl <- read_csv("data/community/tidy/angelo.csv", col_types = "cicccdc") %>%
  bind_rows(read_csv("data/community/tidy/carrizo.csv", col_types = "cicccdc")) %>%
  bind_rows(read_csv("data/community/tidy/elkhorn.csv", col_types = "cicccdc")) %>%
  bind_rows(read_csv("data/community/tidy/jasper.csv", col_types = "cicccdc")) %>%
  bind_rows(read_csv("data/community/tidy/mclann.csv", col_types = "cicccdc")) %>%
  bind_rows(read_csv("data/community/tidy/mclserp.csv", col_types = "cicccdc")) %>%
  bind_rows(read_csv("data/community/tidy/pleasantonridge.csv", col_types = "cicccdc")) %>%
  bind_rows(read_csv("data/community/tidy/sunol.csv", col_types = "cicccdc")) %>%
  bind_rows(read_csv("data/community/tidy/swanton.csv", col_types = "cicccdc")) %>%
  bind_rows(read_csv("data/community/tidy/ucsc.csv", col_types = "cicccdc")) %>%
  bind_rows(read_csv("data/community/tidy/vascocaves.csv", col_types = "cicccdc"))
```

## Correct species names

### Prepare species list

Compile a unique species-guild list from the tidy data.

```{r}
tidy_tax_tbl <- tidy_exp_tbl %>%
  select(species, guild) %>%
  bind_rows(tidy_obs_tbl %>% select(species, guild)) %>%
  distinct() %>%
  arrange(species, guild)
```

Download species name using the taxize package. 

```{r, eval=FALSE}
taxize::get_gbifid_(tidy_tax_tbl$species) %>%
  as_tibble_col(column_name = "gbif") %>%
  mutate(queryname = tidy_tax_tbl$species) %>%
  unnest(cols = c(gbif)) %>%
  select(queryname, everything()) %>%
  write_rds("data/taxonomy/taxize-2022-06-15.rds")
```

Send the list to Josie and Justin for manual correction.

### Rename species

Read the expert table manually complied by Josie and Justin.

```{r}
googlesheets4::gs4_deauth()
misspelling_tbl <- googlesheets4::read_sheet(
  "1ez43lbFMsTJwmkW_23icDabt30ttDhVZ-1vK8Ts_Mck",
  sheet = "Misspelling",
  n_max = Inf,
  na = c("", "NA") # guild = "NA" means NA
)
```

Rename species and guild using the expert table.

```{r}
tidy_exp_tbl %>%
  rename(
    "original_species" = "species",
    "original_guild" = "guild"
  ) %>%
  left_join(
    misspelling_tbl,
    by = c("original_species", "original_guild")
  ) %>%
  filter(keep) %>%
  select(
    site, year, plot, treat,
    species = corrected_species, guild = corrected_guild,
    abund, abund_type
  ) %>%
  arrange(site, year, plot, species) %>%
  write_rds("data/community/all-experimental-data.rds")

tidy_obs_tbl %>%
  rename(
    "original_species" = "species",
    "original_guild" = "guild"
  ) %>%
  left_join(
    misspelling_tbl,
    by = c("original_species", "original_guild")
  ) %>%
  filter(keep) %>%
  select(
    site, year, plot,
    species = corrected_species, guild = corrected_guild,
    abund, abund_type
  ) %>%
  arrange(site, year, plot, species) %>%
  write_rds("data/community/all-observational-data.rds")
```

Remove intermediate objects.

```{r}
rm(misspelling_tbl, tidy_exp_tbl, tidy_obs_tbl, tidy_tax_tbl)
```
