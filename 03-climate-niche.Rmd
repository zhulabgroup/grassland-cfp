# Climate niche estimation

Setup and load packages.

```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, eval = TRUE)
```

```{r}
library(tidyverse)
library(patchwork)
library(sf)
```

## GBIF occurrence data

The first question is what the geographic extent we search for occurrence records from GBIF. Joise used California for convenience, but it seems to make more sense using an ecological, not administrative, boundary.

We can try NEON domains.

![NEON domians](images/neon-domains.png)

We can also try [biodiversity hotspots](https://www.cepf.net/our-work/biodiversity-hotspots). The most relevant one is California Floristic Province (CFP). Study sites seem to distribute nicely within CFP. 

```{r}
site_sf <- read_rds("data/community/site-info.rds")
knitr::kable(site_sf)
```

Make a map overlaying sites with CFP and admin boundaries. 

```{r}
cfp_sf <- sf::st_read("data/occurrence/hotspots/hotspots_2016_1.shp") %>%
  filter(
    NAME == "California Floristic Province",
    Type == "hotspot area"
  )

(ggplot(map_data("county", c("california", "nevada", "oregon"))) +
  geom_polygon(aes(long, lat, group = group),
    fill = "white", color = "grey75"
  ) +
  geom_sf(data = cfp_sf, alpha = .5) +
  geom_sf(data = site_sf, color = "red", aes(text = name)) +
  labs(x = "Longitude (deg)", y = "Latitude (deg)")
) %>%
  plotly::ggplotly(tooltip = "text")
```

Load the master species list.

```{r}
spp_tbl <- read_rds("data/community/match-species-table.rds") %>%
  filter(kingdom == "Plantae") %>%
  group_by(queryname) %>%
  slice_head(n = 1) %>% # choose the top 1
  ungroup() %>%
  select(queryname, canonicalname, everything()) %>%
  distinct(canonicalname, scientificname)
```


Extract occurrence data from GBIF, using the species list. The query output is an object of class `occdat`. Convert it to nested data, then unnest the data.

```{r, eval = FALSE}
gbif_occ <- spp_tbl$canonicalname %>%
  spocc::occ(
    query = ., from = "gbif", has_coords = TRUE, limit = 1e6,
    gbifopts = list(
      continent = "north_america",
      country = "US",
      stateProvince = "California",
      hasGeospatialIssue = FALSE
    )
  )

tibble(queryName = spp_tbl$canonicalname, gbif = gbif_occ$gbif$data) %>%
  unnest(cols = c(gbif)) %>%
  write_rds("data/occurrence/gbif/all-spp-california.rds")
```

Make maps to visualize species.

```{r}
occ_sf <- read_rds("data/occurrence/gbif/all-spp-california.rds") %>%
  st_as_sf(coords = c("longitude", "latitude"), crs = 4326) # WGS84
```

Optional step: filter out non-California locations.

```{r}
occ_sf <- occ_sf %>%
  # select(which(st_agr(.) == "constant")) %>%
  st_intersection(USAboundaries::us_states(states = "California") %>% st_geometry()) # WGS 84
```

## PRISM climate data

Download and process PRISM using the prism package.

```{r}
prism::prism_set_dl_dir("data/climate/prism/")
prism::get_prism_normals("tmean", "800m", annual = TRUE, keepZip = FALSE)
prism::get_prism_normals("ppt", "800m", annual = TRUE, keepZip = FALSE)
prism::get_prism_normals("vpdmax", "800m", annual = TRUE, keepZip = FALSE)
```

Load raster data using the raster package.

```{r}
tmean_ras <- prism::prism_archive_subset("tmean", "annual normals", resolution = "800m") %>%
  prism::pd_to_file() %>%
  raster::raster()
ppt_ras <- prism::prism_archive_subset("ppt", "annual normals", resolution = "800m") %>%
  prism::pd_to_file() %>%
  raster::raster()
vpdmax_ras <- prism::prism_archive_subset("vpdmax", "annual normals", resolution = "800m") %>%
  prism::pd_to_file() %>%
  raster::raster()
```

Extract climate values using longitude and latitude. But first, convert GBIF coordinates in WGS84 to PRISM coordinates in NAD83.

```{r}
occ_sf <- occ_sf %>%
  st_transform(crs = st_crs(tmean_ras)) %>% # NAD83
  select(species = queryName)
```

```{r}
occ_sf <- occ_sf %>%
  mutate(
    tmean = raster::extract(tmean_ras, occ_sf),
    ppt = raster::extract(ppt_ras, occ_sf),
    vpdmax = raster::extract(vpdmax_ras, occ_sf)
  )
```

## Species climate niches

Visualize individual species occurrence in climate space.

```{r calc-spp-niche-parallel, eval=FALSE}
library(foreach)
library(doParallel)
num_cores <- 22 # socs-stats has 44 cores
registerDoParallel(num_cores)

# gbif summary
tmean_rng <- range(occ_sf$tmean)
ppt_rng <- range(occ_sf$ppt)
n_occ_tot <- nrow(occ_sf)

# exp data summary
exp_tbl <- read_rds("data/community/all-experimental-data.rds")
n_exp_tot <- nrow(exp_tbl)

# obs data summary
obs_tbl <- read_rds("data/community/all-observational-data.rds")
n_obs_tot <- nrow(obs_tbl)

niche_gg <- foreach(
  sp = unique(occ_sf$species),
  .packages = "tidyverse"
) %dopar% {
  occ_sp_sf <- filter(occ_sf, species == sp)
  n_occ_sp <- nrow(occ_sp_sf)

  n_exp_sp <- exp_tbl %>%
    filter(species == sp) %>%
    nrow()
  n_obs_sp <- obs_tbl %>%
    filter(species == sp) %>%
    nrow()

  occ_geog <- ggplot(map_data("county", "california")) +
    geom_polygon(aes(long, lat, group = group),
      fill = "white", colour = "grey50"
    ) +
    geom_sf(data = occ_sp_sf, alpha = .5) +
    labs(x = "Longitude (deg)", y = "Latitude (deg)", title = sp) +
    theme(plot.title = element_text(face = "italic"))

  occ_clim <- ggplot(occ_sp_sf, aes(tmean, ppt)) +
    geom_point(alpha = .5) +
    geom_rug(alpha = .5) +
    stat_ellipse() +
    lims(x = tmean_rng, y = ppt_rng) +
    # scale_y_log10() + # log scale ppt
    labs(
      x = "Mean annual temperature (degC)", y = "Annual precipitation (mm)",
      title = str_c(
        "n_occ = ", n_occ_sp, " (", round(n_occ_sp / n_occ_tot * 100, digits = 3), "%)\n",
        "n_exp = ", n_exp_sp, " (", round(n_exp_sp / n_exp_tot * 100, digits = 3), "%)\n",
        "n_obs = ", n_obs_sp, " (", round(n_obs_sp / n_obs_tot * 100, digits = 3), "%)"
      )
    )

  occ_geog + occ_clim # no need to print(); will slow down
}

names(niche_gg) <- unique(occ_sf$species)

stopImplicitCluster()
```

Print all species into a multi-page PDF.

```{r, eval=FALSE}
# runtime ~= 4 min
pdf("figures/species-climate-niche.pdf", width = 8, height = 8 * .618)
print(niche_gg)
dev.off()
```

Summarize species climate niches (mean, sd, etc.).

```{r}
niche_tbl <- occ_sf %>%
  as_tibble() %>% # drop sf geometry--too slow and not needed for this summary
  group_by(species) %>%
  summarize(
    occ_n = n(),
    tmean_occ_mean = mean(tmean, na.rm = TRUE), tmean_occ_sd = sd(tmean, na.rm = TRUE),
    ppt_occ_mean = mean(ppt, na.rm = TRUE), ppt_occ_sd = sd(ppt, na.rm = TRUE),
    vpdmax_occ_mean = mean(vpdmax, na.rm = TRUE), vpdmax_occ_sd = sd(vpdmax, na.rm = TRUE),
  )
```

Visualize species niches in climate space.

```{r kai-niche-plot, fig.cap="Species climate niches (mean and standard error)"}
(niche_tbl %>%
  ggplot(aes(tmean_occ_mean, ppt_occ_mean, text = species)) +
  geom_point(alpha = .5) +
  geom_errorbarh(aes(xmin = tmean_occ_mean - tmean_occ_sd / sqrt(occ_n), xmax = tmean_occ_mean + tmean_occ_sd / sqrt(occ_n)), alpha = .3) +
  geom_errorbar(aes(ymin = ppt_occ_mean - ppt_occ_sd / sqrt(occ_n), ymax = ppt_occ_mean + ppt_occ_sd / sqrt(occ_n)), alpha = .3) +
  labs(
    x = "Species occurrence mean temperature (degC)",
    y = "Species occurrence mean precipitation (mm)"
  )
) %>%
  plotly::ggplotly(tooltip = "text")
```

This figure compares well with Josie's estimates. 

```{r, fig.cap="Species climate niches (mean and standard error) estimated by Josie"}
(read_csv("data/archives/CAGrasslandCommunityChange-master/Analysis/CTI Data/AllSite_CTI_08_2020.csv") %>%
  filter(
    species.name != "Linanthus jepsonii",
    species.name != "Linanthus latisectus",
    relcov >= 0
  ) %>%
  select(species = species.name, guild, tmp = meanT, ppt = meanp) %>%
  distinct() %>%
  ggplot(aes(tmp, ppt, text = species)) +
  geom_point(alpha = .5) +
  # geom_smooth(method = "lm", aes(tmp, ppt)) +
  labs(
    x = "Species occurrence mean temperature (degC)",
    y = "Species occurrence mean precipitation (mm)"
  )
) %>%
  plotly::ggplotly(tooltip = "text")
```

Add VPDmax visualization.

```{r, fig.cap="Temp and VPD niches"}
(niche_tbl %>%
  ggplot(aes(tmean_occ_mean, vpdmax_occ_mean, text = species)) +
  geom_point(alpha = .5) +
  labs(
    x = "Species occurrence mean temperature (degC)",
    y = "Species occurrence max VPD (hPa)"
  )
) %>%
  plotly::ggplotly(tooltip = "text")
```

Save niche estimates.

```{r}
write_rds(niche_tbl, "data/climate/niche_estimates.rds")
```
