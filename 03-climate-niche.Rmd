# Climate niche estimation

Setup and load packages

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
```

```{r}
library(tidyverse)
```

## GBIF occurrence data

Load the master species list.

```{r}
spp_tbl <- read_rds("data/community/match-species-table.rds") %>%
  filter(kingdom == "Plantae") %>%
  group_by(queryname) %>%
  slice_head(n = 1) %>% # choose the top 1
  ungroup() %>%
  select(queryname, canonicalname, everything()) %>%
  distinct(canonicalname, scientificname)
```

Extract occurrence data from GBIF, using the species list. The query output is an object of class `occdat`. Convert it to nested data, then unnest the data.

```{r eval=FALSE}
gbif_occ <- spp_tbl$canonicalname %>%
  spocc::occ(
    query = ., from = "gbif", has_coords = TRUE, limit = 1e6,
    gbifopts = list(
      continent = "north_america",
      country = "US",
      stateProvince = "California",
      hasGeospatialIssue = FALSE
    )
  )

tibble(queryName = spp_tbl$canonicalname, gbif = gbif_occ$gbif$data) %>%
  unnest(cols = c(gbif)) %>%
  write_rds("data/occurrence/gbif/all-spp-california.rds")
```

Make maps to visualize species.

```{r, fig.cap="GBIF occurrence map for all species"}
occ_tbl <- read_rds("data/occurrence/gbif/all-spp-california.rds") %>%
  select(name = queryName, longitude, latitude, locality)

mapr::map_leaflet(occ_tbl, size = 1)
```

```{r, fig.cap="GBIF occurrence map for most frequently occurred 9 species (`map_leaflet()` can only show 9 colors)"}
mapr::map_leaflet(occ_tbl %>%
  filter(name %in% (
    occ_tbl %>%
      count(name) %>%
      top_n(9) %>%
      pull(name)
  )), size = 1)
```

An outstanding question is the geographic extent to pull out GBIF data. Joise used California, but it seems to make more sense using an ecological, not administrative, boundary.

![NEON domians](images/neon-domains.png)

## PRISM climate data

Download and process PRISM using the prism package.

```{r}
prism::prism_set_dl_dir("data/climate/prism/")
prism::get_prism_normals("tmean", "800m", annual = TRUE, keepZip = FALSE)
prism::get_prism_normals("ppt", "800m", annual = TRUE, keepZip = FALSE)
```

Load raster data using the raster package.

```{r}
tmean_ras <- prism::prism_archive_subset("tmean", "annual normals", resolution = "800m") %>%
  prism::pd_to_file() %>%
  raster::raster()
ppt_ras <- prism::prism_archive_subset("ppt", "annual normals", resolution = "800m") %>%
  prism::pd_to_file() %>%
  raster::raster()
```

Extract climate values using longitude and latitude.

```{r}
occ_tbl <- occ_tbl %>%
  mutate(
    tmp = raster::extract(tmean_ras, select(occ_tbl, longitude, latitude)),
    ppt = raster::extract(ppt_ras, select(occ_tbl, longitude, latitude))
  )
```

Estimate species climate niches.

```{r}
niche_tbl <- occ_tbl %>%
  group_by(name) %>%
  summarize(
    tmp_mean = mean(tmp, na.rm = TRUE), tmp_sd = sd(tmp, na.rm = TRUE), tmp_se = plotrix::std.error(tmp, na.rm = TRUE),
    ppt_mean = mean(ppt, na.rm = TRUE), ppt_sd = sd(ppt, na.rm = TRUE), ppt_se = plotrix::std.error(ppt, na.rm = TRUE)
  )
```

Visualize species niches in climate space.

```{r fig.cap="Species climate niches"}
(niche_tbl %>%
  ggplot(aes(tmp_mean, ppt_mean, text = name)) +
  geom_point(alpha = .9) +
  geom_errorbarh(aes(xmin = tmp_mean - tmp_se, xmax = tmp_mean + tmp_se), alpha = .3) +
  geom_errorbar(aes(ymin = ppt_mean - ppt_se, ymax = ppt_mean + ppt_se), alpha = .3) +
  labs(
    x = "Species occurrence temperature (degC)",
    y = "Species occurrence precipitation (mm)"
  )
) %>%
  plotly::ggplotly(tooltip = "text")
```


## Compare with Josie's estimates

Explore GBIF data extracted by Josie.

```{r eval=FALSE}
gbif_josie <- read_rds("data/archives/CAGrasslandCommunityChange-master/Analysis/GBIF_Data/AllKaren_GBIF.rds")

gbif_josie %>% distinct(species.name)

gbif_josie %>%
  st_as_sf(coords = c("longitude", "latitude")) %>%
  ggplot() +
  geom_sf()
```
