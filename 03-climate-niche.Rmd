# Climate niche estimation

Setup and load packages

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
```

```{r}
library(tidyverse)
library(sf)
# library(patchwork)
# library(plotly)
```

## GBIF

Load all experimental and observational data to prepare a master species list.

```{r}
exp_spp <- read_rds("data/community/all-experimental-data.rds") %>%
  filter(abund > 0) %>%
  select(species) %>%
  distinct() %>%
  arrange(species) %>% 
  pull(species)

obs_spp <- read_rds("data/community/all-observational-data.rds") %>%
  filter(abund > 0) %>%
  select(species) %>%
  distinct() %>%
  arrange(species) %>% 
  pull(species)

all_spp <- c(exp_spp, obs_spp) %>%
  unique() %>%
  sort()
```

Extract occurrence data from GBIF, using the species list. The query output is an object of class `occdat`. Convert it to nested data, then unnest the data.

```{r eval=FALSE}
gbif_occ <- all_spp %>%
  spocc::occ(
    query = ., from = "gbif", has_coords = TRUE, limit = 1e6,
    gbifopts = list(
      continent = "north_america",
      country = "US",
      stateProvince = "California",
      hasGeospatialIssue = FALSE
    )
  )

gbif_tib <- gbif_occ$gbif$data %>%
  tibble(queryName = all_spp, gbif = .) %>%
  unnest(cols = c(gbif))

write_rds(gbif_tib, "data/occurrence/gbif/all-spp-california.rds")
```

Make maps to visualize species.

```{r, fig.cap="GBIF occurrence map for all species"}
gbif_tib <- read_rds("data/occurrence/gbif/all-spp-california.rds") %>%
  select(name = queryName, sci_name = name, longitude, latitude, locality)

mapr::map_leaflet(gbif_tib, size = 1)
```

```{r, fig.cap="GBIF occurrence map for most frequently occurred 9 species (`map_leaflet()` can only show 9 colors)"}
mapr::map_leaflet(gbif_tib %>%
  filter(name %in% (
    gbif_tib %>%
      count(name) %>%
      top_n(9) %>%
      pull(name)
  )), size = 1)
```

An outstanding question is the geographic extent to pull out GBIF data. Joise used California, but it seems to make more sense using an ecological, not administrative, boundary.

![NEON domians](images/neon-domains.png)

## Compare with Josie's estimates

Explore GBIF data extracted by Josie.

```{r eval=FALSE}
gbif_josie <- read_rds("data/archives/CAGrasslandCommunityChange-master/Analysis/GBIF_Data/AllKaren_GBIF.rds")

gbif_josie %>% distinct(species.name)

gbif_josie %>%
  st_as_sf(coords = c("longitude", "latitude")) %>%
  ggplot() +
  geom_sf()
```
