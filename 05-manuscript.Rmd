# Manuscript display items

Setup and load packages.

```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, eval = TRUE)
```

```{r}
library(tidyverse)
library(sf)
library(patchwork)
```

## Main text

Figures and tables in the main text.

### Climate niche estimation

Read in GBIF-CHELSA, and niche estimate data.

```{r}
gbif_chelsa_sf <- read_rds("data/climate/climate-gbif-2022-05-10.rds") %>%
  select(geometry, key, species, tmp = chelsa_tmp, ppt = chelsa_ppt, vpd = chelsa_vpd) %>%
  st_as_sf(crs = "+proj=longlat +datum=WGS84 +no_defs")

niche_tbl <- read_rds("data/occurrence/niche-estimates-cfp-2022-05-10.rds")
```

Choose two example species and assign colors. From Justin's email 5/10/22:

> Are you aiming for natives specifically? I think Stipa pulchra works well for the dry, Festuca perennis is also commonly known since its a weed, in the same area. 
> 
> For wet species I don't recommend Allium, I might recommend Danthonia californica, or Juncus bufonis (Juncus are rushes and also typically though of as 'wetter' or cooler species). For a non-native if desired - Holcus lanatus would be a good choice.

```{r}
cool_sp <- "Allium falcifolium"
warm_sp <- "Stipa pulchra"

gbif_chelsa_sf <- gbif_chelsa_sf %>%
  mutate(species_type = case_when(
    species == cool_sp ~ "cool",
    species == warm_sp ~ "warm",
    TRUE ~ "other"
  ))
```

Create three panels separately (fast without rendering).

```{r}
# set up plot params using alphabetical species type names
species_color <- c(cool = "blue", other = gray(.75), warm = "red")
species_size <- c(cool = 1, other = .01, warm = 1)
species_alpha <- c(cool = .5, other = .05, warm = .5)

# occ_geog_gg <-
ggplot() +
  geom_sf(
    data = rnaturalearth::ne_states(
      country = c("Mexico", "United States of America"),
      returnclass = "sf"
    ),
    fill = NA,
    color = gray(.25)
  ) +
  geom_sf(
    data = gbif_chelsa_sf,
    aes(color = species_type, size = species_type, alpha = species_type)
  ) +
  scale_color_manual(values = species_color) +
  scale_size_manual(values = species_size) +
  scale_alpha_manual(values = species_alpha) +
  coord_sf(xlim = c(-125, -115), ylim = c(28, 44)) +
  scale_x_continuous(breaks = c(-125, -120, -115)) +
  scale_y_continuous(breaks = c(30, 35, 40)) +
  labs(x = "Longitude", y = "Latitude") +
  guides(color = "none", size = "none", alpha = "none")

occ_clim_gg <-
  ggplot(mapping = aes(tmp, ppt)) +
  geom_point(
    data = gbif_chelsa_sf, # all species
    color = gray(.5),
    alpha = .1, size = .1
  ) +
  geom_point(
    data = gbif_chelsa_sf %>% filter(species == cool_sp), # warm species
    color = cool_col,
    alpha = .5, size = .5
  ) +
  geom_point(
    data = gbif_chelsa_sf %>% filter(species == warm_sp), # warm species
    color = warm_col,
    alpha = .5, size = .5
  ) +
  labs(x = "Mean annual temperature (째C)", y = "Annual precipitation (mm)")

niche_gg <-
  ggplot(
    mapping = aes(
      x = tmp_occ_mean,
      y = ppt_occ_mean,
      xmin = tmp_occ_mean - tmp_occ_sd / sqrt(occ_n),
      xmax = tmp_occ_mean + tmp_occ_sd / sqrt(occ_n),
      ymin = ppt_occ_mean - ppt_occ_sd / sqrt(occ_n),
      ymax = ppt_occ_mean + ppt_occ_sd / sqrt(occ_n),
      label = species
    )
  ) +
  geom_point(
    data = niche_tbl,
    color = gray(0),
    alpha = .5
  ) +
  geom_errorbarh(
    data = niche_tbl,
    color = gray(.5),
    alpha = .5
  ) +
  geom_errorbar(
    data = niche_tbl,
    color = gray(.5),
    alpha = .5
  ) +
  geom_point( # cool species
    data = niche_tbl %>% filter(species == cool_sp),
    color = cool_col,
    size = 2
  ) +
  geom_label(
    data = niche_tbl %>% filter(species == cool_sp),
    color = cool_col,
    fill = NA,
    fontface = "italic",
    label.padding = unit(.5, "lines"),
    label.size = 0,
    vjust = "outward", hjust = "outward"
  ) +
  geom_point( # warm species
    data = niche_tbl %>% filter(species == warm_sp),
    color = warm_col,
    size = 2
  ) +
  geom_label(
    data = niche_tbl %>% filter(species == warm_sp),
    color = warm_col,
    fill = NA,
    fontface = "italic",
    label.padding = unit(.5, "lines"),
    label.size = 0,
    vjust = "outward", hjust = "outward"
  ) +
  scale_x_continuous(expand = expansion(mult = .1)) + # expand padding to show label
  scale_y_continuous(expand = expansion(mult = .1)) +
  labs(x = "Mean annual temperature (째C)", y = "Annual precipitation (mm)")
```

Combine three panels.

```{r}
fig1_gg <- occ_geog_gg + occ_clim_gg + niche_gg +
  plot_annotation(tag_levels = "A") +
  plot_layout(design = "
  ABB
  ABB
  CCC
  CCC
  CCC
  ")
```

Render (slow) and save.

```{r, fig.width=7.5, fig.height=7.5*1.168, fig.cap="Panel A shows all GBIF occurrences in gray and two example species in blue and red; panel B shows the same data in climate space; panel C shows the average temperature and precipitation estimates for all species, highlighting the two examples."}
theme_set(ggpubr::theme_pubclean())

fig1_gg

# ggsave(
#   plot = fig1_gg,
#   filename = "figures/fig1.png",
#   width = 7.5,
#   height = 7.5 * 1.618
# )
```

### Community shift analyses

Read in experimental and observational data.

```{r}
exp_com_tbl <- read_rds("data/community/all-experimental-data.rds") %>%
  inner_join(niche_tbl, by = "species") %>%
  group_by(site, year, plot, treat) %>%
  summarize(
    tmp_com_mean = sum(abund * tmp_occ_mean) / sum(abund),
    tmp_com_var = sum(abund * tmp_occ_mean^2) / sum(abund) - tmp_com_mean^2,
    ppt_com_mean = sum(abund * ppt_occ_mean) / sum(abund),
    ppt_com_var = sum(abund * ppt_occ_mean^2) / sum(abund) - ppt_com_mean^2,
    vpd_com_mean = sum(abund * vpd_occ_mean) / sum(abund),
    vpd_com_var = sum(abund * vpd_occ_mean^2) / sum(abund) - vpd_com_mean^2
  )

obs_com_tbl <- read_rds("data/community/all-observational-data.rds") %>%
  inner_join(niche_tbl, by = "species") %>%
  group_by(site, year, plot) %>%
  summarize(
    tmp_com_mean = sum(abund * tmp_occ_mean) / sum(abund),
    tmp_com_var = sum(abund * tmp_occ_mean^2) / sum(abund) - tmp_com_mean^2,
    ppt_com_mean = sum(abund * ppt_occ_mean) / sum(abund),
    ppt_com_var = sum(abund * ppt_occ_mean^2) / sum(abund) - ppt_com_mean^2,
    vpd_com_mean = sum(abund * vpd_occ_mean) / sum(abund),
    vpd_com_var = sum(abund * vpd_occ_mean^2) / sum(abund) - vpd_com_mean^2
  )
```

JRGCE warming treatment to CTI and CPI comparisons. 

```{r, fig.cap="Compare mean(CTI) in all 64 ambient vs. warming treatments over years"}
jrgce_gg <-
  exp_com_tbl %>%
  filter(site == "jrgce") %>%
  mutate(treat_T = str_sub(treat, start = 1L, end = 1L)) %>%
  select(site, year, plot, treat_T, tmp_com_mean, ppt_com_mean) %>%
  pivot_longer(cols = tmp_com_mean:ppt_com_mean, names_to = "com_idx_name", values_to = "com_idx_value") %>%
  mutate(com_idx_name = factor(com_idx_name,
    levels = c("tmp_com_mean", "ppt_com_mean"),
    labels = c("CTI", "CPI")
  )) %>%
  ggplot(aes(year, com_idx_value, col = treat_T, group = interaction(treat_T, year))) +
  geom_boxplot() +
  ggpubr::stat_compare_means(
    aes(group = treat_T),
    method = "wilcox.test",
    label = "p.signif", hide.ns = FALSE
  ) +
  facet_wrap(~com_idx_name,
    ncol = 1, scales = "free_y",
    strip.position = "left",
    labeller = as_labeller(c(
      CTI = "Community Temperature Index\n(CTI, 째C)",
      CPI = "Community Precipitation Index\n(CPI, mm)"
    ))
  ) +
  labs(
    x = "Year", y = NULL,
    color = "Warming treatment",
    title = "Jasper Ridge Global Change Experiment"
  ) +
  scale_color_manual(values = c("black", "red")) +
  theme(
    strip.background = element_blank(),
    strip.placement = "outside"
  )
```

Observational data CTI and CPI comparisons.

```{r}
site_labeller <- as_labeller(c(
  angelo = "Angelo Coast Range Reserve",
  carrizo = "Carrizo Plain",
  elkhorn = "Elkhorn Slough",
  jasper = "Jasper Ridge",
  mclann = "McLaughlin (Annual)",
  mclserp = "McLaughlin (Serpentine)",
  swanton = "Swanton Ranch",
  ucsc = "UC Santa Cruz"
))

obs_cti_gg <-
  obs_com_tbl %>%
  ggplot(aes(year, tmp_com_mean, group = year)) +
  geom_boxplot() +
  geom_smooth(
    method = "lm", formula = y ~ x, se = FALSE,
    color = "red", lty = "dashed",
    aes(group = 1)
  ) +
  ggpubr::stat_cor(aes(group = 1, label = ..p.label..),
    p.accuracy = 0.05,
    color = "red"
  ) +
  facet_wrap(~site,
    nrow = 2,
    scales = "free_y",
    labeller = site_labeller
  ) +
  labs(
    x = "Year", y = "Community Temperature Index\n(CTI, 째C)"
  ) +
  theme(
    strip.background = element_blank()
  )

obs_cpi_gg <-
  obs_com_tbl %>%
  ggplot(aes(year, ppt_com_mean, group = year)) +
  geom_boxplot() +
  geom_smooth(
    method = "lm", formula = y ~ x, se = FALSE,
    color = "red", lty = "dashed",
    aes(group = 1)
  ) +
  ggpubr::stat_cor(aes(group = 1, label = ..p.label..),
    p.accuracy = 0.05,
    color = "red"
  ) +
  facet_wrap(~site,
    nrow = 2,
    scales = "free_y",
    labeller = site_labeller
  ) +
  labs(
    x = "Year", y = "Community Precipitation Index\n(CPI, mm)"
  ) +
  theme(
    strip.background = element_blank()
  )
```

Combine panels.

```{r}
fig2_gg <- jrgce_gg + obs_cti_gg + obs_cpi_gg +
  plot_annotation(tag_levels = "A") +
  plot_layout(design = "
  A
  B
  C
  ")
```

Render and save.

```{r, fig.width=10, fig.height=10*1.618, fig.cap="Community shift from long-term experiments and observations."}
theme_set(ggpubr::theme_pubclean())

fig2_gg

# ggsave(
#   plot = fig2_gg,
#   filename = "figures/fig2.png",
#   width = 10,
#   height = 10 * 1.618
# )
```

## Supplements

Figures and tables in the supplements.
