# Manuscript display items

Setup and load packages.

```{r, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, eval = TRUE, warning = FALSE)
```

```{r}
library(tidyverse)
library(sf)
library(patchwork)
theme_set(ggpubr::theme_pubclean())
```

## Main text

Figures and tables in the main text.

### Climate niche estimation

Read in GBIF-CHELSA, and niche estimate data.

```{r}
gbif_chelsa_sf <- read_rds("data/climate/climate-gbif-2022-05-10.rds") %>%
  select(geometry, key, species, tmp = chelsa_tmp, ppt = chelsa_ppt, vpd = chelsa_vpd) %>%
  st_as_sf(crs = "+proj=longlat +datum=WGS84 +no_defs")

niche_tbl <- read_rds("data/occurrence/niche-estimates-cfp-2022-05-10.rds")
```

Choose two example species and assign colors. From Justin's email 5/10/22:

> Are you aiming for natives specifically? I think Stipa pulchra works well for the dry, Festuca perennis is also commonly known since its a weed, in the same area. 
> 
> For wet species I don't recommend Allium, I might recommend Danthonia californica, or Juncus bufonis (Juncus are rushes and also typically though of as 'wetter' or cooler species). For a non-native if desired - Holcus lanatus would be a good choice.
>
> Danthonia californica looks like its in a good spot, but I'm sure how well known it is - Juncus bufonis could be good - most people would know Juncus typically likes 'wet and cooler' but it is not in as an extreme location.
>
> Note: Juncus bufonis should be Juncus bufonius.

Michael confirmed Danthonia californica and Stipa pulchra are two important native species in California on 5/16/22.

```{r}
cool_species <- "Danthonia californica" # "Juncus bufonius"
warm_species <- "Stipa pulchra" # "Festuca perennis"

gbif_chelsa_sf <- gbif_chelsa_sf %>%
  mutate(species_type = case_when(
    species == cool_species ~ "cool",
    species == warm_species ~ "warm",
    TRUE ~ "other"
  ))

niche_tbl <- niche_tbl %>%
  mutate(species_type = case_when(
    species == cool_species ~ "cool",
    species == warm_species ~ "warm",
    TRUE ~ "other"
  ))
```

Create three panels separately (fast without rendering).

```{r}
# set up plot params using alphabetical species type names
color_vec <- c(cool = "blue", other = gray(.9), warm = "red")
shape_vec <- c(cool = 19, other = 20, warm = 19)
alpha_vec <- c(cool = .6, other = .005, warm = .6)

occ_geog_gg <-
  ggplot() +
  geom_sf(
    data = rnaturalearth::ne_states(
      country = c("Mexico", "United States of America"),
      returnclass = "sf"
    ),
    fill = NA,
    color = gray(.25)
  ) +
  geom_sf(
    data = gbif_chelsa_sf,
    aes(color = species_type, shape = species_type, alpha = species_type)
  ) +
  scale_color_manual(values = color_vec) +
  scale_shape_manual(values = shape_vec) +
  scale_alpha_manual(values = alpha_vec) +
  coord_sf(xlim = c(-126, -114), ylim = c(28, 44)) +
  scale_x_continuous(breaks = c(-125, -120, -115)) +
  scale_y_continuous(breaks = c(30, 35, 40)) +
  labs(x = "Longitude", y = "Latitude") +
  guides(color = "none", shape = "none", alpha = "none")

occ_clim_gg <-
  ggplot(data = gbif_chelsa_sf, mapping = aes(tmp, ppt)) +
  geom_point(
    aes(color = species_type, shape = species_type, alpha = species_type)
  ) +
  scale_color_manual(values = color_vec) +
  scale_shape_manual(values = shape_vec) +
  scale_alpha_manual(values = alpha_vec) +
  labs(x = "Mean annual temperature (°C)", y = "Annual precipitation (mm)") +
  guides(color = "none", shape = "none", alpha = "none")

niche_gg <-
  ggplot(
    data = niche_tbl,
    mapping = aes(
      x = tmp_occ_mean,
      y = ppt_occ_mean,
      xmin = tmp_occ_mean - tmp_occ_sd / sqrt(occ_n),
      xmax = tmp_occ_mean + tmp_occ_sd / sqrt(occ_n),
      ymin = ppt_occ_mean - ppt_occ_sd / sqrt(occ_n),
      ymax = ppt_occ_mean + ppt_occ_sd / sqrt(occ_n),
      label = species,
      color = species_type
    )
  ) +
  geom_point() +
  geom_errorbar() +
  geom_errorbarh() +
  scale_color_manual(values = c(cool = "blue", other = gray(.5), warm = "red")) +
  scale_x_continuous(expand = expansion(mult = .1)) + # expand padding to show label
  labs(x = "Mean annual temperature (°C)", y = "Annual precipitation (mm)") +
  guides(color = "none") +
  geom_label(
    data = niche_tbl %>% filter(species_type %in% c("cool", "warm")),
    fill = NA,
    fontface = "italic",
    label.padding = unit(.5, "lines"),
    label.size = 0,
    vjust = "outward", hjust = "outward"
  )
```

Combine three panels.

```{r}
fig1_gg <- occ_geog_gg + occ_clim_gg + niche_gg +
  plot_annotation(tag_levels = "A") +
  plot_layout(design = "
  ABB
  ABB
  CCC
  CCC
  CCC
  ")
```

Render (slow) and save.

```{r, fig.width=7.5, fig.height=7.5*1.168, fig.cap="Grassland species occur along geographic and climatic gradients to estimate ecological niches. (A) Occurrence of grassland species in the California Floristic Province, retrieved from the GBIF data (*n* = 367,657 records, gray points), highlighting two example species *Danthonia californica* in the north (*n* = 894 records, blue points) and *Stipa pulchra* in the south (*n* = 481 records, red points). (B) Species occurrence in climate space of mean annual temperature (°C) and annual precipitation (mm), retrieved from the CHELSA data (gray), highlighting the same two example species *Danthonia californica* under cool and wet climates (blue) and *Stipa pulchra* under warm and dry climates (red). (C) Ecological niche estimates from average temperature and precipitation for each species (*n* = 182 species, mean ± standard error, gray), highlighting the two species (blue and red)."}
fig1_gg

# ggsave(
#   plot = fig1_gg,
#   filename = str_c(
#     "figures/fig1-",
#     word(cool_species, 1) %>% tolower(),
#     "-",
#     word(warm_species, 1) %>% tolower(),
#     ".png"
#   ),
#   width = 7.5,
#   height = 7.5 * 1.618
# )
```

### Community shift analyses

Read in experimental and observational data.

```{r}
exp_com_tbl <- read_rds("data/community/all-experimental-data.rds") %>%
  inner_join(niche_tbl, by = "species") %>%
  group_by(site, year, plot, treat) %>%
  summarize(
    tmp_com_mean = sum(abund * tmp_occ_mean) / sum(abund),
    tmp_com_var = sum(abund * tmp_occ_mean^2) / sum(abund) - tmp_com_mean^2,
    ppt_com_mean = sum(abund * ppt_occ_mean) / sum(abund),
    ppt_com_var = sum(abund * ppt_occ_mean^2) / sum(abund) - ppt_com_mean^2,
    vpd_com_mean = sum(abund * vpd_occ_mean) / sum(abund),
    vpd_com_var = sum(abund * vpd_occ_mean^2) / sum(abund) - vpd_com_mean^2
  )

obs_com_tbl <- read_rds("data/community/all-observational-data.rds") %>%
  inner_join(niche_tbl, by = "species") %>%
  group_by(site, year, plot) %>%
  summarize(
    tmp_com_mean = sum(abund * tmp_occ_mean) / sum(abund),
    tmp_com_var = sum(abund * tmp_occ_mean^2) / sum(abund) - tmp_com_mean^2,
    ppt_com_mean = sum(abund * ppt_occ_mean) / sum(abund),
    ppt_com_var = sum(abund * ppt_occ_mean^2) / sum(abund) - ppt_com_mean^2,
    vpd_com_mean = sum(abund * vpd_occ_mean) / sum(abund),
    vpd_com_var = sum(abund * vpd_occ_mean^2) / sum(abund) - vpd_com_mean^2
  )
```

JRGCE warming treatment to CTI and CPI comparisons. 

```{r}
jrgce_gg <-
  exp_com_tbl %>%
  filter(site == "jrgce") %>%
  mutate(treat_T = str_sub(treat, start = 1L, end = 1L)) %>%
  select(site, year, plot, treat_T, tmp_com_mean, ppt_com_mean) %>%
  pivot_longer(cols = tmp_com_mean:ppt_com_mean, names_to = "com_idx_name", values_to = "com_idx_value") %>%
  mutate(com_idx_name = factor(com_idx_name,
    levels = c("tmp_com_mean", "ppt_com_mean"),
    labels = c("CTI", "CPI")
  )) %>%
  ggplot(aes(year, com_idx_value, col = treat_T, group = interaction(treat_T, year))) +
  geom_boxplot() +
  ggpubr::stat_compare_means(
    aes(group = treat_T),
    method = "wilcox.test",
    label = "p.signif", hide.ns = FALSE
  ) +
  facet_wrap(~com_idx_name,
    ncol = 1, scales = "free_y",
    strip.position = "left",
    labeller = labeller(com_idx_name = c(
      CTI = "Community Temperature Index\n(CTI, °C)",
      CPI = "Community Precipitation Index\n(CPI, mm)"
    ))
  ) +
  labs(
    x = NULL, # "Year",
    y = NULL,
    color = "Warming treatment",
    title = "Jasper Ridge Global Change Experiment",
    subtitle = "<span style='color:black'>Ambient vs. </span><span style='color:red'>warming treatment</span>"
  ) +
  scale_color_manual(values = c("black", "red")) +
  theme(
    strip.background = element_blank(),
    strip.placement = "outside",
    legend.position = "none",
    plot.subtitle = ggtext::element_markdown()
  )
```

Observational data CTI and CPI comparisons, arranged by observational sites. Set up plotting functions and labels.

```{r}
obs_gg_fun <- function(tbl, site_lab, cti_lab = "", cpi_lab = "", yr_lab = NULL) {
  ggplot(data = tbl, aes(year, com_idx_value, group = year)) +
    geom_boxplot() +
    geom_smooth(
      method = "lm", formula = y ~ x, se = FALSE,
      color = "red", lty = "dashed",
      aes(group = 1)
    ) +
    ggpubr::stat_cor(aes(group = 1, label = ..p.label..),
      p.accuracy = 0.05,
      color = "red"
    ) +
    facet_wrap(~com_idx_name,
      ncol = 1, scales = "free_y",
      strip.position = "left",
      labeller = labeller(com_idx_name = c(
        CTI = cti_lab, # "Community Temperature Index\n(CTI, °C)",
        CPI = cpi_lab # "Community Precipitation Index\n(CPI, mm)"
      ))
    ) +
    xlim(1983, 2019) +
    labs(
      x = yr_lab, y = NULL,
      title = site_lab
    ) +
    theme(
      strip.background = element_blank(),
      strip.placement = "outside",
      plot.title = element_text(size = 11)
    )
}

site_vec <- c(
  angelo = "Angelo Coast Range Reserve",
  carrizo = "Carrizo Plain",
  elkhorn = "Elkhorn Slough",
  jasper = "Jasper Ridge Biological Preserve",
  mclann = "McLaughlin Reserve",
  mclserp = "McLaughlin (Serpentine)",
  swanton = "Swanton Ranch",
  ucsc = "UC Santa Cruz"
)
```

Reshape data and make individual panels.

```{r}
obs_com_mean_tbl <- obs_com_tbl %>%
  select(site, year, plot, tmp_com_mean, ppt_com_mean) %>%
  pivot_longer(cols = tmp_com_mean:ppt_com_mean, names_to = "com_idx_name", values_to = "com_idx_value") %>%
  mutate(com_idx_name = factor(com_idx_name,
    levels = c("tmp_com_mean", "ppt_com_mean"),
    labels = c("CTI", "CPI")
  ))

samp_size_tbl <- obs_com_tbl %>%
  group_by(site) %>%
  summarize(
    n_plot = n_distinct(plot),
    n_year = n_distinct(year)
  )

angelo_gg <- obs_com_mean_tbl %>%
  filter(site == "angelo") %>%
  obs_gg_fun(site_vec["angelo"],
    cti_lab = "CTI (°C)", cpi_lab = "CPI (mm)"
  )

carrizo_gg <- obs_com_mean_tbl %>%
  filter(site == "carrizo") %>%
  obs_gg_fun(site_vec["carrizo"])

elkhorn_gg <- obs_com_mean_tbl %>%
  filter(site == "elkhorn") %>%
  obs_gg_fun(site_vec["elkhorn"])

jasper_gg <- obs_com_mean_tbl %>%
  filter(site == "jasper") %>%
  obs_gg_fun(site_vec["jasper"],
    cti_lab = "CTI (°C)", cpi_lab = "CPI (mm)"
  )

mclann_gg <- obs_com_mean_tbl %>%
  filter(site == "mclann") %>%
  obs_gg_fun(site_vec["mclann"],
    yr_lab = "Year"
  )

ucsc_gg <- obs_com_mean_tbl %>%
  filter(site == "ucsc") %>%
  obs_gg_fun(site_vec["ucsc"])
```

Combine panels.

```{r}
fig2_gg <- jrgce_gg +
  angelo_gg + carrizo_gg + elkhorn_gg +
  jasper_gg + mclann_gg + ucsc_gg +
  plot_annotation(tag_levels = "A") +
  plot_layout(design = "
  AAA
  BCD
  EFG
  ")
```

Render and save.

```{r, fig.width=10, fig.height=10*1.618, fig.cap="Grassland community shifts from long-term experiments and observations. (A) Warming treatment causes communities to shift dominance to warmer (CTI, °C) and drier (CPI, mm) species in the Jasper Ridge Global Change Experiment (*n* = 200 plots, with 136 ambient plots in black, 64 warming plots in red, 1998 pre-treatment year, non-parametric two-sample Wilcoxon test, ns: *p* > 0.05, $*$: *p* ≤ 0.05, $**$: *p* ≤ 0.01). (B to G) Consistent with climate warming and drying, grassland communities shift dominance to warmer (CTI) and drier (CPI) species in six long-term observational sites across the California Floristic Province (dashed trend lines by linear regression, all significant slopes by *t*-test, *p* < 0.05)."}
fig2_gg

# ggsave(
#   plot = fig2_gg,
#   filename = "figures/fig2.png",
#   width = 10,
#   height = 10 * 1.618
# )
```

## Supplements

Figures and tables in the supplements.

### Occurrence data sources

Compare BIEN, CCH, GBIF, iNat occurrence datasets.

```{r}
spp_tbl <- read_rds("data/community/all-experimental-data.rds") %>%
  select(species) %>%
  bind_rows(
    read_rds("data/community/all-experimental-data.rds") %>%
      select(species)
  ) %>%
  distinct(species) %>%
  arrange(species)

bien_tbl <- read_rds("data/occurrence/bien/bien-cfp-2022-04-27.rds") %>%
  mutate(
    dataset = "bien",
    species = queryName,
    key = as.character(key)
  ) %>%
  filter(species %in% spp_tbl$species) %>%
  select(dataset, key, species, longitude, latitude)

cch_tbl <- read_rds("data/occurrence/cch/cch-cfp-2022-05-02.rds") %>%
  mutate(
    dataset = "cch",
    species = queryName,
    key = as.character(key)
  ) %>%
  filter(species %in% spp_tbl$species) %>%
  select(dataset, key, species, longitude, latitude)

gbif_tbl <- read_rds("data/occurrence/gbif/gbif-cfp-2022-05-10.rds") %>%
  mutate(
    dataset = "gbif",
    species = queryName,
    key = as.character(key)
  ) %>%
  filter(species %in% spp_tbl$species) %>%
  select(dataset, key, species, longitude, latitude)

inat_tbl <- read_rds("data/occurrence/inat/inat-cfp-2022-05-10.rds") %>%
  mutate(
    dataset = "inat",
    # species = queryName,
    key = as.character(key)
  ) %>%
  filter(species %in% spp_tbl$species) %>%
  select(dataset, key, species, longitude, latitude)
```

Combine them and convert to sf.

```{r}
occ_sf <- bien_tbl %>%
  bind_rows(cch_tbl) %>%
  bind_rows(gbif_tbl) %>%
  bind_rows(inat_tbl) %>%
  st_as_sf(coords = c("longitude", "latitude"), crs = 4326) # WGS84
```

Dataset names.

```{r}
dataset_vec <- c(
  bien = "BIEN",
  cch = "eJepson (CCH)",
  gbif = "GBIF",
  inat = "iNaturalist"
)
```

Compare sample sizes across data sets.

```{r}
occ_sf %>%
  as_tibble() %>%
  group_by(dataset) %>%
  summarise(
    record_number = n() %>% format(trim = TRUE, scientific = FALSE, big.mark = ","),
    species_number = unique(species) %>% length() %>% format(trim = TRUE, scientific = FALSE, big.mark = ",")
  ) %>%
  knitr::kable(caption = "Comparison of occurrence datasets.")
```

```{r fig.cap="Occurrence data comparison from multiple sources in study area"}
set.seed(618)
prop_samp <- .1 # prop to sample and plot
ggplot() +
  geom_sf(
    data = rnaturalearth::ne_states(
      country = c("Mexico", "United States of America"),
      returnclass = "sf"
    ),
    fill = NA,
    color = alpha("black", .1)
  ) +
  # geom_sf(data = cfp_sf, fill = "white", alpha = .5) +
  geom_sf(
    data = occ_sf %>% slice_sample(prop = prop_samp), # randomly sample certain proportion, otherwise too slow to render
    color = "black", alpha = .1, size = .1
  ) +
  labs(x = "Longitude", y = "Latitude") +
  coord_sf(xlim = c(-126, -114), ylim = c(28, 44)) +
  scale_x_continuous(breaks = c(-125, -120, -115)) +
  scale_y_continuous(breaks = c(30, 35, 40)) +
  facet_wrap(. ~ dataset,
    nrow = 1,
    labeller = labeller(dataset = dataset_vec)
  ) +
  theme(
    strip.background = element_blank(),
    # strip.text.x = element_text(hjust = 0)
  )
```

### Climate data sources

Compare CHELSA and PRISM climate data at GBIF occurrence locations, by making scatter plots with correlation.

```{r}
clim_gbif_tbl <- read_rds("data/climate/climate-gbif-2022-05-10.rds") %>%
  as_tibble() %>%
  drop_na() # PRISM = NA in Mexico

chelsa_gbif_tbl <- clim_gbif_tbl %>%
  select(
    geometry, key, species,
    chelsa_tmp, chelsa_ppt
  ) %>%
  pivot_longer(chelsa_tmp:chelsa_ppt,
    names_to = "variable",
    values_to = "CHELSA"
  ) %>%
  mutate(variable = str_sub(variable, start = -3L, end = -1L))

prism_gbif_tbl <- clim_gbif_tbl %>%
  select(
    geometry, key, species,
    prism_tmp, prism_ppt
  ) %>%
  pivot_longer(prism_tmp:prism_ppt,
    names_to = "variable",
    values_to = "PRISM"
  ) %>%
  mutate(variable = str_sub(variable, start = -3L, end = -1L))

clim_comp_tbl <- chelsa_gbif_tbl %>%
  inner_join(prism_gbif_tbl,
    by = c("geometry", "key", "species", "variable")
  )
```

```{r fig.cap="Climate data comparison from multiple sources in study area"}
ggplot(clim_comp_tbl, aes(CHELSA, PRISM)) +
  geom_hex(bins = 100) +
  viridis::scale_fill_viridis() +
  geom_smooth(method = "lm", formula = y ~ x, se = FALSE, color = "red", lty = "dashed") +
  ggpubr::stat_cor(
    aes(label = paste(..r.label.., ..p.label.., sep = "~`,`~")),
    p.accuracy = 0.05,
    color = "red"
  ) +
  geom_abline(slope = 1, intercept = 0, color = "red") +
  facet_wrap(. ~ factor(
    variable,
    levels = c("tmp", "ppt"),
    labels = c(
      "Mean annual temperature (°C)",
      "Annual precipitation (mm)"
    )
  ),
  scales = "free"
  ) +
  labs(
    x = "CHELSA data",
    y = "PRISM data",
    fill = "Occurrence record"
  ) +
  theme(
    aspect.ratio = 1, # can't do + coord_fixed() with facet_wrap(scales = "free")
    strip.background = element_blank(),
    strip.text.x = element_text(size = 15)
  )
```

### Climate variable correlations

TODO: different bioclim variables are highly correlated

### Species climate niche summary statistics

Read species climate niche estimates.

```{r}
niche_tbl <- read_rds("data/occurrence/niche-estimates-cfp-2022-05-10.rds")
```

The mean, median, upper, lower temp and precip for all species are highly correlated.

```{r, fig.cap="Species temperature niche statistics are highly correlated"}
niche_tbl %>%
  select(tmp_occ_mean, tmp_occ_median, tmp_occ_q05, tmp_occ_q95) %>%
  GGally::ggpairs(
    lower = list(continuous = GGally::wrap("points", alpha = 0.2)),
    title = "Species temperature niche (°C)",
    columnLabels = c("Mean", "Median", "Lower limit (5%)", "Upper limit (95%)")
  ) +
  theme(strip.background = element_blank())
```

```{r, fig.cap="Species precipitation niche statistics are highly correlated"}
niche_tbl %>%
  select(ppt_occ_mean, ppt_occ_median, ppt_occ_q05, ppt_occ_q95) %>%
  GGally::ggpairs(
    lower = list(continuous = GGally::wrap("points", alpha = 0.2)),
    title = "Species precipitation niche (mm)",
    columnLabels = c("Mean", "Median", "Lower limit (5%)", "Upper limit (95%)")
  ) +
  theme(strip.background = element_blank())
```

### Individual species climate niches

Read CFP data.

```{r}
cfp_sf <- st_read("data/occurrence/hotspots/hotspots_2016_1.shp") %>%
  filter(
    NAME == "California Floristic Province",
    Type == "hotspot area"
  )
```

Read GBIF-CHELSA data.

```{r}
# check species lists
sp_gbif_vec <- gbif_chelsa_sf %>%
  pull(species) %>%
  unique() %>%
  sort()

# gbif summary
tmp_rng <- range(gbif_chelsa_sf$tmp)
ppt_rng <- range(gbif_chelsa_sf$ppt)
n_occ_tot <- nrow(gbif_chelsa_sf)
```

Multi-page PDF, each for a single species (to avoid overplotting), left geo-space, right clim-space.

```{r eval=TRUE}
# multi-species plot
niche_gg <- vector(mode = "list")
for (i in seq_along(sp_gbif_vec)) {
  sp <- sp_gbif_vec[i]
  occ_sp_sf <- filter(gbif_chelsa_sf, species == sp)
  occ_sp_stat <- occ_sp_sf %>%
    as_tibble() %>%
    summarise(
      occ_n = n(),
      tmp_occ_mean = mean(tmp, na.rm = TRUE),
      tmp_occ_sd = sd(tmp, na.rm = TRUE),
      ppt_occ_mean = mean(ppt, na.rm = TRUE),
      ppt_occ_sd = sd(ppt, na.rm = TRUE)
    )

  occ_geog <-
    ggplot() +
    geom_sf(
      data = rnaturalearth::ne_states(
        country = c("Mexico", "United States of America"),
        returnclass = "sf"
      ),
      fill = NA,
      color = alpha("black", .1)
    ) +
    geom_sf(
      data = cfp_sf,
      color = alpha("black", .3),
      fill = alpha("white", .1)
    ) +
    geom_sf(data = occ_sp_sf, alpha = .1, size = .5) +
    labs(x = "Longitude", y = "Latitude", title = sp) +
    coord_sf(xlim = c(-126, -114), ylim = c(28, 44)) +
    scale_x_continuous(breaks = c(-125, -120, -115)) +
    scale_y_continuous(breaks = c(30, 35, 40)) +
    theme(plot.title = element_text(face = "italic"))

  occ_clim <-
    ggplot(occ_sp_sf, aes(tmp, ppt)) +
    geom_point(alpha = .1, size = .5) +
    geom_rug(alpha = .1) +
    stat_ellipse(col = "red") +
    geom_point(
      data = occ_sp_stat,
      aes(x = tmp_occ_mean, y = ppt_occ_mean),
      shape = 3, col = "red", size = 10
    ) +
    lims(x = tmp_rng, y = ppt_rng) +
    labs(
      x = "Mean annual temperature (°C)", y = "Annual precipitation (mm)",
      title = bquote(italic("n") ~ "=" ~ .(format(occ_sp_stat$occ_n, big.mark = ",", trim = TRUE)))
    )

  # print(sp)
  niche_gg[[i]] <- occ_geog + occ_clim # no need to print(); will slow down
}
names(niche_gg) <- sp_gbif_vec
```

Show two example species.

```{r fig.cap="Example species *Danthonia californica*"}
niche_gg["Danthonia californica"]
```

```{r fig.cap="Example species *Stipa pulchra*"}
niche_gg["Stipa pulchra"]
```

Print all species into a multi-page PDF.

```{r, eval=FALSE}
# runtime ~= 4 min
pdf("figures/species-climate-niche.pdf", width = 8, height = 8 * .618)
print(niche_gg)
dev.off()
```

The file can be viewed at this [link](https://zhulab.ucsc.edu/projects/grassland/figures/species-climate-niche.pdf)

### Site info

Experimental and observational site information in table and map.

```{r}
site_sf <- read_rds("data/community/site-info.rds") %>%
  filter(abbr %in% c("angelo", "carrizo", "elkhorn", "jasper", "mclann", "ucsc")) %>%
  mutate(short_name = case_when(
    abbr == "angelo" ~ "Angelo",
    abbr == "carrizo" ~ "Carrizon Plain",
    abbr == "elkhorn" ~ "Elkhorn Slough",
    abbr == "jasper" ~ "Jasper Ridge",
    abbr == "mclann" ~ "McLaughlin",
    abbr == "ucsc" ~ "UC Santa Cruz"
  ))
site_sf %>%
  as_tibble() %>% # drop geometry
  knitr::kable()
```

```{r fig.cap="Map of experimental and observational study sites"}
set.seed(618)
ggplot() +
  geom_sf(
    data = rnaturalearth::ne_states(
      country = c("Mexico", "United States of America"),
      returnclass = "sf"
    ),
    fill = NA,
    color = alpha("black", .1)
  ) +
  geom_sf(
    data = cfp_sf,
    color = alpha("black", .3),
    fill = alpha("white", .1)
  ) +
  geom_sf(data = site_sf, color = "red") +
  ggrepel::geom_label_repel(
    data = site_sf,
    mapping = aes(label = short_name, geometry = geometry),
    stat = "sf_coordinates",
    size = 3,
    color = "red",
    fill = NA,
    min.segment.length = 0,
    label.padding = unit(.1, "lines"),
    label.size = NA
  ) +
  labs(x = "Longitude", y = "Latitude") +
  coord_sf(xlim = c(-126, -114), ylim = c(28, 44)) +
  scale_x_continuous(breaks = c(-125, -120, -115)) +
  scale_y_continuous(breaks = c(30, 35, 40))
```

### Site climate change

TODO: get PRISM/CHELSA data on six sites and plot climate change; may compare with CTI and CPI changes

### JRGCE biomass vs. pin count data

Show different measures of abundance (e.g., biomass, pin count) are highly correlated.

Read data.

```{r}
attach("data/archives/JRGCE/Input/Biomass/FG/All abundance and environment.rdata")
jrgce_tbl <- abund.dat %>% ungroup()
detach()
```

Calculate correlation coefficients.

```{r}
jrgce_cor_tbl <- jrgce_tbl %>%
  group_by(plt, yr) %>%
  summarize(
    cor_pearson = cor(bio, pin, method = "pearson"),
    cor_kendall = cor(bio, pin, method = "kendall"),
    cor_spearman = cor(bio, pin, method = "spearman")
  ) %>%
  pivot_longer(starts_with("cor_"), names_to = "cor_type", values_to = "cor_value") %>%
  drop_na()
```

Plot distribution.

```{r, fig.cap="Correlation between biomass and pin count measures of abundance for each plot and year"}
jrgce_cor_tbl %>%
  ggplot(aes(x = cor_value)) +
  geom_histogram(
    aes(y = ..density..),
    color = 1,
    fill = NA
  ) +
  geom_density(
    lwd = 1.2,
    linetype = 2,
    color = 2
  ) +
  facet_wrap(~ factor(cor_type,
    levels = c("cor_pearson", "cor_kendall", "cor_spearman"),
    labels = c("Pearson", "Kendall", "Spearman")
  )) +
  labs(
    x = "Correlation coefficient",
    y = "Density"
  )
```

### McL Annual vs. Serp comparison

```{r, fig.cap="Compare annual vs. serpentine grassland communities in McLaughlin Reserve"}
obs_com_tbl %>%
  filter(site %in% c("mclann", "mclserp")) %>%
  select(site, year, plot, tmp_com_mean, ppt_com_mean) %>%
  pivot_longer(tmp_com_mean:ppt_com_mean, names_to = "variable", values_to = "value") %>%
  mutate(variable = factor(
    variable,
    c("tmp_com_mean", "ppt_com_mean")
  )) %>%
  ggplot(aes(year, value, group = year)) +
  geom_boxplot() +
  geom_smooth(
    method = "lm", formula = y ~ x, se = FALSE,
    color = "red", lty = "dashed",
    aes(group = 1)
  ) +
  ggpubr::stat_cor(aes(group = 1, label = ..p.label..),
    p.accuracy = 0.05,
    color = "red"
  ) +
  facet_grid(variable ~ site,
    scales = "free_y",
    switch = "y", # for facet_wrap, use strip.position = "left",
    labeller = labeller(
      variable = c(
        tmp_com_mean = "Community Temperature Index\n(CTI, °C)",
        ppt_com_mean = "Community Precipitation Index\n(CPI, mm)"
      ),
      site = c(
        mclann = "Annual",
        mclserp = "Serpentine"
      )
    )
  ) +
  xlim(1983, 2019) +
  labs(
    x = "Year", y = NULL,
    title = "McLaughlin Reserve"
  ) +
  theme(
    strip.background = element_blank(),
    strip.placement = "outside",
    plot.title = element_text(size = 11)
  )
```

### sd(CTI) and sd(CPI) figures

JRGCE

```{r}
jrgce_gg <-
  exp_com_tbl %>%
  filter(site == "jrgce") %>%
  mutate(
    treat_T = str_sub(treat, start = 1L, end = 1L),
    tmp_com_sd = sqrt(tmp_com_var),
    ppt_com_sd = sqrt(ppt_com_var)
  ) %>%
  select(site, year, plot, treat_T, tmp_com_sd, ppt_com_sd) %>%
  pivot_longer(cols = tmp_com_sd:ppt_com_sd, names_to = "com_idx_name", values_to = "com_idx_value") %>%
  mutate(com_idx_name = factor(com_idx_name,
    levels = c("tmp_com_sd", "ppt_com_sd"),
    labels = c("CTI", "CPI")
  )) %>%
  ggplot(aes(year, com_idx_value, col = treat_T, group = interaction(treat_T, year))) +
  geom_boxplot() +
  ggpubr::stat_compare_means(
    aes(group = treat_T),
    method = "wilcox.test",
    label = "p.signif", hide.ns = FALSE
  ) +
  facet_wrap(~com_idx_name,
    ncol = 1, scales = "free_y",
    strip.position = "left",
    labeller = labeller(com_idx_name = c(
      CTI = "Community Temperature Index (CTI)\nstandard deviation (°C)",
      CPI = "Community Precipitation Index (CPI)\nstandard deviation (mm)"
    ))
  ) +
  labs(
    x = NULL, # "Year",
    y = NULL,
    color = "Warming treatment",
    title = "Jasper Ridge Global Change Experiment",
    subtitle = "<span style='color:black'>Ambient vs. </span><span style='color:red'>warming treatment</span>"
  ) +
  scale_color_manual(values = c("black", "red")) +
  theme(
    strip.background = element_blank(),
    strip.placement = "outside",
    legend.position = "none",
    plot.subtitle = ggtext::element_markdown()
  )
```

Observational data: calculate and make individual panels.

```{r}
obs_com_sd_tbl <- obs_com_tbl %>%
  mutate(
    tmp_com_sd = tmp_com_var %>% sqrt(),
    ppt_com_sd = ppt_com_var %>% sqrt()
  ) %>%
  select(site, year, plot, tmp_com_sd, ppt_com_sd) %>%
  pivot_longer(cols = tmp_com_sd:ppt_com_sd, names_to = "com_idx_name", values_to = "com_idx_value") %>%
  mutate(com_idx_name = factor(com_idx_name,
    levels = c("tmp_com_sd", "ppt_com_sd"),
    labels = c("CTI", "CPI")
  ))

angelo_gg <- obs_com_sd_tbl %>%
  filter(site == "angelo") %>%
  obs_gg_fun(site_vec["angelo"],
    cti_lab = "CTI standard deviation (°C)", cpi_lab = "CPI standard deviation (mm)"
  )

carrizo_gg <- obs_com_sd_tbl %>%
  filter(site == "carrizo") %>%
  obs_gg_fun(site_vec["carrizo"])

elkhorn_gg <- obs_com_sd_tbl %>%
  filter(site == "elkhorn") %>%
  obs_gg_fun(site_vec["elkhorn"])

jasper_gg <- obs_com_sd_tbl %>%
  filter(site == "jasper") %>%
  obs_gg_fun(site_vec["jasper"],
    cti_lab = "CTI standard deviation (°C)", cpi_lab = "CPI standard deviation (mm)"
  )

mclann_gg <- obs_com_sd_tbl %>%
  filter(site == "mclann") %>%
  obs_gg_fun(site_vec["mclann"],
    yr_lab = "Year"
  )

ucsc_gg <- obs_com_sd_tbl %>%
  filter(site == "ucsc") %>%
  obs_gg_fun(site_vec["ucsc"])
```

Combine panels.

```{r, fig.width=10, fig.height=10*1.618, fig.cap="CTI and CPI standard deviation"}
jrgce_gg +
  angelo_gg + carrizo_gg + elkhorn_gg +
  jasper_gg + mclann_gg + ucsc_gg +
  plot_annotation(tag_levels = "A") +
  plot_layout(design = "
  AAA
  BCD
  EFG
  ")
```
