---
title: "Supplementary figures"
date: "`r format(Sys.time(), '%B %d, %Y')`"
editor_options: 
  chunk_output_type: console
output:
  bookdown::html_document2: 
    fig_caption: true
    number_sections: true
    global_numbering: true
  bookdown::word_document2: 
    fig_caption: true
    number_sections: true
    global_numbering: true
---

```{r setup, echo=FALSE, message=FALSE}
source("scripts/utils/setup.R")
```

# Occurrence data sources

Multiple occurrence data are available in the CFP. We downloaded and compared BIEN, CCH, GBIF, iNat occurrence datasets. The comparison shows that GBIF is the most comprehensive in terms of the record number and species number.

```{r occ-data-tab}
source("scripts/compare-occ-data.R")
knitr::kable(occ_samp_tbl, caption = "Comparison of occurrence datasets.")
```

```{r occ-data-fig, fig.cap="Occurrence data comparison from multiple sources (BIEN, eJepson (CCH), GBIF, iNaturalist) in CFP. Randomly showing 10% of data points to avoid overplotting."}
occ_comp_gg
rm(list = ls())
```

# Climate data sources

Multiple climate data are available in the CFP. We downloaded and compared CHELSA, PRISM, and TerraClimate datasets extracted at GBIF occurrence locations. The comparison suggests different climate datasets are highly correlated with each other.

```{r clim-data-fig, fig.cap="Climate data comparison from multiple sources (CHELSA, PRISM, and TerraClimate) in CFP. Each point corresponds to a species occurrence from the GBIF data. Solid is the 1:1 line, and dashed is the regression line, where statistics (correlation coefficient R and p-value) are reported on the top left."}
source("scripts/compare-clim-data.R")
chelsa_prism_gg / chelsa_terraclim_gg
rm(list = ls())
```

# Climate variable correlations

TODO: different bioclim variables are highly correlated

# Climate niche summary statistics

Multiple statistics (mean, median, lower 5%, upper 95%) can summarize species' climate niche. Ecologically, they represent niches differently, e.g., average vs. extreme. Numerically, however, they are all significantly, and in many cases, highly, correlated. Because our interest is in comparing CTI/CPI differences (between treatments or over years), not the absolute CTI/CPI values, our results do not depend on which statistics are chosen among the correlated collection.

In the main text, we used the median because it is robust to outliers and most truthfully represents the niche centroids.

```{r tmp-niche-fig, fig.cap="Species temperature niche statistics. Distributions across species are shown by diagonal histograms, and pairwise correlations are visualized by lower-diagonal scatter plots and quantified by upper-diagonal correlation coefficients with t-tests (ns: *p* > 0.05, $*$: *p* ≤ 0.05, $**$: *p* ≤ 0.01, $***$: *p* ≤ 0.001)."}
source("scripts/compare-niche-stat.R")
niche_tmp_gg
```

```{r ppt-niche-fig, fig.cap="Species precipitation niche statistics. Symbols follow the previous figure."}
niche_ppt_gg
rm(list = ls())
```

# Spatial thinning occurrence-climate records

Acquiring occurrence records from biodiversity database such as GBIF is subject to sampling bias (cite). The collected records tend to bias toward accessibility, where locations proximate to roads and population centers are better sampled. To address this potential bias, we used a spatial thinning algorithm to resample the data by thinning occurrences separated by certain distances (Aiello-Lammens et al., 2015). We thinned the datasets by separating the closest records with 10 km distance.

The full and thinned data yield highly correlated climate niche statistics.

```{r thin-fig, fig.cap="Species climate niche estimates from full and thinned datasets. Each point corresponds to median temperature or precipitation for a species. Solid is the 1:1 line, and dashed is the regression line, where statistics (correlation coefficient R and p-value) are reported on the top left."}
source("scripts/compare-sp-thin.R")
thin_tmp_gg / thin_ppt_gg
rm(list = ls())
```

# Individual species climate niches

Generate a single species per page and assembly into a multi-page plot. Left geo-space, right clim-space.

```{r}
source("scripts/plot-ind-spp.R")
```

Show two example species.

```{r cool-sp-fig, fig.cap="Example species *Danthonia californica*"}
niche_gg["Danthonia californica"]
```

```{r warm-sp-fig, fig.cap="Example species *Stipa pulchra*"}
niche_gg["Stipa pulchra"]
```

Print all species into a multi-page PDF.

```{r, eval=FALSE}
# runtime ~= 4 min
pdf("figures/species-climate-niche.pdf", width = 8, height = 8 * .618)
print(niche_gg)
dev.off()
```

The file can be viewed at this [link](https://zhulab.ucsc.edu/projects/grassland/figures/species-climate-niche.pdf)

```{r}
rm(list = ls())
```

# Site info

Experimental and observational site information in table and map. The map has grassland coverage. Land cover type data on 0.05 degree resolution maunually downloaded from <https://lpdaac.usgs.gov/products/mcd12c1v006/>.

```{r site-tab}
source("scripts/show-site-info.R")
knitr::kable(site_tbl)
```

```{r site-fig, fig.cap="Map of experimental and observational study sites"}
site_gg
rm(list = ls())
```

# Site climate change

TODO: get PRISM/CHELSA data on six sites and plot climate change; may compare with CTI and CPI changes
