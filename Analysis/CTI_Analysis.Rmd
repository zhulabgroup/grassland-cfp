---
title: "CTI Analysis"
author: "Josie Lesage"
date: "1/23/2020"
output: html_document
---


```{r setup, include=FALSE}
## community analysis
library(codyn)
library(MASS)
library(lme4)
library(nlme)


## misc/both/other
library(oz)
library(plotrix)
library(tidyverse)
library(gridExtra)


knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

```{r prism data import and prep, echo = FALSE}
weather <- read.csv("PRISM_data.csv") %>%
  select(-X)

wtryr_weather <- read.csv("PRISM_wtryr_data.csv") %>%
  select(-X)

```


```{r CTI import and prep, cache = TRUE}
setwd("CTI Data")
ang_cti <- read.csv("Angelo_CTI.csv")
car_cti <- read.csv("Carrizo_CTI.csv") %>%
  rename(site = Site)
elk_cti <- read.csv("Elkhorn_CTI.csv") %>%
  rename(site = Site)
jasp_cti <- read.csv("Jasper_CTI.csv") %>%
  rename(site = Site)
McLAnn_cti <- read.csv("McLAnn_CTI.csv")  %>%
  rename(site = Site)
mcLserp_cti <- read.csv("McLSerp_CTI.csv") %>%
  rename(site = Site)
Swan_cti <- read.csv("Swanton_CTI.csv")  %>%
  rename(site = Site)
UCSC_cti <- read.csv("UCSC_CTI.csv")  %>%
  rename(site = Site)

all.CTI <- full_join(ang_cti, car_cti)
all.CTI <- full_join(all.CTI, elk_cti)
all.CTI <- full_join(all.CTI, jasp_cti)
all.CTI <- full_join(all.CTI, McLAnn_cti)
all.CTI <- full_join(all.CTI, mcLserp_cti)
all.CTI <- full_join(all.CTI, Swan_cti)
all.CTI <- full_join(all.CTI, UCSC_cti)

all.CTI <- all.CTI %>%
  select(-X, -hotTI, -ColdTI)

all.CTI <- left_join(all.CTI, wtryr_weather, by = c("year", "site"))
```

```{r cti graph}
ggplot(all.CTI, aes(x=year, y=CTI)) +
  geom_boxplot(aes(group = year)) +
      labs(title = "All sites - Community Temperature Index over time",
       x = "Year",
       y = "Community Temperature Index") +
  facet_wrap(~site, nrow=2) 

ggplot(all.CTI, aes(x=year, y=CTI)) +
  geom_boxplot(aes(group = year)) +
      labs(title = "All sites - Community Temperature Index over time",
       x = "Year",
       y = "Community Temperature Index") +
  stat_smooth(method = "lm", se = F, size =  1)
  

ggplot(all.CTI, aes(x=year, y=CPI)) +
  geom_boxplot(aes(group = year)) +
      labs(title = "All sites - Community Precipitation Index over time",
       x = "Year",
       y = "Community Precipitation Index") +
  facet_wrap(~site, nrow=2) 
```


## Analysis of CTI

In our CTI model, we expect the following:  
* Response variables (one at a time)
+ CTI
+ CPI

* Fixed Effects
+ Time/Year
+ Climate factors?

* Random Effects
+ Site
+ Plot within site


```{r angelo CTI}
hist(ang_cti$CTI)
ang_cti <- left_join(ang_cti, wtryr_weather)

cti.lm.ang <- nlme::lme(CTI ~ year + precip + tmin,
                    data = ang_cti, method = "REML",
                    random =  ~ 1 | plot)

summary(cti.lm.ang)

grid.arrange(plot(cti.lm.ang,type=c("p","smooth")),
             plot(cti.lm.ang,sqrt(abs(resid(.)))~fitted(.),
                  type=c("p","smooth"),ylab=expression(sqrt(abs(resid)))),
                                       ## "sqrt(abs(resid(x)))"),
             plot(cti.lm.ang,resid(.,type="pearson")~year,
                  type=c("p","smooth")),
             qqnorm(cti.lm.ang,abline=c(0,1)))

cti.lm.ang <- nlme::lme(CTI ~ year + precip + tmin,
                    data = all.CTI[all.CTI$site == "Angelo",], method = "REML",
                    random =  ~ 1 | plot)

summary(cti.lm.ang)

grid.arrange(plot(cti.lm.ang,type=c("p","smooth")),
             plot(cti.lm.ang,sqrt(abs(resid(.)))~fitted(.),
                  type=c("p","smooth"),ylab=expression(sqrt(abs(resid)))),
                                       ## "sqrt(abs(resid(x)))"),
             plot(cti.lm.ang,resid(.,type="pearson")~year,
                  type=c("p","smooth")),
             qqnorm(cti.lm.ang,abline=c(0,1)))


```

```{r all sites CTI}
hist(all.CTI$CTI)

cti.lm <- nlme::lme(CTI ~ year,
                    data = all.CTI, method = "REML",
                    random =  ~ 1 | site/plot)

summary(cti.lm)

grid.arrange(plot(cti.lm,type=c("p","smooth")),
             plot(cti.lm,sqrt(abs(resid(.)))~fitted(.),
                  type=c("p","smooth"),ylab=expression(sqrt(abs(resid)))),
                                       ## "sqrt(abs(resid(x)))"),
             plot(cti.lm,resid(.,type="pearson")~year,
                  type=c("p","smooth")),
             qqnorm(cti.lm,abline=c(0,1)))


```

