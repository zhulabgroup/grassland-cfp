---
title: "CTI_Analysis"
author: "Josie Lesage"
date: "1/22/2020"
output: html_document
---

```{r setup, include=FALSE}
## community analysis
library(codyn)
library(MASS)
library(lme4)
library(nlme)

## misc/both/other
library(oz)
library(plotrix)
library(tidyverse)
library(gridExtra) 

```

```{r custom ggplot, echo=FALSE, warning=FALSE, message=FALSE}
theme_set(theme_bw())
scale_colour_discrete <- function(...,palette="Set1") {
    scale_colour_brewer(...,palette=palette)
}
scale_colour_orig <- ggplot2::scale_colour_discrete
scale_fill_discrete <- function(...,palette="Set1") {
    scale_fill_brewer(...,palette=palette)
}
## to squash facets together ...
zmargin <- theme(panel.spacing=grid::unit(0,"lines"))
```


# Background

The goal is for these CTI model(s) to answer the following questions:  
1. Is CTI increasing over time?  
2. Are changes in CTI driven by changes in climate variables?  


```{r cti data import, echo = FALSE, warning=FALSE, message=FALSE}
setwd("CTI Data")
ang_cti <- read.csv("Angelo_CTI.csv")
car_cti <- read.csv("Carrizo_CTI.csv") %>%
  rename(site = Site)
elk_cti <- read.csv("Elkhorn_CTI.csv") %>%
  rename(site = Site)
jasp_cti <- read.csv("Jasper_CTI.csv") %>%
  rename(site = Site)
McLAnn_cti <- read.csv("McLAnn_CTI.csv")  %>%
  rename(site = Site)
mcLserp_cti <- read.csv("McLSerp_CTI.csv") %>%
  rename(site = Site)
Swan_cti <- read.csv("Swanton_CTI.csv")  %>%
  rename(site = Site)
UCSC_cti <- read.csv("UCSC_CTI.csv")  %>%
  rename(site = Site)
```

```{r prism weather import, echo = FALSE, warning=FALSE, message=FALSE}
weather <- read.csv("PRISM_data.csv") %>%
  select(-X)
wtryr_weather <- read.csv("PRISM_wtryr_data.csv") %>%
  select(-X)
```

```{r data prep, echo = FALSE, warning=FALSE, message=FALSE}
all.CTI <- full_join(ang_cti, car_cti)
all.CTI <- full_join(all.CTI, elk_cti)
all.CTI <- full_join(all.CTI, jasp_cti)
all.CTI <- full_join(all.CTI, McLAnn_cti)
all.CTI <- full_join(all.CTI, mcLserp_cti)
all.CTI <- full_join(all.CTI, Swan_cti)
all.CTI <- full_join(all.CTI, UCSC_cti)

all.CTI <- all.CTI %>%
  select(-X, -hotTI, -ColdTI)

all.CTI <- left_join(all.CTI, wtryr_weather, by = c("year", "site")) %>%
  filter(year >= 1999)
```



```{r cti graphs, echo = FALSE, warning=FALSE, message=FALSE}
ggplot(all.CTI, aes(x=year, y=CTI)) +
  geom_boxplot(aes(group = year)) +
      labs(title = "All sites - Community Temperature Index over time",
       x = "Year",
       y = "Community Temperature Index") +
  facet_wrap(~site, nrow=2) 

ggplot(all.CTI, aes(x=year, y=CTI)) +
  geom_boxplot(aes(group = year)) +
      labs(title = "All sites - Community Temperature Index over time",
       x = "Year",
       y = "Community Temperature Index") +
  stat_smooth(method = "lm", se = F, size =  1)

ggplot(all.CTI,aes(x=year, y=CTI, colour=site)) +
  geom_point() +
  geom_smooth(method="lm", alpha=0.3) +
  scale_y_continuous(oob=scales::squish)+
    ## use original colours (Dark2 doesn't have enough distinct values)
    ## suppress legend
    scale_colour_orig(guide="none")
```


# Analysis/Model Testing

In our CTI model, we expect the following:  
* Response variables (one at a time)
+ CTI
+ CPI

* Fixed Effects
+ Time/Year
+ Climate factors?

* Random Effects
+ Site
+ Plot within site

I am using [Ben Bolker's worked GLMM page ](https://bbolker.github.io/mixedmodels-misc/ecostats_chap.html) as a guide to build my models for hypothesis testing. 

```{r explore CTI}
hist(all.CTI$CTI)

cti.lm <- nlme::lme(CTI ~ year + precip + tmin,
                    data = all.CTI, method = "REML",
                    random =  ~ 1 | site/plot)

summary(cti.lm)
```

```{r check fit}
grid.arrange(plot(cti.lm,type=c("p","smooth")),
             plot(cti.lm,sqrt(abs(resid(.)))~fitted(.),
                  type=c("p","smooth"),ylab=expression(sqrt(abs(resid)))),
                                       ## "sqrt(abs(resid(x)))"),
             plot(cti.lm,resid(.,type="pearson")~year,
                  type=c("p","smooth")),
             qqnorm(cti.lm,abline=c(0,1)))

```

