---
title: "CTI Analysis"
author: "Josie Lesage"
date: "1/23/2020"
output: html_document
---


```{r setup, include=FALSE}
## community analysis
library(codyn)
library(MASS)
library(lme4)
library(nlme)


## misc/both/other
library(oz)
library(plotrix)
library(tidyverse)
library(gridExtra)

knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

```{r prism data import and prep, echo = FALSE}
weather <- read.csv("Analysis/ClimData/PRISM_data.csv") %>%
  select(-X)

wtryr_weather <- read.csv("Analysis/ClimData/PRISM_wtryr_data.csv") %>%
  select(-X)

```


```{r CTI import and prep, cache = TRUE}
ang_cti <- read.csv("Analysis/CTI Data/Angelo_CTI.csv")
car_cti <- read.csv("Analysis/CTI Data/Carrizo_CTI.csv") %>%
  rename(site = Site)
elk_cti <- read.csv("Analysis/CTI Data/Elkhorn_CTI.csv") %>%
  rename(site = Site)
jasp_cti <- read.csv("Analysis/CTI Data/Jasper_CTI.csv") %>%
  rename(site = Site)
McLAnn_cti <- read.csv("Analysis/CTI Data/McLAnn_CTI.csv")  %>%
  rename(site = Site)
mcLserp_cti <- read.csv("Analysis/CTI Data/McLSerp_CTI.csv") %>%
  rename(site = Site)
Swan_cti <- read.csv("Analysis/CTI Data/Swanton_CTI.csv")  %>%
  rename(site = Site)
UCSC_cti <- read.csv("Analysis/CTI Data/UCSC_CTI.csv")  %>%
  rename(site = Site)

all.CTI <- full_join(ang_cti, car_cti)
all.CTI <- full_join(all.CTI, elk_cti)
all.CTI <- full_join(all.CTI, jasp_cti)
all.CTI <- full_join(all.CTI, McLAnn_cti)
all.CTI <- full_join(all.CTI, mcLserp_cti)
all.CTI <- full_join(all.CTI, Swan_cti)
all.CTI <- full_join(all.CTI, UCSC_cti)

all.CTI <- all.CTI %>%
  select(-X, -hotTI, -ColdTI)

all.CTI <- left_join(all.CTI, wtryr_weather, by = c("year", "site"))
```

```{r cti graph}
ggplot(all.CTI, aes(x=year, y=CTI, color = site)) +
  geom_boxplot(aes(group = year)) +
      labs(title = "All sites - Community Temperature Index over time",
       x = "Year",
       y = "Community Temperature Index") +
  theme(legend.position = "bottom") +
  facet_wrap(~site, nrow=2) 

ggplot(all.CTI, aes(x=year, y=CTI, color = site)) +
  geom_boxplot(aes(group = year)) +
      labs(title = "All sites - Community Temperature Index over time",
       x = "Year",
       y = "Community Temperature Index") +
  stat_smooth(method = "lm", se = F, size =  1)
  

ggplot(all.CTI, aes(x=year, y=CPI, color = site)) +
  geom_boxplot(aes(group = year)) +
      labs(title = "All sites - Community Precipitation Index over time",
       x = "Year",
       y = "Community Precipitation Index") +
  facet_wrap(~site, nrow=2) 
```


## Analysis of CTI

In our CTI model, we expect the following:  
* Response variables (one at a time)
+ CTI
+ CPI

* Fixed Effects
+ Time/Year
+ Climate factors?

* Random Effects
+ Site
+ Plot within site


```{r site-by-site CTI}
# angelo
ang.cti <- all.CTI %>% filter(site == "Angelo")
hist(ang.cti$CTI)
ang.cti.lm <- nlme::lme(CTI ~ year + tmin + precip,
                    data = ang.cti, method = "REML",
                    random =  ~ 1 | plot)
summary(ang.cti.lm)

# carrizo
car.cti <- all.CTI %>% filter(site == "Carrizo")
hist(car.cti$CTI)
car.cti.lm <- nlme::lme(CTI ~ year + tmin + precip,
                    data = car.cti, method = "REML",
                    random =  ~ 1 | plot)
summary(car.cti.lm)

# elkhorn
elk.cti <- all.CTI %>% filter(site == "Elkhorn")
hist(elk.cti$CTI)
elk.cti.lm <- nlme::lme(CTI ~ year + tmin + precip,
                    data = elk.cti, method = "REML",
                    random =  ~ 1 | plot)
summary(elk.cti.lm)

# jasper
jasp.cti <- all.CTI %>% filter(site == "Jasper")
hist(jasp.cti$CTI)
jasp.cti.lm <- nlme::lme(CTI ~ year + tmin + precip,
                    data = jasp.cti, method = "REML",
                    random =  ~ 1 | plot)
summary(jasp.cti.lm)

# mcL ann
mcLann.cti <- all.CTI %>% filter(site == "McL Ann")
hist(mcLann.cti$CTI)
mcLann.cti.lm <- nlme::lme(CTI ~ year + tmin + precip,
                    data = mcLann.cti, method = "REML",
                    random =  ~ 1 | plot)
summary(mcLann.cti.lm)

# mcL serp
mcLserp.cti <- all.CTI %>% filter(site == "McL Serp")
hist(mcLserp.cti$CTI)
mcLserp.cti.lm <- nlme::lme(CTI ~ year + tmin + precip,
                    data = mcLserp.cti, method = "REML",
                    random =  ~ 1 | plot)
summary(mcLserp.cti.lm)

# swanton
swan.cti <- all.CTI %>% filter(site == "Swanton")
hist(swan.cti$CTI)
swan.cti.lm <- nlme::lme(CTI ~ year + tmin + precip,
                    data = swan.cti, method = "REML",
                    random =  ~ 1 | plot)
summary(swan.cti.lm)


# ucsc
ucsc.cti <- all.CTI %>% filter(site == "UCSC")
hist(ucsc.cti$CTI)
ucsc.cti.lm <- nlme::lme(CTI ~ year + tmin + precip,
                    data = ucsc.cti, method = "REML",
                    random =  ~ 1 | plot)
summary(ucsc.cti.lm)




```

```{r all sites CTI}
hist(all.CTI$CTI)

## using lme; year only
cti.lm <- nlme::lme(CTI ~ year,
                    data = all.CTI, method = "REML",
                    random =  ~ 1 | site/plot)

summary(cti.lm)

grid.arrange(plot(cti.lm,type=c("p","smooth")),
             plot(cti.lm,sqrt(abs(resid(.)))~fitted(.),
                  type=c("p","smooth"),ylab=expression(sqrt(abs(resid)))),
                                       ## "sqrt(abs(resid(x)))"),
             plot(cti.lm,resid(.,type="pearson")~year,
                  type=c("p","smooth")),
             qqnorm(cti.lm,abline=c(0,1)))


## using lmer
cti.glm <- lmer(CTI ~ year + precip + tmin + (1|site/plot), data = all.CTI)
summary(cti.glm)
grid.arrange(plot(cti.glm,type=c("p","smooth")),
             plot(cti.glm,sqrt(abs(resid(.)))~fitted(.),
                  type=c("p","smooth"),ylab=expression(sqrt(abs(resid)))),
             plot(cti.glm,resid(.,type="pearson")~year,
                  type=c("p","smooth")),
             plot(cti.glm,resid(.,type="pearson")~precip,
                  type=c("p","smooth")),
             plot(cti.glm,resid(.,type="pearson")~tmin,
                  type=c("p","smooth")))


## using lme; 'full' model
cti.lm <- nlme::lme(CTI ~ year + tmin + precip,
                    data = all.CTI, method = "REML",
                    random =  ~ 1 | site/plot)
summary(cti.lm)
grid.arrange(plot(cti.lm,type=c("p","smooth")),
             plot(cti.lm,sqrt(abs(resid(.)))~fitted(.),
                  type=c("p","smooth"),ylab=expression(sqrt(abs(resid)))),
                                       ## "sqrt(abs(resid(x)))"),
             plot(cti.lm,resid(.,type="pearson")~year,
                  type=c("p","smooth")),
             qqnorm(cti.lm,abline=c(0,1)))



```

