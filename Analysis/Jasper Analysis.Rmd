---
title: "CTI Analysis - Jasper Test"
author: "Josie Lesage"
date: "10/25/2019"
output: html_document
---

# Setup and data import
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(codyn)
library(CoordinateCleaner)
library(countrycode)
library(MASS)
library(mapr)
library(maptools)
library(oz)
library(plotrix)
library(raster)
library(rgbif)
library(scrubr)
library(sp)
library(spocc)
library(tidyverse)
library(vegan)
library(lubridate)
```


```{r data import, include = FALSE}
jasper_data <- read.csv("jasper_data.csv") %>%
    mutate(species.name = fct_recode(species.name, 
                                   'Eschscholzia californica' = 'Escholtzia californica',
                                   'Elymus multisetus' = 'Elymus multisedis'))
  

```
### Introduction
The goal for this project is threefold:

1. To determine whether species richness is changing over time. 
2. To understand whether the rate of community turnover has changed over time.
3. To understand whether the CTI or CPI has changed over time.

To address #3, I will download species occurance location data from GBIF for the species in the Jasper ridge plots, and associate this location data with climate data from the WorldClim database. I will do any cleaning that's needed between these steps before I can generate a community temperature/precipitation index for the site over time.

### Some notes about Jasper as the pilot analysis
Jasper Ridge is the first location where I will attempt these analyses, as it is the longest running dataset that I am using.  

In these analyses, I can possibly download species occurrance data using multiple packages. One of these is the ['spocc' package](https://cran.r-project.org/web/packages/spocc/spocc.pdf). Another that I could use is the 'rgbif' package.  

I will (likely) also use the following packages for coordinate cleanup, mapping, and duplicate removal:  
scrubr  
CoordinateCleaner  

**Valuable resources**  
Additionally, there are a number of valuable resources that I'll keep track of here:  
1. [Journal article on the problems of using herbarium data](https://esajournals.onlinelibrary.wiley.com/doi/full/10.1890/07-2153.1)  
2. [R implementation of less niave spatial climate data](https://rpubs.com/remkoduursma/226109)  
3. [How to use the SpOcc package](https://ropensci.github.io/spocc/)  
4. [Introduction to species distribution modelling in R](https://jcoliver.github.io/learn-r/011-species-distribution-models.html)  
5. [Nordic Oikos guide to using raster/worldclim with data](https://github.com/GBIF-Europe/nordic_oikos_2018_r/blob/master/s5_environment/worldclim.Rmd)


## Preparing a species list table
In order to get the appropriate data from gbif, we need to generate a table of species/genus information that we can reference and call from.

```{r Jasper species table, cache = TRUE}
jasper_species <- unique(jasper_data$species.name)
jasper_list <- as.data.frame(jasper_species)
jasper_list$jasper_species <- paste0("'", jasper_list$jasper_species, "',")
  
cat(format_delim(jasper_list, delim = ""))
```

There are a total of 33 species in the Jasper Ridge dataset.  
*Note:* There are two "species" in this dataset that are missing species information (Brodaeia and Trifolium) which I need to determine what I will do with. I can remove them, potentially, or collect data for all Trifolium and Broadaeia in the state. 


# Community Poisson GLM

**Look at chapter 14 of the Mixed Models book.**

Before running our analysis, we should check the means and variance for the response variable over different predictor variables. 

```{r add relcov}
jasper_data <- jasper_data %>%
  filter(cover > 0) %>%
  group_by(trtrep, year) %>%
  mutate(sumcov = sum(cover),
         relcov = cover/sumcov)

```


```{r Rich explore}
jasp_rich_means <- jasper_data %>%
  group_by(year, trtrep) %>%
  summarise(rich = n_distinct(species.name)) %>%
  ungroup() %>% group_by(year) %>%
  summarise(meanrich = mean(rich),
            serich = (std.error(rich)))

jasp_rich <- jasper_data %>%
  group_by(year, trtrep) %>%
  summarise(rich = n_distinct(species.name))

ggplot(jasp_rich_means, aes(x = year, y = meanrich)) +
  geom_line() 

```

# Community turnover annual +/-

To answer who joins and who leaves each year, we need to calculate the species in the starting year, then see how many are added and how many leave. We'll do this with Lauren Hallet's (hopefully awesome) codyn package - which has a function for turnover.

```{r turnover metrics}

jasper_byrep <- jasper_data %>%
  select(year, trtrep, species.name, cover) %>%
  group_by(trtrep, year) %>%
  mutate(sumcov = sum(cover),
         relcov = cover/sumcov)

jasp_turnover <- turnover(df = jasper_data,
                          time.var = "year",
                          species.var = "species.name",
                          abundance.var = "cover",
                          replicate.var = "trtrep")

jasp_turn_means <- jasp_turnover %>%
  group_by(year) %>%
  summarise(meanturn = mean(total),
            seturn = std.error(total))

ggplot(jasp_turn_means, aes(x = year, y = meanturn)) +
  geom_point() +
  geom_errorbar(aes(ymin = meanturn-seturn, ymax = meanturn+seturn)) +
  labs(title = "Jasper - Community Turnover (n = 3)",
       x = "Year",
       y = "Turnover (# spp. lost+gained / total # spp.)")

```




# CTI
## Gathering & cleaning occurance data

We will gather species occurrance data from GBIF through the SpOcc package. For the datapoints that are not at the species level, I'll use species lists from the site, and generalize from that data.


```{r grabbing jasper gbif data, echo = FALSE, cache = TRUE, warning=FALSE}
jasp_species_list <- c('Agoseris heterophylla', 
         'Astragalus gambellianus',
         'Bromus hordeaceus',
         'Calycadenia multiglandulosa',
         'Chlorogalum pomeridianum',
         'Eschscholzia californica',
         'Hesperevax sparsiflora',
         'Lasthenia californica',
         'Layia platyglossa',
         'Lepidium nitidum',
         'Linanthus parviflorus',
         'Lotus wrangelianus',
         'Micropus californicus',
         'Microseris douglasii',
         'Castilleja densiflora',
         'Plantago erecta',
         'Poa secunda',
         'Elymus multisetus',
         'Stipa pulchra',
         'Crassula connata',
         'Vulpia microstachys',
         'Minuartia douglasii',
         'Hemizonia congesta',
         'Epilobium brachycarpum',
         'Calandrinia ciliata',
         'Plagiobothrys nothofulvus',
         'Gilia clivorum',
         'Lolium multiflorum',
         'Melica californica',
         'Lomatium utriculatum',
         'Bromus berteroanus')

# jasp_species_data <- occ(query = jasp_species_list, from = "gbif", has_coords = TRUE, limit = 10000,
#                gbifopts = list(hasGeospatialIssue = FALSE, country = "US",
#                                stateProvince = "California"))

## we can also replace all synonym taxon names with one (cuts down the number of plotted dot colors)
## we should use the scrubr version of the function in the future
jasp_species_data <- fixnames(jasp_species_data, how = "query")

## The occ2df function should convert the data to a dataframe format
jasp_species_data_df <- occ2df(jasp_species_data)

map_ggplot(jasp_species_data, map = "state", size = 0.5) 


```


We need to clean the coordinates, as it appears some are in the ocean, and there might be some that are just incorrect. To do this, we will use a coordinate cleaner package.

```{r cleaning jasper coords, echo=FALSE, cache = TRUE, dependson="grabbing jasper gbif data"}
flags <- clean_coordinates(x = jasp_species_data_df, lon = "longitude", lat = "latitude",
                          species = "name",
                          tests = c("capitals", "centroids", "equal","gbif", "institutions",
                                    "seas", "zeros")) # most test are on by default

plot(flags, lon = "longitude", lat = "latitude")

```
There were (~2005 out of 32,260, so ~6%) were flagged.  

```{r examine flagged coords, echo=FALSE, cache = TRUE, dependson="cleaning jasper coords"}

flag_df <- jasp_species_data_df[!flags$.summary,]
str(flag_df)
summary(flag_df)

# keep only the non-flagged data
jasp_species_data_df <- jasp_species_data_df[flags$.summary,]

```
It appears that there were flagged instances for most of the species. For this practice run-through, I'll definitely just cut them out without taking a closer look (for now).  
More guidance on cleaning datasets and removing bad coordinates is [available here](https://ropensci.github.io/CoordinateCleaner/articles/Tutorial_Cleaning_GBIF_data_with_CoordinateCleaner.html).  

## Adding climate data

Following the jcoliver webpage guides...

```{r map of geo extent, echo = FALSE}
max.lat <- ceiling(max(jasp_species_data_df$latitude))
min.lat <- floor(min(jasp_species_data_df$latitude))
max.lon <- ceiling(max(jasp_species_data_df$longitude))
min.lon <- floor(min(jasp_species_data_df$longitude))
geographic.extent <- extent(x = c(min.lon, max.lon, min.lat, max.lat))

# Load the data to use for our base map
data(wrld_simpl)

# Plot the base map
plot(wrld_simpl, 
     xlim = c(min.lon, max.lon),
     ylim = c(min.lat, max.lat),
     axes = TRUE, 
     col = "grey95")

# Add the points for individual observation
points(x = jsl_data_df$longitude, 
       y = jsl_data_df$latitude, 
       col = "olivedrab", 
       pch = 20, 
       cex = 0.75)
# And draw a little box around the graph
box()
```

```{r based on oikos page, cache = TRUE}
xy <- jasp_species_data_df[,c("longitude","latitude")]
sp_xy <- jasp_species_data_df[c("name", "longitude","latitude")]

sp_xy <- sp_xy %>%
  rename(species = name)


env <- getData('worldclim', var='bio', res=2.5)

plot(env, 1, main=NULL, axes=FALSE)
points(xy, col='blue', pch=20)

xy_bio <- raster::extract(env, xy)

```

Reference list for climate variables at Jasper:
 * BIO1 = Annual Mean Temperature (Â°C * 10) -- (i.e. 231 represents 23.1 Â°C)
 * BIO2 = Mean Diurnal Range (Mean of monthly (max temp â min temp)) 
 * BIO3 = Isothermality (BIO2/BIO7) (* 100)
 * BIO4 = Temperature Seasonality (standard deviation *100)
 * BIO5 = Max Temperature of Warmest Month (Â°C * 10)
 * BIO6 = Min Temperature of Coldest Month (Â°C * 10)
 * BIO7 = Temperature Annual Range (BIO5-BIO6)
 * BIO8 = Mean Temperature of Wettest Quarter (Â°C * 10)
 * BIO9 = Mean Temperature of Driest Quarter (Â°C * 10)
 * BIO10 = Mean Temperature of Warmest Quarter (Â°C * 10)
 * BIO11 = Mean Temperature of Coldest Quarter (Â°C * 10)
 * BIO12 = Annual Precipitation (mm)
 * BIO13 = Precipitation of Wettest Month (mm)
 * BIO14 = Precipitation of Driest Month (mm)
 * BIO15 = Precipitation Seasonality (Coeficent of Variation) 
 * BIO16 = Precipitation of Wettest Quarter (mm)
 * BIO17 = Precipitation of Driest Quarter (mm)
 * BIO18 = Precipitation of Warmest Quarter (mm)
 * BIO19 = Precipitation of Coldest Quarter (mm)
 
```{r mean species temp, echo=FALSE}
jasp_clim <- cbind(xy_bio, sp_xy)

jasp_clim <- jasp_clim %>%
  group_by(species) %>%
  summarise(meant = mean(bio1, na.rm = TRUE),
         meanp = mean(bio12, na.rm = TRUE),
         coldT = mean(bio6, na.rm = TRUE),
         hotT = mean(bio5, na.rm = TRUE)) %>%
  mutate(meanT = meant/10,
         coldT = coldT/10,
         hotT = hotT/10) %>%
  rename(species.name = species)
```
 
### Brodiaea

```{r Jasper Brodiaea}

jasp_brodiaea <- c('Brodiaea elegans ssp. elegans',
                   'Brodiaea terrestris ssp. terrestris')
         
# jasp_brodiaea_data <- occ(query = jasp_brodiaea, from = "gbif", has_coords = TRUE, limit = 10000,
#                gbifopts = list(hasGeospatialIssue = FALSE, country = "US",
#                                stateProvince = "California"))

## we can also replace all synonym taxon names with one (cuts down the number of plotted dot colors)
## we should use the scrubr version of the function in the future
jasp_brodiaea_data <- fixnames(jasp_brodiaea_data, how = "query")

## The occ2df function should convert the data to a dataframe format
jasp_brodiaea_data_df <- occ2df(jasp_brodiaea_data)

# map_ggplot(jasp_brodiaea_data, map = "state", size = 0.5) 

flags <- clean_coordinates(x = jasp_brodiaea_data_df, lon = "longitude", lat = "latitude",
                          species = "name",
                          tests = c("capitals", "centroids", "equal","gbif", "institutions",
                                    "seas", "zeros")) # most test are on by default

# remove flagged records
jasp_brodiaea_data_df <- jasp_brodiaea_data_df[flags$.summary,]
```

``` {r Jasp Brod coords}
# extract lat/long for each datapoint
xy <- jasp_brodiaea_data_df[,c("longitude","latitude")]
sp_xy <- jasp_brodiaea_data_df[c("name", "longitude","latitude")]
sp_xy <- sp_xy %>%
  rename(species = name)
env <- getData('worldclim', var='bio', res=2.5)
plot(env, 1, main=NULL, axes=FALSE)
points(xy, col='blue', pch=20)
xy_bio <- raster::extract(env, xy)
jasp_brodiaea_clim <- cbind(xy_bio, sp_xy)

# change all datapoints to the "species sp" format that's used in the og dataframe, calc CTI
jasp_brodiaea_clim <- jasp_brodiaea_clim %>%
  mutate(species.name = "Brodiaea sp") %>%
   group_by(species.name) %>%
   summarise(meant = mean(bio1, na.rm = TRUE),
         meanp = mean(bio12, na.rm = TRUE),
         coldT = mean(bio6, na.rm = TRUE),
         hotT = mean(bio5, na.rm = TRUE)) %>%
  mutate(meanT = meant/10,
         coldT = coldT/10,
         hotT= hotT/10) 
```

### Trifolium
```{r Jasper Trifolium}
jasp_trifolium <- c('Trifolium albopurpureum var. albopurpureum',
                    'Trifolium arvense',
                    'Trifolium barbigerum var. barbigerum',
                    'Trifolium bifidum var. bifidum',
                    'Trifolium bifidum var. decipiens',
                    'Trifolium campestre',
                    'Trifolium cernuum',
                    'Trifolium ciliolatum',
                    'Trifolium depauperatum var. amplectens',
                    'Trifolium depauperatum var. truncatum',
                    'Trifolium albopurpureum var. dichotomum',
                    'Trifolium dubium',
                    'Trifolium fucatum',
                    'Trifolium glomeratum',
                    'Trifolium gracilentum var. gracilentum',
                    'Trifolium hirtum',
                    'Trifolium microcephalum',
                    'Trifolium microdon',
                    'Trifolium oliganthum',
                    'Trifolium repens',
                    'Trifolium subterraneum',
                    'Trifolium variegatum var. variegatum',
                    'Trifolium willdenovii')

# jasp_trifolium_data <- occ(query = jasp_trifolium, from = "gbif", has_coords = TRUE, limit = 10000,
#                gbifopts = list(hasGeospatialIssue = FALSE, country = "US",
#                                stateProvince = "California"))

## we can also replace all synonym taxon names with one (cuts down the number of plotted dot colors)
## we should use the scrubr version of the function in the future
jasp_trifolium_data <- fixnames(jasp_trifolium_data, how = "query")

## The occ2df function should convert the data to a dataframe format
jasp_trifolium_data_df <- occ2df(jasp_trifolium_data)

map_ggplot(jasp_trifolium_data, map = "state", size = 0.5) 

flags <- clean_coordinates(x = jasp_trifolium_data_df, lon = "longitude", lat = "latitude",
                          species = "name",
                          tests = c("capitals", "centroids", "equal","gbif", "institutions",
                                    "seas", "zeros")) # most test are on by default

# remove flagged records
jasp_trifolium_data_df <- jasp_trifolium_data_df[flags$.summary,]
```

``` {r Jasp Trifolium coords}
# extract lat/long for each datapoint
xy <- jasp_trifolium_data_df[,c("longitude","latitude")]
sp_xy <- jasp_trifolium_data_df[c("name", "longitude","latitude")]
sp_xy <- sp_xy %>%
  rename(species = name)
env <- getData('worldclim', var='bio', res=2.5)

xy_bio <- raster::extract(env, xy)
jasp_trifolium_clim <- cbind(xy_bio, sp_xy)

# change all datapoints to the "species sp" format that's used in the og dataframe, calc CTI
jasp_trifolium_clim <- jasp_trifolium_clim %>%
  mutate(species.name = "Trifolium sp") %>%
   group_by(species.name) %>%
   summarise(meant = mean(bio1, na.rm = TRUE),
         meanp = mean(bio12, na.rm = TRUE),
         coldT = mean(bio6, na.rm = TRUE),
         hotT = mean(bio5, na.rm = TRUE)) %>%
  mutate(meanT = meant/10,
         coldT = coldT/10,
         hotT = hotT/10) 
```


## Calculating CTI for Jasper
To calculate CTI, we need to summarize the weight of each species in a community and multiply that by the TI for that species. 

```{r Creating CTI table}
jasper_byrep <- jasper_data %>%
  select(year, trtrep, species.name, cover) %>%
  group_by(trtrep, year) %>%
  mutate(sumcov = sum(cover),
         relcov = cover/sumcov)

jasp_CTI <- left_join(jasper_byrep, jasp_clim, by = "species.name") 
jasp_CTI <- left_join(jasp_CTI, jasp_brodiaea_clim, by = "species.name") %>%
  mutate(meant = coalesce(meant.x, meant.y),
         meanp = coalesce(meanp.x, meanp.y),
         meanT = coalesce(meanT.x, meanT.y),
         coldT = coalesce(coldT.x, coldT.y),
         hotT = coalesce(hotT.x, hotT.y),) %>% 
  select(-meant.x, -meant.y, -meanp.x, -meanp.y, -meanT.x, -meanT.y, -coldT.x, -coldT.y, -hotT.x, -hotT.y)
jasp_CTI <- left_join(jasp_CTI, jasp_trifolium_clim, by = "species.name") %>%
  mutate(meant = coalesce(meant.x, meant.y),
         meanp = coalesce(meanp.x, meanp.y),
         meanT = coalesce(meanT.x, meanT.y),
         coldT = coalesce(coldT.x, coldT.y),
         hotT = coalesce(hotT.x, hotT.y),) %>% 
  select(-meant.x, -meant.y, -meanp.x, -meanp.y, -meanT.x, -meanT.y, -coldT.x, -coldT.y, -hotT.x, -hotT.y)

jasp_CTI <- jasp_CTI %>%
  mutate(relTI = relcov*meanT,
         relP = relcov*meanp,
         relCold = relcov*coldT,
         relHot = relcov*hotT) %>%
  group_by(year, trtrep) %>%
  summarise(CTI = sum(relTI, rm.na = TRUE),
            CPI = sum(relP, rm.na = TRUE),
            ColdTI = sum(relCold, rm.na = TRUE),
            hotTI = sum(relHot, rm.na = TRUE))

jasp_CTI_means <- jasp_CTI %>%
  group_by(year) %>%
  summarise(meanCTI = mean(CTI),
            seCTI = std.error(CTI),
            meanCPI = mean(CPI),
            seCPI = std.error(CPI),
            meanCold = mean(ColdTI),
            seCold = std.error(ColdTI),
            meanHot = mean(hotTI),
            seHot = std.error(hotTI))

# CTI:
 ggplot(jasp_CTI_means, aes(x=year, y=meanCTI)) +
   geom_point() +
   geom_errorbar(aes(ymin = meanCTI-seCTI, ymax = meanCTI+seCTI), width=0.2) +
    labs(title = "Jasper Ridge - CTI using mean temperatures",
       x = "Year",
       y = "Community Temperature Index")


 # Cold CTI
  ggplot(jasp_CTI_means, aes(x=year, y=meanCold)) +
   geom_point() +
   geom_errorbar(aes(ymin = meanCold-seCold, ymax = meanCold+seCold), width=0.2) +
    labs(title = "Jasper Ridge - CTI using Cold Month Minimum",
       x = "Year",
       y = "Community Temperature Index")

  
# Hot CTI
  ggplot(jasp_CTI_means, aes(x=year, y=meanHot)) +
   geom_point() +
   geom_errorbar(aes(ymin = meanHot-seHot, ymax = meanHot+seHot), width=0.2) +
    labs(title = "Jasper Ridge - CTI using Hottest Month Max",
       x = "Year",
       y = "Community Temperature Index")

# CPI
 ggplot(jasp_CTI_means, aes(x=year, y=meanCPI)) +
   geom_point() +
   geom_errorbar(aes(ymin = meanCPI-seCPI, ymax = meanCPI+seCPI), width=0.2)
 

```

# Combining CTI with weather

In order to see how responsive Jasper ridge has been to annual variation in weather, I can compare the CTI of any given year with the precipitation that fell that year.

```{r Creating a CTI/weather dataset, cache = TRUE}
jaspw_year <- jaspw_sum %>%
  group_by(wateryr) %>%
  summarise(precip = sum(ppt),
            tmean = mean(tmean)) %>%
  rename(year = wateryr) 

jaspw_lag <- jaspw_year %>%
  mutate(lagyear = year + 1) %>%
  rename(lagprecip = precip,
         lagtmean = tmean) %>%
  select(-year) %>%
  rename(year = lagyear)

jaspw_year <- left_join(jaspw_year, jaspw_lag, by = "year") %>%
  mutate(twoyrprecip = precip + lagprecip)
  
jasp_wcti <- left_join(jasp_CTI, jaspw_year, by = "year")

jasp_wcti_means <- left_join(jasp_CTI_means, jaspw_year, by = "year")
  
```


```{r preliminary plots, cache = TRUE}

## all data plotted
ggplot(jasp_wcti) +
  geom_point(aes(x = lagprecip, y = CTI), color = "blue") +
  stat_smooth(method = "lm", se = F, size = 1, aes(x = lagprecip, y = CTI), color = "blue") +
  labs(title = "Precipitation and CTI", x = "Precipitation (mm)", y = "CTI")

ggplot(jasp_wcti) +
  geom_point(aes(x = lagprecip, y = CPI), color = "blue") +
  stat_smooth(method = "lm", se = F, size = 1, aes(x = lagprecip, y = CPI), color = "blue") +
  labs(title = "Precipitation and CPI", x = "Precipitation (mm)", y = "CPI")

ggplot(jasp_wcti) +
  geom_point(aes(x = lagtmean, y = CTI), color = "blue") +
  stat_smooth(method = "lm", se = F, size = 1, aes(x = lagtmean, y = CTI), color = "blue") +
  geom_point(aes(x = tmean, y = CTI), color = "red") +
    stat_smooth(method = "lm", se = F, size = 1, aes(x = tmean, y = CTI), color = "red")  +
  labs(title = "tmean and CTI \n (blue is lagged tmean)", x = "", y = "CTI")

## means plotted
ggplot(jasp_wcti_means, aes(x = lagprecip, y = meanCTI),) +
  geom_point(color = "blue") +
  geom_errorbar(aes(ymin = meanCTI-seCTI, ymax = meanCTI+seCTI), width=0.2) +
  stat_smooth(method = "lm", se = F, size = 1, color = "blue") +
  labs(title = "Precipitation and CTI", x = "Precipitation (mm)", y = "CTI")

ggplot(jasp_wcti_means, aes(x = lagprecip, y = meanCPI)) +
  geom_point(color = "blue") +
  stat_smooth(method = "lm", se = F, size = 1, aes(x = lagprecip, y = meanCPI), color = "blue") +
  labs(title = "Precipitation and CPI", x = "Precipitation (mm)", y = "CPI")

```


### Saving CTI .csv

```{r CTI csv}

jasp_CTI <- jasp_CTI %>%
  rename(plot = trtrep) %>%
  mutate(Site = "Jasper")
write.csv(jasp_CTI, "Jasper_CTI.csv")

```


