---
title: "McLSerp_Analysis"
author: "Josie Lesage"
date: "12/4/2019"
output: html_document
---


# Setup and data import
```{r setup, include=FALSE}
## community analysis
library(codyn)
library(MASS)
library(vegan)
library(lme4)

## CTI analysis
library(CoordinateCleaner)
library(countrycode)
library(mapr)
library(maptools)
library(raster)
library(rgbif)
library(scrubr)
library(sp)
library(spocc)

## misc/both/other
library(oz)
library(plotrix)
library(tidyverse)

```

```{r data import, include = FALSE}
mcLserp_data <- read.csv("mcLserp_data.csv") %>%
 rename(species.name = Species_Name) %>%
    mutate(species.name = fct_recode(species.name,
                                     'Astragalus gambellianus' = 'Astragalus gambelianus',
                                     'Melilotus indicus' = 'Melilotus indica',
                                     'Antirrhinum vexillocalyculatum' = 'Antirrhinum vexillo-calyculatum',
                                     'Erythranthe guttata' = 'Mimulus guttatus'))

```

## Preparing a species list table
In order to get the appropriate data from gbif, we need to generate a table of species/genus information that we can reference and call from.

```{r species table}
mcLserp_species <- unique(mcLserp_data$species.name)
mcLserp_list <- as.data.frame(mcLserp_species)

mcLserp_list$mcLserp_species <- paste0("'", mcLserp_list$mcLserp_species, "',")
cat(format_delim(mcLserp_list, delim = ""))

```

There are a total of ~215 species in the McL Serp dataset.  


```{r fixing species table}
mcLserp_data <- mcLserp_data %>%
  filter(species.name != "Bare",
         species.name != "Rock",
         species.name != "Unknown forb")
```

**Note:** there is one instance of "bromus sp." in the dataset (1999), with 10 hits. I am not sure if I should remove this one hit, or leave it be. It's probably bromus hordeaceus - but no way to know for sure. 

```{r combing quads into single plots}
mcLserp_byquad <- mcLserp_data %>%
  filter(Cover > 0) %>%
  group_by(Site, Year, plot, species.name) %>%
  summarise(Cover = sum(Cover)) %>%
  ungroup() %>%
  group_by(plot, Year) %>%
  mutate(sumcov = sum(Cover),
         relcov = Cover/sumcov)
```


## WEATHER DATA

# Community Poisson GLM

**Look at chapter 14 of the Mixed Models book.**

Before running our analysis, we should check the means and variance for the response variable over different predictor variables. 

```{r Rich explore}
mcLserp_rich_means <- mcLserp_byquad %>%
  group_by(Year, plot) %>%
  filter(Cover > 0) %>%
  summarise(rich = n_distinct(species.name)) %>%
  ungroup() %>% group_by(Year) %>%
  summarise(meanrich = mean(rich),
            serich = (std.error(rich)))

elk_rich <- elkhorn_data %>%
  group_by(year, rep) %>%
  summarise(rich = n_distinct(species.name))

ggplot(mcLserp_rich_means, aes(x = Year, y = meanrich)) +
  geom_line() 

```

```{r Richness GLMM, dependson="Rich explore", cache = TRUE}
rich_glm <- glm(rich ~ year, elk_rich, family = poisson)

summary(rich_glm)

```


# Community turnover - annual +/-
To answer who joins and who leaves each year, we need to calculate the species in the starting year, then see how many are added and how many leave. We'll do this with Lauren Hallet's (hopefully awesome) codyn package - which has a function for turnover.

```{r turnover metrics}
mcLserp_turnover <- turnover(df = mcLserp_byquad,
                          time.var = "Year",
                          species.var = "species.name",
                          abundance.var = "relcov",
                          replicate.var = "plot")

McLserp_turn_means <- mcLserp_turnover %>%
  group_by(Year) %>%
  summarise(meanturn = mean(total),
            seturn = std.error(total))

ggplot(McLserp_turn_means, aes(x = Year, y = meanturn)) +
  geom_point() +
  geom_errorbar(aes(ymin = meanturn-seturn, ymax = meanturn+seturn)) +
  labs(title = "McL Serp - Community Turnover (n = 38)",
       x = "Year",
       y = "Turnover (# spp. lost+gained / total # spp.)")
```

```{r rate of change with codyn}
McLSerp.changerate <- rate_change_interval(mcLserp_byquad,
                                        time.var = "Year",
                                        species.var = "species.name",
                                        abundance.var = "Cover",
                                        replicate.var = "plot")

ggplot(McLSerp.changerate, aes(interval, distance, color = plot)) + 
  geom_point() + theme_bw() + stat_smooth(method = "lm", se = F, size = 2)

```


# Gathering & cleaning occurance data

We will gather species occurrance data from GBIF through the SpOcc package. 

```{r grabbing jasper gbif data, echo = FALSE, cache = TRUE, warning=FALSE}
## look at species list


McLSerp_species_list <- c('Astragalus gambellianus', 
                          'Avena fatua',
                          'Bromus hordeaceus',
                          'Bromus madritensis',
                          'Calochortus vestae',
                          'Centaurea solstitialis',
                          'Erodium cicutarium',
                          'Lupinus bicolor',
                          'Senecio vulgaris',
                          'Taeniatherum caput-medusae',
                          'Vulpia microstachys',
                          'Agoseris heterophylla',
                          'Calycadenia pauciflora',
                          'Dichelostemma capitatum',
                          'Gilia capitata',
                          'Gilia tricolor',
                          'Hemizonia congesta',
                          'Lotus humistratus',
                          'Minuartia californica',
                          'Nassella pulchra',
                          'Plantago erecta',
                          'Rigiopappus leptocladus',
                          'Thysanocarpus curvipes',
                          'Trifolium albopurpureum',
                          'Trifolium fucatum',
                          'Cerastium glomeratum',
                          'Athysanus pusillus',
                          'Chorizanthe membranacea',
                          'Holocarpha virgata',
                          'Lagophylla minor',
                          'Lotus wrangelianus',
                          'Micropus californicus',
                          'Minuartia douglasii',
                          'Clarkia gracilis',
                          'Calochortus superbus',
                          'Clarkia purpurea',
                          'Phlox gracilis',
                          'Trifolium gracilentum',
                          'Calochortus luteus',
                          'Collinsia sparsiflora',
                          'Lasthenia californica',
                          'Lupinus succulentus',
                          'Sidalcea diploscypha',
                          'Zigadenus fremontii',
                          'Ancistrocarphus filagineus',
                          'Eriogonum nudum',
                          'Navarretia jepsonii',
                          'Vulpia myuros',
                          'Linanthus bicolor',
                          'Poa secunda',
                          'Aegilops triuncialis',
                          'Euphorbia crenulata',
                          'Grindelia camporum',
                          'Ranunculus occidentalis',
                          'Trifolium willdenovii',
                          'Castilleja rubicundula',
                          'Lolium multiflorum',
                          'Polypogon monspeliensis',
                          'Delphinium variegatum',
                          'Navarretia pubescens',
                          'Viola douglasii',
                          'Castilleja attenuata',
                          'Lactuca serriola',
                          'Vicia villosa',
                          'Eremocarpus setigerus',
                          'Gastridium ventricosum',
                          'Calandrinia ciliata',
                          'Lepidium nitidum',
                          'Microseris douglasii',
                          'Astragalus breweri',
                          'Epilobium brachycarpum',
                          'Lomatium marginatum',
                          'Sisyrinchium bellum',
                          'Trifolium bifidum',
                          'Agoseris grandiflora',
                          'Chlorogalum pomeridianum',
                          'Achyrachaena mollis',
                          'Hordeum marinum',
                          'Layia platyglossa',
                          'Claytonia parviflora',
                          'Lupinus microcarpus',
                          'Triteleia laxa',
                          'Bromus carinatus',
                          'Perideridia kelloggii',
                          'Delphinium hesperium',
                          'Wyethia glabra',
                          'Amsinckia menziesii',
                          'Brodiaea elegans',
                          'Melica californica',
                          'Plagiobothrys nothofulvus',
                          'Centaurium trichanthum',
                          'Githopsis specularioides',
                          'Lessingia ramulosa',
                          'Mimulus androsaceus',
                          'Hesperolinon micranthum',
                          'Hesperevax sparsiflora',
                          'Medicago polymorpha',
                          'Allium amplectens',
                          'Anagallis arvensis',
                          'Stellaria nitens',
                          'Daucus pusillus',
                          'Hesperolinon californicum',
                          'Eriogonum vimineum',
                          'Mimulus douglasii',
                          'Hesperolinon disjunctum',
                          'Silene gallica',
                          'Bromus diandrus',
                          'Eriophyllum lanatum',
                          'Allium fimbriatum',
                          'Elymus elymoides',
                          'Linanthus jepsonii',
                          'Melilotus indicus',
                          'Trifolium variegatum',
                          'Lomatium dasycarpum',
                          'Triphysaria versicolor',
                          'Filago gallica',
                          'Galium aparine',
                          'Astragalus rattanii var. jepsonianus',
                          'Centaurea melitensis',
                          'Lomatium utriculatum',
                          'Lotus micranthus',
                          'Triphysaria eriantha',
                          'Cuscuta californica',
                          'Hordeum brachyantherum',
                          'Aphanes occidentalis',
                          'Sanicula bipinnatifida',
                          'Hypochaeris glabra',
                          'Layia septentrionalis',
                          'Geranium molle',
                          'Trifolium hirtum',
                          'Poa bulbosa',
                          'Claytonia exigua',
                          'Allium serra',
                          'Trifolium microdon',
                          'Camissonia graciliflora',
                          'Chorizanthe polygonoides',
                          'Plectritis ciliosa',
                          'Lotus purshianus',
                          'Sagina apetala',
                          'Ranunculus californicus',
                          'Melica imperfecta',
                          'Thermopsis macrophylla',
                          'Cryptantha hispidula',
                          'Allium falcifolium',
                          'Erodium brachycarpum',
                          'Asclepias fascicularis',
                          'Linanthus latisectus',
                          'Nemophila menziesii',
                          'Filago californica',
                          'Melica torreyana',
                          'Fritillaria pluriflora',
                          'Sanicula bipinnata',
                          'Aira caryophyllea',
                          'Cynosurus echinatus',
                          'Geranium dissectum',
                          'Torilis arvensis',
                          'Streptanthus breweri',
                          'Hordeum depressum',
                          'Nemophila heterophylla',
                          'Cercocarpus betuloides',
                          'Camissonia ovata',
                          'Lomatium macrocarpum',
                          'Chaenactis glabriuscula',
                          'Uropappus lindleyi',
                          'Cardamine oligosperma',
                          'Galium murale',
                          'Achillea millefolium',
                          'Trifolium microcephalum',
                          'Senecio eurycephalus',
                          'Eschscholzia californica',
                          'Quercus durata',
                          'Iris douglasiana',
                          'Erythranthe guttata',
                          'Helianthella californica',
                          'Bellardia trixago',
                          'Helianthus exilis',
                          'Hordeum murinum',
                          'Elytrigia repens',
                          'Scutellaria siphocampyloides',
                          'Linanthus ciliatus',
                          'Phalaris paradoxa',
                          'Linanthus dichotomus',
                          'Pectocarya pusilla',
                          'Trifolium ciliolatum',
                          'Hypochaeris radicata',
                          'Trifolium dubium',
                          'Dodecatheon hendersonii',
                          'Carduus pycnocephalus',
                          'Torilis nodosa',
                          'Vulpia octoflora',
                          'Rumex crispus',
                          'Eriogonum covilleanum',
                          'Stellaria media',
                          'Crassula connata',
                          'Vulpia bromoides',
                          'Pinus sabiniana',
                          'Nemophila pedunculata',
                          'Sanicula crassicaulis',
                          'Triteleia hyacinthina',
                          'Trifolium depauperatum',
                          'Adenostoma fasciculatum',
                          'Apocynum cannabinum',
                          'Eriodictyon californicum',
                          'Antirrhinum vexillocalyculatum',
                          'Trichostema laxum',
                          'Bromus japonicus',
                          'Asclepias eriocarpa',
                          'Velezia rigida')

McLSerp_species_data <- occ(query = McLSerp_species_list, from = "gbif", has_coords = TRUE, limit = 10000,
                gbifopts = list(hasGeospatialIssue = FALSE, country = "US",
                                stateProvince = "California"))

```

We need to clean the coordinates, as it appears some are in the ocean (look @ NorCal), and there might be some that are just incorrect. To do this, we will use a coordinate cleaner package.

```{r cleaning jasper coords, echo=FALSE, cache = TRUE, dependson="grabbing jasper gbif data"}

## we can also replace all synonym taxon names with one (cuts down the number of plotted dot colors)
## we should use the scrubr version of the function in the future
McLSerp_species_data <- fixnames(McLSerp_species_data, how = "query")

## The occ2df function should convert the data to a dataframe format
McLSerp_species_data_df <- occ2df(McLSerp_species_data)

map_ggplot(McLSerp_species_data, map = "state", size = 0.5) +
  theme(legend.position = "none")

## flag potentially wrong coords
flags <- clean_coordinates(x = McLSerp_species_data_df, lon = "longitude", lat = "latitude",
                          species = "name",
                          tests = c("capitals", "centroids", "equal","gbif", "institutions",
                                    "seas", "zeros")) # most test are on by default

plot(flags, lon = "longitude", lat = "latitude")

flag_df <- McLSerp_species_data_df[!flags$.summary,]
str(flag_df)
summary(flag_df)

# keep only the non-flagged data
McLSerp_species_data_df <- McLSerp_species_data_df[flags$.summary,]


```
Most of our flagged coordinates are coastal/in the ocean. Therefore, we'll remove them from our database after taking a look at which ones (~2667 out of 69,872, so ~4%) were flagged.  

It appears that there were flagged instances for most of the species. For this practice run-through, I'll definitely just cut them out without taking a closer look (for now).  
More guidance on cleaning datasets and removing bad coordinates is [available here](https://ropensci.github.io/CoordinateCleaner/articles/Tutorial_Cleaning_GBIF_data_with_CoordinateCleaner.html).  

# Adding climate data

Following the jcoliver webpage guides...

```{r map of geo extent, echo = FALSE}
max.lat <- ceiling(max(McLSerp_species_data_df$latitude))
min.lat <- floor(min(McLSerp_species_data_df$latitude))
max.lon <- ceiling(max(McLSerp_species_data_df$longitude))
min.lon <- floor(min(McLSerp_species_data_df$longitude))
geographic.extent <- extent(x = c(min.lon, max.lon, min.lat, max.lat))

# Load the data to use for our base map
data(wrld_simpl)

# Plot the base map
plot(wrld_simpl, 
     xlim = c(min.lon, max.lon),
     ylim = c(min.lat, max.lat),
     axes = TRUE, 
     col = "grey95")

# Add the points for individual observation
points(x = McLSerp_species_data_df$longitude, 
       y = McLSerp_species_data_df$latitude, 
       col = "olivedrab", 
       pch = 20, 
       cex = 0.75)
# And draw a little box around the graph
box()
```

```{r based on oikos page, cache = TRUE}
xy <- McLSerp_species_data_df[,c("longitude","latitude")]
sp_xy <- McLSerp_species_data_df[c("name", "longitude","latitude")]

sp_xy <- sp_xy %>%
  rename(species = name)


env <- getData('worldclim', var='bio', res=2.5)

plot(env, 1, main=NULL, axes=FALSE)
points(xy, col='blue', pch=20)

xy_bio <- raster::extract(env, xy)

```

Reference list for climate variables:
 * BIO1 = Annual Mean Temperature (°C * 10) -- (i.e. 231 represents 23.1 °C)
 * BIO2 = Mean Diurnal Range (Mean of monthly (max temp – min temp)) 
 * BIO3 = Isothermality (BIO2/BIO7) (* 100)
 * BIO4 = Temperature Seasonality (standard deviation *100)
 * BIO5 = Max Temperature of Warmest Month (°C * 10)
 * BIO6 = Min Temperature of Coldest Month (°C * 10)
 * BIO7 = Temperature Annual Range (BIO5-BIO6)
 * BIO8 = Mean Temperature of Wettest Quarter (°C * 10)
 * BIO9 = Mean Temperature of Driest Quarter (°C * 10)
 * BIO10 = Mean Temperature of Warmest Quarter (°C * 10)
 * BIO11 = Mean Temperature of Coldest Quarter (°C * 10)
 * BIO12 = Annual Precipitation (mm)
 * BIO13 = Precipitation of Wettest Month (mm)
 * BIO14 = Precipitation of Driest Month (mm)
 * BIO15 = Precipitation Seasonality (Coeficent of Variation) 
 * BIO16 = Precipitation of Wettest Quarter (mm)
 * BIO17 = Precipitation of Driest Quarter (mm)
 * BIO18 = Precipitation of Warmest Quarter (mm)
 * BIO19 = Precipitation of Coldest Quarter (mm)
 
```{r mean species temp, echo=FALSE}
McLSerp_species_clim <- cbind(xy_bio, sp_xy)

McLSerp_species_clim <- McLSerp_species_clim %>%
  group_by(species) %>%
  summarise(meant = mean(bio1, na.rm = TRUE),
         meanp = mean(bio12, na.rm = TRUE)) %>%
  mutate(meanT = meant/10) %>%
  rename(species.name = species)
```


# Extra species
```{r McLSerp Juncus}
McLSerp_juncus <- c('Juncus balticus',
                   'Juncus bufonius',
                   'Juncus oxymeris',
                   'Juncus phaeocephalus',
                   'Juncus occidentalis')

McLSerp_juncus_data <- occ(query = McLSerp_juncus, from = "gbif", has_coords = TRUE, limit = 10000,
                gbifopts = list(hasGeospatialIssue = FALSE, country = "US",
                                stateProvince = "California"))

## we can also replace all synonym taxon names with one (cuts down the number of plotted dot colors)
## we should use the scrubr version of the function in the future
McLSerp_juncus_data <- fixnames(McLSerp_juncus_data, how = "query")

## The occ2df function should convert the data to a dataframe format
McLSerp_juncus_data_df <- occ2df(McLSerp_juncus_data)

map_ggplot(McLSerp_juncus_data, map = "state", size = 0.5) 

flags <- clean_coordinates(x = McLSerp_juncus_data_df, lon = "longitude", lat = "latitude",
                          species = "name",
                          tests = c("capitals", "centroids", "equal","gbif", "institutions",
                                    "seas", "zeros")) # most test are on by default

# remove flagged records
McLSerp_juncus_data_df <- McLSerp_juncus_data_df[flags$.summary,]

# extract lat/long for each datapoint
xy <- McLSerp_juncus_data_df[,c("longitude","latitude")]
sp_xy <- McLSerp_juncus_data_df[c("name", "longitude","latitude")]
sp_xy <- sp_xy %>%
  rename(species = name)
env <- getData('worldclim', var='bio', res=2.5)
plot(env, 1, main=NULL, axes=FALSE)
points(xy, col='blue', pch=20)
xy_bio <- raster::extract(env, xy)
McLSerp_juncus_clim <- cbind(xy_bio, sp_xy)

# change all datapoints to the "species sp" format that's used in the og dataframe, calc CTI
McLSerp_juncus_clim <- McLSerp_juncus_clim %>%
  mutate(species.name = "Juncus sp.") %>%
   group_by(species.name) %>%
   summarise(meant = mean(bio1, na.rm = TRUE),
         meanp = mean(bio12, na.rm = TRUE)) %>%
  mutate(meanT = meant/10) 
```

```{r McLSerp Astragalus}
McLSerp_astragalus <- c('Astragalus breweri',
                   'Astragalus clevelandii',
                   'Astragalus gambellianus',
                   'Astragalus rattanii var. jepsonianus')

McLSerp_astragalus_data <- occ(query = McLSerp_astragalus, from = "gbif", has_coords = TRUE, limit = 10000,
                gbifopts = list(hasGeospatialIssue = FALSE, country = "US",
                                stateProvince = "California"))

## we can also replace all synonym taxon names with one (cuts down the number of plotted dot colors)
## we should use the scrubr version of the function in the future
McLSerp_astragalus_data <- fixnames(McLSerp_astragalus_data, how = "query")

## The occ2df function should convert the data to a dataframe format
McLSerp_astragalus_data_df <- occ2df(McLSerp_astragalus_data)

map_ggplot(McLSerp_astragalus_data, map = "state", size = 0.5) 

flags <- clean_coordinates(x = McLSerp_astragalus_data_df, lon = "longitude", lat = "latitude",
                          species = "name",
                          tests = c("capitals", "centroids", "equal","gbif", "institutions",
                                    "seas", "zeros")) # most test are on by default

# remove flagged records
McLSerp_astragalus_data_df <- McLSerp_astragalus_data_df[flags$.summary,]

# extract lat/long for each datapoint
xy <- McLSerp_astragalus_data_df[,c("longitude","latitude")]
sp_xy <- McLSerp_astragalus_data_df[c("name", "longitude","latitude")]
sp_xy <- sp_xy %>%
  rename(species = name)
env <- getData('worldclim', var='bio', res=2.5)
plot(env, 1, main=NULL, axes=FALSE)
points(xy, col='blue', pch=20)
xy_bio <- raster::extract(env, xy)
McLSerp_astragalus_clim <- cbind(xy_bio, sp_xy)

# change all datapoints to the "species sp" format that's used in the og dataframe, calc CTI
McLSerp_astragalus_clim <- McLSerp_astragalus_clim %>%
  mutate(species.name = "Astragalus sp.") %>%
   group_by(species.name) %>%
   summarise(meant = mean(bio1, na.rm = TRUE),
         meanp = mean(bio12, na.rm = TRUE)) %>%
  mutate(meanT = meant/10) 
```


```{r McLSerp Quercus}
McLSerp_quercus <- c('Quercus berberidifolia',
                   'Quercus chrysolepis',
                   'Quercus douglasii',
                   'Quercus durata',
                   'Quercus kelloggii',
                   'Quercus lobata',
                   'Quercus wislizeni var. frutescens',
                   'Quercus wislizeni var. wislizeni')

McLSerp_quercus_data <- occ(query = McLSerp_quercus, from = "gbif", has_coords = TRUE, limit = 10000,
                gbifopts = list(hasGeospatialIssue = FALSE, country = "US",
                                stateProvince = "California"))

## we can also replace all synonym taxon names with one (cuts down the number of plotted dot colors)
## we should use the scrubr version of the function in the future
McLSerp_quercus_data <- fixnames(McLSerp_quercus_data, how = "query")

## The occ2df function should convert the data to a dataframe format
McLSerp_quercus_data_df <- occ2df(McLSerp_quercus_data)

map_ggplot(McLSerp_quercus_data, map = "state", size = 0.5) 

flags <- clean_coordinates(x = McLSerp_quercus_data_df, lon = "longitude", lat = "latitude",
                          species = "name",
                          tests = c("capitals", "centroids", "equal","gbif", "institutions",
                                    "seas", "zeros")) # most test are on by default

# remove flagged records
McLSerp_quercus_data_df <- McLSerp_quercus_data_df[flags$.summary,]

# extract lat/long for each datapoint
xy <- McLSerp_quercus_data_df[,c("longitude","latitude")]
sp_xy <- McLSerp_quercus_data_df[c("name", "longitude","latitude")]
sp_xy <- sp_xy %>%
  rename(species = name)
env <- getData('worldclim', var='bio', res=2.5)
plot(env, 1, main=NULL, axes=FALSE)
points(xy, col='blue', pch=20)
xy_bio <- raster::extract(env, xy)
McLSerp_quercus_clim <- cbind(xy_bio, sp_xy)

# change all datapoints to the "species sp" format that's used in the og dataframe, calc CTI
McLSerp_quercus_clim <- McLSerp_quercus_clim %>%
  mutate(species.name = "Quercus sp.") %>%
   group_by(species.name) %>%
   summarise(meant = mean(bio1, na.rm = TRUE),
         meanp = mean(bio12, na.rm = TRUE)) %>%
  mutate(meanT = meant/10) 
```

```{r McLSerp Centaurea}
McLSerp_centaurea <- c('Centaurea calcitrapa',
                   'Centaurea melitensis',
                   'Centaurea solstitialis')

McLSerp_centaurea_data <- occ(query = McLSerp_centaurea, from = "gbif", has_coords = TRUE, limit = 10000,
                gbifopts = list(hasGeospatialIssue = FALSE, country = "US",
                                stateProvince = "California"))

## we can also replace all synonym taxon names with one (cuts down the number of plotted dot colors)
## we should use the scrubr version of the function in the future
McLSerp_centaurea_data <- fixnames(McLSerp_centaurea_data, how = "query")

## The occ2df function should convert the data to a dataframe format
McLSerp_centaurea_data_df <- occ2df(McLSerp_centaurea_data)

map_ggplot(McLSerp_centaurea_data, map = "state", size = 0.5) 

flags <- clean_coordinates(x = McLSerp_centaurea_data_df, lon = "longitude", lat = "latitude",
                          species = "name",
                          tests = c("capitals", "centroids", "equal","gbif", "institutions",
                                    "seas", "zeros")) # most test are on by default

# remove flagged records
McLSerp_centaurea_data_df <- McLSerp_centaurea_data_df[flags$.summary,]

# extract lat/long for each datapoint
xy <- McLSerp_centaurea_data_df[,c("longitude","latitude")]
sp_xy <- McLSerp_centaurea_data_df[c("name", "longitude","latitude")]
sp_xy <- sp_xy %>%
  rename(species = name)
env <- getData('worldclim', var='bio', res=2.5)
plot(env, 1, main=NULL, axes=FALSE)
points(xy, col='blue', pch=20)
xy_bio <- raster::extract(env, xy)
McLSerp_centaurea_clim <- cbind(xy_bio, sp_xy)

# change all datapoints to the "species sp" format that's used in the og dataframe, calc CTI
McLSerp_centaurea_clim <- McLSerp_centaurea_clim %>%
  mutate(species.name = "Centaurea sp.") %>%
   group_by(species.name) %>%
   summarise(meant = mean(bio1, na.rm = TRUE),
         meanp = mean(bio12, na.rm = TRUE)) %>%
  mutate(meanT = meant/10) 
```

```{r McLSerp Allium}
McLSerp_allium <- c('Allium acuminatum',
                   'Allium amplectens',
                   'Allium dichlamydeum',
                   'Allium falcifolium',
                   'Allium fimbriatum var. fimbriatum',
                   'Allium fimbriatum var. purdyi', 
                   'Allium serra')

McLSerp_allium_data <- occ(query = McLSerp_allium, from = "gbif", has_coords = TRUE, limit = 10000,
                gbifopts = list(hasGeospatialIssue = FALSE, country = "US",
                                stateProvince = "California"))

## we can also replace all synonym taxon names with one (cuts down the number of plotted dot colors)
## we should use the scrubr version of the function in the future
McLSerp_allium_data <- fixnames(McLSerp_allium_data, how = "query")

## The occ2df function should convert the data to a dataframe format
McLSerp_allium_data_df <- occ2df(McLSerp_allium_data)

map_ggplot(McLSerp_allium_data, map = "state", size = 0.5) 

flags <- clean_coordinates(x = McLSerp_allium_data_df, lon = "longitude", lat = "latitude",
                          species = "name",
                          tests = c("capitals", "centroids", "equal","gbif", "institutions",
                                    "seas", "zeros")) # most test are on by default

# remove flagged records
McLSerp_allium_data_df <- McLSerp_allium_data_df[flags$.summary,]

# extract lat/long for each datapoint
xy <- McLSerp_allium_data_df[,c("longitude","latitude")]
sp_xy <- McLSerp_allium_data_df[c("name", "longitude","latitude")]
sp_xy <- sp_xy %>%
  rename(species = name)
env <- getData('worldclim', var='bio', res=2.5)
plot(env, 1, main=NULL, axes=FALSE)
points(xy, col='blue', pch=20)
xy_bio <- raster::extract(env, xy)
McLSerp_allium_clim <- cbind(xy_bio, sp_xy)

# change all datapoints to the "species sp" format that's used in the og dataframe, calc CTI
McLSerp_allium_clim <- McLSerp_allium_clim %>%
  mutate(species.name = "Allium sp.") %>%
   group_by(species.name) %>%
   summarise(meant = mean(bio1, na.rm = TRUE),
         meanp = mean(bio12, na.rm = TRUE)) %>%
  mutate(meanT = meant/10) 
```

# Calculating CTI
To calculate CTI, we need to summarize the weight of each species in a community and multiply that by the TI for that species. 

```{r relative cover of each spp, cache = TRUE}
McLSerp_rel <- mcLserp_data %>%
  filter(Year > 2005) %>%
  select(Year, plot, Quadrat, species.name, Cover) %>%
  remove_missing() %>%
  group_by(plot, Quadrat, Year) %>%
  mutate(sumcov = sum(Cover), 
         relcov = Cover/sumcov)
```

```{r Creating CTI table}
mcLserp_CTI <- left_join(mcLserp_byquad, McLSerp_species_clim, by = "species.name") 
mcLserp_CTI <- left_join(mcLserp_CTI, McLSerp_centaurea_clim, by = "species.name") %>%
  mutate(meant = coalesce(meant.x, meant.y),
         meanp = coalesce(meanp.x, meanp.y),
         meanT = coalesce(meanT.x, meanT.y),) %>% 
        select(-meant.x, -meant.y, -meanp.x, -meanp.y, -meanT.x, -meanT.y)
mcLserp_CTI <- left_join(mcLserp_CTI, McLSerp_quercus_clim, by = "species.name") %>%
  mutate(meant = coalesce(meant.x, meant.y),
         meanp = coalesce(meanp.x, meanp.y),
         meanT = coalesce(meanT.x, meanT.y),) %>% 
        select(-meant.x, -meant.y, -meanp.x, -meanp.y, -meanT.x, -meanT.y)
mcLserp_CTI <- left_join(mcLserp_CTI, McLSerp_juncus_clim, by = "species.name") %>%
  mutate(meant = coalesce(meant.x, meant.y),
         meanp = coalesce(meanp.x, meanp.y),
         meanT = coalesce(meanT.x, meanT.y),) %>% 
        select(-meant.x, -meant.y, -meanp.x, -meanp.y, -meanT.x, -meanT.y)
mcLserp_CTI <- left_join(mcLserp_CTI, McLSerp_astragalus_clim, by = "species.name") %>%
  mutate(meant = coalesce(meant.x, meant.y),
         meanp = coalesce(meanp.x, meanp.y),
         meanT = coalesce(meanT.x, meanT.y),) %>% 
        select(-meant.x, -meant.y, -meanp.x, -meanp.y, -meanT.x, -meanT.y)
mcLserp_CTI <- left_join(mcLserp_CTI, McLSerp_allium_clim, by = "species.name") %>%
  mutate(meant = coalesce(meant.x, meant.y),
         meanp = coalesce(meanp.x, meanp.y),
         meanT = coalesce(meanT.x, meanT.y),) %>% 
        select(-meant.x, -meant.y, -meanp.x, -meanp.y, -meanT.x, -meanT.y)


mcLserp_CTI <- mcLserp_CTI %>%
  mutate(relTI = relcov*meanT,
         relP = relcov*meanp) %>%
  group_by(Year, plot) %>%
  summarise(CTI = sum(relTI, rm.na = TRUE),
            CPI = sum(relP, rm.na = TRUE)) 

mcLserp_CTI_means <- mcLserp_CTI %>%
  group_by(Year) %>%
  summarise(meanCTI = mean(CTI),
            seCTI = std.error(CTI),
            meanCPI = mean(CPI),
            seCPI = std.error(CPI))

# CTI by relative weight of species in community:
ggplot(mcLserp_CTI_means, aes(x=Year, y=meanCTI)) +
  geom_point() +
  geom_errorbar(aes(ymin = meanCTI-seCTI, ymax = meanCTI+seCTI), width=0.2)

# CPI by relative weight of species in community):
ggplot(mcLserp_CTI_means, aes(x=Year, y=meanCPI)) +
 geom_point() +
 geom_errorbar(aes(ymin = meanCPI-seCPI, ymax = meanCPI+seCPI), width=0.2)


```

