---
title: "PRISM"
author: "Josie Lesage"
date: "1/10/2020"
output: html_document
---

```{r setup, include=FALSE}
## community analysis
library(codyn)
library(MASS)
library(vegan)
library(lme4)

## CTI + PRISM
library(CoordinateCleaner)
library(countrycode)
library(mapr)
library(maptools)
library(raster)
library(rgbif)
library(scrubr)
library(sp)
library(spocc)
library(prism)

## misc/both/other
library(oz)
library(plotrix)
library(tidyverse)
library(reshape2)
library(stringr)
library(psych)

```

# PRISM DATA

## Background

The goal of this markdown doc is to download PRISM data via the 'prism' R package and create a .csv file of teh climate data at each site.

To do this, we'll need some GPS points for the plots in my studies...  

Jasper ridge: 37.406855, -122.223305
Elkhorn slough: 36.868095, -121.740360
McLaughlin Reserve: 38.869529, -122.419575...  


Here's a neat webpage to help me get the correct data out of prism!
https://rpubs.com/collnell/get_prism


## Data Download
First, we download all of the data from PRISM. This is based on the rpubs docs by (Shannon Carter)[https://rpubs.com/shannon_carter/471278] and (Colleen N.)[https://rpubs.com/collnell/get_prism].
```{r Prism data download, eval=FALSE}
options(prism.path = "/prism")
get_prism_monthlys(type = "ppt", years = 1982:2019, mon = 1:12, keepZip = F)
get_prism_monthlys(type = "tmean", years = 1982:2019, mon = 1:12, keepZip = F)
get_prism_monthlys(type = "tmin", years = 1982:2019, mon = 1:12, keepZip = F)
get_prism_monthlys(type = "tmax", years = 1982:2019, mon = 1:12, keepZip = F)

# Stack all of the prism raster data
climate_data <- ls_prism_data() %>% prism_stack(.)

# Get proj from raster stack
climate_crs <- climate_data@crs@projargs

```

After downloading all of the PRISM raster data, we need to extract the data for our specific sites. We can do this by associating the site name with a lat/long and extracting from the raster.  

We begin by making a dataframe with the lat/long, then convert that to match the PRISM format.

```{r create site lat/long} 
sites <- data.frame(site = c("Jasper", "Elkhorn", "McL Ann", "McL Serp", "UCSC", "Swanton", "Angelo", "Carrizo"),
                    Lat = c(37.406855, 36.868095, 38.869529, 38.869529, 36.988252, 37.070389, 39.738936, 35.114272),
                    Long = c (-122.223305, -121.740360, -122.419575, -122.419575, -122.051716, -122.250000, -123.630758, -119.773864))

# Convert these locations to format that can be matched to Prism climate data
coordinates(sites) <- c('Long', 'Lat')
proj4string(sites) <- CRS(climate_crs)

```

Then, we extract the data. 


```{r extract climate data, eval = false}
# Extract the  extracted from the raster stack for those sites 
climate_site_raw <- data.frame(coordinates(sites), 
                   sites$site, 
                   raster::extract(climate_data, sites))

```

```{r reshape climate from raster}
# Reshape data. Col 1:3 are lat, long, and site ID. Col 4:ncol are climate data
# Column headers include date and climate type info
climate_site <- climate_site_raw %>% 
  gather(date, value, 4:ncol(climate_site_raw))

climate_site$date <- gsub('PRISM_', '', climate_site$date) %>% 
  gsub('provisional_4kmM3_', '', .) %>% 
  gsub('provisional_4kmM2_', '', .) %>%
  gsub('stable_4kmM3_', '', .) %>% 
  gsub('stable_4kmM2_', '', .) %>%
  gsub('_bil', '', .)

# Split header into type (precipitation or temperature), year, and month
climate_site <- separate(climate_site, 'date', 
                 into = c('type', 'YearMonth'), 
                 sep = '_')
climate_site <- separate(climate_site, 'YearMonth',
                 into = c('year', 'month'),
                 sep = 4)

# Reshape data-- make a separate column for temperature and precipitation
climate_site <- unique(climate_site)
climate_site <- climate_site %>% 
  spread(type, value) %>%
  rename(site = sites.site) %>%
  mutate(Year1 = year,
         Month1 = month) %>%
  unite(Year1, Month1, col = "date", sep = "-")

climate_site$date <- lubridate::ymd(climate_site$date, truncated = 1L)
climate_site_wtryr <- climate_site %>% 
  mutate(date1 = date,
         wateryr = wtr_yr(date1)) %>%
  group_by(site, wateryr) %>%
  summarise(precip = sum(ppt),
            tmean = mean(tmean),
            tmin = mean(tmin),
            tmax = mean(tmax)) %>%
  rename(year = wateryr) %>%
  filter(year != 2020)

# Make year and month numeric variables
climate_site$year  <- as.numeric(climate_site$year)
climate_site_wtryr$year  <- as.numeric(climate_site_wtryr$year)
```

```{r writing our csv files}

write.csv(climate_site, "PRISM_data.csv")
write.csv(climate_site_wtryr, "PRISM_wtryr_data.csv")

```


