---
title: "Climate and CTI Analysis"
author: "Josie Lesage"
date: "1/17/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = '../') 

## community analysis
library(codyn)
library(MASS)
library(lme4)
library(nlme)


## misc/both/other
library(oz)
library(plotrix)
library(tidyverse)
library(gridExtra)

# to rip legends out of figures
g_legend <- function(a.gplot){ 
    tmp <- ggplot_gtable(ggplot_build(a.gplot)) 
    leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box") 
    legend <- tmp$grobs[[leg]] 
    legend
} 

# converts the year into the water year based on month
wtr_yr <- function(dates, start_month=10) {
  # Convert dates into POSIXlt
  dates.posix = as.POSIXlt(dates)
  # Year offset
  offset = ifelse(dates.posix$mon >= start_month - 1, 1, 0)
  # Water year
  adj.year = dates.posix$year + 1900 + offset
  # Return the water year
  adj.year
}

```

```{r data import, echo = FALSE}
climate_site <- read.csv("Analysis/ClimData/PRISM_data.csv")
climate_site_wtryr <- read.csv("Analysis/ClimData/PRISM_wtryr_data.csv")

ang_cti <- read.csv("Analysis/CTI Data/Angelo_CTI.csv")
car_cti <- read.csv("Analysis/CTI Data/Carrizo_CTI.csv") %>%
  rename(site = Site)
elk_cti <- read.csv("Analysis/CTI Data/Elkhorn_CTI.csv") %>%
  rename(site = Site)
jasp_cti <- read.csv("Analysis/CTI Data/Jasper_CTI.csv") %>%
  rename(site = Site)
McLAnn_cti <- read.csv("Analysis/CTI Data/McLAnn_CTI.csv")  %>%
  rename(site = Site)
mcLserp_cti <- read.csv("Analysis/CTI Data/McLSerp_CTI.csv") %>%
  rename(site = Site)
Swan_cti <- read.csv("Analysis/CTI Data/Swanton_CTI.csv")  %>%
  rename(site = Site)
UCSC_cti <- read.csv("Analysis/CTI Data/UCSC_CTI.csv")  %>%
  rename(site = Site)

all.CTI <- full_join(ang_cti, car_cti)
all.CTI <- full_join(all.CTI, elk_cti)
all.CTI <- full_join(all.CTI, jasp_cti)
all.CTI <- full_join(all.CTI, McLAnn_cti)
all.CTI <- full_join(all.CTI, mcLserp_cti)
all.CTI <- full_join(all.CTI, Swan_cti)
all.CTI <- full_join(all.CTI, UCSC_cti)

all.CTI <- all.CTI %>%
  select(-X, -hotTI, -ColdTI)

all.CTI.wtryr <- left_join(all.CTI, climate_site_wtryr, by = c("year", "site"))
all.CTI.clim <- left_join(all.CTI, climate_site, by = c("year", "site"))
```
# Introduction

These data were downloaded in another markdown file ("PRISM.rmd"). They represent the interpolated climate data at all sites for which I have community composition datasets.  

To begin, we can take a look at the monthly precipitation at each site, and compare their annual min and max temps.

```{r plots, echo = FALSE}
ggplot(all.CTI.clim, aes(x = site, y = tmean)) +
  geom_boxplot()  +
  geom_jitter(aes(color = month)) +
  labs(x = "site",
       y = "mean monthly temp, 1982-2019",
       title = "Mean monthly temps at all sites")

ggplot(all.CTI.clim) +
  geom_jitter(aes(x = site, y = tmax), color = "red") +
  geom_jitter(aes(x = site, y = tmin), color = "blue") +
  labs(x = "site",
       y = "monthly min and max temps, 1982-2019",
       title = "Comparison of min and max temps at all sites")
```

Things look good - the warmest sites look warmest, and the wettest look wettest. The rain appears to be falling when logic says it would.  
We're also interested in seeing how climate may or may not have changed over time - so we will generate annual summaries.  

The lines are temperature, and the bars are precip. Thi graph shows the data by water year (oct-sep):  

```{r annual climate, echo = FALSE}
ggplot(all.CTI.wtryr) +
  geom_point(aes(x = year, y = tmin*750, color = site), shape = 3) +
  geom_line(aes(x = year, y = tmin*750, color = site)) +
  geom_bar(aes(x = year, y = precip, color = site, fill = site), 
           stat = "identity", position = "dodge") +
  scale_y_continuous(sec.axis = sec_axis(~./750, name = "Temperature (C)")) +
  scale_x_continuous(limits = c(1980, 2020), breaks = seq(1980, 2020, 10), expand = c(0,0)) +
  labs(title = "Climate and CTI data for CA grasslands, 1982-2019",
       y = "Water Year Precipitation (mm)",
       x = "Year") +
  theme_bw() +
  theme(legend.position = "none",
        strip.background = element_blank(),
        strip.text.x = element_blank(),
        axis.text.x = element_text(hjust = 0.5, vjust = 0.5, angle = 90)) +
  facet_wrap(~site, nrow = 1)
```


# ANALYSIS
In order to have legs to stand on, we must take a look at the weather history at these sites - this means determining whether there have been directional trends in temperature or precipitation over time.  
One thing to note is that we should only look at the data over the years in which we have community composition data.  

First, let's take a look at the change in precipitation over time, since I think that is less likely to be significant for our focal years. Then, we'll look at our temp. data.  

```{r ppt prep, echo = FALSE}
# this is a quick piece of code to ensure that there's only one datapoint per year per site
all.CTI.wtryr <- all.CTI.wtryr %>%
  group_by(year, site) %>%
  summarise(precip = mean(precip),
            tmax = mean(tmax),
            tmin = mean(tmin),
            tmean = mean(tmean))
```

### Overall water year precip
```{r precip models}
# angelo
ang.ppt <- all.CTI.wtryr %>% filter(site == "Angelo")
hist(ang.ppt$precip)
ang.ppt.lm <- lm(precip ~ year,
                    data = ang.ppt)
summary(ang.ppt.lm)
ggplot(ang.ppt, aes(x = year, y = precip)) + geom_line()

# carrizo
car.ppt <- all.CTI.wtryr %>% filter(site == "Carrizo")
hist(car.ppt$precip)
car.ppt.lm <- lm(precip ~ year,
                    data = car.ppt)
summary(car.ppt.lm)
ggplot(car.ppt, aes(x = year, y = precip)) + geom_line()

# elkhorn
elk.ppt <- all.CTI.wtryr %>% filter(site == "Elkhorn")
hist(elk.ppt$precip)
elk.ppt.lm <- lm(precip ~ year,
                    data = elk.ppt)
summary(elk.ppt.lm)
ggplot(elk.ppt, aes(x = year, y = precip)) + geom_line()

# jasper
jasp.ppt <- all.CTI.wtryr %>% filter(site == "Jasper")
hist(jasp.ppt$precip)
jasp.ppt.lm <- lm(precip ~ year,
                    data = jasp.ppt)
summary(jasp.ppt.lm)
ggplot(jasp.ppt, aes(x = year, y = precip)) + geom_line()

# mcL ann
mcLann.ppt <- all.CTI.wtryr %>% filter(site == "McL Ann")
hist(mcLann.ppt$precip)
mcLann.ppt.lm <- lm(precip ~ year,
                    data = mcLann.ppt)
summary(mcLann.ppt.lm)
ggplot(mcLann.ppt, aes(x = year, y = precip)) + geom_line()

# mcL serp
mcLserp.ppt <- all.CTI.wtryr %>% filter(site == "McL Serp")
hist(mcLserp.ppt$precip)
mcLserp.ppt.lm <- lm(precip ~ year,
                    data = mcLserp.ppt)
summary(mcLserp.ppt.lm)
ggplot(mcLserp.ppt, aes(x = year, y = precip)) + geom_line()

# swanton
swan.ppt <- all.CTI.wtryr %>% filter(site == "Swanton")
hist(swan.ppt$precip)
swan.ppt.lm <- lm(precip ~ year,
                    data = swan.ppt)
summary(swan.ppt.lm)
ggplot(swan.ppt, aes(x = year, y = precip)) + geom_line()


# ucsc
ucsc.ppt <- all.CTI.wtryr %>% filter(site == "UCSC")
hist(ucsc.ppt$precip)
ucsc.ppt.lm <- lm(precip ~ year,
                    data = ucsc.ppt)
summary(ucsc.ppt.lm)
ggplot(ucsc.ppt, aes(x = year, y = precip)) + geom_line()

```

### Wintertime precip
