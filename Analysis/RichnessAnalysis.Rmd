---
title: "Richness_Analysis"
author: "Josie Lesage"
date: "1/23/2020"
output: html_document
---

# Setup and data import
```{r setup, include=FALSE}
## community analysis
library(codyn)
library(MASS)
library(lme4)
library(nlme)


## misc/both/other
library(oz)
library(plotrix)
library(tidyverse)
library(gridExtra)



knitr::opts_chunk$set(echo = TRUE)

# to rip legends out of figures
g_legend <- function(a.gplot){ 
    tmp <- ggplot_gtable(ggplot_build(a.gplot)) 
    leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box") 
    legend <- tmp$grobs[[leg]] 
    legend
} 
```

```{r com data import, echo=FALSE}
angelo_data <- read.csv("Analysis/ComData/angelo_data.csv") %>%
  select(-X)  %>%
  mutate(site = "Angelo") 
ang_data_rel <- angelo_data %>%
  select(year, plot, species.name, cover) %>%
  group_by(plot, year) %>%
  mutate(sumcov = sum(cover),
         relcov = cover/sumcov)

car_data <- read.csv("Analysis/ComData/carrizo_data.csv") %>%
    rename(species.name = Species.Name,
           plot = Plot,
           site = Site) %>%
    select(-X) 
car_data <- car_data %>%
  filter(species.name != "litter",
         species.name != "bare",
         species.name != "hole",
         species.name != "moss") %>%
  mutate(site = "Carrizo")
car_data_rel <- car_data %>%
  select(year, plot, species.name, Intercepts) %>%
  distinct(year, plot, species.name, .keep_all = TRUE) %>%
  group_by(plot, year) %>%
  mutate(sumintercept = sum(Intercepts),
         relcov = Intercepts/sumintercept)

elkhorn_data <- read.csv("Analysis/ComData/elkhorn_data.csv") %>%
   rename(plot = rep)
elkhorn_data <- elkhorn_data %>%
  select(-X) %>%
  filter(species.name != "Moss",
         species.name != "Thatch",
         species.name != "Bare ground") %>%
  mutate(site = "Elkhorn")
elkhorn_data_rel <- elkhorn_data %>%
  select(year, plot, species.name, intercepts) %>%
  group_by(plot, year) %>%
  mutate(sumintercept = sum(intercepts),
         relcov = intercepts/sumintercept)

jasper_data <- read.csv("Analysis/ComData/jasper_data.csv") %>%
  rename(plot = uniqueID)
jasper_data <- jasper_data %>%
  select(-X) %>%
  filter(cover > 0) %>%
  group_by(plot, year) %>%
  mutate(sumcov = sum(cover),
         relcov = cover/sumcov) %>%
  mutate(site = "Jasper")

McLAnn_data <- read.csv("Analysis/ComData/mclann_data.csv") %>%
   rename(species.name = Species_Name,
          year = Year,
          site = Site)
McLAnn_data <- McLAnn_data %>%
  select(-X) %>%
  filter(species.name != "Bare",
         species.name != "Rock",
         species.name != "Unknown grass",
         species.name != "Unknown forb") %>%
  mutate(site = "McL Ann")
McLAnn_byquad <- McLAnn_data %>%
  group_by(site, year, plot, species.name) %>%
  summarise(Cover = sum(Cover)) %>%
  ungroup() %>%
  group_by(plot, year) %>%
  mutate(sumcov = sum(Cover),
         relcov = Cover/sumcov)

mcLserp_data <- read.csv("Analysis/ComData/mclserp_data.csv") %>%
  select(-X) %>%
   rename(species.name = Species_Name,
          year = Year,
          site = Site)
mcLserp_data <- mcLserp_data %>%
  filter(species.name != "Bare",
         species.name != "Rock",
         species.name != "Unknown forb") %>%
  mutate(site = "McL Serp")
mcLserp_byquad <- mcLserp_data %>%
  group_by(site, year, plot, species.name) %>%
  summarise(Cover = sum(Cover)) %>%
  ungroup() %>%
  group_by(plot, year) %>%
  mutate(sumcov = sum(Cover),
         relcov = Cover/sumcov)

swan_data <- read.csv("Analysis/ComData/swanton_data.csv") %>%
   rename(plot = rep)
swan_data <- swan_data %>%
  select(-X) %>%
  filter(species.name != "Moss",
         species.name != "Thatch",
         species.name != "Bare ground") %>%
  mutate(site = "Swanton")
swan_data_rel <- swan_data %>%
  select(year, plot, species.name, intercepts) %>%
  group_by(plot, year) %>%
  mutate(sumintercept = sum(intercepts),
         relcov = intercepts/sumintercept)


ucsc_data <- read.csv("Analysis/ComData/ucsc_data.csv") %>%
   rename(plot = rep)
ucsc_data <- ucsc_data %>%
  select(-X) %>%
  filter(species.name != "Thatch",
         species.name != "Bare ground") %>%
  mutate(site = "UCSC")
ucsc_data_rel <- ucsc_data %>%
  select(year, plot, species.name, intercepts) %>%
  group_by(plot, year) %>%
  mutate(sumintercept = sum(intercepts),
         relcov = intercepts/sumintercept)


```

```{r prism data import and prep, echo = FALSE}
weather <- read.csv("Analysis/ClimData/PRISM_data.csv") %>%
  select(-X)
wtryr_weather <- read.csv("Analysis/ClimData/PRISM_wtryr_data.csv") %>%
  select(-X)
```

# Changes in guild-level richness over time
## Pure richness

```{r converting species level cover to guild level cover}
ang_grich <- angelo_data %>%
  group_by(year, plot, guild) %>%
  summarise(rich = n_distinct(species.name)) %>%
  group_by(year, plot) %>%
  select(plot, year, rich, guild)  %>%
  spread(guild, rich) %>%
  replace(is.na(.), 0) %>%
  add_column(NAG = 0) %>% add_column(NAGr = 0) %>% add_column(EPG = 0) %>%
  add_column(NPGr = 0) %>% add_column(NPS = 0) %>% add_column(NPT = 0) %>%
  mutate(Nat = (NAF+NAG+NAGr+NPF+NPG+NPGr+NPS+NPT),
         Exo = (EAF+EAG+EPF+EPG),
         NatAnns = (NAF+NAG+NAGr),
         ExoAnns = (EAF+EAG),
         ExoPers = (EPF+EPG),
         NatPers = (NPF+NPG+NPGr+NPS+NPT),
         all = (NAF+NAG+NAGr+NPF+NPG+NPGr+NPS+NPT+EAF+EAG+EPF+EPG)) %>%
  ungroup() %>% 
  gather('Nat', 'Exo', 'NatAnns', 'ExoAnns', 'ExoPers', 'NatPers', "all", key = "guild", value = "rich") %>%
  mutate(site = "Angelo") %>%
  select(site, year, plot, guild, rich)

car_grich <- car_data %>%
group_by(year, plot, guild) %>%
  summarise(rich = n_distinct(species.name)) %>%
  group_by(year, plot) %>%
  select(plot, year, rich, guild)  %>%
  spread(guild, rich) %>%
  replace(is.na(.), 0) %>%
  add_column(NAGr = 0) %>% add_column(EPG = 0) %>% add_column(NPGr = 0) %>%
  add_column(NPS = 0) %>% add_column(NPT = 0) %>%
  mutate(Nat = (NAF+NAG+NAGr+NPF+NPG+NPGr+NPS+NPT),
         Exo = (EAF+EAG+EPF+EPG),
         NatAnns = (NAF+NAG+NAGr),
         ExoAnns = (EAF+EAG),
         ExoPers = (EPF+EPG),
         NatPers = (NPF+NPG+NPGr+NPS+NPT),
         all = (NAF+NAG+NAGr+NPF+NPG+NPGr+NPS+NPT+EAF+EAG+EPF+EPG)) %>%
  ungroup() %>% 
  gather('Nat', 'Exo', 'NatAnns', 'ExoAnns', 'ExoPers', 'NatPers', "all", key = "guild", value = "rich") %>%
  mutate(site = "Carrizo") %>%
  select(site, year, plot, guild, rich)

elk_grich <- elkhorn_data %>%
  group_by(year, plot, guild) %>%
  summarise(rich = n_distinct(species.name)) %>%
  group_by(year, plot) %>%
  select(plot, year, rich, guild)  %>%
  spread(guild, rich) %>%
  replace(is.na(.), 0) %>%
  add_column(NAF = 0) %>% add_column(NAG = 0) %>% add_column(NPS = 0) %>% add_column(NPT = 0) %>%
  mutate(Nat = (NAF+NAG+NAGr+NPF+NPG+NPGr+NPS+NPT),
         Exo = (EAF+EAG+EPF+EPG),
         NatAnns = (NAF+NAG+NAGr),
         ExoAnns = (EAF+EAG),
         ExoPers = (EPF+EPG),
         NatPers = (NPF+NPG+NPGr+NPS+NPT),
         all = (NAF+NAG+NAGr+NPF+NPG+NPGr+NPS+NPT+EAF+EAG+EPF+EPG)) %>%
  ungroup() %>% 
  gather('Nat', 'Exo', 'NatAnns', 'ExoAnns', 'ExoPers', 'NatPers', "all", key = "guild", value = "rich") %>%
  mutate(site = "Elkhorn") %>%
  select(site, year, plot, guild, rich)

jasp_grich <- jasper_data %>%
  group_by(year, plot, guild) %>%
  summarise(rich = n_distinct(species.name)) %>%
  group_by(year, plot) %>%
  select(plot, year, rich, guild)  %>%
  spread(guild, rich) %>%
  replace(is.na(.), 0) %>%
  add_column(NAGr = 0) %>%  add_column(EAF = 0) %>% add_column(EPF = 0) %>%
  add_column(EPG = 0) %>%  add_column(NPGr = 0) %>% add_column(NPS = 0) %>%
  add_column(NPT = 0) %>%
  mutate(Nat = (NAF+NAG+NAGr+NPF+NPG+NPGr+NPS+NPT),
         Exo = (EAF+EAG+EPF+EPG),
         NatAnns = (NAF+NAG+NAGr),
         ExoAnns = (EAF+EAG),
         ExoPers = (EPF+EPG),
         NatPers = (NPF+NPG+NPGr+NPS+NPT),
         all = (NAF+NAG+NAGr+NPF+NPG+NPGr+NPS+NPT+EAF+EAG+EPF+EPG)) %>%
  ungroup() %>% 
  gather('Nat', 'Exo', 'NatAnns', 'ExoAnns', 'ExoPers', 'NatPers', "all", key = "guild", value = "rich") %>%
  mutate(site = "Jasper") %>%
  select(site, year, plot, guild, rich)

McLAnn_grich <- McLAnn_data %>%
  group_by(year, plot, guild) %>%
  summarise(rich = n_distinct(species.name)) %>%
  group_by(year, plot) %>%
  select(plot, year, rich, guild)  %>%
  spread(guild, rich) %>%
  replace(is.na(.), 0) %>%
  add_column(NAGr = 0) %>% add_column(NPGr = 0) %>% 
  mutate(Nat = (NAF+NAG+NAGr+NPF+NPG+NPGr+NPS+NPT),
         Exo = (EAF+EAG+EPF+EPG),
         NatAnns = (NAF+NAG+NAGr),
         ExoAnns = (EAF+EAG),
         ExoPers = (EPF+EPG),
         NatPers = (NPF+NPG+NPGr+NPS+NPT),
         all = (NAF+NAG+NAGr+NPF+NPG+NPGr+NPS+NPT+EAF+EAG+EPF+EPG)) %>%
  ungroup() %>% 
  gather('Nat', 'Exo', 'NatAnns', 'ExoAnns', 'ExoPers', 'NatPers', "all", key = "guild", value = "rich") %>%
  mutate(site = "McL Ann") %>%
  select(site, year, plot, guild, rich)

mcLserp_grich <- mcLserp_data %>%
  group_by(year, plot, guild) %>%
  summarise(rich = n_distinct(species.name)) %>%
  group_by(year, plot) %>%
  select(plot, year, rich, guild)  %>%
  spread(guild, rich) %>%
  replace(is.na(.), 0) %>%
  add_column(NAGr = 0) %>% add_column(NPGr = 0) %>% 
  mutate(Nat = (NAF+NAG+NAGr+NPF+NPG+NPGr+NPS+NPT),
         Exo = (EAF+EAG+EPF+EPG),
         NatAnns = (NAF+NAG+NAGr),
         ExoAnns = (EAF+EAG),
         ExoPers = (EPF+EPG),
         NatPers = (NPF+NPG+NPGr+NPS+NPT),
         all = (NAF+NAG+NAGr+NPF+NPG+NPGr+NPS+NPT+EAF+EAG+EPF+EPG)) %>%
  ungroup() %>% 
  gather('Nat', 'Exo', 'NatAnns', 'ExoAnns', 'ExoPers', 'NatPers', "all", key = "guild", value = "rich") %>%
  mutate(site = "McL Serp") %>%
  select(site, year, plot, guild, rich)

swan_grich <- swan_data %>%
  group_by(year, plot, guild) %>%
  summarise(rich = n_distinct(species.name)) %>%
  group_by(year, plot) %>%
  select(plot, year, rich, guild)  %>%
  spread(guild, rich) %>%
  replace(is.na(.), 0) %>%
  add_column(NAF = 0) %>% add_column(NAG = 0) %>% add_column(EPG = 0) %>% 
  add_column(NPGr = 0) %>% add_column(NPS = 0) %>% add_column(NPT = 0) %>%
  mutate(Nat = (NAF+NAG+NAGr+NPF+NPG+NPGr+NPS+NPT),
         Exo = (EAF+EAG+EPF+EPG),
         NatAnns = (NAF+NAG+NAGr),
         ExoAnns = (EAF+EAG),
         ExoPers = (EPF+EPG),
         NatPers = (NPF+NPG+NPGr+NPS+NPT),
         all = (NAF+NAG+NAGr+NPF+NPG+NPGr+NPS+NPT+EAF+EAG+EPF+EPG)) %>%
  ungroup() %>% 
  gather('Nat', 'Exo', 'NatAnns', 'ExoAnns', 'ExoPers', 'NatPers', "all", key = "guild", value = "rich") %>%
  mutate(site = "Swanton") %>%
  select(site, year, plot, guild, rich)

ucsc_grich <- ucsc_data %>%
  group_by(year, plot, guild) %>%
  summarise(rich = n_distinct(species.name)) %>%
  group_by(year, plot) %>%
  select(plot, year, rich, guild)  %>%
  spread(guild, rich) %>%
  replace(is.na(.), 0) %>%
  add_column(NAF = 0) %>% add_column(NAG = 0) %>% add_column(NPS = 0) %>% add_column(NPT = 0) %>%
  mutate(Nat = (NAF+NAG+NAGr+NPF+NPG+NPGr+NPS+NPT),
         Exo = (EAF+EAG+EPF+EPG),
         NatAnns = (NAF+NAG+NAGr),
         ExoAnns = (EAF+EAG),
         ExoPers = (EPF+EPG),
         NatPers = (NPF+NPG+NPGr+NPS+NPT),
         all = (NAF+NAG+NAGr+NPF+NPG+NPGr+NPS+NPT+EAF+EAG+EPF+EPG)) %>%
  ungroup() %>% 
  gather('Nat', 'Exo', 'NatAnns', 'ExoAnns', 'ExoPers', 'NatPers', "all", key = "guild", value = "rich") %>%
  mutate(site = "UCSC") %>%
  select(site, year, plot, guild, rich)

all.grich <- full_join(mcLserp_grich, swan_grich)
all.grich <- full_join(all.grich, elk_grich)
all.grich <- full_join(all.grich, ang_grich)
all.grich <- full_join(all.grich, McLAnn_grich)
all.grich <- full_join(all.grich, car_grich)
all.grich <- full_join(all.grich, ucsc_grich)
all.grich$plot <- as.factor(all.grich$plot)
all.grich <- full_join(all.grich, jasp_grich)

all.grich <- left_join(all.grich, wtryr_weather, by = c("year", "site")) 

all.grich.means <- all.grich %>%
  group_by(site, guild, year) %>%
  summarise(serich = std.error(rich),
            meanrich = mean(rich),
            precip = mean(precip),
            tmean = mean(tmean),
            tmax = mean(tmax),
            tmin = mean(tmin))
```

```{r tidy richness workspace, include=FALSE}
remove(mcLserp_grich)
remove(swan_grich)
remove(elk_grich)
remove(jasp_grich)
remove(ang_grich)
remove(McLAnn_grich)
remove(car_grich)
remove(ucsc_grich)
```
### Graphs
```{r guild rich graphs}
ggplot(all.grich.means, aes(x = year, y = meanrich, color = site)) +
  geom_line() +
  labs(title = "",
       x = "Year",
       y = "Richness") +
  facet_grid(~guild) 

guild.grich <- all.grich.means %>% filter(guild == "Exo" | guild == "Nat" | guild == "all")

grid.arrange(
  ggplot(guild.grich) +
    geom_point(aes(x = year, y = meanrich, color = guild)) +
    geom_line(aes(x = year, y = meanrich, color = guild)) +
    geom_errorbar(aes(x = year, ymin = meanrich-serich, ymax = meanrich+serich, color = guild)) +
    labs(title = "Richness of native and exotic species in 8 CA grasslands",
       x = "Year",
       y = "Richness") +
    facet_wrap(~site, nrow = 1, scales = "free"))

g.all.grich <- all.grich.means %>% filter(guild == "all")
g.exo.grich <- all.grich.means %>% filter(guild == "Exo")
g.nat.grich <- all.grich.means %>% filter(guild == "Nat")

(graph.all.rich <- ggplot(g.all.grich, aes(x = year, y = meanrich, color = site)) +
    geom_point() +
    geom_line() +
  geom_errorbar(aes(ymin = meanrich-serich, ymax = meanrich+serich)) +
  labs(title = "Total richness",
       x = "Year",
       y = "Richness") +
  theme_classic() +
  theme(legend.position = "bottom",
        axis.title.y = element_blank(),
        strip.background = element_blank(),
        strip.text.x = element_blank(),
        axis.text.x = element_text(hjust = 0.5, vjust = 0.5, angle = 90)) +
  scale_x_continuous(limits = c(1980,2020), breaks = seq(1980,2020,20), expand = c(0, 0)) +
    facet_wrap(~site, nrow = 2, scales = "free"))

(graph.exo.rich <- ggplot(g.exo.grich, aes(x = year, y = meanrich, color = site)) +
  geom_point() +
    geom_line() +
  geom_errorbar(aes(ymin = meanrich-serich, ymax = meanrich+serich)) +
  labs(title = "Exotic richness",
       x = "Year",
       y = "Richness") +
  theme_classic() +
  theme(legend.position = "none",
        axis.title.y = element_blank(),
        strip.background = element_blank(),
        strip.text.x = element_blank(),
        axis.text.x = element_text(hjust = 0.5, vjust = 0.5, angle = 90)) +
  scale_x_continuous(limits = c(1980,2020), breaks = seq(1980,2020,20), expand = c(0, 0)) +
    facet_wrap(~site, nrow = 2, scales = "free"))

(graph.nat.rich <- ggplot(g.nat.grich, aes(x = year, y = meanrich, color = site)) +
  geom_point() +
    geom_line() +
  geom_errorbar(aes(ymin = meanrich-serich, ymax = meanrich+serich)) +
  labs(title = "Native richness",
       x = "Year",
       y = "Richness")  +  
  theme_classic() +
  theme(legend.position = "none",
        axis.title.y = element_blank(),
        strip.background = element_blank(),
        strip.text.x = element_blank(),
        axis.text.x = element_text(hjust = 0.5, vjust = 0.5, angle = 90)) +
  scale_x_continuous(limits = c(1980,2020), breaks = seq(1980,2020,20), expand = c(0, 0)) +
    facet_wrap(~site, nrow = 2, scales = "free"))

graph.rich.leg <- g_legend(graph.all.rich)

grid.arrange(graph.all.rich + theme(legend.position = "none"),
             graph.nat.rich, 
             graph.exo.rich, 
             graph.rich.leg, 
             nrow = 4)
```

### Analysis

This represents changes in overall richness and native vs. exotic richness over time. Because these sites all are measured in different ways, and I'm not particularly interested in measuring the differences between them, I will run separate analyses for each site. 

```{r overall richness glmms, echo = FALSE}

all.all.grich <- all.grich %>% filter(guild == "all")

# Angelo
ang.all.rich <- all.all.grich %>% filter(site == "Angelo")
ang.all.rich$year <- scale(ang.all.rich$year)
ang.all.rich.glm <- glmer(rich ~ year + (1|plot), family = "poisson", data = ang.all.rich)
summary(ang.all.rich.glm)

# Carrizo
car.all.rich <- all.all.grich %>% filter(site == "Carrizo")
car.all.rich$year <- scale(car.all.rich$year)
car.all.rich.glm <- glmer(rich ~ year + (1|plot), family = "poisson", data = car.all.rich)
summary(car.all.rich.glm)

# Elkhorn
elk.all.rich <- all.all.grich %>% filter(site == "Elkhorn")
elk.all.rich$year <- scale(elk.all.rich$year)
elk.all.rich.glm <- glmer(rich ~ year + (1|plot), family = "poisson", data = elk.all.rich)
summary(elk.all.rich.glm)

# Jasper
jasp.all.rich <- all.all.grich %>% filter(site == "Jasper")
jasp.all.rich$year <- scale(jasp.all.rich$year)
jasp.all.rich.glm <- glmer(rich ~ year + (1|plot), family = "poisson", data = jasp.all.rich)
summary(jasp.all.rich.glm)

# McL Ann
mcLann.all.rich <- all.all.grich %>% filter(site == "McL Ann")
mcLann.all.rich$year <- scale(mcLann.all.rich$year)
mcLann.all.rich.glm <- glmer(rich ~ year + (1|plot), family = "poisson", data = mcLann.all.rich)
summary(mcLann.all.rich.glm)

# McL Serp
mcLserp.all.rich <- all.all.grich %>% filter(site == "McL Serp")
mcLserp.all.rich$year <- scale(mcLserp.all.rich$year)
mcLserp.all.rich.glm <- glmer(rich ~ year + (1|plot), family = "poisson", data = mcLserp.all.rich)
summary(mcLserp.all.rich.glm)

# Swanton
swan.all.rich <- all.all.grich %>% filter(site == "Swanton")
swan.all.rich$year <- scale(swan.all.rich$year)
swan.all.rich.glm <- glmer(rich ~ year + (1|plot), family = "poisson", data = swan.all.rich)
summary(swan.all.rich.glm)

# UCSC
ucsc.all.rich <- all.all.grich %>% filter(site == "UCSC")
ucsc.all.rich$year <- scale(ucsc.all.rich$year)
ucsc.all.rich.glm <- glmer(rich ~ year + (1|plot), family = "poisson", data = ucsc.all.rich)
summary(ucsc.all.rich.glm)
```

```{r native richness glmms, echo = FALSE}

all.nat.grich <- all.grich %>% filter(guild == "Nat")

# Angelo
ang.all.rich <- all.nat.grich %>% filter(site == "Angelo")
ang.all.rich$year <- scale(ang.all.rich$year)
ang.all.rich.glm <- glmer(rich ~ year + (1|plot), family = "poisson", data = ang.all.rich)
summary(ang.all.rich.glm)

# Carrizo
car.all.rich <- all.nat.grich %>% filter(site == "Carrizo")
car.all.rich$year <- scale(car.all.rich$year)
car.all.rich.glm <- glmer(rich ~ year + (1|plot), family = "poisson", data = car.all.rich)
summary(car.all.rich.glm)

# Elkhorn
elk.all.rich <- all.nat.grich %>% filter(site == "Elkhorn")
elk.all.rich$year <- scale(elk.all.rich$year)
elk.all.rich.glm <- glmer(rich ~ year + (1|plot), family = "poisson", data = elk.all.rich)
summary(elk.all.rich.glm)

# Jasper
jasp.all.rich <- all.nat.grich %>% filter(site == "Jasper")
jasp.all.rich$year <- scale(jasp.all.rich$year)
jasp.all.rich.glm <- glmer(rich ~ year + (1|plot), family = "poisson", data = jasp.all.rich)
summary(jasp.all.rich.glm)

# McL Ann
mcLann.all.rich <- all.nat.grich %>% filter(site == "McL Ann")
mcLann.all.rich$year <- scale(mcLann.all.rich$year)
mcLann.all.rich.glm <- glmer(rich ~ year + (1|plot), family = "poisson", data = mcLann.all.rich)
summary(mcLann.all.rich.glm)

# McL Serp
mcLserp.all.rich <- all.nat.grich %>% filter(site == "McL Serp")
mcLserp.all.rich$year <- scale(mcLserp.all.rich$year)
mcLserp.all.rich.glm <- glmer(rich ~ year + (1|plot), family = "poisson", data = mcLserp.all.rich)
summary(mcLserp.all.rich.glm)

# Swanton
swan.all.rich <- all.nat.grich %>% filter(site == "Swanton")
swan.all.rich$year <- scale(swan.all.rich$year)
swan.all.rich.glm <- glmer(rich ~ year + (1|plot), family = "poisson", data = swan.all.rich)
summary(swan.all.rich.glm)

# UCSC
ucsc.all.rich <- all.nat.grich %>% filter(site == "UCSC")
ucsc.all.rich$year <- scale(ucsc.all.rich$year)
ucsc.all.rich.glm <- glmer(rich ~ year + (1|plot), family = "poisson", data = ucsc.all.rich)
summary(ucsc.all.rich.glm)
```

```{r exotic richness glmms, echo = FALSE}

all.exo.grich <- all.grich %>% filter(guild == "Exo")

# Angelo
ang.all.rich <- all.exo.grich %>% filter(site == "Angelo")
ang.all.rich$year <- scale(ang.all.rich$year)
ang.all.rich.glm <- glmer(rich ~ year + (1|plot), family = "poisson", data = ang.all.rich)
summary(ang.all.rich.glm)

# Carrizo
car.all.rich <- all.exo.grich %>% filter(site == "Carrizo")
car.all.rich$year <- scale(car.all.rich$year)
car.all.rich.glm <- glmer(rich ~ year + (1|plot), family = "poisson", data = car.all.rich)
summary(car.all.rich.glm)

# Elkhorn
elk.all.rich <- all.exo.grich %>% filter(site == "Elkhorn")
elk.all.rich$year <- scale(elk.all.rich$year)
elk.all.rich.glm <- glmer(rich ~ year + (1|plot), family = "poisson", data = elk.all.rich)
summary(elk.all.rich.glm)

# Jasper
jasp.all.rich <- all.exo.grich %>% filter(site == "Jasper")
jasp.all.rich$year <- scale(jasp.all.rich$year)
jasp.all.rich.glm <- glmer(rich ~ year + (1|plot), family = "poisson", data = jasp.all.rich)
summary(jasp.all.rich.glm)

# McL Ann
mcLann.all.rich <- all.exo.grich %>% filter(site == "McL Ann")
mcLann.all.rich$year <- scale(mcLann.all.rich$year)
mcLann.all.rich.glm <- glmer(rich ~ year + (1|plot), family = "poisson", data = mcLann.all.rich)
summary(mcLann.all.rich.glm)

# McL Serp
mcLserp.all.rich <- all.exo.grich %>% filter(site == "McL Serp")
mcLserp.all.rich$year <- scale(mcLserp.all.rich$year)
mcLserp.all.rich.glm <- glmer(rich ~ year + (1|plot), family = "poisson", data = mcLserp.all.rich)
summary(mcLserp.all.rich.glm)

# Swanton
swan.all.rich <- all.exo.grich %>% filter(site == "Swanton")
swan.all.rich$year <- scale(swan.all.rich$year)
swan.all.rich.glm <- glmer(rich ~ year + (1|plot), family = "poisson", data = swan.all.rich)
summary(swan.all.rich.glm)

# UCSC
ucsc.all.rich <- all.exo.grich %>% filter(site == "UCSC")
ucsc.all.rich$year <- scale(ucsc.all.rich$year)
ucsc.all.rich.glm <- glmer(rich ~ year + (1|plot), family = "poisson", data = ucsc.all.rich)
summary(ucsc.all.rich.glm)
```
## Relative richness of different guilds

```{r relative richness}
ang_grich <- angelo_data %>%
  group_by(year, plot, guild) %>%
  summarise(rich = n_distinct(species.name)) %>% ungroup() %>%
  group_by(year, plot) %>%
  mutate(totalrich = sum(rich),
         relrich = rich/totalrich)  %>%
  select(plot, year, relrich, guild)  %>%
  spread(guild, relrich) %>%
  replace(is.na(.), 0) %>%
  add_column(NAG = 0) %>% add_column(NAGr = 0) %>% add_column(EPG = 0) %>%
  add_column(NPGr = 0) %>% add_column(NPS = 0) %>% add_column(NPT = 0) %>%
  mutate(Nat = (NAF+NAG+NAGr+NPF+NPG+NPGr+NPS+NPT),
         Exo = (EAF+EAG+EPF+EPG),
         NatAnns = (NAF+NAG+NAGr),
         ExoAnns = (EAF+EAG),
         ExoPers = (EPF+EPG),
         NatPers = (NPF+NPG+NPGr+NPS+NPT),
         all = (NAF+NAG+NAGr+NPF+NPG+NPGr+NPS+NPT+EAF+EAG+EPF+EPG)) %>%
  ungroup() %>% 
  gather('Nat', 'Exo', 'NatAnns', 'ExoAnns', 'ExoPers', 'NatPers', "all", key = "guild", value = "relrich") %>%
  group_by(year, guild) %>%
  summarise(meanrelrich = mean(relrich),
            serelrich = (std.error(relrich))) %>%
  mutate(site = "Angelo")

car_grich <- car_data %>%
  group_by(year, Plot, guild) %>%
  summarise(rich = n_distinct(species.name)) %>% ungroup() %>%
  group_by(year, Plot) %>%
  mutate(totalrich = sum(rich),
         relrich = rich/totalrich)  %>%
  select(Plot, year, relrich, guild)  %>%
  spread(guild, relrich) %>%
  replace(is.na(.), 0) %>%
  add_column(NAGr = 0) %>% add_column(EPG = 0) %>% add_column(NPGr = 0) %>%
  add_column(NPS = 0) %>% add_column(NPT = 0) %>%
  mutate(Nat = (NAF+NAG+NAGr+NPF+NPG+NPGr+NPS+NPT),
         Exo = (EAF+EAG+EPF+EPG),
         NatAnns = (NAF+NAG+NAGr),
         ExoAnns = (EAF+EAG),
         ExoPers = (EPF+EPG),
         NatPers = (NPF+NPG+NPGr+NPS+NPT),
         all = (NAF+NAG+NAGr+NPF+NPG+NPGr+NPS+NPT+EAF+EAG+EPF+EPG)) %>%
  ungroup() %>% 
  gather('Nat', 'Exo', 'NatAnns', 'ExoAnns', 'ExoPers', 'NatPers', "all", key = "guild", value = "relrich") %>%
  group_by(year, guild) %>%
  summarise(meanrelrich = mean(relrich),
            serelrich = (std.error(relrich))) %>%
  mutate(site = "Carrizo")

elk_grich <- elkhorn_data %>%
  group_by(year, rep, guild) %>%
  summarise(rich = n_distinct(species.name)) %>% ungroup() %>%
  group_by(year, rep) %>%
  mutate(totalrich = sum(rich),
         relrich = rich/totalrich)  %>%
  select(rep, year, relrich, guild)  %>%
  spread(guild, relrich) %>%
  replace(is.na(.), 0) %>%
  add_column(NAF = 0) %>% add_column(NAG = 0) %>% add_column(NPS = 0) %>% add_column(NPT = 0) %>%
  mutate(Nat = (NAF+NAG+NAGr+NPF+NPG+NPGr+NPS+NPT),
         Exo = (EAF+EAG+EPF+EPG),
         NatAnns = (NAF+NAG+NAGr),
         ExoAnns = (EAF+EAG),
         ExoPers = (EPF+EPG),
         NatPers = (NPF+NPG+NPGr+NPS+NPT),
         all = (NAF+NAG+NAGr+NPF+NPG+NPGr+NPS+NPT+EAF+EAG+EPF+EPG)) %>%
  ungroup() %>% 
  gather('Nat', 'Exo', 'NatAnns', 'ExoAnns', 'ExoPers', 'NatPers', "all", key = "guild", value = "relrich") %>%
  group_by(year, guild) %>%
  summarise(meanrelrich = mean(relrich),
            serelrich = (std.error(relrich))) %>%
  mutate(site = "Elkhorn")

jasp_grich <- jasper_data %>%
  group_by(year, uniqueID, guild) %>%
  summarise(rich = n_distinct(species.name)) %>% ungroup() %>%
  group_by(year, uniqueID) %>%
  mutate(totalrich = sum(rich),
         relrich = rich/totalrich)  %>%
  select(uniqueID, year, relrich, guild)  %>%
  spread(guild, relrich) %>%
  replace(is.na(.), 0) %>% 
  add_column(NAGr = 0) %>%  add_column(EAF = 0) %>% add_column(EPF = 0) %>%
  add_column(EPG = 0) %>%  add_column(NPGr = 0) %>% add_column(NPS = 0) %>%
  add_column(NPT = 0) %>%
  mutate(Nat = (NAF+NAG+NAGr+NPF+NPG+NPGr+NPS+NPT),
         Exo = (EAF+EAG+EPF+EPG),
         NatAnns = (NAF+NAG+NAGr),
         ExoAnns = (EAF+EAG),
         ExoPers = (EPF+EPG),
         NatPers = (NPF+NPG+NPGr+NPS+NPT),
         all = (NAF+NAG+NAGr+NPF+NPG+NPGr+NPS+NPT+EAF+EAG+EPF+EPG)) %>%
  ungroup() %>% 
  gather('Nat', 'Exo', 'NatAnns', 'ExoAnns', 'ExoPers', 'NatPers', "all", key = "guild", value = "relrich") %>%
  group_by(year, guild) %>%
  summarise(meanrelrich = mean(relrich),
            serelrich = (std.error(relrich))) %>%
  mutate(site = "Jasper")

McLAnn_grich <- McLAnn_data %>%
  group_by(year, plot, guild) %>%
  summarise(rich = n_distinct(species.name)) %>% ungroup() %>%
  group_by(year, plot) %>%
  mutate(totalrich = sum(rich),
         relrich = rich/totalrich)  %>%
  select(plot, year, relrich, guild) %>%
  spread(guild, relrich) %>%
  replace(is.na(.), 0) %>%
  add_column(NAGr = 0) %>% add_column(NPGr = 0) %>% 
  mutate(Nat = (NAF+NAG+NAGr+NPF+NPG+NPGr+NPS+NPT),
         Exo = (EAF+EAG+EPF+EPG),
         NatAnns = (NAF+NAG+NAGr),
         ExoAnns = (EAF+EAG),
         ExoPers = (EPF+EPG),
         NatPers = (NPF+NPG+NPGr+NPS+NPT),
         all = (NAF+NAG+NAGr+NPF+NPG+NPGr+NPS+NPT+EAF+EAG+EPF+EPG)) %>%
  ungroup() %>% 
  gather('Nat', 'Exo', 'NatAnns', 'ExoAnns', 'ExoPers', 'NatPers', "all", key = "guild", value = "relrich") %>%
  group_by(year, guild) %>%
  summarise(meanrelrich = mean(relrich),
            serelrich = (std.error(relrich))) %>%
  mutate(site = "McL Ann")

mcLserp_grich <- mcLserp_data %>%
  group_by(year, plot, guild) %>%
  summarise(rich = n_distinct(species.name)) %>% ungroup() %>%
  group_by(year, plot) %>%
  mutate(totalrich = sum(rich),
         relrich = rich/totalrich) %>%
  select(plot, year, relrich, guild)  %>%
  spread(guild, relrich) %>%
  replace(is.na(.), 0) %>%
  add_column(NAGr = 0) %>% add_column(NPGr = 0) %>% 
  mutate(Nat = (NAF+NAG+NAGr+NPF+NPG+NPGr+NPS+NPT),
         Exo = (EAF+EAG+EPF+EPG),
         NatAnns = (NAF+NAG+NAGr),
         ExoAnns = (EAF+EAG),
         ExoPers = (EPF+EPG),
         NatPers = (NPF+NPG+NPGr+NPS+NPT),
         all = (NAF+NAG+NAGr+NPF+NPG+NPGr+NPS+NPT+EAF+EAG+EPF+EPG)) %>%
  ungroup() %>% 
  gather('Nat', 'Exo', 'NatAnns', 'ExoAnns', 'ExoPers', 'NatPers', "all", key = "guild", value = "relrich") %>%
  group_by(year, guild) %>%
  summarise(meanrelrich = mean(relrich),
            serelrich = (std.error(relrich))) %>%
  mutate(site = "McL Serp")

swan_grich <- swan_data %>%
  group_by(year, rep, guild) %>%
  summarise(rich = n_distinct(species.name)) %>% ungroup() %>%
  group_by(year, rep) %>%
  mutate(totalrich = sum(rich),
         relrich = rich/totalrich) %>%
  select(rep, year, relrich, guild)  %>%
  spread(guild, relrich) %>%
  replace(is.na(.), 0) %>%
  add_column(NAF = 0) %>% add_column(NAG = 0) %>% add_column(EPG = 0) %>% 
  add_column(NPGr = 0) %>% add_column(NPS = 0) %>% add_column(NPT = 0) %>%
  mutate(Nat = (NAF+NAG+NAGr+NPF+NPG+NPGr+NPS+NPT),
         Exo = (EAF+EAG+EPF+EPG),
         NatAnns = (NAF+NAG+NAGr),
         ExoAnns = (EAF+EAG),
         ExoPers = (EPF+EPG),
         NatPers = (NPF+NPG+NPGr+NPS+NPT),
         all = (NAF+NAG+NAGr+NPF+NPG+NPGr+NPS+NPT+EAF+EAG+EPF+EPG)) %>%
  ungroup() %>% 
  gather('Nat', 'Exo', 'NatAnns', 'ExoAnns', 'ExoPers', 'NatPers', "all", key = "guild", value = "relrich") %>%
  group_by(year, guild) %>%
  summarise(meanrelrich = mean(relrich),
            serelrich = (std.error(relrich))) %>%
  mutate(site = "Swanton")

ucsc_grich <- ucsc_data %>%
  group_by(year, rep, guild) %>%
  summarise(rich = n_distinct(species.name)) %>% ungroup() %>%
  group_by(year, rep) %>%
  mutate(totalrich = sum(rich),
         relrich = rich/totalrich) %>%
  select(rep, year, relrich, guild)  %>%
  spread(guild, relrich) %>%
  replace(is.na(.), 0) %>%
  add_column(NAF = 0) %>% add_column(NAG = 0) %>% add_column(NPS = 0) %>% add_column(NPT = 0) %>%
  mutate(Nat = (NAF+NAG+NAGr+NPF+NPG+NPGr+NPS+NPT),
         Exo = (EAF+EAG+EPF+EPG),
         NatAnns = (NAF+NAG+NAGr),
         ExoAnns = (EAF+EAG),
         ExoPers = (EPF+EPG),
         NatPers = (NPF+NPG+NPGr+NPS+NPT),
         all = (NAF+NAG+NAGr+NPF+NPG+NPGr+NPS+NPT+EAF+EAG+EPF+EPG)) %>%
  ungroup() %>% 
  gather('Nat', 'Exo', 'NatAnns', 'ExoAnns', 'ExoPers', 'NatPers', "all", key = "guild", value = "relrich") %>%
  group_by(year, guild) %>%
  summarise(meanrelrich = mean(relrich),
            serelrich = (std.error(relrich))) %>%
  mutate(site = "UCSC")

all.grelrich <- full_join(mcLserp_grich, swan_grich)
all.grelrich <- full_join(all.grelrich, elk_grich)
all.grelrich <- full_join(all.grelrich, jasp_grich)
all.grelrich <- full_join(all.grelrich, ang_grich)
all.grelrich <- full_join(all.grelrich, McLAnn_grich)
all.grelrich <- full_join(all.grelrich, car_grich)
all.grelrich <- full_join(all.grelrich, ucsc_grich)

all.grelrich <- left_join(all.grelrich, wtryr_weather, by = c("year", "site")) 

all.grelrich.means <- all.grelrich %>%
  group_by(site, guild, year) %>%
  summarise(serich = std.error(serelrich),
            meanrich = mean(meanrelrich),
            precip = mean(precip),
            tmean = mean(tmean),
            tmax = mean(tmax),
            tmin = mean(tmin))
```


```{r tidy richness workspace, include=FALSE}
remove(mcLserp_grich)
remove(swan_grich)
remove(elk_grich)
remove(jasp_grich)
remove(ang_grich)
remove(McLAnn_grich)
remove(car_grich)
remove(ucsc_grich)
```

```{r guild rich graphs}
ggplot(all.grelrich.means, aes(x = year, y = meanrich, color = site)) +
  geom_line() +
  labs(title = "",
       x = "Year",
       y = "Richness") +
  facet_grid(~guild) 

exo.relgrich <- all.grelrich.means %>% filter(guild == "Exo")
nat.relgrich <- all.grelrich.means %>% filter(guild == "Nat")


exo.relrich <- ggplot(nat.relgrich, aes(x = year, y = meanrich, color = site)) +
  geom_point() +
    geom_line() +
  labs(title = "Native species richness",
       x = "Year",
       y = "Richness") +
    facet_wrap(~site, nrow = 1)

nat.relrich <- ggplot(exo.relgrich, aes(x = year, y = meanrich, color = site)) +
  geom_point() +
    geom_line() +
  labs(title = "Exotic species richness",
       x = "Year",
       y = "Richness") +
    facet_wrap(~site, nrow = 1)

grid.arrange(exo.relrich, nat.relrich)

guild.grich <- all.grich.means %>% filter(guild == "Exo" | guild == "Nat")

grid.arrange(
  ggplot(guild.grich) +
  geom_point(aes(x = year, y = meanrich, color = guild)) +
  geom_line(aes(x = year, y = meanrich, color = guild)) +
    labs(title = "Richness of native and exotic species in 8 CA grasslands",
       x = "Year",
       y = "Relative Richness") +
    facet_wrap(~site, nrow = 1))
```



# Changes in guild-level cover over time

```{r converting species level cover to guild level cover}
ang_gcover <- angelo_data %>%
  group_by(year, plot, guild) %>%
  summarise(cover = sum(cover)) %>% ungroup() %>%
  group_by(year, plot) %>%
  mutate(sumcov = sum(cover),
         relcov = cover/sumcov) %>% select(plot, year, relcov, guild)  %>%
  spread(guild, relcov) %>%
  replace(is.na(.), 0) %>%
  add_column(NAG = 0) %>% add_column(NAGr = 0) %>% add_column(EPG = 0) %>%
  add_column(NPGr = 0) %>% add_column(NPS = 0) %>% add_column(NPT = 0) %>%
  mutate(Nat = (NAF+NAG+NAGr+NPF+NPG+NPGr+NPS+NPT),
         Exo = (EAF+EAG+EPF+EPG),
         NatAnns = (NAF+NAG+NAGr),
         ExoAnns = (EAF+EAG),
         ExoPers = (EPF+EPG),
         NatPers = (NPF+NPG+NPGr+NPS+NPT)) %>%
  ungroup() %>% 
  gather('Nat', 'Exo', 'NatAnns', 'ExoAnns', 'ExoPers', 'NatPers', key = "guild", value = "relcov") %>%
  group_by(year, guild) %>%
  summarise(meancov = mean(relcov),
            secov = (std.error(relcov))) %>%
  mutate(site = "Angelo")

car_gcover <- car_data %>%
  group_by(year, plot, guild) %>%
  summarise(cover = sum(Intercepts)) %>% ungroup() %>%
  group_by(year, plot) %>%
  mutate(sumcov = sum(cover),
         relcov = cover/sumcov) %>% select(plot, year, relcov, guild)  %>%
  spread(guild, relcov) %>%
  replace(is.na(.), 0) %>%
  add_column(NAGr = 0) %>% add_column(EPG = 0) %>% add_column(NPGr = 0) %>%
  add_column(NPS = 0) %>% add_column(NPT = 0) %>%
  mutate(Nat = (NAF+NAG+NAGr+NPF+NPG+NPGr+NPS+NPT),
         Exo = (EAF+EAG+EPF+EPG),
         NatAnns = (NAF+NAG+NAGr),
         ExoAnns = (EAF+EAG),
         ExoPers = (EPF+EPG),
         NatPers = (NPF+NPG+NPGr+NPS+NPT)) %>%
  ungroup() %>% 
  gather('Nat', 'Exo', 'NatAnns', 'ExoAnns', 'ExoPers', 'NatPers', key = "guild", value = "relcov") %>%
  group_by(year, guild) %>%
  summarise(meancov = mean(relcov),
            secov = (std.error(relcov))) %>%
  mutate(site = "Carrizo")

elk_gcover <- elkhorn_data %>%
 group_by(year, plot, guild) %>%
  summarise(cover = sum(intercepts)) %>% ungroup() %>%
  group_by(year, plot) %>%
  mutate(sumcov = sum(cover),
         relcov = cover/sumcov) %>% select(plot, year, relcov, guild)  %>%
  spread(guild, relcov) %>%
  replace(is.na(.), 0) %>%
  add_column(NAF = 0) %>% add_column(NAG = 0) %>% add_column(NPS = 0) %>% add_column(NPT = 0) %>%
  mutate(Nat = (NAF+NAG+NAGr+NPF+NPG+NPGr+NPS+NPT),
         Exo = (EAF+EAG+EPF+EPG),
         NatAnns = (NAF+NAG+NAGr),
         ExoAnns = (EAF+EAG),
         ExoPers = (EPF+EPG),
         NatPers = (NPF+NPG+NPGr+NPS+NPT)) %>%
  ungroup() %>% 
  gather('Nat', 'Exo', 'NatAnns', 'ExoAnns', 'ExoPers', 'NatPers', key = "guild", value = "relcov") %>%
  group_by(year, guild) %>%
  summarise(meancov = mean(relcov),
            secov = (std.error(relcov))) %>%
  mutate(site = "Elkhorn")

jasp_gcover <- jasper_data %>%
 group_by(year, plot, guild) %>%
  summarise(cover = sum(cover)) %>% ungroup() %>%
  group_by(year, plot) %>%
  mutate(sumcov = sum(cover),
         relcov = cover/sumcov) %>% select(plot, year, relcov, guild)  %>%
  spread(guild, relcov) %>%
  replace(is.na(.), 0) %>%
  add_column(NAGr = 0) %>%  add_column(EAF = 0) %>% add_column(EPF = 0) %>%
  add_column(EPG = 0) %>%  add_column(NPGr = 0) %>% add_column(NPS = 0) %>%
  add_column(NPT = 0) %>%
  mutate(Nat = (NAF+NAG+NAGr+NPF+NPG+NPGr+NPS+NPT),
         Exo = (EAF+EAG+EPF+EPG),
         NatAnns = (NAF+NAG+NAGr),
         ExoAnns = (EAF+EAG),
         ExoPers = (EPF+EPG),
         NatPers = (NPF+NPG+NPGr+NPS+NPT)) %>%
  ungroup() %>% 
  gather('Nat', 'Exo', 'NatAnns', 'ExoAnns', 'ExoPers', 'NatPers', key = "guild", value = "relcov") %>%
  group_by(year, guild) %>%
  summarise(meancov = mean(relcov),
            secov = (std.error(relcov))) %>%
  mutate(site = "Jasper")

McLAnn_gcover <- McLAnn_data %>%
  filter(Cover > 0) %>%
  group_by(year, plot, guild) %>%
  summarise(cover = sum(Cover)) %>% ungroup() %>%
  group_by(year, plot) %>%
  mutate(sumcov = sum(cover),
         relcov = cover/sumcov) %>% select(plot, year, relcov, guild)  %>%
  spread(guild, relcov) %>%
  replace(is.na(.), 0) %>%
  add_column(NAGr = 0) %>% add_column(NPGr = 0) %>% 
  mutate(Nat = (NAF+NAG+NAGr+NPF+NPG+NPGr+NPS+NPT),
         Exo = (EAF+EAG+EPF+EPG),
         NatAnns = (NAF+NAG+NAGr),
         ExoAnns = (EAF+EAG),
         ExoPers = (EPF+EPG),
         NatPers = (NPF+NPG+NPGr+NPS+NPT)) %>%
  ungroup() %>% 
  gather('Nat', 'Exo', 'NatAnns', 'ExoAnns', 'ExoPers', 'NatPers', key = "guild", value = "relcov") %>%
  group_by(year, guild) %>%
  summarise(meancov = mean(relcov),
            secov = (std.error(relcov))) %>%
  mutate(site = "McL Ann")

mcLserp_gcover <- mcLserp_data %>%
  filter(Cover > 0) %>%
  group_by(year, plot, guild) %>%
  summarise(cover = sum(Cover)) %>% ungroup() %>%
  group_by(year, plot) %>%
  mutate(sumcov = sum(cover),
         relcov = cover/sumcov) %>% select(plot, year, relcov, guild)  %>%
  spread(guild, relcov) %>%
  replace(is.na(.), 0) %>%
  add_column(NAGr = 0) %>% add_column(NPGr = 0) %>% add_column(EPG = 0) %>% 
  mutate(Nat = (NAF+NAG+NAGr+NPF+NPG+NPGr+NPS+NPT),
         Exo = (EAF+EAG+EPF+EPG),
         NatAnns = (NAF+NAG+NAGr),
         ExoAnns = (EAF+EAG),
         ExoPers = (EPF+EPG),
         NatPers = (NPF+NPG+NPGr+NPS+NPT)) %>%
  ungroup() %>% 
  gather('Nat', 'Exo', 'NatAnns', 'ExoAnns', 'ExoPers', 'NatPers', key = "guild", value = "relcov") %>%
  group_by(year, guild) %>%
  summarise(meancov = mean(relcov),
            secov = (std.error(relcov))) %>%
  mutate(site = "McL Serp")

swan_gcover <- swan_data %>%
  group_by(year, plot, guild) %>%
  summarise(cover = sum(intercepts)) %>% ungroup() %>%
  group_by(year, plot) %>%
  mutate(sumcov = sum(cover),
         relcov = cover/sumcov) %>% select(plot, year, relcov, guild)  %>%
  spread(guild, relcov) %>%
  replace(is.na(.), 0) %>%
  add_column(NAF = 0) %>% add_column(NAG = 0) %>% add_column(EPG = 0) %>% 
  add_column(NPGr = 0) %>% add_column(NPS = 0) %>% add_column(NPT = 0) %>%
  mutate(Nat = (NAF+NAG+NAGr+NPF+NPG+NPGr+NPS+NPT),
         Exo = (EAF+EAG+EPF+EPG),
         NatAnns = (NAF+NAG+NAGr),
         ExoAnns = (EAF+EAG),
         ExoPers = (EPF+EPG),
         NatPers = (NPF+NPG+NPGr+NPS+NPT)) %>%
  ungroup() %>% 
  gather('Nat', 'Exo', 'NatAnns', 'ExoAnns', 'ExoPers', 'NatPers', key = "guild", value = "relcov") %>%
  group_by(year, guild) %>%
  summarise(meancov = mean(relcov),
            secov = (std.error(relcov))) %>%
  mutate(site = "Swanton")

ucsc_gcover <- ucsc_data %>%
  group_by(year, plot, guild) %>%
  summarise(cover = sum(intercepts)) %>% ungroup() %>%
  group_by(year, plot) %>%
  mutate(sumcov = sum(cover),
         relcov = cover/sumcov) %>% select(plot, year, relcov, guild)  %>%
  spread(guild, relcov) %>%
  replace(is.na(.), 0) %>%
  add_column(NAF = 0) %>% add_column(NAG = 0) %>% add_column(NPS = 0) %>% add_column(NPT = 0) %>%
  mutate(Nat = (NAF+NAG+NAGr+NPF+NPG+NPGr+NPS+NPT),
         Exo = (EAF+EAG+EPF+EPG),
         NatAnns = (NAF+NAG+NAGr),
         ExoAnns = (EAF+EAG),
         ExoPers = (EPF+EPG),
         NatPers = (NPF+NPG+NPGr+NPS+NPT)) %>%
  ungroup() %>% 
  gather('Nat', 'Exo', 'NatAnns', 'ExoAnns', 'ExoPers', 'NatPers', key = "guild", value = "relcov") %>%
  group_by(year, guild) %>%
  summarise(meancov = mean(relcov),
            secov = (std.error(relcov))) %>%
  mutate(site = "UCSC")

all.gcov <- full_join(mcLserp_gcover, swan_gcover)
all.gcov <- full_join(all.gcov, elk_gcover)
all.gcov <- full_join(all.gcov, jasp_gcover)
all.gcov <- full_join(all.gcov, ang_gcover)
all.gcov <- full_join(all.gcov, McLAnn_gcover)
all.gcov <- full_join(all.gcov, car_gcover)
all.gcov <- full_join(all.gcov, ucsc_gcover)

all_gcov <- left_join(all.gcov, wtryr_weather, by = c("year", "site")) 

all_gcov <- left_join(all_gcov, all.CTI, by = c("site", "year"))

all_gcov_means <- all_gcov %>%
  group_by(site, guild, year) %>%
  summarise(serelcov = std.error(meancov),
            meanrelcov = mean(meancov),
            precip = mean(precip.y),
            tmean = mean(tmean.y),
            tmax = mean(tmax.y),
            tmin = mean(tmin.y),
            mean.CTI = mean(CTI),
            se.CTI = std.error(CTI))
```

```{r tidy gcover workspace, include=FALSE}
remove(mcLserp_gcover, swan_gcover, elk_gcover, jasp_gcover, ang_gcover, McLAnn_gcover, car_gcover, ucsc_gcover)
```

```{r guild cover graphs}
ggplot(all_gcov_means, aes(x = year, y = meanrelcov, color = site)) +
  geom_line() +
  labs(title = "",
       x = "Year",
       y = "Relative cover") +
  facet_grid(~guild) 

ggplot(all_gcov_means, aes(x = meanrelcov, y = mean.CTI, color = site)) +
  geom_line() +
  labs(title = "",
       x = "Year",
       y = "Relative cover") +
  facet_grid(~guild) 


exo.gcov <- all_gcov_means %>% filter(guild == "Exo")
nat.gcov <- all_gcov_means %>% filter(guild == "Nat")

spp.gcov <- full_join(exo.gcov, nat.gcov)
ggplot(nat.gcov, aes(x = meanrelcov, y = mean.CTI, color = site)) +
  geom_point() +
  geom_line() +
  labs(title = "",
       x = "Relative native cover",
       y = "CTI") +
  theme_bw() +
  theme(legend.position = "bottom",
        strip.background = element_blank(),
        strip.text = element_blank()) +
  scale_x_continuous(limits = c(0,1), expand = c(0.05,0)) +
  facet_grid(~guild)



grid.arrange(
  ggplot(nat.gcov, aes(x = year, y = meanrelcov, color = site)) +
  geom_point() +
    geom_line() +
  labs(title = "",
       x = "Year",
       y = "Relative cover"),
  ggplot(exo.gcov, aes(x = year, y = meanrelcov, color = site)) +
  geom_point() +
    geom_line() +
  labs(title = "",
       x = "Year",
       y = "Relative cover"))
```
