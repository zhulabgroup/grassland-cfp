---
title: "UCSC Analysis"
author: "Josie Lesage"
date: "12/13/2019"
output: html_document
---

# Setup and data import
```{r setup, include=FALSE}
## community analysis
library(codyn)
library(MASS)
library(vegan)
library(lme4)

## CTI analysis
library(CoordinateCleaner)
library(countrycode)
library(mapr)
library(maptools)
library(raster)
library(rgbif)
library(scrubr)
library(sp)
library(spocc)

## misc/both/other
library(oz)
library(plotrix)
library(tidyverse)
```


```{r data import, include = FALSE}
ucsc_data <- read.csv("ucsc_data.csv") %>%
    mutate(species.name = fct_recode(species.name, 
                                   'Vulpia myuros' = 'Festuca myuros'))
```

The goal for this project is to successfully download species occurance location data from GBIF for the species in the Swanton plots, and to associate this location data with climate data from the WorldClim database. Additionally, I hope to do any cleaning that's needed between these steps before I can generate a community temperature index for the site over time.


## Preparing a species list table
In order to get the appropriate data from gbif, we need to generate a table of species/genus information that we can reference and call from.

```{r species table}
ucsc_species <- unique(ucsc_data$species.name)
ucsc_list <- as.data.frame(ucsc_species)
```

There are a total of ~33 species in the Elkhorn dataset.  


```{r fixing species table}
ucsc_data <- ucsc_data %>%
  filter(species.name != "Thatch",
         species.name != "Bare ground")

ucsc_species <- unique(ucsc_data$species.name)
ucsc_list <- as.data.frame(ucsc_species)
ucsc_list$ucsc_species <- paste0("'", ucsc_list$ucsc_species, "',")
  
cat(format_delim(ucsc_list, delim = ""))

ucsc_data_rel <- ucsc_data %>%
  select(year, rep, species.name, intercepts) %>%
  group_by(rep, year) %>%
  mutate(sumintercept = sum(intercepts),
         relcov = intercepts/sumintercept)
```

**Note:** there are instances of "bromus sp." and "rumex spp." in the dataset. I am not sure if I should remove this one hit, or leave it be. It's probably bromus hordeaceus - but no way to know for sure. 

# Community Poisson GLM

**Look at chapter 14 of the Mixed Models book.**

Before running our analysis, we should check the means and variance for the response variable over different predictor variables. 

```{r Rich explore}
ucsc_rich_means <- ucsc_data %>%
  group_by(year, rep) %>%
  summarise(rich = n_distinct(species.name)) %>%
  ungroup() %>% group_by(year) %>%
  summarise(meanrich = mean(rich),
            serich = (std.error(rich)))

ucsc_rich <- ucsc_data %>%
  group_by(year, rep) %>%
  summarise(rich = n_distinct(species.name))

ucsc_rich_overall <- ucsc_data %>%
  group_by(year) %>%
  summarise(rich = n_distinct(species.name))

ggplot(ucsc_rich_means, aes(x = year, y = meanrich)) +
  geom_line() 
ggplot(ucsc_rich_overall, aes(x = year, y = rich)) +
  geom_line() 

```


# Community turnover metrics

## Community turnover - annual +/-
To answer who joins and who leaves each year, we need to calculate the species in the starting year, then see how many are added and how many leave. We'll do this with Lauren Hallet's (hopefully awesome) codyn package - which has a function for turnover.

```{r turnover metrics}
ucsc_turnover <- turnover(df = ucsc_data_rel,
                          time.var = "year",
                          species.var = "species.name",
                          abundance.var = "relcov",
                          replicate.var = "rep")

ucsc_turn_means <- ucsc_turnover %>%
  group_by(year) %>%
  summarise(meanturn = mean(total),
            seturn = std.error(total))

ggplot(ucsc_turn_means, aes(x = year, y = meanturn)) +
  geom_point() +
  geom_errorbar(aes(ymin = meanturn-seturn, ymax = meanturn+seturn)) +
  labs(title = "Swanton - Community Turnover (n = 3)",
       x = "Year",
       y = "Turnover (# spp. lost+gained / total # spp.)")

```




# Gathering & cleaning occurance data

We will gather species occurrance data from GBIF through the SpOcc package. 

```{r grabbing jasper gbif data, echo = FALSE, cache = TRUE, warning=FALSE}
## look at species list

ucsc_genus_list <- c('Bromus', 'Brassica')

ucsc_species_list <- c('Erodium botrys', 
                       'Geranium dissectum',
                       'Bromus hordeaceus',
                       'Vulpia myuros',
                       'Festuca perennis',
                       'Hypochaeris radicata',
                       'Plantago lanceolata',
                       'Rumex acetosella',
                       'Eschscholzia californica',
                       'Erodium moschatum',
                       'Lysimachia arvensis',
                       'Bromus diandrus',
                       'Brachypodium distachyon',
                       'Trifolium angustifolium',
                       'Trifolium subterraneum',
                       'Danthonia californica',
                       'Juncus occidentalis',
                       'Aira caryophyllea',
                       'Avena barbata',
                       'Erodium cicutarium',
                       'Carduus pycnocephalus',
                       'Phalaris aquatica',
                       'Epilobium ciliatum',
                       'Cerastium glomeratum',
                       'Juncus phaeocephalus',
                       'Hirschfeldia incana',
                       'Trifolium dubium',
                       'Cynosurus echinatus',
                       'Isolepis carinata')

ucsc_species_data <- occ(query = ucsc_species_list, from = "gbif", has_coords = TRUE, limit = 10000,
                gbifopts = list(hasGeospatialIssue = FALSE, country = "US",
                                stateProvince = "California"))

## we can also replace all synonym taxon names with one (cuts down the number of plotted dot colors)
## we should use the scrubr version of the function in the future
ucsc_species_data <- fixnames(ucsc_species_data, how = "query")

## The occ2df function should convert the data to a dataframe format
ucsc_species_data_df <- occ2df(ucsc_species_data)

map_ggplot(ucsc_species_data, map = "state", size = 0.5) 


```

We need to clean the coordinates, as it appears some are in the ocean (look @ NorCal), and there might be some that are just incorrect. To do this, we will use a coordinate cleaner package.

```{r cleaning jasper coords, echo=FALSE, cache = TRUE, dependson="grabbing jasper gbif data"}
flags <- clean_coordinates(x = ucsc_species_data_df, lon = "longitude", lat = "latitude",
                          species = "name",
                          tests = c("capitals", "centroids", "equal","gbif", "institutions",
                                    "seas", "zeros")) # most test are on by default

plot(flags, lon = "longitude", lat = "latitude")

```
Most of our flagged coordinates are coastal/in the ocean. Therefore, we'll remove them from our database after taking a look at which ones (~1350 out of 15,300, so ~8.8%) were flagged.  

```{r examine flagged coords, echo=FALSE, cache = TRUE, dependson="cleaning jasper coords"}

flag_df <- ucsc_species_data_df[!flags$.summary,]
str(flag_df)
summary(flag_df)

# keep only the non-flagged data
ucsc_species_data_df <- ucsc_species_data_df[flags$.summary,]

```
It appears that there were flagged instances for most of the species. For this practice run-through, I'll definitely just cut them out without taking a closer look (for now).  
More guidance on cleaning datasets and removing bad coordinates is [available here](https://ropensci.github.io/CoordinateCleaner/articles/Tutorial_Cleaning_GBIF_data_with_CoordinateCleaner.html).  

# Adding climate data

Following the jcoliver webpage guides...

```{r map of geo extent, echo = FALSE}
max.lat <- ceiling(max(ucsc_species_data_df$latitude))
min.lat <- floor(min(ucsc_species_data_df$latitude))
max.lon <- ceiling(max(ucsc_species_data_df$longitude))
min.lon <- floor(min(ucsc_species_data_df$longitude))
geographic.extent <- extent(x = c(min.lon, max.lon, min.lat, max.lat))

# Load the data to use for our base map
data(wrld_simpl)

# Plot the base map
plot(wrld_simpl, 
     xlim = c(min.lon, max.lon),
     ylim = c(min.lat, max.lat),
     axes = TRUE, 
     col = "grey95")

# Add the points for individual observation
points(x = ucsc_species_data_df$longitude, 
       y = ucsc_species_data_df$latitude, 
       col = "olivedrab", 
       pch = 20, 
       cex = 0.75)
# And draw a little box around the graph
box()
```

```{r based on oikos page, cache = TRUE}
xy <- ucsc_species_data_df[,c("longitude","latitude")]
sp_xy <- ucsc_species_data_df[c("name", "longitude","latitude")]

sp_xy <- sp_xy %>%
  rename(species = name)


# only need this if I think the worldclim layers have changed 
#     env <- getData('worldclim', var='bio', res=2.5)

plot(env, 1, main=NULL, axes=FALSE)
points(xy, col='blue', pch=20)

xy_bio <- raster::extract(env, xy)

```

Reference list for climate variables:
 * BIO1 = Annual Mean Temperature (°C * 10) -- (i.e. 231 represents 23.1 °C)
 * BIO2 = Mean Diurnal Range (Mean of monthly (max temp – min temp)) 
 * BIO3 = Isothermality (BIO2/BIO7) (* 100)
 * BIO4 = Temperature Seasonality (standard deviation *100)
 * BIO5 = Max Temperature of Warmest Month (°C * 10)
 * BIO6 = Min Temperature of Coldest Month (°C * 10)
 * BIO7 = Temperature Annual Range (BIO5-BIO6)
 * BIO8 = Mean Temperature of Wettest Quarter (°C * 10)
 * BIO9 = Mean Temperature of Driest Quarter (°C * 10)
 * BIO10 = Mean Temperature of Warmest Quarter (°C * 10)
 * BIO11 = Mean Temperature of Coldest Quarter (°C * 10)
 * BIO12 = Annual Precipitation (mm)
 * BIO13 = Precipitation of Wettest Month (mm)
 * BIO14 = Precipitation of Driest Month (mm)
 * BIO15 = Precipitation Seasonality (Coeficent of Variation) 
 * BIO16 = Precipitation of Wettest Quarter (mm)
 * BIO17 = Precipitation of Driest Quarter (mm)
 * BIO18 = Precipitation of Warmest Quarter (mm)
 * BIO19 = Precipitation of Coldest Quarter (mm)
 
```{r mean species temp, echo=FALSE}
ucsc_species_clim <- cbind(xy_bio, sp_xy)

ucsc_species_clim <- ucsc_species_clim %>%
  group_by(species) %>%
  summarise(meant = mean(bio1, na.rm = TRUE),
         meanp = mean(bio12, na.rm = TRUE)) %>%
  mutate(meanT = meant/10) %>%
  rename(species.name = species)
```

         
### Bromus

```{r UCSC Bromus}

ucsc_bromus <- c('Bromus carinatus',
                 'Bromus hordeaceus',
                 'Bromus madritensis',
                 'Bromus diandrus',
                 'Bromus catharticus')
         
ucsc_bromus_data <- occ(query = ucsc_bromus, from = "gbif", has_coords = TRUE, limit = 10000,
                gbifopts = list(hasGeospatialIssue = FALSE, country = "US",
                                stateProvince = "California"))

## we can also replace all synonym taxon names with one (cuts down the number of plotted dot colors)
## we should use the scrubr version of the function in the future
ucsc_bromus_data <- fixnames(ucsc_bromus_data, how = "query")

## The occ2df function should convert the data to a dataframe format
ucsc_bromus_data_df <- occ2df(ucsc_bromus_data)

map_ggplot(ucsc_bromus_data, map = "state", size = 0.5) 

flags <- clean_coordinates(x = ucsc_bromus_data_df, lon = "longitude", lat = "latitude",
                          species = "name",
                          tests = c("capitals", "centroids", "equal","gbif", "institutions",
                                    "seas", "zeros")) # most test are on by default

# remove flagged records
ucsc_bromus_data_df <- ucsc_bromus_data_df[flags$.summary,]

# extract lat/long for each datapoint
xy <- ucsc_bromus_data_df[,c("longitude","latitude")]
sp_xy <- ucsc_bromus_data_df[c("name", "longitude","latitude")]
sp_xy <- sp_xy %>%
  rename(species = name)

xy_bio <- raster::extract(env, xy)
ucsc_bromus_clim <- cbind(xy_bio, sp_xy)

# change all datapoints to the "species sp" format that's used in the og dataframe, calc CTI
ucsc_bromus_clim <- ucsc_bromus_clim %>%
  mutate(species.name = "Bromus sp") %>%
   group_by(species.name) %>%
   summarise(meant = mean(bio1, na.rm = TRUE),
         meanp = mean(bio12, na.rm = TRUE)) %>%
  mutate(meanT = meant/10) 


            
```


### Brassica

```{r UCSC Brassica}

ucsc_brassica <- c('Brassica rapa',
                   'Brassica nigra',
                   'Hirschfeldia incana')
         
ucsc_brassica_data <- occ(query = ucsc_brassica, from = "gbif", has_coords = TRUE, limit = 10000,
                gbifopts = list(hasGeospatialIssue = FALSE, country = "US",
                                stateProvince = "California"))

## we can also replace all synonym taxon names with one (cuts down the number of plotted dot colors)
## we should use the scrubr version of the function in the future
ucsc_brassica_data <- fixnames(ucsc_brassica_data, how = "query")

## The occ2df function should convert the data to a dataframe format
ucsc_brassica_data_df <- occ2df(ucsc_brassica_data)

map_ggplot(ucsc_brassica_data, map = "state", size = 0.5) 

flags <- clean_coordinates(x = ucsc_brassica_data_df, lon = "longitude", lat = "latitude",
                          species = "name",
                          tests = c("capitals", "centroids", "equal","gbif", "institutions",
                                    "seas", "zeros")) # most test are on by default

# remove flagged records
ucsc_brassica_data_df <- ucsc_brassica_data_df[flags$.summary,]

# extract lat/long for each datapoint
xy <- ucsc_brassica_data_df[,c("longitude","latitude")]
sp_xy <- ucsc_brassica_data_df[c("name", "longitude","latitude")]
sp_xy <- sp_xy %>%
  rename(species = name)

xy_bio <- raster::extract(env, xy)
ucsc_brassica_clim <- cbind(xy_bio, sp_xy)

# change all datapoints to the "species sp" format that's used in the og dataframe, calc CTI
ucsc_brassica_clim <- ucsc_brassica_clim %>%
  mutate(species.name = "Brassica species") %>%
   group_by(species.name) %>%
   summarise(meant = mean(bio1, na.rm = TRUE),
         meanp = mean(bio12, na.rm = TRUE)) %>%
  mutate(meanT = meant/10) 
            
```


# Calculating CTI
To calculate CTI, we need to summarize the weight of each species in a community and multiply that by the TI for that species. 

```{r relative cover of each spp, cache = TRUE}
ucsc_data_rel <- ucsc_data %>%
  select(year, rep, species.name, intercepts) %>%
  group_by(rep, year) %>%
  mutate(sumintercept = sum(intercepts),
         relcov = intercepts/sumintercept)
```


```{r Creating CTI table}

ucsc_CTI <- left_join(ucsc_data_rel, ucsc_species_clim, by = "species.name") 
ucsc_CTI <- left_join(ucsc_CTI, ucsc_bromus_clim, by = "species.name") %>%
  mutate(meant = coalesce(meant.x, meant.y),
         meanp = coalesce(meanp.x, meanp.y),
         meanT = coalesce(meanT.x, meanT.y),) %>% 
        select(-meant.x, -meant.y, -meanp.x, -meanp.y, -meanT.x, -meanT.y)
ucsc_CTI <- left_join(ucsc_CTI, ucsc_brassica_clim, by = "species.name") %>%
  mutate(meant = coalesce(meant.x, meant.y),
         meanp = coalesce(meanp.x, meanp.y),
         meanT = coalesce(meanT.x, meanT.y),) %>% 
        select(-meant.x, -meant.y, -meanp.x, -meanp.y, -meanT.x, -meanT.y)

ucsc_CTI <- ucsc_CTI %>%
    mutate(relTI = relcov*meanT,
         relP = relcov*meanp) %>%
  remove_missing() %>%
  group_by(year, rep) %>%
  summarise(CTI = sum(relTI, rm.na = TRUE),
            CPI = sum(relP, rm.na = TRUE))

ucsc_CTI_means <- ucsc_CTI %>%
  group_by(year) %>%
  summarise(meanCTI = mean(CTI),
            seCTI = std.error(CTI),
            meanCPI = mean(CPI),
            seCPI = std.error(CPI))

ggplot(ucsc_CTI_means, aes(x=year, y=meanCTI)) +
  geom_point() +
  geom_errorbar(aes(ymin = meanCTI-seCTI, ymax = meanCTI+seCTI), width=0.2)

ggplot(ucsc_CTI_means, aes(x=year, y=meanCPI)) +
  geom_point() +
  geom_errorbar(aes(ymin = meanCPI-seCPI, ymax = meanCPI+seCPI), width=0.2)


```



### Saving CTI .csv

```{r CTI csv}

ucsc_CTI <- ucsc_CTI %>%
  rename(plot = rep) %>%
  mutate(Site = "UCSC")
write.csv(ucsc_CTI, "UCSC_CTI.csv")

```


