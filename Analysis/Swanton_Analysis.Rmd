---
title: "Swanton Analysis"
author: "Josie Lesage"
date: "12/5/2019"
output: html_document
---

# Setup and data import
```{r setup, include=FALSE}
## community analysis
library(codyn)
library(MASS)
library(vegan)
library(lme4)

## CTI analysis
library(CoordinateCleaner)
library(countrycode)
library(mapr)
library(maptools)
library(raster)
library(rgbif)
library(scrubr)
library(sp)
library(spocc)

## misc/both/other
library(oz)
library(plotrix)
library(tidyverse)
```


```{r data import, include = FALSE}
swan_data <- read.csv("swanton_data.csv") %>%
  mutate(species.name = fct_recode(species.name, 
                                   'Vulpia myuros' = 'Festuca myuros'))
```

The goal for this project is to successfully download species occurance location data from GBIF for the species in the Swanton plots, and to associate this location data with climate data from the WorldClim database. Additionally, I hope to do any cleaning that's needed between these steps before I can generate a community temperature index for the site over time.


## Preparing a species list table
In order to get the appropriate data from gbif, we need to generate a table of species/genus information that we can reference and call from.

```{r species table}
swan_species <- unique(swan_data$species.name)
swan_list <- as.data.frame(swan_species)
```

There are a total of ~34 species in the Elkhorn dataset.  


```{r fixing species table}
swan_data <- swan_data %>%
  filter(species.name != "Moss",
         species.name != "Thatch",
         species.name != "Bare ground")

swan_species <- unique(swan_data$species.name)
swan_list <- as.data.frame(swan_species)
swan_list$swan_species <- paste0("'", swan_list$swan_species, "',")
  
cat(format_delim(swan_list, delim = ""))

swan_data_rel <- swan_data %>%
  select(year, rep, species.name, intercepts) %>%
  group_by(rep, year) %>%
  mutate(sumintercept = sum(intercepts),
         relcov = intercepts/sumintercept)
```

**Note:** there are instances of "bromus sp." and "rumex spp." in the dataset. I am not sure if I should remove this one hit, or leave it be. It's probably bromus hordeaceus - but no way to know for sure. 

# Community Poisson GLM

**Look at chapter 14 of the Mixed Models book.**

Before running our analysis, we should check the means and variance for the response variable over different predictor variables. 

```{r Rich explore}
swan_rich_means <- swan_data %>%
  group_by(year, rep) %>%
  summarise(rich = n_distinct(species.name)) %>%
  ungroup() %>% group_by(year) %>%
  summarise(meanrich = mean(rich),
            serich = (std.error(rich)))

swan_rich <- swan_data %>%
  group_by(year, rep) %>%
  summarise(rich = n_distinct(species.name))

ggplot(swan_rich_means, aes(x = year, y = meanrich)) +
  geom_line() 

```


# Community turnover metrics

## Community turnover - annual +/-
To answer who joins and who leaves each year, we need to calculate the species in the starting year, then see how many are added and how many leave. We'll do this with Lauren Hallet's (hopefully awesome) codyn package - which has a function for turnover.

```{r turnover metrics}
swan_turnover <- turnover(df = swan_data_rel,
                          time.var = "year",
                          species.var = "species.name",
                          abundance.var = "relcov",
                          replicate.var = "rep")

swan_turn_means <- swan_turnover %>%
  group_by(year) %>%
  summarise(meanturn = mean(total),
            seturn = std.error(total))

ggplot(swan_turn_means, aes(x = year, y = meanturn)) +
  geom_point() +
  geom_errorbar(aes(ymin = meanturn-seturn, ymax = meanturn+seturn)) +
  labs(title = "Swanton - Community Turnover (n = 3)",
       x = "Year",
       y = "Turnover (# spp. lost+gained / total # spp.)")

```



# Gathering & cleaning occurance data

We will gather species occurrance data from GBIF through the SpOcc package. 

```{r grabbing jasper gbif data, echo = FALSE, cache = TRUE, warning=FALSE}
## look at species list
swan_species <- unique(swan_data$species.name)
swan_list <- as.data.frame(swan_species)
swan_list$swan_species <- paste0("'",swan_list$swan_species,"',")
cat(swan_list <- format_delim(swan_list, delim = ""))

swan_species_list <- c('Lysimachia arvensis',
                       'Erodium botrys',
                       'Erodium cicutarium',
                       'Erodium moschatum',
                       'Trifolium dubium',
                       'Trifolium subterraneum',
                       'Hypochaeris radicata',
                       'Plantago lanceolata',
                       'Rumex acetosella',
                       'Festuca perennis',
                       'Vulpia myuros',
                       'Bromus diandrus',
                       'Cerastium glomeratum',
                       'Geranium dissectum',
                       'Hordeum murinum',
                       'Juncus bufonius',
                       'Bromus carinatus',
                       'Rumex pulcher',
                       'Hordeum brachyantherum',
                       'Avena barbata',
                       'Stipa pulchra',
                       'Rumex crispus',
                       'Vicia sativa',
                       'Trifolium angustifolium',
                       'Silybum marianum',
                       'Cynosurus echinatus',
                       'Carduus pycnocephalus',
                       'Cirsium vulgare',
                       'Eschscholzia californica',
                       'Sonchus asper')

swan_species_data <- occ(query = swan_species_list, from = "gbif", has_coords = TRUE, limit = 10000,
                gbifopts = list(hasGeospatialIssue = FALSE, country = "US",
                                stateProvince = "California"))

## we can also replace all synonym taxon names with one (cuts down the number of plotted dot colors)
## we should use the scrubr version of the function in the future
swan_species_data <- fixnames(swan_species_data, how = "query")

## The occ2df function should convert the data to a dataframe format
swan_species_data_df <- occ2df(swan_species_data)

map_ggplot(swan_species_data, map = "state", size = 0.5) 
```

We need to clean the coordinates, as it appears some are in the ocean (look @ NorCal), and there might be some that are just incorrect. To do this, we will use a coordinate cleaner package.

```{r cleaning jasper coords, echo=FALSE, cache = TRUE, dependson="grabbing jasper gbif data"}
flags <- clean_coordinates(x = swan_species_data_df, lon = "longitude", lat = "latitude",
                          species = "name",
                          tests = c("capitals", "centroids", "equal","gbif", "institutions",
                                    "seas", "zeros")) # most test are on by default

plot(flags, lon = "longitude", lat = "latitude")

```
we'll remove the flagged locations from our database after taking a look at which ones (3,912 out of 45,624, so ~9%) were flagged.  

```{r examine flagged coords, echo=FALSE, cache = TRUE, dependson="cleaning jasper coords"}

flag_df <- swan_species_data_df[!flags$.summary,]
str(flag_df)
summary(flag_df)

# keep only the non-flagged data
swan_species_data_df <- swan_species_data_df[flags$.summary,]

```
It appears that there were flagged instances for most of the species. For this practice run-through, I'll definitely just cut them out without taking a closer look (for now).  
More guidance on cleaning datasets and removing bad coordinates is [available here](https://ropensci.github.io/CoordinateCleaner/articles/Tutorial_Cleaning_GBIF_data_with_CoordinateCleaner.html).  

# Adding climate data

Following the jcoliver webpage guides...

```{r map of geo extent, echo = FALSE}
max.lat <- ceiling(max(swan_species_data_df$latitude))
min.lat <- floor(min(swan_species_data_df$latitude))
max.lon <- ceiling(max(swan_species_data_df$longitude))
min.lon <- floor(min(swan_species_data_df$longitude))
geographic.extent <- extent(x = c(min.lon, max.lon, min.lat, max.lat))

# Load the data to use for our base map
data(wrld_simpl)

# Plot the base map
plot(wrld_simpl, 
     xlim = c(min.lon, max.lon),
     ylim = c(min.lat, max.lat),
     axes = TRUE, 
     col = "grey95")

# Add the points for individual observation
points(x = swan_species_data_df$longitude, 
       y = swan_species_data_df$latitude, 
       col = "olivedrab", 
       pch = 20, 
       cex = 0.75)
# And draw a little box around the graph
box()
```

```{r based on oikos page, cache = TRUE}
xy <- swan_species_data_df[,c("longitude","latitude")]
sp_xy <- swan_species_data_df[c("name", "longitude","latitude")]

sp_xy <- sp_xy %>%
  rename(species = name)


env <- getData('worldclim', var='bio', res=2.5)

plot(env, 1, main=NULL, axes=FALSE)
points(xy, col='blue', pch=20)

xy_bio <- raster::extract(env, xy)

```

Reference list for climate variables:
 * BIO1 = Annual Mean Temperature (°C * 10) -- (i.e. 231 represents 23.1 °C)
 * BIO2 = Mean Diurnal Range (Mean of monthly (max temp – min temp)) 
 * BIO3 = Isothermality (BIO2/BIO7) (* 100)
 * BIO4 = Temperature Seasonality (standard deviation *100)
 * BIO5 = Max Temperature of Warmest Month (°C * 10)
 * BIO6 = Min Temperature of Coldest Month (°C * 10)
 * BIO7 = Temperature Annual Range (BIO5-BIO6)
 * BIO8 = Mean Temperature of Wettest Quarter (°C * 10)
 * BIO9 = Mean Temperature of Driest Quarter (°C * 10)
 * BIO10 = Mean Temperature of Warmest Quarter (°C * 10)
 * BIO11 = Mean Temperature of Coldest Quarter (°C * 10)
 * BIO12 = Annual Precipitation (mm)
 * BIO13 = Precipitation of Wettest Month (mm)
 * BIO14 = Precipitation of Driest Month (mm)
 * BIO15 = Precipitation Seasonality (Coeficent of Variation) 
 * BIO16 = Precipitation of Wettest Quarter (mm)
 * BIO17 = Precipitation of Driest Quarter (mm)
 * BIO18 = Precipitation of Warmest Quarter (mm)
 * BIO19 = Precipitation of Coldest Quarter (mm)
 
```{r mean species temp, echo=FALSE}
swan_species_clim <- cbind(xy_bio, sp_xy)

swan_species_clim <- swan_species_clim %>%
  group_by(species) %>%
  summarise(meant = mean(bio1, na.rm = TRUE),
         meanp = mean(bio12, na.rm = TRUE)) %>%
  mutate(meanT = meant/10) %>%
  rename(species.name = species)
```

         
 

# Extra sp
### Bromus sp.
We need to check that these are the correct species - using as placeholders for now. 
```{r Swanton Bromus}
swan_bromus <- c('Bromus carinatus',
                 'Bromus diandrus',
                 'Avena barbata')

swan_bromus_data <- occ(query = swan_bromus, from = "gbif", has_coords = TRUE, limit = 10000,
                gbifopts = list(hasGeospatialIssue = FALSE, country = "US",
                                stateProvince = "California"))

## we can also replace all synonym taxon names with one (cuts down the number of plotted dot colors)
## we should use the scrubr version of the function in the future
swan_bromus_data <- fixnames(swan_bromus_data, how = "query")

## The occ2df function should convert the data to a dataframe format
swan_bromus_data_df <- occ2df(swan_bromus_data)

flags <- clean_coordinates(x = swan_bromus_data_df, lon = "longitude", lat = "latitude",
                          species = "name",
                          tests = c("capitals", "centroids", "equal","gbif", "institutions",
                                    "seas", "zeros")) # most test are on by default

# remove flagged records
swan_bromus_data_df <- swan_bromus_data_df[flags$.summary,]

# extract lat/long for each datapoint
xy <- swan_bromus_data_df[,c("longitude","latitude")]
sp_xy <- swan_bromus_data_df[c("name", "longitude","latitude")]
sp_xy <- sp_xy %>%
  rename(species = name)

xy_bio <- raster::extract(env, xy)
swan_bromus_clim <- cbind(xy_bio, sp_xy)

# change all datapoints to the "species sp" format that's used in the og dataframe, calc CTI
swan_bromus_clim <- swan_bromus_clim %>%
  mutate(species.name = "Bromus sp") %>%
   group_by(species.name) %>%
   summarise(meant = mean(bio1, na.rm = TRUE),
         meanp = mean(bio12, na.rm = TRUE)) %>%
  mutate(meanT = meant/10) 
```

### Rumex sp.
We need to check that these are the correct species - using as placeholders for now. 
```{r Swanton Rumex}
swan_rumex <- c('Rumex acetosella',
                'Rumex crispus',
                'Rumex pulcher')

swan_rumex_data <- occ(query = swan_rumex, from = "gbif", has_coords = TRUE, limit = 10000,
                gbifopts = list(hasGeospatialIssue = FALSE, country = "US",
                                stateProvince = "California"))

## we can also replace all synonym taxon names with one (cuts down the number of plotted dot colors)
## we should use the scrubr version of the function in the future
swan_rumex_data <- fixnames(swan_rumex_data, how = "query")

## The occ2df function should convert the data to a dataframe format
swan_rumex_data_df <- occ2df(swan_rumex_data)

map_ggplot(swan_rumex_data, map = "state", size = 0.5) 

flags <- clean_coordinates(x = swan_rumex_data_df, lon = "longitude", lat = "latitude",
                          species = "name",
                          tests = c("capitals", "centroids", "equal","gbif", "institutions",
                                    "seas", "zeros")) # most test are on by default

# remove flagged records
swan_rumex_data_df <- swan_rumex_data_df[flags$.summary,]

# extract lat/long for each datapoint
xy <- swan_rumex_data_df[,c("longitude","latitude")]
sp_xy <- swan_rumex_data_df[c("name", "longitude","latitude")]
sp_xy <- sp_xy %>%
  rename(species = name)

xy_bio <- raster::extract(env, xy)
swan_rumex_clim <- cbind(xy_bio, sp_xy)

# change all datapoints to the "species sp" format that's used in the og dataframe, calc CTI
swan_rumex_clim <- swan_rumex_clim %>%
  mutate(species.name = "Rumex spp") %>%
   group_by(species.name) %>%
   summarise(meant = mean(bio1, na.rm = TRUE),
         meanp = mean(bio12, na.rm = TRUE)) %>%
  mutate(meanT = meant/10) 
```


# Calculating CTI

To calculate CTI, we need to summarize the weight of each species in a community and multiply that by the TI for that species. 

```{r relative cover of each spp, cache = TRUE}
swan_data_rel <- swan_data %>%
  select(year, rep, species.name, intercepts) %>%
  group_by(rep, year) %>%
  mutate(sumintercept = sum(intercepts),
         relcov = intercepts/sumintercept)
```

```{r Creating CTI table}
swan_CTI <- left_join(swan_data_rel, swan_species_clim, by = "species.name") 
swan_CTI <- left_join(swan_CTI, swan_rumex_clim, by = "species.name") %>%
  mutate(meant = coalesce(meant.x, meant.y),
         meanp = coalesce(meanp.x, meanp.y),
         meanT = coalesce(meanT.x, meanT.y),) %>% 
        select(-meant.x, -meant.y, -meanp.x, -meanp.y, -meanT.x, -meanT.y)
swan_CTI <- left_join(swan_CTI, swan_bromus_clim, by = "species.name") %>%
  mutate(meant = coalesce(meant.x, meant.y),
         meanp = coalesce(meanp.x, meanp.y),
         meanT = coalesce(meanT.x, meanT.y),) %>% 
        select(-meant.x, -meant.y, -meanp.x, -meanp.y, -meanT.x, -meanT.y)

view(swan_CTI %>%
       filter(year == 2010))

swan_CTI <- swan_CTI %>%
  mutate(relTI = relcov*meanT,
         relP = relcov*meanp) %>%
  remove_missing() %>%
  group_by(year, rep) %>%
  summarise(CTI = sum(relTI, rm.na = TRUE),
            CPI = sum(relP, rm.na = TRUE))

swan_CTI_means <- swan_CTI %>%
  group_by(year) %>%
  summarise(meanCTI = mean(CTI),
            seCTI = std.error(CTI),
            meanCPI = mean(CPI),
            seCPI = std.error(CPI))

ggplot(swan_CTI_means, aes(x=year, y=meanCTI)) +
  geom_point() +
  geom_errorbar(aes(ymin = meanCTI-seCTI, ymax = meanCTI+seCTI), width=0.2)

ggplot(swan_CTI_means, aes(x=year, y=meanCPI)) +
  geom_point() +
  geom_errorbar(aes(ymin = meanCPI-seCPI, ymax = meanCPI+seCPI), width=0.2)


```



### Saving CTI .csv

```{r CTI csv}

swan_CTI <- swan_CTI %>%
  rename(plot = rep) %>%
  mutate(Site = "Swanton")
write.csv(swan_CTI, "Swanton_CTI.csv")

```
