---
title: "McLAnn Analysis"
author: "Josie Lesage"
date: "12/13/2019"
output: html_document
---

# Setup and data import
```{r setup, include=FALSE}
## community analysis
library(codyn)
library(MASS)
library(vegan)
library(lme4)

## CTI analysis
library(CoordinateCleaner)
library(countrycode)
library(mapr)
library(maptools)
library(raster)
library(rgbif)
library(scrubr)
library(sp)
library(spocc)

## misc/both/other
library(oz)
library(plotrix)
library(tidyverse)
```


```{r data import, include = FALSE}
McLAnn_data <- read.csv("mclann_data.csv") %>%
 rename(species.name = Species_Name) %>%
    mutate(species.name = fct_recode(species.name, 
                                     'Cerastium fontanum ssp. vulgare' = 'Cerastium vulgare',
                                     'Astragalus gambellianus' = 'Astragalus gambelianus',
                                     'Melilotus indicus' = 'Melilotus indica'))
```

The goal for this project is to successfully download species occurance location data from GBIF for the species in the Swanton plots, and to associate this location data with climate data from the WorldClim database. Additionally, I hope to do any cleaning that's needed between these steps before I can generate a community temperature index for the site over time.


## Preparing a species list table
In order to get the appropriate data from gbif, we need to generate a table of species/genus information that we can reference and call from.

```{r species table}
McLAnn_species <- unique(McLAnn_data$species.name)
McLAnn_list <- as.data.frame(McLAnn_species)
```

There are a total of ~200 species in the Elkhorn dataset.  


```{r fixing species table}
McLAnn_data <- McLAnn_data %>%
  filter(species.name != "Bare",
         species.name != "Rock",
         species.name != "Unknown grass",
         species.name != "Unknown forb")

McLAnn_species <- unique(McLAnn_data$species.name)
McLAnn_list <- as.data.frame(McLAnn_species)
McLAnn_list$McLAnn_species <- paste0("'", McLAnn_list$McLAnn_species, "',")
  
cat(format_delim(McLAnn_list, delim = ""))

McLAnn_byquad <- McLAnn_data %>%
  filter(Cover >= 0) %>%
  group_by(Site, Year, plot, species.name) %>%
  summarise(Cover = sum(Cover)) %>%
  ungroup() %>%
  group_by(plot, Year) %>%
  mutate(sumcov = sum(Cover),
         relcov = Cover/sumcov)

```

**Note:** there are instances of "Species sp." in the dataset. I am not sure if I should remove this one hit, or leave it be. 

# Community Poisson GLM

**Look at chapter 14 of the Mixed Models book.**

Before running our analysis, we should check the means and variance for the response variable over different predictor variables. 

```{r Rich explore}
McLAnn_rich_means <- McLAnn_byquad %>%
  group_by(Year, plot) %>%
  filter(Cover > 0) %>%
  summarise(rich = n_distinct(species.name)) %>%
  ungroup() %>% group_by(Year) %>%
  summarise(meanrich = mean(rich),
            serich = (std.error(rich)))

McLAnn_rich <- McLAnn_data %>%
  group_by(Year, plot, Quadrat) %>%
  summarise(rich = n_distinct(species.name))

ggplot(McLAnn_rich_means, aes(x = Year, y = meanrich)) +
  geom_line() 

ggplot(McLAnn_rich, aes(x = Year, y = rich)) +
  geom_point() 

```


# Community turnover - annual +/-
To answer who joins and who leaves each year, we need to calculate the species in the starting year, then see how many are added and how many leave. We'll do this with Lauren Hallet's (hopefully awesome) codyn package - which has a function for turnover.

```{r turnover metrics}
McLAnn_turnover <- turnover(df = McLAnn_byquad,
                          time.var = "Year",
                          species.var = "species.name",
                          abundance.var = "relcov",
                          replicate.var = "plot")

McLAnn_turn_means <- McLAnn_turnover %>%
  group_by(Year) %>%
  summarise(meanturn = mean(total),
            seturn = std.error(total))

ggplot(McLAnn_turn_means, aes(x = Year, y = meanturn)) +
  geom_point() +
  geom_errorbar(aes(ymin = meanturn-seturn, ymax = meanturn+seturn)) +
  labs(title = "McL Serp - Community Turnover (n = 38)",
       x = "Year",
       y = "Turnover (# spp. lost+gained / total # spp.)")

```


# Gathering & cleaning occurance data

We will gather species occurrance data from GBIF through the SpOcc package. 

```{r grabbing jasper gbif data, echo = FALSE, cache = TRUE, warning=FALSE}

## look at species list

McLAnn_genus_list <- c('Juncus sp.', 'Stephanomeria sp.', 'Minuartia sp.')

McLAnn_species_list <- c('Bromus hordeaceus', 
                         'Bromus madritensis',
                         'Castilleja densiflora',
                         'Erodium cicutarium',
                         'Holocarpha virgata',
                         'Medicago polymorpha',
                         'Nassella pulchra',
                         'Navarretia pubescens',
                         'Vulpia myuros',
                         'Cerastium glomeratum',
                         'Allium serra',
                         'Avena fatua',
                         'Bromus diandrus',
                         'Clarkia purpurea',
                         'Claytonia exigua',
                         'Collinsia heterophylla',
                         'Dodecatheon hendersonii',
                         'Geranium molle',
                         'Ranunculus occidentalis',
                         'Rigiopappus leptocladus',
                         'Senecio vulgaris',
                         'Triteleia laxa',
                         'Vulpia microstachys',
                         'Galium aparine',
                         'Centaurea solstitialis',
                         'Lupinus bicolor',
                         'Poa bulbosa',
                         'Taeniatherum caput-medusae',
                         'Trifolium hirtum',
                         'Bellardia trixago',
                         'Lolium multiflorum',
                         'Achyrachaena mollis',
                         'Hypochaeris glabra',
                         'Brodiaea elegans',
                         'Castilleja attenuata',
                         'Silene gallica',
                         'Capsella bursa-pastoris',
                         'Agoseris heterophylla',
                         'Epilobium brachycarpum',
                         'Gilia tricolor',
                         'Lotus humistratus',
                         'Micropus californicus',
                         'Plagiobothrys nothofulvus',
                         'Plantago erecta',
                         'Vicia villosa',
                         'Aira caryophyllea',
                         'Navarretia viscidula',
                         'Triphysaria eriantha',
                         'Navarretia tagetina',
                         'Centaurium trichanthum',
                         'Linanthus ciliatus',
                         'Minuartia californica',
                         'Polypogon monspeliensis',
                         'Euphorbia crenulata',
                         'Microseris douglasii',
                         'Trifolium gracilentum',
                         'Agoseris grandiflora',
                         'Chlorogalum pomeridianum',
                         'Hemizonia congesta',
                         'Trifolium bifidum',
                         'Dichelostemma capitatum',
                         'Linanthus bicolor',
                         'Torilis arvensis',
                         'Daucus pusillus',
                         'Sanicula bipinnatifida',
                         'Allophyllum gilioides',
                         'Trifolium microcephalum',
                         'Collinsia sparsiflora',
                         'Poa secunda',
                         'Trifolium microdon',
                         'Trifolium willdenovii',
                         'Madia gracilis',
                         'Achillea millefolium',
                         'Gastridium ventricosum',
                         'Plectritis ciliosa',
                         'Convolvulus arvensis',
                         'Galium murale',
                         'Lotus micranthus',
                         'Astragalus gambellianus',
                         'Calochortus luteus',
                         'Lotus wrangelianus',
                         'Trifolium albopurpureum',
                         'Calochortus superbus',
                         'Lactuca serriola',
                         'Sisyrinchium bellum',
                         'Lepidium nitidum',
                         'Sidalcea diploscypha',
                         'Trifolium depauperatum',
                         'Dactylis glomerata',
                         'Hesperevax sparsiflora',
                         'Filago gallica',
                         'Lomatium marginatum',
                         'Brassica nigra',
                         'Hordeum marinum',
                         'Anthriscus caucalis',
                         'Chamomilla suaveolens',
                         'Lathyrus vestitus',
                         'Sanicula crassicaulis',
                         'Melilotus indicus',
                         'Trifolium dubium',
                         'Aphanes occidentalis',
                         'Wyethia glabra',
                         'Amsinckia menziesii',
                         'Athysanus pusillus',
                         'Cirsium vulgare',
                         'Sisymbrium officinale',
                         'Trifolium obtusiflorum',
                         'Madia exigua',
                         'Centaurea melitensis',
                         'Eremocarpus setigerus',
                         'Velezia rigida',
                         'Petrorhagia prolifera',
                         'Nemophila menziesii',
                         'Lupinus microcarpus',
                         'Trifolium fucatum',
                         'Lomatium utriculatum',
                         'Zigadenus fremontii',
                         'Castilleja exserta',
                         'Delphinium variegatum',
                         'Elymus elymoides',
                         'Lupinus succulentus',
                         'Stellaria nitens',
                         'Lasthenia californica',
                         'Madia elegans',
                         'Atriplex triangularis',
                         'Delphinium hesperium',
                         'Thysanocarpus curvipes',
                         'Phacelia imbricata',
                         'Carduus pycnocephalus',
                         'Astragalus breweri',
                         'Eschscholzia californica',
                         'Hieracium albiflorum',
                         'Briza minor',
                         'Minuartia douglasii',
                         'Cynosurus echinatus',
                         'Grindelia camporum',
                         'Anagallis arvensis',
                         'Lithophragma heterophyllum',
                         'Calandrinia ciliata',
                         'Geranium dissectum',
                         'Erodium brachycarpum',
                         'Sagina apetala',
                         'Phlox gracilis',
                         'Ranunculus californicus',
                         'Torilis nodosa',
                         'Erodium botrys',
                         'Layia platyglossa',
                         'Cryptantha hispidula',
                         'Sanicula bipinnata',
                         'Melica californica',
                         'Camissonia graciliflora',
                         'Perideridia kelloggii',
                         'Aegilops triuncialis',
                         'Claytonia parviflora',
                         'Nemophila heterophylla',
                         'Rumex crispus',
                         'Cardamine oligosperma',
                         'Phalaris paradoxa',
                         'Galium porrigens',
                         'Mimulus douglasii',
                         'Crassula connata',
                         'Astragalus rattanii var. jepsonianus',
                         'Pectocarya pusilla',
                         'Elytrigia repens',
                         'Uropappus lindleyi',
                         'Chorizanthe membranacea',
                         'Navarretia jepsonii',
                         'Castilleja rubicundula',
                         'Githopsis specularioides',
                         'Hordeum murinum',
                         'Bromus tectorum',
                         'Poa annua',
                         'Bromus laevipes',
                         'Lupinus albifrons',
                         'Trifolium ciliolatum',
                         'Holodiscus discolor',
                         'Quercus durata',
                         'Hypochaeris radicata',
                         'Stellaria media',
                         'Helianthus exilis',
                         'Quercus douglasii',
                         'Ancistrocarphus filagineus',
                         'Quercus lobata',
                         'Salvia columbariae',
                         'Eriophyllum lanatum',
                         'Elymus glaucus',
                         'Juncus bufonius',
                         'Cuscuta californica',
                         'Vulpia bromoides',
                         'Cerastium fontanum ssp. vulgare',
                         'Tragopogon dubius',
                         'Cercocarpus betuloides',
                         'Lomatium dasycarpum',
                         'Gnaphalium californicum',
                         'Allium amplectens',
                         'Nassella lepida',
                         'Lonicera hispidula',
                         'Nemophila pedunculata',
                         'Trifolium variegatum',
                         'Allium fimbriatum')

McLAnn_species_data <- occ(query = McLAnn_species_list, from = "gbif", has_coords = TRUE, limit = 10000,
                gbifopts = list(hasGeospatialIssue = FALSE, country = "US",
                                stateProvince = "California"))

```

We need to clean the coordinates, as it appears some are in the ocean (look @ NorCal), and there might be some that are just incorrect. To do this, we will use a coordinate cleaner package.

```{r cleaning McLAnn coords, echo=FALSE, cache = TRUE, dependson="grabbing jasper gbif data"}

## we can also replace all synonym taxon names with one (cuts down the number of plotted dot colors)
McLAnn_species_data <- fixnames(McLAnn_species_data, how = "query")

## The occ2df function should convert the data to a dataframe format
McLAnn_species_data_df <- occ2df(McLAnn_species_data)

map_ggplot(McLAnn_species_data, map = "state", size = 0.5) 

## flag potentially incorrect data
flags <- clean_coordinates(x = McLAnn_species_data_df, lon = "longitude", lat = "latitude",
                          species = "name",
                          tests = c("capitals", "centroids", "equal","gbif", "institutions",
                                    "seas", "zeros")) # most test are on by default

plot(flags, lon = "longitude", lat = "latitude")

flag_df <- McLAnn_species_data_df[!flags$.summary,]
str(flag_df)
summary(flag_df)

# keep only the non-flagged data
McLAnn_species_data_df <- McLAnn_species_data_df[flags$.summary,]

```

It appears that there were flagged instances for most of the species. For this practice run-through, I'll definitely just cut them out without taking a closer look (for now).  
More guidance on cleaning datasets and removing bad coordinates is [available here](https://ropensci.github.io/CoordinateCleaner/articles/Tutorial_Cleaning_GBIF_data_with_CoordinateCleaner.html).  

# Adding climate data

Following the jcoliver webpage guides...

```{r map of geo extent, echo = FALSE}
max.lat <- ceiling(max(McLAnn_species_data_df$latitude))
min.lat <- floor(min(McLAnn_species_data_df$latitude))
max.lon <- ceiling(max(McLAnn_species_data_df$longitude))
min.lon <- floor(min(McLAnn_species_data_df$longitude))
geographic.extent <- extent(x = c(min.lon, max.lon, min.lat, max.lat))

# Load the data to use for our base map
data(wrld_simpl)

# Plot the base map
plot(wrld_simpl, 
     xlim = c(min.lon, max.lon),
     ylim = c(min.lat, max.lat),
     axes = TRUE, 
     col = "grey95")

# Add the points for individual observation
points(x = ucsc_species_data_df$longitude, 
       y = ucsc_species_data_df$latitude, 
       col = "olivedrab", 
       pch = 20, 
       cex = 0.75)
# And draw a little box around the graph
box()
```

```{r based on oikos page, cache = TRUE}
xy <- McLAnn_species_data_df[,c("longitude","latitude")]
sp_xy <- McLAnn_species_data_df[c("name", "longitude","latitude")]

sp_xy <- sp_xy %>%
  rename(species = name)


env <- getData('worldclim', var='bio', res=2.5)

plot(env, 1, main=NULL, axes=FALSE)
points(xy, col='blue', pch=20)

xy_bio <- raster::extract(env, xy)

```

Reference list for climate variables:
 * BIO1 = Annual Mean Temperature (°C * 10) -- (i.e. 231 represents 23.1 °C)
 * BIO2 = Mean Diurnal Range (Mean of monthly (max temp – min temp)) 
 * BIO3 = Isothermality (BIO2/BIO7) (* 100)
 * BIO4 = Temperature Seasonality (standard deviation *100)
 * BIO5 = Max Temperature of Warmest Month (°C * 10)
 * BIO6 = Min Temperature of Coldest Month (°C * 10)
 * BIO7 = Temperature Annual Range (BIO5-BIO6)
 * BIO8 = Mean Temperature of Wettest Quarter (°C * 10)
 * BIO9 = Mean Temperature of Driest Quarter (°C * 10)
 * BIO10 = Mean Temperature of Warmest Quarter (°C * 10)
 * BIO11 = Mean Temperature of Coldest Quarter (°C * 10)
 * BIO12 = Annual Precipitation (mm)
 * BIO13 = Precipitation of Wettest Month (mm)
 * BIO14 = Precipitation of Driest Month (mm)
 * BIO15 = Precipitation Seasonality (Coeficent of Variation) 
 * BIO16 = Precipitation of Wettest Quarter (mm)
 * BIO17 = Precipitation of Driest Quarter (mm)
 * BIO18 = Precipitation of Warmest Quarter (mm)
 * BIO19 = Precipitation of Coldest Quarter (mm)
 
```{r mean species temp, echo=FALSE}
McLAnn_species_clim <- cbind(xy_bio, sp_xy)

McLAnn_species_clim <- McLAnn_species_clim %>%
  group_by(species) %>%
  summarise(meant = mean(bio1, na.rm = TRUE),
         meanp = mean(bio12, na.rm = TRUE)) %>%
  mutate(meanT = meant/10) %>%
  rename(species.name = species)
```

### Juncus
```{r McLAnn Juncus}
McLAnn_juncus <- c('Juncus balticus',
                   'Juncus bufonius',
                   'Juncus oxymeris',
                   'Juncus phaeocephalus',
                   'Juncus occidentalis')

McLAnn_juncus_data <- occ(query = McLAnn_juncus, from = "gbif", has_coords = TRUE, limit = 10000,
                gbifopts = list(hasGeospatialIssue = FALSE, country = "US",
                                stateProvince = "California"))

## we can also replace all synonym taxon names with one (cuts down the number of plotted dot colors)
## we should use the scrubr version of the function in the future
McLAnn_juncus_data <- fixnames(McLAnn_juncus_data, how = "query")

## The occ2df function should convert the data to a dataframe format
McLAnn_juncus_data_df <- occ2df(McLAnn_juncus_data)

map_ggplot(McLAnn_juncus_data, map = "state", size = 0.5) 

flags <- clean_coordinates(x = McLAnn_juncus_data_df, lon = "longitude", lat = "latitude",
                          species = "name",
                          tests = c("capitals", "centroids", "equal","gbif", "institutions",
                                    "seas", "zeros")) # most test are on by default

# remove flagged records
McLAnn_juncus_data_df <- McLAnn_juncus_data_df[flags$.summary,]

# extract lat/long for each datapoint
xy <- McLAnn_juncus_data_df[,c("longitude","latitude")]
sp_xy <- McLAnn_juncus_data_df[c("name", "longitude","latitude")]
sp_xy <- sp_xy %>%
  rename(species = name)
env <- getData('worldclim', var='bio', res=2.5)
plot(env, 1, main=NULL, axes=FALSE)
points(xy, col='blue', pch=20)
xy_bio <- raster::extract(env, xy)
McLAnn_juncus_clim <- cbind(xy_bio, sp_xy)

# change all datapoints to the "species sp" format that's used in the og dataframe, calc CTI
McLAnn_juncus_clim <- McLAnn_juncus_clim %>%
  mutate(species.name = "Juncus sp.") %>%
   group_by(species.name) %>%
   summarise(meant = mean(bio1, na.rm = TRUE),
         meanp = mean(bio12, na.rm = TRUE)) %>%
  mutate(meanT = meant/10) 
```
### Stephanomeria
```{r McLAnn Juncus}
McLAnn_Stephanomeria <- c('Stephanomeria virgata')

McLAnn_Stephanomeria_data <- occ(query = McLAnn_Stephanomeria, from = "gbif", has_coords = TRUE, limit = 10000,
                gbifopts = list(hasGeospatialIssue = FALSE, country = "US",
                                stateProvince = "California"))

## we can also replace all synonym taxon names with one (cuts down the number of plotted dot colors)
## we should use the scrubr version of the function in the future
McLAnn_Stephanomeria_data <- fixnames(McLAnn_Stephanomeria_data, how = "query")

## The occ2df function should convert the data to a dataframe format
McLAnn_Stephanomeria_data_df <- occ2df(McLAnn_Stephanomeria_data)

map_ggplot(McLAnn_Stephanomeria_data, map = "state", size = 0.5) 

flags <- clean_coordinates(x = McLAnn_Stephanomeria_data_df, lon = "longitude", lat = "latitude",
                          species = "name",
                          tests = c("capitals", "centroids", "equal","gbif", "institutions",
                                    "seas", "zeros")) # most test are on by default

# remove flagged records
McLAnn_Stephanomeria_data_df <- McLAnn_Stephanomeria_data_df[flags$.summary,]

# extract lat/long for each datapoint
xy <- McLAnn_Stephanomeria_data_df[,c("longitude","latitude")]
sp_xy <- McLAnn_Stephanomeria_data_df[c("name", "longitude","latitude")]
sp_xy <- sp_xy %>%
  rename(species = name)
env <- getData('worldclim', var='bio', res=2.5)
plot(env, 1, main=NULL, axes=FALSE)
points(xy, col='blue', pch=20)
xy_bio <- raster::extract(env, xy)
McLAnn_Stephanomeria_clim <- cbind(xy_bio, sp_xy)

# change all datapoints to the "species sp" format that's used in the og dataframe, calc CTI
McLAnn_Stephanomeria_clim <- McLAnn_Stephanomeria_clim %>%
  mutate(species.name = "Stephanomeria sp.") %>%
   group_by(species.name) %>%
   summarise(meant = mean(bio1, na.rm = TRUE),
         meanp = mean(bio12, na.rm = TRUE)) %>%
  mutate(meanT = meant/10) 
```
### Minuartia
```{r McLAnn Minuartia}
McLAnn_Minuartia <- c('Minuartia californica',
                          'Minuartia douglasii')

McLAnn_Minuartia_data <- occ(query = McLAnn_Minuartia, from = "gbif", has_coords = TRUE, limit = 10000,
                gbifopts = list(hasGeospatialIssue = FALSE, country = "US",
                                stateProvince = "California"))

## we can also replace all synonym taxon names with one (cuts down the number of plotted dot colors)
## we should use the scrubr version of the function in the future
McLAnn_Minuartia_data <- fixnames(McLAnn_Minuartia_data, how = "query")

## The occ2df function should convert the data to a dataframe format
McLAnn_Minuartia_data_df <- occ2df(McLAnn_Minuartia_data)

map_ggplot(McLAnn_Minuartia_data, map = "state", size = 0.5) 

flags <- clean_coordinates(x = McLAnn_Minuartia_data_df, lon = "longitude", lat = "latitude",
                          species = "name",
                          tests = c("capitals", "centroids", "equal","gbif", "institutions",
                                    "seas", "zeros")) # most test are on by default

# remove flagged records
McLAnn_Minuartia_data_df <- McLAnn_Minuartia_data_df[flags$.summary,]

# extract lat/long for each datapoint
xy <- McLAnn_Minuartia_data_df[,c("longitude","latitude")]
sp_xy <- McLAnn_Minuartia_data_df[c("name", "longitude","latitude")]
sp_xy <- sp_xy %>%
  rename(species = name)
env <- getData('worldclim', var='bio', res=2.5)
plot(env, 1, main=NULL, axes=FALSE)
points(xy, col='blue', pch=20)
xy_bio <- raster::extract(env, xy)
McLAnn_Minuartia_clim <- cbind(xy_bio, sp_xy)

# change all datapoints to the "species sp" format that's used in the og dataframe, calc CTI
McLAnn_Minuartia_clim <- McLAnn_Minuartia_clim %>%
  mutate(species.name = "Minuartia sp.") %>%
   group_by(species.name) %>%
   summarise(meant = mean(bio1, na.rm = TRUE),
         meanp = mean(bio12, na.rm = TRUE)) %>%
  mutate(meanT = meant/10) 
```
 

# Calculating CTI
To calculate CTI, we need to summarize the weight of each species in a community and multiply that by the TI for that species. 

```{r relative cover of each spp, cache = TRUE}
McLAnn_byq <- McLAnn_data %>%
  filter(Year > 2005) %>%
  select(Year, plot, Quadrat, species.name, Cover) %>%
  remove_missing() %>%
  group_by(plot, Quadrat, Year) %>%
  mutate(sumcov = sum(Cover), 
         relcov = Cover/sumcov)
```


```{r Creating CTI table}
McLAnn_CTI <- left_join(McLAnn_byquad, McLAnn_species_clim, by = "species.name") 
McLAnn_CTI <- left_join(McLAnn_CTI, McLAnn_Stephanomeria_clim, by = "species.name") %>%
  mutate(meant = coalesce(meant.x, meant.y),
         meanp = coalesce(meanp.x, meanp.y),
         meanT = coalesce(meanT.x, meanT.y),) %>% 
        select(-meant.x, -meant.y, -meanp.x, -meanp.y, -meanT.x, -meanT.y)
McLAnn_CTI <- left_join(McLAnn_CTI, McLAnn_Minuartia_clim, by = "species.name") %>%
  mutate(meant = coalesce(meant.x, meant.y),
         meanp = coalesce(meanp.x, meanp.y),
         meanT = coalesce(meanT.x, meanT.y),) %>% 
        select(-meant.x, -meant.y, -meanp.x, -meanp.y, -meanT.x, -meanT.y)
McLAnn_CTI <- left_join(McLAnn_CTI, McLAnn_juncus_clim, by = "species.name") %>%
  mutate(meant = coalesce(meant.x, meant.y),
         meanp = coalesce(meanp.x, meanp.y),
         meanT = coalesce(meanT.x, meanT.y),) %>% 
        select(-meant.x, -meant.y, -meanp.x, -meanp.y, -meanT.x, -meanT.y)


McLAnn_CTI <- McLAnn_CTI %>%
  mutate(relTI = relcov*meanT,
         relP = relcov*meanp) %>%
  group_by(Year, plot) %>%
  summarise(CTI = sum(relTI, rm.na = TRUE),
            CPI = sum(relP, rm.na = TRUE))

McLAnn_CTI_means <- McLAnn_CTI %>%
  group_by(Year) %>%
  summarise(meanCTI = mean(CTI),
            seCTI = std.error(CTI),
            meanCPI = mean(CPI),
            seCPI = std.error(CPI))

ggplot(McLAnn_CTI_means, aes(x=Year, y=meanCTI)) +
  geom_point() +
  geom_errorbar(aes(ymin = meanCTI-seCTI, ymax = meanCTI+seCTI), width=0.2)

ggplot(McLAnn_CTI_means, aes(x=Year, y=meanCPI)) +
  geom_point() +
  geom_errorbar(aes(ymin = meanCPI-seCPI, ymax = meanCPI+seCPI), width=0.2)


```


### Saving CTI .csv

```{r CTI csv}

McLAnn_CTI <- McLAnn_CTI %>%
  rename(year = Year) %>%
  mutate(Site = "McL Ann")
write.csv(McLAnn_CTI, "McLAnn_CTI.csv")

```