---
title: "Climate and CTI Analysis"
author: "Josie Lesage"
date: "1/17/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = '../') 

## analysis
library(codyn)
library(MASS)
library(lme4)
library(nlme)


## misc/both/other
library(oz)
library(plotrix)
library(tidyverse)
library(gridExtra)

# show lots of digits
options(scipen=4)

# to rip legends out of figures
g_legend <- function(a.gplot){ 
    tmp <- ggplot_gtable(ggplot_build(a.gplot)) 
    leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box") 
    legend <- tmp$grobs[[leg]] 
    legend
} 

# converts the year into the water year based on month
wtr_yr <- function(dates, start_month=10) {
  # Convert dates into POSIXlt
  dates.posix = as.POSIXlt(dates)
  # Year offset
  offset = ifelse(dates.posix$mon >= start_month - 1, 1, 0)
  # Water year
  adj.year = dates.posix$year + 1900 + offset
  # Return the water year
  adj.year
}

```

```{r data import, echo = FALSE, message = FALSE, warning = FALSE}
climate_site_wtryr <- read.csv("Analysis/ClimData/PRISM_wtryr_alldata.csv") %>%
  rename("year" = "wateryear")

all.CTI <- read.csv("Analysis/CTI Data/AllSites_CTI.csv") %>%
  dplyr::select(-X) %>%
  mutate(site = factor(site, levels=c("Angelo", "Carrizo", "Elkhorn", "Jasper", "McL Ann", "McL Serp", "Swanton", "UCSC"))) %>%
  group_by(site, year) %>%
  summarise(meanCTI = mean(plotCTI),
            seCTI = std.error(plotCTI),
            meanCPI = mean(plotCPI),
            seCPI = std.error(plotCPI))
  
all.CTI.wtryr <- left_join(all.CTI, climate_site_wtryr, by = c("year", "site"))

```
# INTRODUCTION

These data were downloaded in another markdown file ("PRISM.rmd"). They represent the interpolated climate data at all sites for which I have community composition datasets.  

To begin, we can take a look at the monthly precipitation at each site, and compare their annual min and max temps.

```{r avg temp}
avg.temp <- all.CTI.wtryr %>%
  group_by(site) %>%
  summarize(avgtmin = mean(mean_minT),
            avgtmean = mean(mean_meanT))
```


```{r plots, echo = FALSE}
ggplot(all.CTI.wtryr, aes(x = site, y = mean_meanT)) +
  geom_boxplot()  +
  labs(x = "site",
       y = "mean temp, 1982-2019",
       title = "Mean monthly temps at all sites") +
  geom_jitter(aes(x = site, y = mean_maxT), color = "red") +
  geom_jitter(aes(x = site, y = mean_minT), color = "blue") +
  labs(x = "site",
       y = "annual min (blue), max (red), and mean (boxplots) temps",
       title = "Comparison of temps at all sites")
```

Things look good - the warmest sites look warmest, and the wettest look wettest. The rain appears to be falling when logic says it would. The extra points on Carrizo and McL are due to the number of plots - this isn't summarized by plots yet.  
We're also interested in seeing how climate may or may not have changed over time - so we will generate annual summaries.  


# ANALYSIS
In order to have legs to stand on, we must take a look at the weather history at these sites - this means determining whether there have been directional trends in temperature or precipitation over time.  

One thing to note is that we should only look at the data over the years in which we have community composition data.  


## Precipitation Analysis
First, let's take a look at the change in precipitation over time, since I think that is less likely to be significant for our focal years. Then, we'll look at our temp. data.  

### Water year precipitation

```{r water year precip models}
# angelo
summary(lm(total_precip ~ year,
                    data = all.CTI.wtryr[all.CTI.wtryr$site == "Angelo",]))

# carrizo
summary(lm(total_precip ~ year,
                    data = all.CTI.wtryr[all.CTI.wtryr$site == "Carrizo",]))

# elkhorn
summary(lm(total_precip ~ year,
                    data = all.CTI.wtryr[all.CTI.wtryr$site == "Elkhorn",]))

# jasper
summary(lm(total_precip ~ year,
                    data = all.CTI.wtryr[all.CTI.wtryr$site == "Jasper",]))

# mcL ann
summary(lm(total_precip ~ year,
                    data = all.CTI.wtryr[all.CTI.wtryr$site == "McL Ann",]))

# mcL serp
summary(lm(total_precip ~ year,
                    data = all.CTI.wtryr[all.CTI.wtryr$site == "McL Serp",]))

# swanton
summary(lm(total_precip ~ year,
                    data = all.CTI.wtryr[all.CTI.wtryr$site == "Swanton",]))

# ucsc
summary(lm(total_precip ~ year,
                    data = all.CTI.wtryr[all.CTI.wtryr$site == "UCSC",]))

ggplot(all.CTI.wtryr, aes(x = year, y = total_precip, color = site)) + 
  geom_line() +
  facet_wrap(~site, ncol = 4, scales = "free")

```

### Winter Precipitation
So, there's pretty clearly no change in overall annual precip. However, never one to give up, I'll also check the wintertime precip (which Dr. Harrison has found is important in her models).

```{r winter precip models}
# angelo
summary(lm(win_precip ~ year,
                    data = all.CTI.wtryr[all.CTI.wtryr$site == "Angelo",]))

# carrizo
summary(lm(win_precip ~ year,
                    data = all.CTI.wtryr[all.CTI.wtryr$site == "Carrizo",]))

# elkhorn
summary(lm(win_precip ~ year,
                    data = all.CTI.wtryr[all.CTI.wtryr$site == "Elkhorn",]))

# jasper
summary(lm(win_precip ~ year,
                    data = all.CTI.wtryr[all.CTI.wtryr$site == "Jasper",]))

# mcL ann
summary(lm(win_precip ~ year,
                    data = all.CTI.wtryr[all.CTI.wtryr$site == "McL Ann",]))

# mcL serp
summary(lm(win_precip ~ year,
                    data = all.CTI.wtryr[all.CTI.wtryr$site == "McL Serp",]))

# swanton
summary(lm(win_precip ~ year,
                    data = all.CTI.wtryr[all.CTI.wtryr$site == "Swanton",]))

# ucsc
summary(lm(win_precip ~ year,
                    data = all.CTI.wtryr[all.CTI.wtryr$site == "UCSC",]))

ggplot(all.CTI.wtryr, aes(x = year, y = win_precip)) +
  geom_bar(stat = "identity") +
  facet_grid(~site, scales = "free")

```

```{r winter ppt graphs, echo = FALSE}
ggplot(win.ppt, aes(x = year, y = precip, color = site)) +
  geom_point(shape = 3) +
  geom_line() +
  labs(x = "Year",
       y = "Precip (mm)",
       title = "Winter precip at all sites") +
  theme_bw() +
  theme(legend.position = "none",
        strip.background = element_blank(),
        strip.text = element_blank()) +
  facet_wrap(~site, scales = "free", nrow = 2)
```

# Temperature

# Vapor Pressure Deficit
```{r annual minimum VPD models}
# angelo
summary(lm(mean_vpdmin ~ year,
                    data = all.CTI.wtryr[all.CTI.wtryr$site == "Angelo",]))

# carrizo
summary(lm(mean_vpdmin ~ year,
                    data = all.CTI.wtryr[all.CTI.wtryr$site == "Carrizo",]))

# elkhorn
summary(lm(mean_vpdmin ~ year,
                    data = all.CTI.wtryr[all.CTI.wtryr$site == "Elkhorn",]))

# jasper
summary(lm(mean_vpdmin ~ year,
                    data = all.CTI.wtryr[all.CTI.wtryr$site == "Jasper",]))

# mcL ann
summary(lm(mean_vpdmin ~ year,
                    data = all.CTI.wtryr[all.CTI.wtryr$site == "McL Ann",]))

# mcL serp
summary(lm(mean_vpdmin ~ year,
                    data = all.CTI.wtryr[all.CTI.wtryr$site == "McL Serp",]))

# swanton
summary(lm(mean_vpdmin ~ year,
                    data = all.CTI.wtryr[all.CTI.wtryr$site == "Swanton",]))

# ucsc
summary(lm(mean_vpdmin ~ year,
                    data = all.CTI.wtryr[all.CTI.wtryr$site == "UCSC",]))

ggplot(all.CTI.wtryr, aes(x = year, y = win_precip)) +
  geom_bar(stat = "identity") +
  facet_grid(~site, scales = "free")

```

```{r growing season minimum VPD models}
# angelo
summary(lm(grow_vpdmin ~ year,
                    data = all.CTI.wtryr[all.CTI.wtryr$site == "Angelo",]))

# carrizo
summary(lm(grow_vpdmin ~ year,
                    data = all.CTI.wtryr[all.CTI.wtryr$site == "Carrizo",]))

# elkhorn
summary(lm(grow_vpdmin ~ year,
                    data = all.CTI.wtryr[all.CTI.wtryr$site == "Elkhorn",]))

# jasper
summary(lm(grow_vpdmin ~ year,
                    data = all.CTI.wtryr[all.CTI.wtryr$site == "Jasper",]))

# mcL ann
summary(lm(grow_vpdmin ~ year,
                    data = all.CTI.wtryr[all.CTI.wtryr$site == "McL Ann",]))

# mcL serp
summary(lm(grow_vpdmin ~ year,
                    data = all.CTI.wtryr[all.CTI.wtryr$site == "McL Serp",]))

# swanton
summary(lm(grow_vpdmin ~ year,
                    data = all.CTI.wtryr[all.CTI.wtryr$site == "Swanton",]))

# ucsc
summary(lm(grow_vpdmin ~ year,
                    data = all.CTI.wtryr[all.CTI.wtryr$site == "UCSC",]))

ggplot(all.CTI.wtryr, aes(x = year, y = grow_vpdmin, color = site)) +
  geom_point() +
  geom_line() +
  facet_grid(~site, scales = "free")

```



## Lab meeting plots

```{r lab graphs}
## creating significance df
wytmin <- wytmin %>%
  dplyr::select(site, year, precip, mean_minT) %>%
  gather("total_precip":"mean_minT", key = "var", value = "value")

#graph
ggplot(wytmin) +
  geom_point(aes(x = year, y = value, color = site), shape = 3) +
  geom_line(aes(x = year, y = value, color = site, linetype = sig)) +
  labs(x = "Year") +
  theme_bw() +
  theme(legend.position = "left",
        strip.background = element_blank(),
        axis.text.x = element_text(hjust = 1, vjust = 1, angle = 45)) +
  scale_linetype_manual(values=c("dashed", "dotted", "solid")) +
  facet_wrap(site~var, scales = "free", nrow = 2)
```

```{r graph}
graphs.df <- all.CTI.wtryr %>%
  group_by(year, site) %>%
  summarize(tmin = mean(mean_minT),
            wintmin = mean(win_minT),
            tmean = mean(mean_meanT),
            precip = mean(total_precip),
            winprecip = mean(win_precip),
            vpd_min = mean(mean_vpdmin),
            vpd_grow = mean(grow_vpdmin))

ggplot(graphs.df, aes(color = site)) + 
  geom_line(aes(x = year, y = tmean)) +
  geom_point(aes(x = year, y = tmean), color = "black") +
  geom_line(aes(x = year, y = tmin), linetype = 2) +
  geom_point(aes(x = year, y = tmin), color = "black") +
  geom_line(aes(x = year, y = wintmin), linetype = 3) +
  geom_point(aes(x = year, y = wintmin), color = "black") +
  geom_bar(aes(x = year, y = precip/200, fill = site, color = site, alpha = 0.01), stat = "identity") +
  labs(x = "Year",
       title = "Temp (mean, min, and winter min) and precip over time") +
  theme_bw() +
  theme(legend.position = "none") +
  scale_y_continuous(name = "Mean (solid), min. (dash), and winter min. (dot) annual temperature (°C)", 
                     sec.axis = sec_axis(~.*200, name = "Annual precipitation (mm)")) +
  facet_wrap(~site, ncol = 4, scales = "free")


ggplot(graphs.df, aes(color = site)) + 
  geom_line(aes(x = year, y = vpd_min), linetype = "solid", color = "black") +
  geom_point(aes(x = year, y = vpd_min), color = "black") +
  geom_line(aes(x = year, y = vpd_grow), linetype = "solid", color = "black") +
  geom_point(aes(x = year, y = vpd_grow), color = "black") +
  geom_bar(aes(x = year, y = winprecip/200, fill = site, color = site, alpha = 0.01), stat = "identity") +
  labs(x = "Year",
       title = "Mean minimum annual and growing season vapor pressure deficit") +
  theme_bw() +
  theme(legend.position = "none") +
  scale_y_continuous(name = "Vapor Pressure Deficit", 
                     sec.axis = sec_axis(~.*200, name = "Winter precipitation (mm)")) +
  facet_wrap(~site, ncol = 4, scales = "free")


graphs.df <- left_join(all.CTI.wtryr, tminforgraph) %>%
  group_by(site) %>%
  summarize(tmin = mean(tmin),
            wintmin = mean(wintmin),
            tmean = mean(tmean),
            precip = mean(precip))

ggplot(graphs.df, aes(color = site)) + 
  geom_line(aes(x = site, y = tmean)) +
  geom_point(aes(x = site, y = tmean), color = "black") +
  labs(x = "Year",
       title = "Temp (mean, min, and winter min) and precip over time") +
  theme_bw() +
  theme(legend.position = "none") +
  scale_y_continuous(name = "Mean (solid), mini (dash), and winter min (dot) annual temperature (°C)", 
                     sec.axis = sec_axis(~.*200, name = "Annual precipitation (mm)")) +
  facet_wrap(~site, ncol = 4, scales = "free")

```


```{r mean temp, precip per site}
means.all.CTI.wtryr <- all.CTI.wtryr %>%
  group_by(site) %>%
  summarize(precip = mean(precip),
            tmean = mean(tmean))
```

