---
title: "Grabbing CTI Data from GBIF"
author: "Josie Lesage"
date: "07/08/2020"
output: html_document
---

# Setup and data import
```{r setup, include=FALSE}
## community analysis
library(codyn)
library(MASS)
library(vegan)
library(lme4)

## CTI analysis
library(CoordinateCleaner)
library(countrycode)
library(mapr)
library(maptools)
library(raster)
library(rgbif)
library(scrubr)
library(sp)
library(spocc)

## misc/both/other
library(oz)
library(plotrix)
library(tidyverse)
library(gridExtra)
```

```{r data import, include = FALSE}
rel_all <- read.csv("Analysis/ComData/AllData_Relative.csv") %>%
  dplyr::select(-X)
```

# File Goal

The goal of this file is to call on GBIF for the species occurrance data for each site. 

We will save each of these sets of data as an .rds file.

# Site-level data cleanup
## Angelo
### Preparing a species list table and importing data

```{r Angelo data and species list}
rel_ang <- rel_all %>%
  filter(site == "Angelo")
angelo_species <- unique(rel_ang$species.name)
angelo_species <- as.data.frame(angelo_species)
angelo_species$angelo_species <- paste0("'", angelo_species$angelo_species, "',")
cat(format_delim(angelo_species, delim = ""))
remove(angelo_species)
```

There are a total of ~36 species in the Angelo dataset.
**Note:** there is one species just labeled "Trifolium spp." in the dataset.

### Gathering & cleaning occurance data

We will gather species occurrance data from GBIF through the SpOcc package. 

#### Species with epithets
```{r grabbing Angelo gbif data, echo = FALSE, cache = TRUE, warning=FALSE}

## look at species list
ang_species_list <- c('Danthonia californica', 
                      'Bromus hordeaceus',
                      'Bromus tectorum',
                      'Bromus diandrus',
                      'Aira caryophyllea',
                      'Briza minor',
                      'Cynosurus echinatus',
                      'Vulpia myuros',
                      'Avena barbata',
                      'Dichelostemma capitatum',
                      'Brodiaea elegans',
                      'Eschscholzia californica',
                      'Sanicula bipinnatifida',
                      'Rumex acetosella',
                      'Convolvulus arvensis',
                      'Torilis arvensis',
                      'Daucus pusillus',
                      'Lotus micranthus',
                      'Lotus wrangelianus',
                      'Lupinus bicolor',
                      'Galium parisiense',
                      'Madia gracilis',
                      'Hypochaeris glabra',
                      'Castilleja attenuata',
                      'Aphanes occidentalis',
                      'Linanthus bicolor',
                      'Trichostema lanceolatum',
                      'Eremocarpus setigerus',
                      'Geranium dissectum',
                      'Epilobium brachycarpum',
                      'Clarkia purpurea',
                      'Plagiobothrys nothofulvus',
                      'Cerastium glomeratum',
                      'Erodium cicutarium',
                      'Hemizonia congesta')

ang_species_data <- occ(query = ang_species_list, from = "gbif", has_coords = TRUE, limit = 15000,
                gbifopts = list(hasGeospatialIssue = FALSE, country = "US",
                                stateProvince = "California"))
```

```{r clean ang species data}
## we can also replace all synonym taxon names with one (cuts down the number of plotted dot colors)
## we should use the scrubr version of the function in the future
ang_species_data <- fixnames(ang_species_data, how = "query")

## The occ2df function should convert the data to a dataframe format
ang_species_data_df <- occ2df(ang_species_data)

# we can take a look at where all of the records were found
map_ggplot(ang_species_data, map = "state", size = 0.5) +
  coord_cartesian(xlim=c(-125, -115), ylim = c(32, 42))

# We need to clean the coordinates, as it appears some are in the ocean, and there might be some that are just incorrect. To do this, we will use a coordinate cleaner package.

flags <- clean_coordinates(x = ang_species_data_df, lon = "longitude", lat = "latitude",
                          species = "name",
                          tests = c("capitals", "centroids", "equal","gbif", "institutions",
                                    "seas", "zeros", "duplicates")) # most tests are on by default

# Most of our flagged coordinates are coastal/in the ocean. Therefore, we'll remove them from our database.
# keep only the non-flagged data
ang_species_data_df <- ang_species_data_df[flags$.summary,] %>%
  rename("species.name" = "name")

```

It appears that there were flagged instances for most of the species. 
More guidance on cleaning datasets and removing bad coordinates is [available here](https://ropensci.github.io/CoordinateCleaner/articles/Tutorial_Cleaning_GBIF_data_with_CoordinateCleaner.html).

#### Species without epithets

Because the trifolium found in the plots could reflect any number of species known from the site, we fill collect gbif data for all of these, and label it as "Trifolium"

```{r Angelo Trifolium query GBIF}
ang_trifolium <- c('Trifolium albopurpureum var. albopurpureum',
                    'Trifolium albopurpureum var. dichotomum',
                    'Trifolium barbigerum var. barbigerum',
                    'Trifolium bifidum var. decipiens',
                    'Trifolium cyathiferum',
                    'Trifolium dubium',
                    'Trifolium fucatum',
                    'Trifolium microdon',
                    'Trifolium microcephalum',
                    'Trifolium oliganthum',
                    'Trifolium repens',
                    'Trifolium subterraneum',
                    'Trifolium variegatum',
                    'Trifolium willdenovii')

ang_trifolium_data <- occ(query = ang_trifolium, from = "gbif", has_coords = TRUE, limit = 10000,
                gbifopts = list(hasGeospatialIssue = FALSE, country = "US",
                                stateProvince = "California"))
```

```{r clean ang trifolium data}
## we can also replace all synonym taxon names with one (cuts down the number of plotted dot colors)
## we should use the scrubr version of the function in the future
ang_trifolium_data <- fixnames(ang_trifolium_data, how = "query")

## The occ2df function should convert the data to a dataframe format
ang_trifolium_data_df <- occ2df(ang_trifolium_data)

flags <- clean_coordinates(x = ang_trifolium_data_df, lon = "longitude", lat = "latitude",
                          species = "name",
                          tests = c("capitals", "centroids", "equal","gbif", "institutions",
                                    "seas", "zeros", "duplicates")) # most test are on by default

# remove flagged records
ang_trifolium_data_df <- ang_trifolium_data_df[flags$.summary,]

# change all datapoints to the "species sp" format that's used in the og dataframe, calc CTI
ang_trifolium_data_df <- ang_trifolium_data_df %>%
  mutate(species.name = "Trifolium spp.")

```

#### Combine with and without epithet dataframes
```{r recombine ang with epithet with non-epithet data}
ang_species_data_df <- full_join(ang_species_data_df, ang_trifolium_data_df)

```



## Carrizo
### Preparing a species list table and importing data
```{r carrizo data and species list}
rel_car <- rel_all %>%
  filter(site == "Carrizo")
car_species <- unique(rel_car$species.name)
car_species <- as.data.frame(car_species)
car_species$car_species <- paste0("'", car_species$car_species, "',")
cat(format_delim(car_species, delim = ""))
```
There are a total of ~70 species in the Carrizo dataset, some of which are sub-species, and others of which as genera or physical features (holes, moss, etc).
**Note:** There are three genera without specific epithets in the data: *Delphinium*, *Astragalus*, and *Allium*.

#### Species with epithets
```{r grabbing carrizo gbif data, echo = FALSE, cache = TRUE, warning=FALSE}
car_species_list <- c('Bromus rubens', 
                       'Schismus arabicus',
                       'Hordeum murinum',
                       'Erodium cicutarium',
                       'Vulpia microstachys v pauciflora',
                       'Vulpia myuros v hirsuta',
                       'Lepidium nitidum',
                       'Tropidocarpum gracile',
                       'Trifolium gracilentum',
                       'Guillenia lasiophylla',
                       'Dichelostemma capitatum',
                       'Amsinckia tessellata',
                       'Calandrinia ciliata',
                       'Phlox gracilis',
                       'Lasthenia californica',
                       'Bromus hordeaceus',
                       'Athysanus pusillus',
                       'Sisymbrium irio',
                       'Poa secunda ssp secunda',
                       'Pectocarya penicillata',
                       'Lotus wrangelianus',
                       'Monolopia lanceolata',
                       'Microseris elegans',
                       'Microseris douglasii',
                       'Malacothrix coulteri',
                       'Lasthenia minor',
                       'Eriogonum gracillimum',
                       'Lupinus microcarpus v microcarpus',
                       'Trichostema lanceolatum',
                       'Trifolium albopurpureum',
                       'Amsinckia menziesii',
                       'Descurainia sophia',
                       'Capsella bursa-pastoris',
                       'Astragalus didymocarpus',
                       'Salsola tragus',
                       'Astragalus oxyphysus',
                       'Lepidium dictyotum',
                       'Astragalus lentiginosus v nigricalycis',
                       'Phacelia ciliata',
                       'Amsinckia menziesii v intermedia',
                       'Monolopia congdonii',
                       'Marrubium vulgare',
                       'Hollisteria lanata',
                       'Herniaria hirsuta ssp. cinerea',
                       'Plagiobothrys canescens',
                       'Linanthus liniflorus',
                       'Castilleja exserta',
                       'Chorizanthe uniaristata',
                       'Chorizanthe watsonii',
                       'Lupinus bicolor',
                       'Uropappus lindleyi',
                       'Vulpia bromoides',
                       'Chaenactis glabriuscula v glabriuscula',
                       'Lastarriaea coriacea',
                       'Camissonia campestris',
                       'Plantago erecta',
                       'Muilla maritima',
                       'Lactuca serriola',
                       'Lasthenia glabrata ssp coulteri',
                       'Camissonia palmeri',
                       'Crassula connata',
                       'Eremocarpus setigerus',
                       'Castilleja lineariloba',
                       'Stephanomeria pauciflora',
                       'Delphinium recurvatum')

car_species_data <- occ(query = car_species_list, from = "gbif", has_coords = TRUE, limit = 10000,
                gbifopts = list(hasGeospatialIssue = FALSE, country = "US",
                                stateProvince = "California"))
```

```{r clean ang species data}
## we can also replace all synonym taxon names with one (cuts down the number of plotted dot colors)
## we should use the scrubr version of the function in the future
car_species_data <- fixnames(car_species_data, how = "query")

## The occ2df function should convert the data to a dataframe format
car_species_data_df <- occ2df(car_species_data)

# We need to clean the coordinates, as it appears some are in the ocean, and there might be some that are just incorrect. To do this, we will use a coordinate cleaner package.
flags <- clean_coordinates(x = car_species_data_df, lon = "longitude", lat = "latitude",
                          species = "name",
                          tests = c("capitals", "centroids", "equal","gbif", "institutions",
                                    "seas", "zeros", "duplicates")) # most tests are on by default

# Most of our flagged coordinates are coastal/in the ocean. Therefore, we'll remove them from our database.
# keep only the non-flagged data
car_species_data_df <- car_species_data_df[flags$.summary,] %>%
  rename("species.name" = "name")
```

#### Species without epithets

Because there are three genera found in the plots could reflect any number of species known from the site, we fill collect gbif data for all of these.

##### Allium
```{r car allium query GBIF}
car_allium <- c('Allium lacunosum',
                   'Allium peninsulare',
                   'Allium crispum',
                   'Allium fimbriatum',
                   'Allium howellii')

car_allium_data <- occ(query = car_allium, from = "gbif", has_coords = TRUE, limit = 10000,
                gbifopts = list(hasGeospatialIssue = FALSE, country = "US",
                                stateProvince = "California"))
```

```{r clean car allium data}
## we can also replace all synonym taxon names with one (cuts down the number of plotted dot colors)
## we should use the scrubr version of the function in the future
car_allium_data <- fixnames(car_allium_data, how = "query")

## The occ2df function should convert the data to a dataframe format
car_allium_data_df <- occ2df(car_allium_data)

flags <- clean_coordinates(x = car_allium_data_df, lon = "longitude", lat = "latitude",
                          species = "name",
                          tests = c("capitals", "centroids", "equal","gbif", "institutions",
                                    "seas", "zeros", "duplicates")) # most test are on by default

# remove flagged records
car_allium_data_df <- car_allium_data_df[flags$.summary,]

# change all datapoints to the "species sp" format that's used in the og dataframe, calc CTI
car_allium_data_df <- car_allium_data_df %>%
  mutate(species.name = "Allium sp.")

```

##### Astragulus
```{r carrizo delphinium query GBIF}
car_astragalus <- c('Astragalus asymmetricus',
                'Astragalus didymocarpus',
                'Astragalus douglasii',
                'Astragalus macrodon',
                'Astragalus oxyphysus',
                'Astragalus lentiginosus')

car_astragalus_data <- occ(query = car_astragalus, from = "gbif", has_coords = TRUE, limit = 10000,
                gbifopts = list(hasGeospatialIssue = FALSE, country = "US",
                                stateProvince = "California"))
```

```{r clean ang trifolium data}
## we can also replace all synonym taxon names with one (cuts down the number of plotted dot colors)
## we should use the scrubr version of the function in the future
car_astragalus_data <- fixnames(car_astragalus_data, how = "query")

## The occ2df function should convert the data to a dataframe format
car_astragalus_data_df <- occ2df(car_astragalus_data)

flags <- clean_coordinates(x = car_astragalus_data_df, lon = "longitude", lat = "latitude",
                          species = "name",
                          tests = c("capitals", "centroids", "equal","gbif", "institutions",
                                    "seas", "zeros", "duplicates")) # most test are on by default

# remove flagged records
car_astragalus_data_df <- car_astragalus_data_df[flags$.summary,]

# change all datapoints to the "species sp" format that's used in the og dataframe, calc CTI
car_astragalus_data_df <- car_astragalus_data_df %>%
  mutate(species.name = "Astragalus sp.")

```

##### 'Delphenium'
```{r carrizo delphinium query GBIF}
car_delpinium <- c('Delphinium gypsophilum',
                    'Delphinium patens',
                    'Delphinium parryi',
                    'Delphinium recurvatum')

car_delpinium_data <- occ(query = car_delpinium, from = "gbif", has_coords = TRUE, limit = 10000,
                gbifopts = list(hasGeospatialIssue = FALSE, country = "US",
                                stateProvince = "California"))
```

```{r clean ang trifolium data}
## we can also replace all synonym taxon names with one (cuts down the number of plotted dot colors)
## we should use the scrubr version of the function in the future
car_delpinium_data <- fixnames(car_delpinium_data, how = "query")

## The occ2df function should convert the data to a dataframe format
car_delpinium_data_df <- occ2df(car_delpinium_data)

flags <- clean_coordinates(x = car_delpinium_data_df, lon = "longitude", lat = "latitude",
                          species = "name",
                          tests = c("capitals", "centroids", "equal","gbif", "institutions",
                                    "seas", "zeros", "duplicates")) # most test are on by default

# remove flagged records
car_delpinium_data_df <- car_delpinium_data_df[flags$.summary,]

# change all datapoints to the "species sp" format that's used in the og dataframe, calc CTI
car_delpinium_data_df <- car_delpinium_data_df %>%
  mutate(species.name = "Delphenium sp.")

```

#### Combine with and without epithet dataframes and remove extra objects
```{r recombine car with epithet with non-epithet data}
car_species_data_df <- full_join(car_species_data_df, car_allium_data_df)
car_species_data_df <- full_join(car_species_data_df, car_astragalus_data_df)
car_species_data_df <- full_join(car_species_data_df, car_delpinium_data_df)

```

## Elkhorn
### Preparing a species list table and importing data
```{r elk data and species list}
rel_elk <- rel_all %>%
  filter(site == "Elkhorn")
elk_species <- unique(rel_elk$species.name)
elk_species <- as.data.frame(elk_species)
elk_species$elk_species <- paste0("'", elk_species$elk_species, "',")
cat(format_delim(elk_species, delim = ""))
```

There are a total of 39 species in the Carrizo dataset, some of which are sub-species, and others of which as genera or physical features (holes, moss, etc).
**Note:** There is one genus genera without specific epithets in the data: *Bromus sp.*

#### Species with epithets
```{r grabbing elk gbif data, echo = FALSE, cache = TRUE, warning=FALSE}
elk_species_list <- c('Erodium botrys', 
                      'Geranium dissectum', 
                      'Trifolium dubium', 
                      'Trifolium subterraneum', 
                      'Hypochaeris radicata', 
                      'Plantago lanceolata', 
                      'Rumex acetosella', 
                      'Taraxia ovata', 
                      'Aira caryophyllea', 
                      'Bromus hordeaceus',
                      'Bromus diandrus',
                      'Festuca perennis', 
                      'Vulpia myuros', 
                      'Juncus bufonius', 
                      'Isolepis carinata', 
                      'Danthonia californica', 
                      'Briza maxima', 
                      'Holcus lanatus', 
                      'Stipa pulchra', 
                      'Juncus occidentalis',
                      'Juncus phaeocephalus',
                      'Lysimachia arvensis',
                      'Trifolium angustifolium',
                      'Erodium moschatum',
                      'Avena barbata',
                      'Cynosurus echinatus',
                      'Briza minor',
                      'Vicia sativa',
                      'Silybum marianum',
                      'Hypochaeris glabra',
                      'Carduus pycnocephalus',
                      'Cerastium glomeratum',
                      'Phalaris aquatica',
                      'Brachypodium distachyon',
                      'Sonchus oleraceus',
                      'Convolvulus arvensis',
                      'Sonchus asper')

elk_species_data <- occ(query = elk_species_list, from = "gbif", has_coords = TRUE, limit = 10000,
                gbifopts = list(hasGeospatialIssue = FALSE, country = "US",
                                stateProvince = "California"))
```

```{r clean ang species data}
## we can also replace all synonym taxon names with one (cuts down the number of plotted dot colors)
elk_species_data <- fixnames(elk_species_data, how = "query")

## The occ2df function should convert the data to a dataframe format
elk_species_data_df <- occ2df(elk_species_data)

# We need to clean the coordinates, as it appears some are in the ocean, and there might be some that are just incorrect. To do this, we will use a coordinate cleaner package.
flags <- clean_coordinates(x = elk_species_data_df, lon = "longitude", lat = "latitude",
                          species = "name",
                          tests = c("capitals", "centroids", "equal","gbif", "institutions",
                                    "seas", "zeros", "duplicates")) # most tests are on by default

# Most of our flagged coordinates are coastal/in the ocean. Therefore, we'll remove them from our database.
# keep only the non-flagged data
elk_species_data_df <- elk_species_data_df[flags$.summary,] %>%
  rename("species.name" = "name")
```

Because there are three genera found in the plots could reflect any number of species known from the site, we fill collect gbif data for all of these.
### Species without epithets
##### Bromus
```{r elk bromus query GBIF}
elk_bromus <- c('Bromus carinatus',
                'Bromus hordeaceus',
                'Bromus diandrus',
                'Avena barbata')

elk_bromus_data <- occ(query = elk_bromus, from = "gbif", has_coords = TRUE, limit = 10000,
                gbifopts = list(hasGeospatialIssue = FALSE, country = "US",
                                stateProvince = "California"))
```

```{r clean elk bromus data}
## we can also replace all synonym taxon names with one (cuts down the number of plotted dot colors)
## we should use the scrubr version of the function in the future
elk_bromus_data <- fixnames(elk_bromus_data, how = "query")

## The occ2df function should convert the data to a dataframe format
elk_bromus_data_df <- occ2df(elk_bromus_data)

flags <- clean_coordinates(x = elk_bromus_data_df, lon = "longitude", lat = "latitude",
                          species = "name",
                          tests = c("capitals", "centroids", "equal","gbif", "institutions",
                                    "seas", "zeros", "duplicates")) # most test are on by default

# remove flagged records
elk_bromus_data_df <- elk_bromus_data_df[flags$.summary,]

# change all datapoints to the "species sp" format that's used in the og dataframe, calc CTI
elk_bromus_data_df <- elk_bromus_data_df %>%
  mutate(species.name = "Bromus sp")
```

##### Brassica
```{r elk bromus query GBIF}
elk_brassica <- c('Brassica rapa',
                  'Brassica nigra',
                  'Hirschfeldia incana')

elk_brassica_data <- occ(query = elk_brassica, from = "gbif", has_coords = TRUE, limit = 10000,
                gbifopts = list(hasGeospatialIssue = FALSE, country = "US",
                                stateProvince = "California"))
```

```{r clean elk bromus data}
## we can also replace all synonym taxon names with one (cuts down the number of plotted dot colors)
## we should use the scrubr version of the function in the future
elk_brassica_data <- fixnames(elk_brassica_data, how = "query")

## The occ2df function should convert the data to a dataframe format
elk_brassica_data_df <- occ2df(elk_brassica_data)

flags <- clean_coordinates(x = elk_brassica_data_df, lon = "longitude", lat = "latitude",
                          species = "name",
                          tests = c("capitals", "centroids", "equal","gbif", "institutions",
                                    "seas", "zeros", "duplicates")) # most test are on by default

# remove flagged records
elk_brassica_data_df <- elk_brassica_data_df[flags$.summary,]

# change all datapoints to the "species sp" format that's used in the og dataframe, calc CTI
elk_brassica_data_df <- elk_brassica_data_df %>%
  mutate(species.name = "Brassica species")
```
### Combine with and without epithet dataframes and remove extra objects
```{r recombine car with epithet with non-epithet data}
elk_species_data_df <- full_join(elk_species_data_df, elk_bromus_data_df)
elk_species_data_df <- full_join(elk_species_data_df, elk_brassica_data_df)

elk_species_data_rds <- elk_species_data_df

```


## Jasper

### Preparing a species list table and importing data
```{r jasp data and species list}
rel_jasp <- rel_all %>%
  filter(site == "Jasper")
jasp_species <- unique(rel_jasp$species.name)
jasp_species <- as.data.frame(jasp_species)
jasp_species$jasp_species <- paste0("'", jasp_species$jasp_species, "',")
cat(format_delim(jasp_species, delim = ""))
```

There are a total of 39 species in the Carrizo dataset, some of which are sub-species, and others of which as genera or physical features (holes, moss, etc).
**Note:** Without specific epithets in the data: **, **

#### Species with epithets
```{r grabbing jasp gbif data, echo = FALSE, cache = TRUE, warning=FALSE}
jasp_species_list <- c('Agoseris heterophylla', 
         'Astragalus gambellianus',
         'Bromus hordeaceus',
         'Calycadenia multiglandulosa',
         'Chlorogalum pomeridianum',
         'Eschscholzia californica',
         'Hesperevax sparsiflora',
         'Lasthenia californica',
         'Layia platyglossa',
         'Lepidium nitidum',
         'Linanthus parviflorus',
         'Lotus wrangelianus',
         'Micropus californicus',
         'Microseris douglasii',
         'Castilleja densiflora',
         'Plantago erecta',
         'Poa secunda',
         'Elymus multisetus',
         'Stipa pulchra',
         'Crassula connata',
         'Vulpia microstachys',
         'Minuartia douglasii',
         'Hemizonia congesta',
         'Epilobium brachycarpum',
         'Calandrinia ciliata',
         'Plagiobothrys nothofulvus',
         'Gilia clivorum',
         'Lolium multiflorum',
         'Melica californica',
         'Lomatium utriculatum',
         'Bromus berteroanus')

jasp_species_data <- occ(query = jasp_species_list, from = "gbif", has_coords = TRUE, limit = 10000,
                gbifopts = list(hasGeospatialIssue = FALSE, country = "US",
                                stateProvince = "California"))
```

```{r clean jasp species data}
## we can also replace all synonym taxon names with one (cuts down the number of plotted dot colors)
jasp_species_data <- fixnames(jasp_species_data, how = "query")

## The occ2df function should convert the data to a dataframe format
jasp_species_data_df <- occ2df(jasp_species_data)

# We need to clean the coordinates, as it appears some are in the ocean, and there might be some that are just incorrect. To do this, we will use a coordinate cleaner package.
flags <- clean_coordinates(x = jasp_species_data_df, lon = "longitude", lat = "latitude",
                          species = "name",
                          tests = c("capitals", "centroids", "equal","gbif", "institutions",
                                    "seas", "zeros", "duplicates")) # most tests are on by default

# Most of our flagged coordinates are coastal/in the ocean. Therefore, we'll remove them from our database.
# keep only the non-flagged data
jasp_species_data_df <- jasp_species_data_df[flags$.summary,] %>%
  rename("species.name" = "name")
```

Because there are three genera found in the plots could reflect any number of species known from the site, we fill collect gbif data for all of these.
### Species without epithets
##### Brodiaea
```{r jasper brodiaea query GBIF}
jasp_brodiaea <- c('Brodiaea elegans ssp. elegans',
                   'Brodiaea terrestris ssp. terrestris')
         
jasp_brodiaea_data <- occ(query = jasp_brodiaea, from = "gbif", has_coords = TRUE, limit = 10000,
                gbifopts = list(hasGeospatialIssue = FALSE, country = "US",
                                stateProvince = "California"))
```

```{r clean jasper brodiaea data}
## we can also replace all synonym taxon names with one (cuts down the number of plotted dot colors)
## we should use the scrubr version of the function in the future
jasp_brodiaea_data <- fixnames(jasp_brodiaea_data, how = "query")

## The occ2df function should convert the data to a dataframe format
jasp_brodiaea_data_df <- occ2df(jasp_brodiaea_data)

flags <- clean_coordinates(x = jasp_brodiaea_data_df, lon = "longitude", lat = "latitude",
                          species = "name",
                          tests = c("capitals", "centroids", "equal","gbif", "institutions",
                                    "seas", "zeros", "duplicates")) # most test are on by default

# remove flagged records
jasp_brodiaea_data_df <- jasp_brodiaea_data_df[flags$.summary,]

# change all datapoints to the "species sp" format that's used in the og dataframe, calc CTI
jasp_brodiaea_data_df <- jasp_brodiaea_data_df %>%
  mutate(species.name = "Brodiaea sp")
```

##### Trifolium
```{r jasper trifolium query GBIF}
jasp_trifolium <- c('Trifolium albopurpureum var. albopurpureum',
                    'Trifolium arvense',
                    'Trifolium barbigerum var. barbigerum',
                    'Trifolium bifidum var. bifidum',
                    'Trifolium bifidum var. decipiens',
                    'Trifolium campestre',
                    'Trifolium cernuum',
                    'Trifolium ciliolatum',
                    'Trifolium depauperatum var. amplectens',
                    'Trifolium depauperatum var. truncatum',
                    'Trifolium albopurpureum var. dichotomum',
                    'Trifolium dubium',
                    'Trifolium fucatum',
                    'Trifolium glomeratum',
                    'Trifolium gracilentum var. gracilentum',
                    'Trifolium hirtum',
                    'Trifolium microcephalum',
                    'Trifolium microdon',
                    'Trifolium oliganthum',
                    'Trifolium repens',
                    'Trifolium subterraneum',
                    'Trifolium variegatum var. variegatum',
                    'Trifolium willdenovii')

jasp_trifolium_data <- occ(query = jasp_trifolium, from = "gbif", has_coords = TRUE, limit = 10000,
                gbifopts = list(hasGeospatialIssue = FALSE, country = "US",
                                stateProvince = "California"))
```

```{r clean jasper trifolium data}
## we can also replace all synonym taxon names with one (cuts down the number of plotted dot colors)
## we should use the scrubr version of the function in the future
jasp_trifolium_data <- fixnames(jasp_trifolium_data, how = "query")

## The occ2df function should convert the data to a dataframe format
jasp_trifolium_data_df <- occ2df(jasp_trifolium_data)

flags <- clean_coordinates(x = jasp_trifolium_data_df, lon = "longitude", lat = "latitude",
                          species = "name",
                          tests = c("capitals", "centroids", "equal","gbif", "institutions",
                                    "seas", "zeros", "duplicates")) # most test are on by default

# remove flagged records
jasp_trifolium_data_df <- jasp_trifolium_data_df[flags$.summary,]

# change all datapoints to the "species sp" format that's used in the og dataframe, calc CTI
jasp_trifolium_data_df <- jasp_trifolium_data_df %>%
  mutate(species.name = "Trifolium sp")
```

### Combine with and without epithet dataframes and remove extra objects
```{r recombine jasp with epithet with non-epithet data}
jasp_species_data_df <- full_join(jasp_species_data_df, jasp_brodiaea_data_df)
jasp_species_data_df <- full_join(jasp_species_data_df, jasp_trifolium_data_df)

```


## McL Ann

### Preparing a species list table and importing data
```{r mcLann data and species list}
rel_mcLann <- rel_all %>%
  filter(site == "McL Ann")
mcLann_species <- unique(rel_mcLann$species.name)
mcLann_species <- as.data.frame(mcLann_species)
mcLann_species$mcLann_species <- paste0("'", mcLann_species$mcLann_species, "',")
cat(format_delim(mcLann_species, delim = ""))
```

There are a total of 39 species in the Carrizo dataset, some of which are sub-species, and others of which as genera or physical features (holes, moss, etc).
**Note:** Without specific epithets in the data: **, **

#### Species with epithets
```{r grabbing mcLann gbif data, echo = FALSE, cache = TRUE, warning=FALSE}
mcLann_species_list <- c('Bromus hordeaceus', 
                         'Bromus madritensis',
                         'Castilleja densiflora',
                         'Erodium cicutarium',
                         'Holocarpha virgata',
                         'Medicago polymorpha',
                         'Nassella pulchra',
                         'Navarretia pubescens',
                         'Vulpia myuros',
                         'Cerastium glomeratum',
                         'Allium serra',
                         'Avena fatua',
                         'Bromus diandrus',
                         'Clarkia purpurea',
                         'Claytonia exigua',
                         'Collinsia heterophylla',
                         'Dodecatheon hendersonii',
                         'Geranium molle',
                         'Ranunculus occidentalis',
                         'Rigiopappus leptocladus',
                         'Senecio vulgaris',
                         'Triteleia laxa',
                         'Vulpia microstachys',
                         'Galium aparine',
                         'Centaurea solstitialis',
                         'Lupinus bicolor',
                         'Poa bulbosa',
                         'Taeniatherum caput-medusae',
                         'Trifolium hirtum',
                         'Bellardia trixago',
                         'Lolium multiflorum',
                         'Achyrachaena mollis',
                         'Hypochaeris glabra',
                         'Brodiaea elegans',
                         'Castilleja attenuata',
                         'Silene gallica',
                         'Capsella bursa-pastoris',
                         'Agoseris heterophylla',
                         'Epilobium brachycarpum',
                         'Gilia tricolor',
                         'Lotus humistratus',
                         'Micropus californicus',
                         'Plagiobothrys nothofulvus',
                         'Plantago erecta',
                         'Vicia villosa',
                         'Aira caryophyllea',
                         'Navarretia viscidula',
                         'Triphysaria eriantha',
                         'Navarretia tagetina',
                         'Zeltnera trichantha',
                         'Linanthus ciliatus',
                         'Minuartia californica',
                         'Polypogon monspeliensis',
                         'Euphorbia crenulata',
                         'Microseris douglasii',
                         'Trifolium gracilentum',
                         'Agoseris grandiflora',
                         'Chlorogalum pomeridianum',
                         'Hemizonia congesta',
                         'Trifolium bifidum',
                         'Dichelostemma capitatum',
                         'Linanthus bicolor',
                         'Torilis arvensis',
                         'Daucus pusillus',
                         'Sanicula bipinnatifida',
                         'Allophyllum gilioides',
                         'Trifolium microcephalum',
                         'Collinsia sparsiflora',
                         'Poa secunda',
                         'Trifolium microdon',
                         'Trifolium willdenovii',
                         'Madia gracilis',
                         'Achillea millefolium',
                         'Gastridium ventricosum',
                         'Plectritis ciliosa',
                         'Convolvulus arvensis',
                         'Galium murale',
                         'Lotus micranthus',
                         'Astragalus gambellianus',
                         'Calochortus luteus',
                         'Lotus wrangelianus',
                         'Trifolium albopurpureum',
                         'Calochortus superbus',
                         'Lactuca serriola',
                         'Sisyrinchium bellum',
                         'Lepidium nitidum',
                         'Sidalcea diploscypha',
                         'Trifolium depauperatum',
                         'Dactylis glomerata',
                         'Hesperevax sparsiflora',
                         'Filago gallica',
                         'Lomatium marginatum',
                         'Brassica nigra',
                         'Hordeum marinum',
                         'Anthriscus caucalis',
                         'Chamomilla suaveolens',
                         'Lathyrus vestitus',
                         'Sanicula crassicaulis',
                         'Melilotus indicus',
                         'Trifolium dubium',
                         'Aphanes occidentalis',
                         'Wyethia glabra',
                         'Amsinckia menziesii',
                         'Athysanus pusillus',
                         'Cirsium vulgare',
                         'Sisymbrium officinale',
                         'Trifolium obtusiflorum',
                         'Madia exigua',
                         'Centaurea melitensis',
                         'Eremocarpus setigerus',
                         'Velezia rigida',
                         'Petrorhagia prolifera',
                         'Nemophila menziesii',
                         'Lupinus microcarpus',
                         'Trifolium fucatum',
                         'Lomatium utriculatum',
                         'Zigadenus fremontii',
                         'Castilleja exserta',
                         'Delphinium variegatum',
                         'Elymus elymoides',
                         'Lupinus succulentus',
                         'Stellaria nitens',
                         'Lasthenia californica',
                         'Madia elegans',
                         'Atriplex triangularis',
                         'Delphinium hesperium',
                         'Thysanocarpus curvipes',
                         'Phacelia imbricata',
                         'Carduus pycnocephalus',
                         'Astragalus breweri',
                         'Eschscholzia californica',
                         'Hieracium albiflorum',
                         'Briza minor',
                         'Minuartia douglasii',
                         'Cynosurus echinatus',
                         'Grindelia camporum',
                         'Anagallis arvensis',
                         'Lithophragma heterophyllum',
                         'Calandrinia ciliata',
                         'Geranium dissectum',
                         'Erodium brachycarpum',
                         'Sagina apetala',
                         'Phlox gracilis',
                         'Ranunculus californicus',
                         'Torilis nodosa',
                         'Erodium botrys',
                         'Layia platyglossa',
                         'Cryptantha hispidula',
                         'Sanicula bipinnata',
                         'Melica californica',
                         'Camissonia graciliflora',
                         'Perideridia kelloggii',
                         'Aegilops triuncialis',
                         'Claytonia parviflora',
                         'Nemophila heterophylla',
                         'Rumex crispus',
                         'Cardamine oligosperma',
                         'Phalaris paradoxa',
                         'Galium porrigens',
                         'Mimulus douglasii',
                         'Crassula connata',
                         'Astragalus rattanii var. jepsonianus',
                         'Pectocarya pusilla',
                         'Elymus repens',
                         'Uropappus lindleyi',
                         'Chorizanthe membranacea',
                         'Navarretia jepsonii',
                         'Castilleja rubicundula',
                         'Githopsis specularioides',
                         'Hordeum murinum',
                         'Bromus tectorum',
                         'Poa annua',
                         'Bromus laevipes',
                         'Lupinus albifrons',
                         'Trifolium ciliolatum',
                         'Holodiscus discolor',
                         'Quercus durata',
                         'Hypochaeris radicata',
                         'Stellaria media',
                         'Helianthus exilis',
                         'Quercus douglasii',
                         'Ancistrocarphus filagineus',
                         'Quercus lobata',
                         'Salvia columbariae',
                         'Eriophyllum lanatum',
                         'Elymus glaucus',
                         'Juncus bufonius',
                         'Cuscuta californica',
                         'Vulpia bromoides',
                         'Cerastium fontanum ssp. vulgare',
                         'Tragopogon dubius',
                         'Cercocarpus betuloides',
                         'Lomatium dasycarpum',
                         'Gnaphalium californicum',
                         'Allium amplectens',
                         'Nassella lepida',
                         'Lonicera hispidula',
                         'Nemophila pedunculata',
                         'Trifolium variegatum',
                         'Allium fimbriatum')

mcLann_species_data <- occ(query = mcLann_species_list, from = "gbif", has_coords = TRUE, limit = 100000,
                gbifopts = list(hasGeospatialIssue = FALSE, country = "US", stateProvince = "California"))
```

```{r clean mcLann species data}
## we can also replace all synonym taxon names with one (cuts down the number of plotted dot colors)
mcLann_species_data <- fixnames(mcLann_species_data, how = "query")

## The occ2df function should convert the data to a dataframe format
mcLann_species_data_df <- occ2df(mcLann_species_data)

# We need to clean the coordinates, as it appears some are in the ocean, and there might be some that are just incorrect. To do this, we will use a coordinate cleaner package.
flags <- clean_coordinates(x = mcLann_species_data_df, lon = "longitude", lat = "latitude",
                          species = "name",
                          tests = c("capitals", "centroids", "equal","gbif", "institutions",
                                    "seas", "zeros", "duplicates")) # most tests are on by default

# Most of our flagged coordinates are coastal/in the ocean. Therefore, we'll remove them from our database.
# keep only the non-flagged data
mcLann_species_data_df <- mcLann_species_data_df[flags$.summary,] %>%
  rename("species.name" = "name")
```

Because there are three genera found in the plots could reflect any number of species known from the site, we fill collect gbif data for all of these.
### Species without epithets
##### Juncus
```{r mclann juncus query GBIF}
mcLann_juncus <- c('Juncus balticus',
                   'Juncus bufonius',
                   'Juncus oxymeris',
                   'Juncus phaeocephalus',
                   'Juncus occidentalis')
         
mcLann_juncus_data <- occ(query = mcLann_juncus, from = "gbif", has_coords = TRUE, limit = 10000,
                gbifopts = list(hasGeospatialIssue = FALSE, country = "US",
                                stateProvince = "California"))
```

```{r clean mcLann juncus data}
## we can also replace all synonym taxon names with one (cuts down the number of plotted dot colors)
## we should use the scrubr version of the function in the future
mcLann_juncus_data <- fixnames(mcLann_juncus_data, how = "query")

## The occ2df function should convert the data to a dataframe format
mcLann_juncus_data_df <- occ2df(mcLann_juncus_data)

flags <- clean_coordinates(x = mcLann_juncus_data_df, lon = "longitude", lat = "latitude",
                          species = "name",
                          tests = c("capitals", "centroids", "equal","gbif", "institutions",
                                    "seas", "zeros", "duplicates")) # most test are on by default

# remove flagged records
mcLann_juncus_data_df <- mcLann_juncus_data_df[flags$.summary,]

# change all datapoints to the "species sp" format that's used in the og dataframe, calc CTI
mcLann_juncus_data_df <- mcLann_juncus_data_df %>%
  mutate(species.name = "Juncus sp.")
```

##### Stephanomeria
```{r mclann Stephanomeria query GBIF}
mcLann_stephanomeria <- c('Stephanomeria virgata')

mcLann_stephanomeria_data <- occ(query = mcLann_stephanomeria, from = "gbif", has_coords = TRUE, limit = 10000,
                gbifopts = list(hasGeospatialIssue = FALSE, country = "US",
                                stateProvince = "California"))
```

```{r clean mclann stephanomeria data}
## we can also replace all synonym taxon names with one (cuts down the number of plotted dot colors)
## we should use the scrubr version of the function in the future
mcLann_stephanomeria_data <- fixnames(mcLann_stephanomeria_data, how = "query")

## The occ2df function should convert the data to a dataframe format
mcLann_stephanomeria_data_df <- occ2df(mcLann_stephanomeria_data)

flags <- clean_coordinates(x = mcLann_stephanomeria_data_df, lon = "longitude", lat = "latitude",
                          species = "name",
                          tests = c("capitals", "centroids", "equal","gbif", "institutions",
                                    "seas", "zeros", "duplicates")) # most test are on by default

# remove flagged records
mcLann_stephanomeria_data_df <- mcLann_stephanomeria_data_df[flags$.summary,]

# change all datapoints to the "species sp" format that's used in the og dataframe, calc CTI
mcLann_stephanomeria_data_df <- mcLann_stephanomeria_data_df %>%
  mutate(species.name = "Stephanomeria sp.")
```

##### Minuartia
```{r mclann minuartia query GBIF}
mcLann_minuartia <- c('Minuartia californica',
                      'Minuartia douglasii')

mcLann_minuartia_data <- occ(query = mcLann_minuartia, from = "gbif", has_coords = TRUE, limit = 10000,
                gbifopts = list(hasGeospatialIssue = FALSE, country = "US",
                                stateProvince = "California"))
```

```{r clean mclann minuartia data}
## we can also replace all synonym taxon names with one (cuts down the number of plotted dot colors)
## we should use the scrubr version of the function in the future
mcLann_minuartia_data <- fixnames(mcLann_minuartia_data, how = "query")

## The occ2df function should convert the data to a dataframe format
mcLann_minuartia_data_df <- occ2df(mcLann_minuartia_data)

flags <- clean_coordinates(x = mcLann_minuartia_data_df, lon = "longitude", lat = "latitude",
                          species = "name",
                          tests = c("capitals", "centroids", "equal","gbif", "institutions",
                                    "seas", "zeros", "duplicates")) # most test are on by default

# remove flagged records
mcLann_minuartia_data_df <- mcLann_minuartia_data_df[flags$.summary,]

# change all datapoints to the "species sp" format that's used in the og dataframe, calc CTI
mcLann_minuartia_data_df <- mcLann_minuartia_data_df %>%
  mutate(species.name = "Minuartia sp.")
```

### Combine with and without epithet dataframes and remove extra objects
```{r recombine mcLann with epithet with non-epithet data}
mcLann_species_data_df <- full_join(mcLann_species_data_df, mcLann_juncus_data_df)
mcLann_species_data_df <- full_join(mcLann_species_data_df, mcLann_stephanomeria_data_df)
mcLann_species_data_df <- full_join(mcLann_species_data_df, mcLann_minuartia_data_df)
```


## McL Serp

### Preparing a species list table and importing data
```{r mcLserp data and species list}
rel_mcLserp <- rel_all %>%
  filter(site == "McL Serp")
mcLserp_species <- unique(rel_mcLserp$species.name)
mcLserp_species <- as.data.frame(mcLserp_species)
mcLserp_species$mcLserp_species <- paste0("'", mcLserp_species$mcLserp_species, "',")
cat(format_delim(mcLserp_species, delim = ""))
```

There are a total of 39 species in the Carrizo dataset, some of which are sub-species, and others of which as genera or physical features (holes, moss, etc).
**Note:** Without specific epithets in the data: **, **

#### Species with epithets
```{r grabbing mcLserp gbif data, echo = FALSE, cache = TRUE, warning=FALSE}
mcLann_species_list <- c('Astragalus gambellianus', 
                         'Athysanus pusillus',
                         'Avena fatua',
                         'Bromus hordeaceus',
                         'Bromus madritensis',
                         'Calochortus vestae',
                         'Centaurea solstitialis',
                         'Clarkia purpurea',
                         'Dichelostemma capitatum',
                         'Erodium cicutarium',
                         'Hemizonia congesta',
                         'Lasthenia californica',
                         'Lotus wrangelianus',
                         'Lupinus bicolor',
                         'Lupinus succulentus',
                         'Micropus californicus',
                         'Perideridia kelloggii',
                         'Phlox gracilis',
                         'Plagiobothrys nothofulvus',
                         'Plantago erecta',
                         'Senecio vulgaris',
                         'Sisyrinchium bellum',
                         'Taeniatherum caput-medusae',
                         'Vulpia microstachys',
                         'Agoseris heterophylla',
                         'Ancistrocarphus filagineus',
                         'Calycadenia pauciflora',
                         'Cerastium glomeratum',
                         'Chlorogalum pomeridianum',
                         'Clarkia gracilis',
                         'Claytonia parviflora',
                         'Collinsia sparsiflora',
                         'Euphorbia crenulata',
                         'Gilia capitata',
                         'Gilia tricolor',
                         'Hordeum marinum',
                         'Lotus humistratus',
                         'Minuartia californica',
                         'Nassella pulchra',
                         'Navarretia pubescens',
                         'Poa secunda',
                         'Ranunculus occidentalis',
                         'Rigiopappus leptocladus',
                         'Thysanocarpus curvipes',
                         'Trifolium albopurpureum',
                         'Trifolium fucatum',
                         'Triteleia laxa',
                         'Zigadenus fremontii',
                         'Amsinckia menziesii',
                         'Chorizanthe membranacea',
                         'Eriogonum nudum',
                         'Holocarpha virgata',
                         'Lagophylla minor',
                         'Minuartia douglasii',
                         'Sidalcea diploscypha',
                         'Trifolium gracilentum',
                         'Trifolium hirtum',
                         'Vulpia myuros',
                         'Anagallis arvensis',
                         'Calochortus superbus',
                         'Castilleja rubicundula',
                         'Delphinium variegatum',
                         'Grindelia camporum',
                         'Hesperolinon californicum',
                         'Achyrachaena mollis',
                         'Calochortus luteus',
                         'Lomatium utriculatum',
                         'Lotus micranthus',
                         'Medicago polymorpha',
                         'Melilotus indicus',
                         'Calandrinia ciliata',
                         'Lactuca serriola',
                         'Lepidium nitidum',
                         'Linanthus bicolor',
                         'Navarretia jepsonii',
                         'Aegilops triuncialis',
                         'Eremocarpus setigerus',
                         'Lolium multiflorum',
                         'Lomatium dasycarpum',
                         'Astragalus breweri',
                         'Castilleja attenuata',
                         'Trifolium willdenovii',
                         'Triphysaria eriantha',
                         'Agoseris grandiflora',
                         'Brodiaea elegans',
                         'Polypogon monspeliensis',
                         'Trifolium variegatum',
                         'Zeltnera trichantha',
                         'Gastridium ventricosum',
                         'Poa bulbosa',
                         'Viola douglasii',
                         'Lomatium marginatum',
                         'Melica californica',
                         'Microseris douglasii',
                         'Sanicula bipinnatifida',
                         'Vicia villosa',
                         'Hesperolinon micranthum',
                         'Trifolium bifidum',
                         'Hordeum brachyantherum',
                         'Bromus diandrus',
                         'Claytonia exigua',
                         'Epilobium brachycarpum',
                         'Hypochaeris glabra',
                         'Layia platyglossa',
                         'Layia septentrionalis',
                         'Bromus carinatus',
                         'Cuscuta californica',
                         'Elymus elymoides',
                         'Eriogonum vimineum',
                         'Lupinus microcarpus',
                         'Stellaria nitens',
                         'Triphysaria versicolor',
                         'Delphinium hesperium',
                         'Wyethia glabra',
                         'Allium serra',
                         'Filago gallica',
                         'Geranium molle',
                         'Aphanes occidentalis',
                         'Daucus pusillus',
                         'Trifolium microdon',
                         'Githopsis specularioides',
                         'Lessingia ramulosa',
                         'Mimulus androsaceus',
                         'Hesperevax sparsiflora',
                         'Allium amplectens',
                         'Allium fimbriatum',
                         'Mimulus douglasii',
                         'Galium aparine',
                         'Astragalus rattanii var. jepsonianus',
                         'Hesperolinon disjunctum',
                         'Centaurea melitensis',
                         'Silene gallica',
                         'Eriophyllum lanatum',
                         'Camissonia graciliflora',
                         'Linanthus jepsonii',
                         'Allium falcifolium',
                         'Chorizanthe polygonoides',
                         'Lotus purshianus',
                         'Sagina apetala',
                         'Fritillaria pluriflora',
                         'Asclepias fascicularis',
                         'Erodium brachycarpum',
                         'Plectritis ciliosa',
                         'Sanicula bipinnata',
                         'Linanthus latisectus',
                         'Aira caryophyllea',
                         'Cynosurus echinatus',
                         'Ranunculus californicus',
                         'Thermopsis macrophylla',
                         'Geranium dissectum',
                         'Nemophila menziesii',
                         'Torilis arvensis',
                         'Cryptantha hispidula',
                         'Melica imperfecta',
                         'Filago californica',
                         'Melica torreyana',
                         'Achillea millefolium',
                         'Chaenactis glabriuscula',
                         'Uropappus lindleyi',
                         'Streptanthus breweri',
                         'Camissonia ovata',
                         'Cardamine oligosperma',
                         'Juncus sp.',
                         'Trifolium microcephalum',
                         'Senecio eurycephalus',
                         'Eschscholzia californica',
                         'Hordeum depressum',
                         'Nemophila heterophylla',
                         'Quercus durata',
                         'Iris douglasiana',
                         'Lomatium macrocarpum',
                         'Cercocarpus betuloides',
                         'Galium murale',
                         'Erythranthe guttata',
                         'Helianthella californica',
                         'Bellardia trixago',
                         'Helianthus exilis',
                         'Hordeum murinum',
                         'Elymus repens',
                         'Scutellaria siphocampyloides',
                         'Linanthus ciliatus',
                         'Phalaris paradoxa',
                         'Trifolium ciliolatum',
                         'Pectocarya pusilla',
                         'Linanthus dichotomus',
                         'Hypochaeris radicata',
                         'Trifolium dubium',
                         'Dodecatheon hendersonii',
                         'Carduus pycnocephalus',
                         'Torilis nodosa',
                         'Vulpia octoflora',
                         'Rumex crispus',
                         'Eriogonum covilleanum',
                         'Nemophila pedunculata',
                         'Vulpia bromoides',
                         'Stellaria media',
                         'Crassula connata',
                         'Sanicula crassicaulis',
                         'Pinus sabiniana',
                         'Apocynum cannabinum',
                         'Antirrhinum vexillocalyculatum',
                         'Eriodictyon californicum',
                         'Triteleia hyacinthina',
                         'Adenostoma fasciculatum',
                         'Trichostema laxum',
                         'Trifolium depauperatum',
                         'Bromus japonicus',
                         'Asclepias eriocarpa',
                         'Velezia rigida')

mcLserp_species_data <- occ(query = mcLann_species_list, from = "gbif", has_coords = TRUE, limit = 100000,
                gbifopts = list(hasGeospatialIssue = FALSE, country = "US",
                                stateProvince = "California"))
```

```{r clean mcLann species data}
## we can also replace all synonym taxon names with one (cuts down the number of plotted dot colors)
mcLserp_species_data <- fixnames(mcLserp_species_data, how = "query")

## The occ2df function should convert the data to a dataframe format
mcLserp_species_data_df <- occ2df(mcLserp_species_data)

# We need to clean the coordinates, as it appears some are in the ocean, and there might be some that are just incorrect. To do this, we will use a coordinate cleaner package.
flags <- clean_coordinates(x = mcLserp_species_data_df, lon = "longitude", lat = "latitude",
                          species = "name",
                          tests = c("capitals", "centroids", "equal","gbif", "institutions",
                                    "seas", "zeros", "duplicates")) # most tests are on by default

# Most of our flagged coordinates are coastal/in the ocean. Therefore, we'll remove them from our database.
# keep only the non-flagged data
mcLserp_species_data_df <- mcLserp_species_data_df[flags$.summary,] %>%
  rename("species.name" = "name")
```

Because there are three genera found in the plots could reflect any number of species known from the site, we fill collect gbif data for all of these.
### Species without epithets
##### Juncus
```{r mclann juncus query GBIF}
mcLserp_juncus <- c('Juncus balticus',
                   'Juncus bufonius',
                   'Juncus oxymeris',
                   'Juncus phaeocephalus',
                   'Juncus occidentalis')
         
mcLserp_juncus_data <- occ(query = mcLserp_juncus, from = "gbif", has_coords = TRUE, limit = 10000,
                gbifopts = list(hasGeospatialIssue = FALSE, country = "US",
                                stateProvince = "California"))
```

```{r clean mcLann juncus data}
## we can also replace all synonym taxon names with one (cuts down the number of plotted dot colors)
## we should use the scrubr version of the function in the future
mcLserp_juncus_data <- fixnames(mcLserp_juncus_data, how = "query")

## The occ2df function should convert the data to a dataframe format
mcLserp_juncus_data_df <- occ2df(mcLserp_juncus_data)

flags <- clean_coordinates(x = mcLserp_juncus_data_df, lon = "longitude", lat = "latitude",
                          species = "name",
                          tests = c("capitals", "centroids", "equal","gbif", "institutions",
                                    "seas", "zeros", "duplicates")) # most test are on by default

# remove flagged records
mcLserp_juncus_data_df <- mcLserp_juncus_data_df[flags$.summary,]

# change all datapoints to the "species sp" format that's used in the og dataframe, calc CTI
mcLserp_juncus_data_df <- mcLserp_juncus_data_df %>%
  mutate(species.name = "Juncus sp.")
```

##### Astragalus
```{r mcLserp astragalus GBIF query}
mcLserp_astragalus <- c('Astragalus breweri',
                   'Astragalus clevelandii',
                   'Astragalus gambellianus',
                   'Astragalus rattanii var. jepsonianus')

mcLserp_astragalus_data <- occ(query = mcLserp_astragalus, from = "gbif", has_coords = TRUE, limit = 10000,
                gbifopts = list(hasGeospatialIssue = FALSE, country = "US",
                                stateProvince = "California"))
```

```{r clean mcLserp astragalus data}
## we can also replace all synonym taxon names with one (cuts down the number of plotted dot colors)
## we should use the scrubr version of the function in the future
mcLserp_astragalus_data <- fixnames(mcLserp_astragalus_data, how = "query")

## The occ2df function should convert the data to a dataframe format
mcLserp_astragalus_data_df <- occ2df(mcLserp_astragalus_data)

flags <- clean_coordinates(x = mcLserp_astragalus_data_df, lon = "longitude", lat = "latitude",
                          species = "name",
                          tests = c("capitals", "centroids", "equal","gbif", "institutions",
                                    "seas", "zeros", "duplicates")) # most test are on by default

# remove flagged records
mcLserp_astragalus_data_df <- mcLserp_astragalus_data_df[flags$.summary,]

# change all datapoints to the "species sp" format that's used in the og dataframe, calc CTI
mcLserp_astragalus_data_df <- mcLserp_astragalus_data_df %>%
  mutate(species.name = "Astragalus sp.")
```

##### Quercus
```{r mclserp quercus GBIF query}
mcLserp_quercus <- c('Quercus berberidifolia',
                   'Quercus chrysolepis',
                   'Quercus douglasii',
                   'Quercus durata',
                   'Quercus kelloggii',
                   'Quercus lobata',
                   'Quercus wislizeni var. frutescens',
                   'Quercus wislizeni var. wislizeni')

mcLserp_quercus_data <- occ(query = mcLserp_quercus, from = "gbif", has_coords = TRUE, limit = 10000,
                gbifopts = list(hasGeospatialIssue = FALSE, country = "US",
                                stateProvince = "California"))
```

```{r mcLserp quercus cleanup}
## we can also replace all synonym taxon names with one (cuts down the number of plotted dot colors)
## we should use the scrubr version of the function in the future
mcLserp_quercus_data <- fixnames(mcLserp_quercus_data, how = "query")

## The occ2df function should convert the data to a dataframe format
mcLserp_quercus_data_df <- occ2df(mcLserp_quercus_data)

flags <- clean_coordinates(x = mcLserp_quercus_data_df, lon = "longitude", lat = "latitude",
                          species = "name",
                          tests = c("capitals", "centroids", "equal","gbif", "institutions",
                                    "seas", "zeros")) # most test are on by default

# remove flagged records
mcLserp_quercus_data_df <- mcLserp_quercus_data_df[flags$.summary,]

# change all datapoints to the "species sp" format that's used in the og dataframe, calc CTI
mcLserp_quercus_data_df <- mcLserp_quercus_data_df %>%
  mutate(species.name = "Quercus sp.")

```


##### Centaurea
```{r mclserp centaurea GBIF query}
mcLserp_centaurea <- c('Centaurea calcitrapa',
                   'Centaurea melitensis',
                   'Centaurea solstitialis')

mcLserp_centaurea_data <- occ(query = mcLserp_centaurea, from = "gbif", has_coords = TRUE, limit = 10000,
                gbifopts = list(hasGeospatialIssue = FALSE, country = "US",
                                stateProvince = "California"))
```

```{r mcLserp centaurea cleanup}
## we can also replace all synonym taxon names with one (cuts down the number of plotted dot colors)
## we should use the scrubr version of the function in the future
mcLserp_centaurea_data <- fixnames(mcLserp_centaurea_data, how = "query")

## The occ2df function should convert the data to a dataframe format
mcLserp_centaurea_data_df <- occ2df(mcLserp_centaurea_data)

flags <- clean_coordinates(x = mcLserp_centaurea_data_df, lon = "longitude", lat = "latitude",
                          species = "name",
                          tests = c("capitals", "centroids", "equal","gbif", "institutions",
                                    "seas", "zeros")) # most test are on by default

# remove flagged records
mcLserp_centaurea_data_df <- mcLserp_centaurea_data_df[flags$.summary,]

mcLserp_centaurea_data_df <-mcLserp_centaurea_data_df %>%
  mutate(species.name = "Centaurea sp.") 
```

##### Allium
```{r mclserp allium GBIF query}
mcLserp_allium <- c('Allium acuminatum',
                   'Allium amplectens',
                   'Allium dichlamydeum',
                   'Allium falcifolium',
                   'Allium fimbriatum var. fimbriatum',
                   'Allium fimbriatum var. purdyi', 
                   'Allium serra')

mcLserp_allium_data <- occ(query = mcLserp_allium, from = "gbif", has_coords = TRUE, limit = 10000,
                gbifopts = list(hasGeospatialIssue = FALSE, country = "US",
                                stateProvince = "California"))
```

```{r mcLserp allium cleanup}
## we can also replace all synonym taxon names with one (cuts down the number of plotted dot colors)
## we should use the scrubr version of the function in the future
mcLserp_allium_data <- fixnames(mcLserp_allium_data, how = "query")

## The occ2df function should convert the data to a dataframe format
mcLserp_allium_data_df <- occ2df(mcLserp_allium_data)

flags <- clean_coordinates(x = mcLserp_allium_data_df, lon = "longitude", lat = "latitude",
                          species = "name",
                          tests = c("capitals", "centroids", "equal","gbif", "institutions",
                                    "seas", "zeros")) # most test are on by default

# remove flagged records
mcLserp_allium_data_df <- mcLserp_allium_data_df[flags$.summary,]

mcLserp_allium_data_df <-mcLserp_allium_data_df %>%
  mutate(species.name = "Allium sp.") 
```


### Combine with and without epithet dataframes and remove extra objects
```{r recombine mclserp with epithet with non-epithet data}
mcLserp_species_data_df <- full_join(mcLserp_species_data_df, mcLserp_juncus_data_df)
mcLserp_species_data_df <- full_join(mcLserp_species_data_df, mcLserp_astragalus_data_df)
mcLserp_species_data_df <- full_join(mcLserp_species_data_df, mcLserp_quercus_data_df)
mcLserp_species_data_df <- full_join(mcLserp_species_data_df, mcLserp_centaurea_data_df)
mcLserp_species_data_df <- full_join(mcLserp_species_data_df, mcLserp_allium_data_df)
```


## Swanton
### Preparing a species list table and importing data
```{r swanton data and species list}
rel_swan <- rel_all %>%
  filter(site == "Swanton")
swan_species <- unique(rel_swan$species.name)
swan_species <- as.data.frame(swan_species)
swan_species$swan_species <- paste0("'", swan_species$swan_species, "',")
cat(format_delim(swan_species, delim = ""))
```

There are a total of 39 species in the Carrizo dataset, some of which are sub-species, and others of which as genera or physical features (holes, moss, etc).
**Note:** Without specific epithets in the data: **, **

#### Species with epithets
```{r grabbing swanton gbif data, echo = FALSE, cache = TRUE, warning=FALSE}
swan_species_list <- c('Lysimachia arvensis',
                       'Erodium botrys',
                       'Erodium cicutarium',
                       'Erodium moschatum',
                       'Trifolium dubium',
                       'Trifolium subterraneum',
                       'Hypochaeris radicata',
                       'Plantago lanceolata',
                       'Rumex acetosella',
                       'Festuca perennis',
                       'Vulpia myuros',
                       'Bromus diandrus',
                       'Cerastium glomeratum',
                       'Geranium dissectum',
                       'Hordeum murinum',
                       'Juncus bufonius',
                       'Bromus carinatus',
                       'Rumex pulcher',
                       'Hordeum brachyantherum',
                       'Avena barbata',
                       'Stipa pulchra',
                       'Rumex crispus',
                       'Vicia sativa',
                       'Trifolium angustifolium',
                       'Silybum marianum',
                       'Cynosurus echinatus',
                       'Carduus pycnocephalus',
                       'Cirsium vulgare',
                       'Eschscholzia californica',
                       'Sonchus asper')

swan_species_data <- occ(query = swan_species_list, from = "gbif", has_coords = TRUE, limit = 10000,
                gbifopts = list(hasGeospatialIssue = FALSE, country = "US",
                                stateProvince = "California"))
```

```{r clean mcLann species data}
## we can also replace all synonym taxon names with one (cuts down the number of plotted dot colors)
swan_species_data <- fixnames(swan_species_data, how = "query")

## The occ2df function should convert the data to a dataframe format
swan_species_data_df <- occ2df(swan_species_data)

# We need to clean the coordinates, as it appears some are in the ocean, and there might be some that are just incorrect. To do this, we will use a coordinate cleaner package.
flags <- clean_coordinates(x = swan_species_data_df, lon = "longitude", lat = "latitude",
                          species = "name",
                          tests = c("capitals", "centroids", "equal","gbif", "institutions",
                                    "seas", "zeros", "duplicates")) # most tests are on by default

# Most of our flagged coordinates are coastal/in the ocean. Therefore, we'll remove them from our database.
# keep only the non-flagged data
swan_species_data_df <- swan_species_data_df[flags$.summary,] %>%
  rename("species.name" = "name")
```

Because there are three genera found in the plots could reflect any number of species known from the site, we fill collect gbif data for all of these.
### Species without epithets
##### Bromus
```{r swanton bromus query GBIF}
swan_bromus <- c('Bromus carinatus',
                 'Bromus diandrus',
                 'Avena barbata')
         
swan_bromus_data <- occ(query = swan_bromus, from = "gbif", has_coords = TRUE, limit = 10000,
                gbifopts = list(hasGeospatialIssue = FALSE, country = "US",
                                stateProvince = "California"))
```

```{r clean swanton bromus data}
## we can also replace all synonym taxon names with one (cuts down the number of plotted dot colors)
## we should use the scrubr version of the function in the future
swan_bromus_data <- fixnames(swan_bromus_data, how = "query")

## The occ2df function should convert the data to a dataframe format
swan_bromus_data_df <- occ2df(swan_bromus_data)

flags <- clean_coordinates(x = swan_bromus_data_df, lon = "longitude", lat = "latitude",
                          species = "name",
                          tests = c("capitals", "centroids", "equal","gbif", "institutions",
                                    "seas", "zeros", "duplicates")) # most test are on by default

# remove flagged records
swan_bromus_data_df <- swan_bromus_data_df[flags$.summary,]

# change all datapoints to the "species sp" format that's used in the og dataframe, calc CTI
swan_bromus_data_df <- swan_bromus_data_df %>%
  mutate(species.name = "Bromus sp")
```

##### Rumex
```{r swanton rumex query GBIF}
swan_rumex <- c('Rumex acetosella',
                'Rumex crispus',
                'Rumex pulcher')
         
swan_rumex_data <- occ(query = swan_rumex, from = "gbif", has_coords = TRUE, limit = 10000,
                gbifopts = list(hasGeospatialIssue = FALSE, country = "US",
                                stateProvince = "California"))
```

```{r clean swanton rumex data}
## we can also replace all synonym taxon names with one (cuts down the number of plotted dot colors)
## we should use the scrubr version of the function in the future
swan_rumex_data <- fixnames(swan_rumex_data, how = "query")

## The occ2df function should convert the data to a dataframe format
swan_rumex_data_df <- occ2df(swan_rumex_data)

flags <- clean_coordinates(x = swan_rumex_data_df, lon = "longitude", lat = "latitude",
                          species = "name",
                          tests = c("capitals", "centroids", "equal","gbif", "institutions",
                                    "seas", "zeros", "duplicates")) # most test are on by default

# remove flagged records
swan_rumex_data_df <- swan_rumex_data_df[flags$.summary,]

# change all datapoints to the "species sp" format that's used in the og dataframe, calc CTI
swan_rumex_data_df <- swan_rumex_data_df %>%
  mutate(species.name = "Rumex spp")
```

### Combine with and without epithet dataframes and remove extra objects
```{r recombine swanton with epithet with non-epithet data}
swan_species_data_df <- full_join(swan_species_data_df, swan_bromus_data_df)
swan_species_data_df <- full_join(swan_species_data_df, swan_rumex_data_df)
```


## UCSC
### Preparing a species list table and importing data
```{r swanton data and species list}
rel_ucsc <- rel_all %>%
  filter(site == "UCSC")
ucsc_species <- unique(rel_ucsc$species.name)
ucsc_species <- as.data.frame(ucsc_species)
ucsc_species$ucsc_species <- paste0("'", ucsc_species$ucsc_species, "',")
cat(format_delim(ucsc_species, delim = ""))
```

There are a total of 39 species in the Carrizo dataset, some of which are sub-species, and others of which as genera or physical features (holes, moss, etc).
**Note:** Without specific epithets in the data: *Bromus sp*

#### Species with epithets
```{r grabbing swanton gbif data, echo = FALSE, cache = TRUE, warning=FALSE}
ucsc_species_list <- c('Erodium botrys', 
                       'Geranium dissectum',
                       'Bromus hordeaceus',
                       'Vulpia myuros',
                       'Festuca perennis',
                       'Hypochaeris radicata',
                       'Plantago lanceolata',
                       'Rumex acetosella',
                       'Eschscholzia californica',
                       'Erodium moschatum',
                       'Lysimachia arvensis',
                       'Bromus diandrus',
                       'Brachypodium distachyon',
                       'Briza maxima',
                       'Stipa pulchra',
                       'Aira caryophyllea',
                       'Avena barbata',
                       'Erodium cicutarium',
                       'Carduus pycnocephalus',
                       'Phalaris aquatica',
                       'Trifolium angustifolium',
                       'Epilobium ciliatum',
                       'Cerastium glomeratum',
                       'Juncus phaeocephalus',
                       'Brassica species',
                       'Hirschfeldia incana')

ucsc_species_data <- spocc::occ(query = ucsc_species_list, from = "gbif", has_coords = TRUE, limit = 10000,
                gbifopts = list(hasGeospatialIssue = FALSE, country = "US",
                                stateProvince = "California"))
```

```{r clean mcLann species data}
## we can also replace all synonym taxon names with one (cuts down the number of plotted dot colors)
ucsc_species_data <- fixnames(ucsc_species_data, how = "query")

## The occ2df function should convert the data to a dataframe format
ucsc_species_data_df <- occ2df(ucsc_species_data)

# We need to clean the coordinates, as it appears some are in the ocean, and there might be some that are just incorrect. To do this, we will use a coordinate cleaner package.
flags <- clean_coordinates(x = ucsc_species_data_df, lon = "longitude", lat = "latitude",
                          species = "name",
                          tests = c("capitals", "centroids", "equal","gbif", "institutions",
                                    "seas", "zeros", "duplicates")) # most tests are on by default

# Most of our flagged coordinates are coastal/in the ocean. Therefore, we'll remove them from our database.
# keep only the non-flagged data
ucsc_species_data_df <- ucsc_species_data_df[flags$.summary,] %>%
  rename("species.name" = "name")
```

Because there are three genera found in the plots could reflect any number of species known from the site, we fill collect gbif data for all of these.
### Species without epithets
##### Bromus
```{r ucsc bromus query GBIF}
ucsc_bromus <- c('Bromus carinatus',
                 'Bromus diandrus',
                 'Avena barbata')
         
ucsc_bromus_data <- occ(query = ucsc_bromus, from = "gbif", has_coords = TRUE, limit = 10000,
                gbifopts = list(hasGeospatialIssue = FALSE, country = "US",
                                stateProvince = "California"))
```

```{r clean swanton bromus data}
## we can also replace all synonym taxon names with one (cuts down the number of plotted dot colors)
## we should use the scrubr version of the function in the future
ucsc_bromus_data <- fixnames(ucsc_bromus_data, how = "query")

## The occ2df function should convert the data to a dataframe format
ucsc_bromus_data_df <- occ2df(ucsc_bromus_data)

flags <- clean_coordinates(x = ucsc_bromus_data_df, lon = "longitude", lat = "latitude",
                          species = "name",
                          tests = c("capitals", "centroids", "equal","gbif", "institutions",
                                    "seas", "zeros", "duplicates")) # most test are on by default

# remove flagged records
ucsc_bromus_data_df <- ucsc_bromus_data_df[flags$.summary,]

# change all datapoints to the "species sp" format that's used in the og dataframe, calc CTI
ucsc_bromus_data_df <- ucsc_bromus_data_df %>%
  mutate(species.name = "Bromus sp")
```

##### Brassica
```{r swanton bromus query GBIF}
ucsc_brassica <- c('Brassica rapa',
                  'Brassica nigra',
                  'Hirschfeldia incana')
         
ucsc_brassica_data <- occ(query = ucsc_brassica, from = "gbif", has_coords = TRUE, limit = 10000,
                gbifopts = list(hasGeospatialIssue = FALSE, country = "US",
                                stateProvince = "California"))
```

```{r clean swanton bromus data}
## we can also replace all synonym taxon names with one (cuts down the number of plotted dot colors)
## we should use the scrubr version of the function in the future
ucsc_brassica_data <- fixnames(ucsc_brassica_data, how = "query")

## The occ2df function should convert the data to a dataframe format
ucsc_brassica_data_df <- occ2df(ucsc_brassica_data)

flags <- clean_coordinates(x = ucsc_brassica_data_df, lon = "longitude", lat = "latitude",
                          species = "name",
                          tests = c("capitals", "centroids", "equal","gbif", "institutions",
                                    "seas", "zeros", "duplicates")) # most test are on by default

# remove flagged records
ucsc_brassica_data_df <- ucsc_brassica_data_df[flags$.summary,]

# change all datapoints to the "species sp" format that's used in the og dataframe, calc CTI
ucsc_brassica_data_df <- ucsc_brassica_data_df %>%
  mutate(species.name = "Brassica species")
```

### Combine with and without epithet dataframes and remove extra objects
```{r recombine swanton with epithet with non-epithet data}
ucsc_species_data_df <- full_join(ucsc_species_data_df, ucsc_bromus_data_df)
ucsc_species_data_df <- full_join(ucsc_species_data_df, ucsc_brassica_data_df)
```

```{r save rds files}
# save the gbif spatial data
write_rds(ang_species_data_df, "Analysis/GBIF_Data/AngGBIF_0820.rds")
write_rds(car_species_data_df, "Analysis/GBIF_Data/CarGBIF_0820.rds")
write_rds(elk_species_data_df, "Analysis/GBIF_Data/ElkGBIF_0820.rds")
write_rds(jasp_species_data_df, "Analysis/GBIF_Data/JaspGBIF_0820.rds")
write_rds(mcLann_species_data_df, "Analysis/GBIF_Data/mcLannGBIF_0820.rds")
write_rds(mcLserp_species_data_df, "Analysis/GBIF_Data/mcLserpGBIF_0820.rds")
write_rds(swan_species_data_df, "Analysis/GBIF_Data/swanGBIF_0820.rds")
write_rds(ucsc_species_data_df, "Analysis/GBIF_Data/ucscGBIF_0820.rds")
```


