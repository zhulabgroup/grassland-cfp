---
title: "Observational community shift analyses"
date: "`r format(Sys.time(), '%B %d, %Y')`"
editor_options: 
  chunk_output_type: console
output:
  bookdown::html_document2: 
    fig_caption: true
    number_sections: true
    global_numbering: true
    fig_width: 15
    fig_height: 15 
  bookdown::word_document2: 
    fig_caption: true
    number_sections: true
    global_numbering: true
    fig_width: 15
    fig_height: 15 
---

```{r setup, echo=FALSE, message=FALSE}
source("scripts/_setup.R")
```

# Methods

Let us begin with the theory of moment method estimation, which is a generalization of the CTI/CPI approach. For location $i$, species $j$, denote species abundance (point intercept or percent cover) as $A_{ij}$, and species trait (e.g., optimal temperature) as $T_j$. At the community level, the expected trait (i.e., first moment), which is equivalent to CTI/CPI, is

$$
\mathrm{E}(T_i) = \bar{T_i} = \frac{\sum_j A_{ij}T_j}{\sum_j A_{ij}}.
$$

Furthermore, the trait variance (i.e., second central moment), using the variance-expectation formula, is

$$
\mathrm{Var}(T_i) = \mathrm{E}[T_i^2] - \mathrm{E}[T_i]^2 = \frac{\sum_j A_{ij}T_j^2}{\sum_j A_{ij}} - \bar{T_i}^2.
$$

A pair of $\{\mathrm{E}(T_i), \mathrm{Var}(T_i)\}$ characterizes the trait values under the distribution of species abundance. Operationally, we might use a pair of mean and standard deviation, $\{ \mu(T_i) = \mathrm{E}(T_i), \sigma(T_i) = \sqrt{\mathrm{Var}(T_i)}\}$, so that they are comparable with the same unit. 

# Community change

Show available sampling year for plot by site for observational data.

```{r data-avail}
read_rds(.path$com_obs) %>%
  distinct(site, plot, year) %>%
  ggplot(aes(year, plot)) +
  geom_point() +
  facet_wrap(~site, scales = "free")
```

Calculate CWM using niche estimates for experimental and observational data.

```{r cal-cwm}
source("scripts/calculate-cwm.R")
```

Load customized plotting functions.

```{r plot-cwm-obs}
source("scripts/plot-cwm-obs.R")
```

## CTI ~ year

Community temperature niches change over years.

CTI community-level mean in several sites increases over years, suggesting communities are becoming "warmer," i.e., thermophilization.

```{r obs-mean-cti, fig.cap="Compare mean(CTI) across sites over years"}
plot_cwm_obs("mean_cti")
```

CTI community-level standard deviation.

```{r obs-sd-cti, fig.cap="Compare sd(CTI) across sites over years"}
plot_cwm_obs("sd_cti")
```

## CPI ~ year

Community precipitation niches change over years.

CPI community-level mean in several sites decreases over years, suggesting communities are becoming "drier," i.e., mesophilization.

```{r obs-mean-cpi, fig.cap="Compare mean(CPI) across sites over years"}
plot_cwm_obs("mean_cpi")
```

CPI community-level standard deviation.

```{r obs-sd-cpi, fig.cap="Compare sd(CPI) across sites over years"}
plot_cwm_obs("sd_cpi")
```

## CVI ~ year

Community VPDmax niches change over years.

CVI community-level mean in several sites changes over years, but no clear direction.

```{r obs-mean-cvi, fig.cap="Compare mean(CVI) across sites over years"}
plot_cwm_obs("mean_cvi")
```

CVI community-level standard deviation.

```{r obs-sd-cvi, fig.cap="Compare sd(CVI) across sites over years"}
plot_cwm_obs("sd_cvi")
```

# Site climate change

Download CHELSA monthly climate data from 1980 to 2019, assemble to annual, and extract at site locations.

```{r get-chelsa-annual, eval=FALSE}
source("scripts/get-chelsa-annual.R")
rm(list = ls())
```

Plot climate change at observed grassland community sites.

```{r plot-site-climate}
source("scripts/plot-site-climate.R")
```

Temperature increases.

```{r plot-site-tmp, fig.cap="Temperature change at observational sites"}
tmp_gg
```

Precipitation decreases.

```{r plot-site-ppt, fig.cap="Precipitation change at observational sites"}
ppt_gg
```

VPD increases.

```{r plot-site-vpd, fig.cap="VPD change at observational sites"}
vpd_gg
```

Note that subsetting climate data to the observational years leads to messy patterns. It doesn't make sense because the time series is too short.

Precipitation and VPD don't have a close correlation. 

```{r plot-site-ppt-vpd, fig.cap="Precipitation-VPD relation at observational site-year"}
ppt_vpd_gg
rm(list = ls())
```

## Site CTI/CPI ~ climate (temp/precip)

Explore site CTI/CPI values with site temperature/precipitation values.

```{r}
source("scripts/correlate-cwm-clim.R")
```

```{r plot-cti-tmp, fig.cap="CTI and temperature correlation among observational sites, each point is a year."}
cti_gg
```

```{r plot-cpi-ppt, fig.cap="CPI and precipitation correlation among observational sites, each point is a year."}
cpi_gg
rm(list = ls())
```
