# Community shift analyses

Setup and load packages.

```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, eval = TRUE)
```

```{r}
library(tidyverse)
```

Load niche estimates.

```{r}
niche_tbl <- read_rds("data/climate/niche_estimates.rds")
```

## Experimental data

Load all experimental community data

```{r}
expdat_tbl <- read_rds("data/community/all-experimental-data.rds")
```

Join species climate niche estimates with community data, then aggregate by site, year, plot, treatment, calculate community-averaged temp and precip, weighted by abundance.

```{r}
expcom_tbl <- expdat_tbl %>%
  inner_join(niche_tbl, by = "species") %>%
  group_by(site, year, plot, treat) %>%
  summarize(
    tmean_com = sum(abund * tmean_mean) / sum(abund),
    ppt_com = sum(abund * ppt_mean) / sum(abund),
    vpdmax_com = sum(abund * vpdmax_mean) / sum(abund)
  )
```

### JRGCE 

Warming vs. ambient plots.

```{r, fig.cap = "Compare CTI in ambient vs. elevated warming treatments over years"}
expcom_tbl %>%
  filter(
    site == "JRGCE",
    treat %in% c("____", "T___")
  ) %>%
  ggplot(aes(year, tmean_com, col = treat, group = interaction(treat, year))) +
  geom_boxplot() +
  labs(
    x = "Year", y = "Community Temperature Index (CTI, degC)",
    color = "Warming treatment"
  ) +
  scale_color_manual(values = c("black", "red"))
```

Watered vs. ambient plots.

```{r, fig.cap = "Compare CPI in ambient vs. elevated adding water treatments over years"}
expcom_tbl %>%
  filter(
    site == "JRGCE",
    treat %in% c("____", "_P__")
  ) %>%
  ggplot(aes(year, ppt_com, col = treat, group = interaction(treat, year))) +
  geom_boxplot() +
  labs(
    x = "Year", y = "Community Precipitation Index (CPI, mm)",
    color = "Watering treatment"
  ) +
  scale_color_manual(values = c("black", "blue"))
```

For both warming and watering treatments, show replicates as raw data.

```{r, fig.cap="Plot (replicate) level community weighted temperature and precipitation indexes from ambient and elevated temp and precip treatments over years"}
expcom_tbl %>%
  filter(
    site == "JRGCE",
    treat %in% c("____", "T___", "_P__", "TP__")
  ) %>%
  mutate(year = as.factor(year)) %>%
  ggplot(aes(tmean_com, ppt_com, group = interaction(treat, year))) +
  geom_point(aes(color = year), alpha = .5) +
  # stat_ellipse() +
  facet_wrap(~treat) +
  labs(
    x = "Community Temperature Index (CTI, degC)",
    y = "Community Precipitation Index (CPI, mm)",
    col = "Year"
  ) +
  scale_color_viridis_d()
```

Because of outliers, summarize by median (same as boxplot, not mean) values of replicates from the same treatment.

```{r, fig.cap="Median community weighted temperature and precipitation indexes from ambient and elevated temp and precip treatments over years"}
expcom_tbl %>%
  filter(
    site == "JRGCE",
    treat %in% c("____", "T___", "_P__", "TP__")
  ) %>%
  group_by(year, treat) %>%
  summarize(tmean_com = median(tmean_com), ppt_com = median(ppt_com)) %>%
  # mutate(year = as.factor(year)) %>%
  ggplot(aes(tmean_com, ppt_com, col = year)) +
  geom_path() +
  facet_wrap(~treat) +
  labs(
    x = "Community Temperature Index (CTI, degC)",
    y = "Community Precipitation Index (CPI, mm)",
    col = "Year"
  ) +
  scale_color_viridis_c()
```

### Santa Cruz IDE

Plot (replicate) level CPI in ambient vs. drought treatments.

```{r, fig.cap="Compare CPI in ambient vs. drought treatments over years"}
expcom_tbl %>%
  filter(site %in% c("IDE Arboretum", "IDE Marshall Field", "IDE YLR")) %>%
  ggplot(aes(year, ppt_com, col = treat, group = interaction(treat, year))) +
  geom_boxplot() +
  facet_wrap(~site) +
  labs(
    x = "Year", y = "Community Precipitation Index (CPI, mm)",
    color = "Drought treatment"
  ) +
  scale_color_manual(values = c("black", "red"))
```

Michael said Marshall Field has lots of native species, while Arboretum and YLR are highly invaded (2/16/22). That might explain the difference among those sites. 

Use VPDmax to replace total precip.

```{r, fig.cap="Compare community VPDmax in ambient vs. drought treatments over years"}
expcom_tbl %>%
  filter(site %in% c("IDE Arboretum", "IDE Marshall Field", "IDE YLR")) %>%
  ggplot(aes(year, vpdmax_com, col = treat, group = interaction(treat, year))) +
  geom_boxplot() +
  facet_wrap(~site) +
  labs(
    x = "Year", y = "Community VPDmax Index (CVI, hPa)",
    color = "Drought treatment"
  ) +
  scale_color_manual(values = c("black", "red"))
```

```{r eval=FALSE}
obs_cover <- read_rds("data/community/all-observational-data.rds") %>%
  # replace_na(list(abund = 0)) %>%
  filter(abund > 0) %>%
  group_by(site, year, plot) %>%
  mutate(rel_cover = abund / sum(abund)) %>%
  ungroup() %>%
  select(site, year, plot, species, guild, rel_cover)

site_spp_tbl <- obs_cover %>%
  group_by(site, species) %>%
  summarize(avg_rel_cover = mean(rel_cover)) %>%
  pivot_wider(names_from = site, values_from = avg_rel_cover, values_fill = 0) %>%
  rowwise() %>%
  mutate(avg_site = mean(c_across(Angelo:UCSC))) %>%
  arrange(desc(avg_site))
```
